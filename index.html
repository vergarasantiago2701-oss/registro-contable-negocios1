<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Contabilidad - Restaurantes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
            flex-wrap: wrap;
        }
        
        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: #f5f5f5;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            min-width: 150px;
        }
        
        .tab-button:hover {
            background: #efefef;
        }
        
        .tab-button.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        
        .content {
            display: none;
            padding: 30px;
        }
        
        .content.active {
            display: block;
        }
        
        .business-selector {
            margin-bottom: 30px;
        }
        
        .business-selector label {
            font-weight: 600;
            color: #333;
            margin-right: 10px;
            font-size: 1.1em;
        }
        
        .business-selector select {
            padding: 10px 15px;
            font-size: 1em;
            border: 2px solid #667eea;
            border-radius: 5px;
            cursor: pointer;
            background: white;
            color: #333;
        }
        
        .form-group {
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .form-group.full {
            grid-template-columns: 1fr;
        }
        
        .input-field {
            display: flex;
            flex-direction: column;
        }
        
        .input-field label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        
        .input-field input,
        .input-field select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }
        
        .input-field input:focus,
        .input-field select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 25px;
            justify-content: center;
        }
        
        button {
            padding: 12px 30px;
            font-size: 1em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
            border: 2px solid #ddd;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .payment-method {
            display: flex;
            gap: 20px;
            margin: 15px 0;
        }
        
        .radio-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .radio-group input[type="radio"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }
        
        .radio-group label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        table th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        table td {
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
        }
        
        table tr:hover {
            background: #f5f5f5;
        }
        
        .summary-card {
            background: #f9f9f9;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin: 15px 0;
            border-radius: 5px;
        }
        
        .summary-card h3 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .summary-box {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        
        .summary-box h4 {
            color: #666;
            margin-bottom: 10px;
            font-size: 0.9em;
            text-transform: uppercase;
        }
        
        .summary-box .value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            border: 1px solid #c3e6cb;
            display: none;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            border: 1px solid #f5c6cb;
            display: none;
        }
        
        .business-section {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #667eea;
        }
        
        .business-section h3 {
            color: #333;
            margin-bottom: 15px;
        }
        
        @media (max-width: 768px) {
            .form-group {
                grid-template-columns: 1fr;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .tab-button {
                font-size: 0.85em;
                min-width: 100px;
                padding: 10px 15px;
            }
        }
		/* ===== MODAL ===== */
		.modal-backdrop{
		position: fixed; inset: 0;
		background: rgba(0,0,0,0.45);
		display: flex; align-items: center; justify-content: center;
		padding: 16px; z-index: 9999;
		}
		.modal-card{
		width: 100%; max-width: 520px;
		background: #fff; border-radius: 10px;
		box-shadow: 0 20px 60px rgba(0,0,0,0.35);
		overflow: hidden; border: 1px solid #e5e5e5;
		}
		.modal-header{
		display: flex; align-items: center; justify-content: space-between;
		padding: 16px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
		color: #fff;
		}
		.modal-body{ padding: 18px 20px; }
		.modal-footer{
		padding: 14px 20px; display: flex; justify-content: flex-end; gap: 10px; background: #fafafa;
		border-top: 1px solid #eee;
		}
		.modal-close{
		background: transparent; border: none; color: #fff; font-size: 18px; cursor: pointer;
		}
		.modal-radio{ display: grid; gap: 10px; margin-top: 10px; }
		.radio-item{ display: flex; gap: 10px; align-items: center; cursor: pointer; }
		
		/*inputs deshabilitados*/
		input:disabled {
		  background-color: #f5f5f5;
		  color: #999;
		  cursor: not-allowed;
		}
		/* Efecto "shake" para errores de ingreso */
		@keyframes shake {
			10%, 90% { transform: translateX(-1px); }
			20%, 80% { transform: translateX(2px); }
			30%, 50%, 70% { transform: translateX(-4px); }
			40%, 60% { transform: translateX(4px); }
			}
			.input-shake {
			animation: shake 0.3s ease-in-out;
			border-color: #dc3545 !important; /* rojo de error */
		}
		/* Contenedor con scroll horizontal solo para la tabla ‚Äúgrande‚Äù */
		.table-responsive{
		  width: 100%;
		  overflow-x: auto;
		  -webkit-overflow-scrolling: touch;
		}
		
		/* La tabla de 12 columnas debe tener un ancho m√≠nimo y layout fijo */
		#resumenContent table.tabla-registros{
		  table-layout: fixed;
		  width: 100%;
		  min-width: 1100px; /* ajusta si necesitas m√°s o menos */
		}
		
		#resumenContent table.tabla-registros th,
		#resumenContent table.tabla-registros td{
		  white-space: normal;
		  word-break: break-word;
		  overflow-wrap: anywhere;
		  padding: 8px 6px;
		  font-size: 13px;
		  line-height: 1.2;
		}
		
		/* Anchos por columna (1..12) solo para la tabla grande */
		#resumenContent table.tabla-registros th:nth-child(1),
		#resumenContent table.tabla-registros td:nth-child(1){ width: 90px;  max-width: 90px; }
		
		#resumenContent table.tabla-registros th:nth-child(2),
		#resumenContent table.tabla-registros td:nth-child(2){ width: 150px; max-width: 150px; }
		
		#resumenContent table.tabla-registros th:nth-child(3),
		#resumenContent table.tabla-registros td:nth-child(3){ width: 60px;  max-width: 60px;  }
		
		#resumenContent table.tabla-registros th:nth-child(4),
		#resumenContent table.tabla-registros td:nth-child(4){ width: 90px;  max-width: 90px;  }
		
		#resumenContent table.tabla-registros th:nth-child(5),
		#resumenContent table.tabla-registros td:nth-child(5){ width: 90px;  max-width: 90px;  }
		
		#resumenContent table.tabla-registros th:nth-child(6),
		#resumenContent table.tabla-registros td:nth-child(6){ width: 90px;  max-width: 90px;  }
		
		#resumenContent table.tabla-registros th:nth-child(7),
		#resumenContent table.tabla-registros td:nth-child(7){ width: 90px;  max-width: 90px;  }
		
		#resumenContent table.tabla-registros th:nth-child(8),
		#resumenContent table.tabla-registros td:nth-child(8){ width: 80px;  max-width: 80px;  }
		
		#resumenContent table.tabla-registros th:nth-child(9),
		#resumenContent table.tabla-registros td:nth-child(9){ width: 130px; max-width: 130px; }
		
		#resumenContent table.tabla-registros th:nth-child(10),
		#resumenContent table.tabla-registros td:nth-child(10){ width: 180px; max-width: 180px; }
		
		#resumenContent table.tabla-registros th:nth-child(11),
		#resumenContent table.tabla-registros td:nth-child(11){ width: 110px; max-width: 110px; }
		
		#resumenContent table.tabla-registros th:nth-child(12),
		#resumenContent table.tabla-registros td:nth-child(12){ width: 110px; max-width: 110px; }
		
		/* Evita que el bot√≥n expanda la columna */
		#resumenContent table.tabla-registros td:nth-child(12) .btn-success{
		  width: 100%;
		  max-width: 100%;
		  padding: 8px 0;
		  white-space: nowrap;
		}
		
		/* Modo compacto m√≥vil: oculta columnas menos cr√≠ticas y reduce min-width */
		@media (max-width: 768px){
		  /* 4=Precio, 9=Cliente, 10=Descripci√≥n */
		  #resumenContent table.tabla-registros th:nth-child(4),
		  #resumenContent table.tabla-registros td:nth-child(4),
		  #resumenContent table.tabla-registros th:nth-child(9),
		  #resumenContent table.tabla-registros td:nth-child(9),
		  #resumenContent table.tabla-registros th:nth-child(10),
		  #resumenContent table.tabla-registros td:nth-child(10){
		    display: none;
		  }
		  #resumenContent table.tabla-registros{ min-width: 820px; }
		}

		/* ===== Acorde√≥n de Informes ===== */
		#informes details {
			border: 1px solid #e6e6e6;
			border-radius: 8px;
			background: #fff;
			margin: 14px 0;
			overflow: hidden;
		}
		#informes details[open] {
			box-shadow: 0 4px 18px rgba(0,0,0,0.06);
		}
		#informes details > summary {
			list-style: none;
			cursor: pointer;
			padding: 14px 16px;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: #fff;
			font-weight: 700;
			display: flex;
			align-items: center;
			justify-content: space-between;
		}
		#informes details > summary::-webkit-details-marker { display:none; }

		#informes .summary-title {
			display: inline-flex; align-items: center; gap: 10px;
		}
		#informes .chev {
			transition: transform .25s ease;
		}
		#informes details[open] .chev {
			transform: rotate(90deg);
		}

		#informes .panel-body {
			padding: 16px;
			background: #fafafa;
		}

		#informes .acc-actions {
			display:flex; gap:8px; margin: 6px 0 10px;
			justify-content:flex-end;
		}
		#informes .acc-actions .btn-secondary { padding: 8px 14px; }
		#informes .help-tip {
			font-size: 12px; color: #666; margin: 4px 0 10px;
		}

		/* ====== DETALLE INGRESOS ‚Äì estilos unificados ====== */
		.kpi-card {
		background: #fff;
		border: 2px solid #e5e5e5;
		border-radius: 8px;
		overflow: hidden;
		}

		.kpi-card .kpi-card__header {
		background: #f3f6ff; /* tono claro en la l√≠nea del primario */
		padding: 10px 12px;
		font-weight: 700;
		color: #4453c0; /* primo del #667eea */
		text-transform: uppercase;
		font-size: 12px;
		letter-spacing: .02em;
		border-bottom: 1px solid #e9ecf9;
		}

		.kpi-card table {
		width: 100%;
		border-collapse: collapse;
		}

		.kpi-card thead th {
		background: #667eea; /* igual que otras cabeceras */
		color: #fff;
		padding: 10px;
		font-weight: 700;
		text-align: left;
		font-size: 13px;
		}

		.kpi-card tbody td {
		padding: 10px 12px;
		border-bottom: 1px solid #eee;
		font-size: 13px;
		}

		.kpi-card tbody tr:last-child td {
		border-bottom: none;
		}

		.kpi-badge {
		display: inline-block;
		padding: 2px 8px;
		border-radius: 999px;
		font-size: 12px;
		font-weight: 700;
		background: #eef2ff;
		color: #4453c0;
		margin-left: 6px;
		vertical-align: middle;
		}

		/* Colores de valores por m√©todo (detalle visual sutil) */
		.kpi-efectivo { color: #28a745; font-weight: 700; }
		.kpi-nequi    { color: #007bff; font-weight: 700; }
		.kpi-neg      { color: #dc3545; font-weight: 700; }
		.kpi-pos      { color: #28a745; font-weight: 700; }
		.kpi-muted    { color: #666; }

		/* ===== M√©todos de pago (badges) ===== */
		.metodo-badges{
		display:flex; gap:6px; flex-wrap:wrap; align-items:flex-start; /* top */
		}
		.badge-met{
		display:inline-flex; align-items:center; gap:6px;
		padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700;
		background:#eef2ff; color:#4453c0; border:1px solid #e0e7ff;
		white-space:nowrap; letter-spacing:0; font-variant-numeric:tabular-nums;
		}
		.badge-met.efec{ background:#eaf7ee; color:#1e7e34; border-color:#cdebd5; }
		.badge-met.nequi{ background:#eaf2ff; color:#0d6efd; border-color:#cfe2ff; }
		.badge-met.otro{ background:#f7f7f7; color:#555; border-color:#e6e6e6; }
		.badge-met .ico{ font-size:14px; line-height:1; }
		.badge-met .val{ font-weight:700; }

		/* Mantener alineaci√≥n alta en celdas, para que filas con varias l√≠neas no ‚Äúbajen‚Äù la referencia */
		.tabla-registros td, .tabla-registros th{
		vertical-align: top;                 /* üëà importante */
		word-break: normal;
		}

		/* (Opcional) Dar ancho c√≥modo a la columna 'M√©todo venta' para evitar cortes raros */
		#resumenContent table.tabla-registros th:nth-child(5),
		#resumenContent table.tabla-registros td:nth-child(5){
		width: 220px;     /* prueba 200‚Äì240px */
		max-width: 240px;
		}
    </style>
</head>
<body>
    <div class="container">
        <div class="header" style="position:relative;">
			
			<button onclick="logout()" class="btn-danger" style="
				position:absolute;
				top:20px;
				right:20px;">
				Cerrar sesi√≥n
			</button>

			<h1>üìä Sistema de Contabilidad</h1>
			<p>Gesti√≥n de Negocios - Base, Ventas y Gastos</p>

		</div>
        
        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('entrada', event)">Entrada de Datos</button>
			<button class="tab-button" onclick="switchTab('resumen', event)">Resumen Diario</button>
			<button class="tab-button" onclick="switchTab('acumulado', event)">Cuentas Acumuladas</button>
			<button class="tab-button" onclick="switchTab('metodos', event)">An√°lisis Pagos</button>
			<button class="tab-button" onclick="switchTab('configuracion', event)">Configuraci√≥n</button>
			<button class="tab-button" onclick="switchTab('informes', event)">Informes</button>
        </div>
        
        <!-- PESTA√ëA 1: ENTRADA DE DATOS -->
        <div id="entrada" class="content active">
            <div class="success-message" id="successMsg">‚úì Datos guardados correctamente</div>
            <div class="error-message" id="errorMsg"></div>
            
            <div class="business-selector">
                <label for="business">Selecciona Negocio:</label>
                <select id="business">
                    <option value="Negocio1">Negocio Fritos</option>
                    <option value="Negocio2">Negocio Almuerzos</option>
                    <option value="Negocio3">Negocio Licorer√≠a</option>
                    <option value="Negocio4">Negocio Comidas R√°pidas</option>
                </select>
            </div>
            
            <h3 style="color: #333; margin-bottom: 10px;">Registrar Movimiento del D√≠a</h3>
            <p style="color:#666; margin-bottom:20px; font-size:0.9em;">
			  Registra <strong>ventas por producto</strong> y/o <strong>gastos</strong> para el negocio y fecha.
			</p>
            
            <div class="form-group full">
                <div class="input-field">
                    <label for="fecha">Fecha:</label>
                    <input type="date" id="fecha" value="">
                </div>
            </div>
            
            <div class="form-group">
			  <div class="input-field">
				<div class="form-group">
				  <div class="input-field">
					<label>Producto:</label>
					<select id="productoSelect"></select>
				  </div>

				  <div class="input-field">
					<label>Cantidad:</label>
					<input type="number" id="cantidad" min="1" value="1">
				  </div>
				</div>

				<!-- Se muestra solo cuando sea Mojarra en Negocio2 -->
				<div class="input-field" style="display:none;" id="precioPersonalizadoWrap">
				  <label>Precio personalizado (solo Mojarra &gt; $25.000):</label>
				  <input type="number" id="precioPersonalizado" min="25001" step="1" placeholder="Ej: 26000">
				  <small style="color:#666;">Si el precio es mayor a $25.000, escribe aqu√≠ el valor exacto.</small>
				</div>

				<!-- Se muestra solo cuando sea Corriente en Negocio2 -->
				<div class="input-field" style="display:none;" id="tipoCorrienteWrap">
					<label>Tipo de corriente:</label>
					<input type="text" id="tipoCorriente" placeholder="Ej: pollo, res, mixta">
					<small style="color:#666;">Obligatorio para Corriente (Negocio Almuerzos).</small>
				</div>

				<div class="summary-card">
				  <strong>Total Venta:</strong>
				  <span id="totalVentaPreview">$0</span>
				</div>
				
				<!-- Bot√≥n para apilar la l√≠nea al carrito -->
				<div class="button-group" style="margin-top:10px;">
				  <button class="btn-success" type="button" onclick="agregarAlCarrito()">‚ûï Agregar al pedido</button>
				</div>

				<!-- Tabla del carrito (pedido actual, no guardado a√∫n) -->
				<div class="business-section" id="carritoSection" style="display:none;">
				  <h4>Pedido actual (no guardado)</h4>
				  <table id="carritoTabla">
					<thead>
					  <tr>
						<th>Producto</th>
						<th>Cant.</th>
						<th>Precio Unit.</th>
						<th>Total</th>
						<th></th>
					  </tr>
					</thead>
					<tbody></tbody>
				  </table>
				  <div style="margin-top:10px; text-align:right;">
					<strong>Total pedido:</strong> <span id="carritoTotal">$0</span>
				  </div>
				</div>
			  </div>
			</div>
            
            <div class="form-group">
                <div class="input-field">
                    <label for="gastos">Gastos ($):</label>
                    <input type="number" id="gastos" placeholder="0" step="0.01" min="0">
                </div>
                <div class="input-field">
                    <label for="descripcion">Descripci√≥n de Gasto:</label>
                    <input type="text" id="descripcion" placeholder="Ej: Compra de ingredientes">
                </div>
            </div>
            
            <!-- <div class="form-group full">
                <div class="input-field">
                    <label>M√©todo de Pago (Ventas):</label>
                    <div class="payment-method">
                        <div class="radio-group">
                            <input type="radio" id="efectivo" name="metodo" value="Efectivo" checked>
                            <label for="efectivo">üíµ Efectivo</label>
                        </div>
                        <div class="radio-group">
                            <input type="radio" id="nequi" name="metodo" value="Nequi">
                            <label for="nequi">üì± Nequi</label>
                        </div>
                    </div>
                </div>
            </div> -->
            
            <div class="button-group">
                <button class="btn-primary" onclick="abrirModalPago()">Guardar Registro</button>
                <button class="btn-secondary" onclick="limpiarFormulario()">Limpiar</button>
            </div>
        </div>
        
        <!-- PESTA√ëA 2: RESUMEN DIARIO -->
        <div id="resumen" class="content">
            <h3 style="color: #333; margin-bottom: 20px;">Resumen Diario</h3>
            
            <div class="input-field" style="margin-bottom: 20px; max-width: 300px;">
                <label for="fechaFiltro">Filtrar por Fecha:</label>
                <input type="date" id="fechaFiltro" onchange="actualizarResumen()">
            </div>
            
			<div class="input-field" style="margin-bottom: 10px; max-width: 300px;">
			<label class="radio-group" style="gap:8px;">
				<input type="checkbox" id="soloDeudas" onchange="actualizarResumen()">
				<span>Mostrar solo deudas (ventas en "Debe")</span>
			</label>
			</div>

			<!-- Contenedor de la secci√≥n de Cuentas por Cobrar -->
			<div id="cxcContent"></div>
            <div id="resumenContent"></div>
        </div>
        
        <!-- PESTA√ëA 3: CUENTAS ACUMULADAS -->
        <div id="acumulado" class="content">
            <h3 style="color: #333; margin-bottom: 20px;">Cuentas Acumuladas por Negocio</h3>
            
            <div class="summary-grid" id="acumuladoContent"></div>
        </div>
        
        <!-- PESTA√ëA 4: AN√ÅLISIS PAGOS -->
        <div id="metodos" class="content">
            <h3 style="color: #333; margin-bottom: 20px;">An√°lisis de M√©todos de Pago</h3>
            
            <div class="form-group">
                <div class="input-field">
                    <label for="negocioFiltro">Negocio:</label>
                    <select id="negocioFiltro" onchange="actualizarAnalisisPagos()">
                        <option value="Todos">Todos los Negocios</option>
                        <option value="Negocio1">Negocio Fritos</option>
                        <option value="Negocio2">Negocio Almuerzos</option>
                        <option value="Negocio3">Negocio Licorer√≠a</option>
                        <option value="Negocio4">Negocio Comidas R√°pidas</option>
                    </select>
                </div>
                <div class="input-field">
                    <label for="filtroFechaPagos">Filtrar por Fecha:</label>
                    <select id="filtroFechaPagos" onchange="actualizarAnalisisPagos()">
                        <option value="actual">Estado Actual (Acumulado)</option>
                        <option value="fecha">Por Fecha Espec√≠fica</option>
                    </select>
                </div>
				<!-- Toggle incluir capital inicial -->
				<div class="input-field">
					<label for="toggleCapitalInicial" style="user-select:none;">Opciones:</label>
					<label class="radio-group" style="gap:10px;">
						<input type="checkbox" id="toggleCapitalInicial" onchange="actualizarAnalisisPagos()">
						<span>Incluir capital inicial</span>
					</label>
				</div>
            </div>
            
            <div id="fechaPagosContainer" style="display: none; margin-bottom: 20px;">
                <div class="input-field" style="max-width: 300px;">
                    <label for="fechaSeleccionadaPagos">Selecciona Fecha:</label>
                    <input type="date" id="fechaSeleccionadaPagos" onchange="actualizarAnalisisPagos()">
                </div>
            </div>
            
            <div id="analisisPagosContent"></div>
        </div>
        
        <!-- PESTA√ëA 5: CONFIGURACI√ìN -->
        <div id="configuracion" class="content">
            <h3 style="color: #333; margin-bottom: 20px;">Configuraci√≥n del Sistema</h3>
            
            <div class="business-section">
                <h4>Gesti√≥n de Datos</h4>
                <div class="button-group">
                    <button class="btn-secondary" onclick="exportarDatos()">üì• Exportar Datos</button>
                    <button class="btn-secondary" onclick="descargarExcel()">üìä Descargar Excel</button>
                    <!--<button class="btn-danger" onclick="limpiarTodos()">üóëÔ∏è Limpiar Datos Locales</button>-->
                </div>
            </div>
            
            <div class="business-section">
                <h4>Informaci√≥n del Sistema</h4>
                <p><strong>Versi√≥n:</strong> 2.0.3</p>
                <p><strong>Negocios Registrados:</strong> 4</p>
                <p><strong>Datos Almacenados:</strong> <span id="totalRegistros">0</span> registros</p>
            </div>

            <!-- === Cat√°logo de productos (Config) === -->
            <div class="business-section">
              <h4>Cat√°logo de productos por negocio</h4>
              <p style="color:#666;margin:8px 0 14px;">
                Agrega productos personalizados (se suman al cat√°logo base del negocio). Se guardan en la nube.
              </p>

              <div class="form-group">
                <div class="input-field">
                  <label for="cfgNegocio">Negocio:</label>
                  <select id="cfgNegocio" onchange="renderCatalogoUI()">
                    <option value="Negocio1">Negocio Fritos</option>
                    <option value="Negocio2">Negocio Almuerzos</option>
                    <option value="Negocio3">Negocio Licorer√≠a</option>
                    <option value="Negocio4">Negocio Comidas R√°pidas</option>
                  </select>
                </div>

                <div class="input-field">
                  <label for="cfgNombreProd">Nombre del producto:</label>
                  <input id="cfgNombreProd" type="text" placeholder="Ej: Perro hawaiano">
                </div>
                <div class="input-field">
                  <label for="cfgPrecioProd">Precio (COP):</label>
                  <input id="cfgPrecioProd" type="number" min="1" step="1" placeholder="Ej: 12000">
                </div>
              </div>

              <div class="button-group" style="justify-content:flex-start;">
                <button class="btn-success" type="button" onclick="cfgAgregarProducto()">‚ûï Agregar producto</button>
              </div>

              <div id="cfgTablaWrap" style="margin-top:14px;">
                <!-- Aqu√≠ se renderiza la tabla del cat√°logo del negocio seleccionado -->
              </div>
            </div>			
        </div>
		<!-- PESTA√ëA 6: INFORMES -->
		<div id="informes" class="content">

			<!-- Acciones globales del acorde√≥n -->
			<div class="acc-actions">
				<button class="btn-secondary" type="button" onclick="toggleInformes(true)">Expandir todo</button>
				<button class="btn-secondary" type="button" onclick="toggleInformes(false)">Replegar todo</button>
			</div>
			<div class="help-tip">Sugerencia: <strong>Alt + clic</strong> sobre el t√≠tulo abre <em>solo ese</em> informe.</div>

			<!-- ====== Informe mensual ====== -->
			<details id="secMensual" open>
				<summary>
				<span class="summary-title"><span class="chev">‚ñ∂</span> Informe mensual</span>
				</summary>
				<div class="panel-body">
				<h3 style="color:#333;margin-bottom:16px;">Informe mensual</h3>
				<div class="form-group">
					<div class="input-field">
					<label for="mesReporte">Mes:</label>
					<input type="month" id="mesReporte">
					</div>
					<div class="input-field">
					<label for="negocioReporte">Negocio:</label>
					<select id="negocioReporte">
						<option value="Todos">Todos</option>
						<option value="Negocio1">Negocio Fritos</option>
						<option value="Negocio2">Negocio Almuerzos</option>
						<option value="Negocio3">Negocio Licorer√≠a</option>
						<option value="Negocio4">Negocio Comidas R√°pidas</option>
					</select>
					</div>
				</div>
				<div class="button-group" style="justify-content:flex-start;">
					<button class="btn-secondary" type="button" onclick="previsualizarInforme()">üëÄ Previsualizar</button>
					<button class="btn-primary" type="button" onclick="exportarInformeMensualPDF()">üßæ Exportar PDF</button>
				</div>
				<div id="previewInforme" style="margin-top:16px;"></div>
				</div>
			</details>

			<!-- ====== Resumen por Per√≠odo ====== -->
			<details id="secPeriodo">
				<summary>
				<span class="summary-title"><span class="chev">‚ñ∂</span> Resumen por Per√≠odo</span>
				</summary>
				<div class="panel-body">
				<h3 style="color:#333;margin-bottom:16px;">Resumen por Per√≠odo</h3>
				<div class="form-group">
					<div class="input-field">
					<label for="infDesdePeriodo">Desde:</label>
					<input type="date" id="infDesdePeriodo">
					</div>
					<div class="input-field">
					<label for="infHastaPeriodo">Hasta:</label>
					<input type="date" id="infHastaPeriodo">
					</div>
					<div class="input-field">
					<label for="infNegocioReporte">Negocio:</label>
					<select id="infNegocioReporte" onchange="previsualizarPeriodoInforme(); renderCxcPeriodoEnInformes();">
						<option value="Todos">Todos</option>
						<option value="Negocio1">Negocio Fritos</option>
						<option value="Negocio2">Negocio Almuerzos</option>
						<option value="Negocio3">Negocio Licorer√≠a</option>
						<option value="Negocio4">Negocio Comidas R√°pidas</option>
					</select>
					</div>
					<div class="input-field">
					<label class="radio-group" style="gap:8px;">
						<input type="checkbox" id="infSoloDeudasPeriodo" onchange="previsualizarPeriodoInforme()">
						<span>Mostrar solo deudas (ventas en "Debe")</span>
					</label>
					</div>
					<div class="input-field">
					<label class="radio-group" style="gap:8px;">
						<input type="checkbox" id="infCxcAcumuladoPeriodo" checked onchange="renderCxcPeriodoEnInformes()">
						<span>CxC acumulado (todas las fechas)</span>
					</label>
					</div>
					<div class="input-field">
					<label class="radio-group" style="gap:8px;">
						<input type="checkbox" id="infIncluirDetalle" checked>
						<span>Incluir tabla de detalle</span>
					</label>
					</div>
				</div>
				<div class="button-group" style="justify-content:flex-start;margin-top:4px;">
					<button class="btn-secondary" type="button" onclick="previsualizarPeriodoInforme()">üëÄ Previsualizar per√≠odo</button>
					<button class="btn-primary" type="button" onclick="exportarInformePeriodoPDF()">üßæ Exportar PDF del per√≠odo</button>
				</div>
				<div id="infCxcPeriodo" style="margin-top:14px;"></div>
				<div id="previewPeriodoInforme" style="margin-top:10px;"></div>
				</div>
			</details>

			<!-- ====== Estado de Resultados (P&L) ====== -->
			<details id="secPL">
				<summary>
				<span class="summary-title"><span class="chev">‚ñ∂</span> Estado de Resultados (P&amp;L)</span>
				</summary>
				<div class="panel-body">
				<h3 style="color:#333;margin-bottom:16px;">Estado de Resultados (P&amp;L)</h3>
				<div class="form-group">
					<div class="input-field">
					<label for="plDesde">Desde:</label>
					<input type="date" id="plDesde">
					</div>
					<div class="input-field">
					<label for="plHasta">Hasta:</label>
					<input type="date" id="plHasta">
					</div>
					<div class="input-field">
					<label for="plNegocio">Negocio:</label>
					<select id="plNegocio">
						<option value="Todos">Todos</option>
						<option value="Negocio1">Negocio Fritos</option>
						<option value="Negocio2">Negocio Almuerzos</option>
						<option value="Negocio3">Negocio Licorer√≠a</option>
						<option value="Negocio4">Negocio Comidas R√°pidas</option>
					</select>
					</div>
					<div class="input-field">
					<label class="radio-group" style="gap:8px;">
						<input type="checkbox" id="plIncluirCostos" onchange="previsualizarPL()">
						<span>Incluir costos (cuando los registremos)</span>
					</label>
					</div>
				</div>
				<div class="button-group" style="justify-content:flex-start;">
					<button class="btn-secondary" type="button" onclick="previsualizarPL()">üëÄ Previsualizar P&amp;L</button>
					<button class="btn-primary" type="button" onclick="exportarPLPDF()">üßæ Exportar PDF (P&amp;L)</button>
				</div>
				<div id="plPreview" style="margin-top:12px;"></div>
				</div>
			</details>

		</div>
    </div>
	<!-- MODAL Confirmaci√≥n de pago -->
	<div id="modalPagoBackdrop" class="modal-backdrop" style="display:none;">
		<div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalPagoTitulo">
			<div class="modal-header">
			<h3 id="modalPagoTitulo">Confirmar estado de pago</h3>
			<button class="modal-close" onclick="cerrarModalPago()" aria-label="Cerrar">‚úñ</button>
			</div>

			<div class="modal-body">
			  <p style="color:#555;margin-bottom:12px;">
				Indica c√≥mo registrar√°s este movimiento.
			  </p>

			  <div class="modal-radio">
				<label class="radio-item">
				  <input type="radio" name="estadoPago" value="pagado" checked onchange="updateModalPagoUI()">
				  <span>El cliente <strong>pag√≥ todo</strong></span>
				</label>
				<label class="radio-item">
				  <input type="radio" name="estadoPago" value="debe" onchange="updateModalPagoUI()">
				  <span>El cliente <strong>qued√≥ debiendo</strong></span>
				</label>
				<label class="radio-item">
				  <input type="radio" name="estadoPago" value="soloGasto" onchange="updateModalPagoUI()">
				  <span><strong>Solo gasto</strong> (sin ventas)</span>
				</label>
			  </div>

			  <!-- Hora del pedido (opcional) -->
			  <div id="horaPedidoWrap" style="margin-top:12px;">
					<label for="horaPedido" style="font-weight:600;color:#333;margin-bottom:6px;">
						Hora del pedido (opcional):
					</label>
					<input type="time" id="horaPedido"
						style="width:100%;padding:10px;border:2px solid #ddd;border-radius:6px;">
					<small style="color:#666;">Si no la ingresas, se guardar√° sin hora.</small>
			  </div>

			  <!-- NOMBRE DEL CLIENTE (solo si 'Debe' y hay ventas) -->
			  <div id="nombreClienteWrap" class="input-field" style="display:none; margin-top:12px;">
					<label for="nombreClienteDeudor" style="font-weight:600;color:#333;margin-bottom:6px;">
						Nombre del cliente (deudor):
					</label>
					<input type="text" id="nombreClienteDeudor" placeholder="Ej: Juan P√©rez"
							style="width:100%;padding:10px;border:2px solid #ddd;border-radius:6px;">
					<small style="color:#666;">Obligatorio cuando la venta queda en ‚ÄúDebe‚Äù.</small>
			  </div>

			  <!-- M√©todo de pago de la VENTA (solo si 'pagado' y hay carrito) -->
			  <div id="metodoVentaWrap" style="display:none; margin-top:12px;">
				<label style="font-weight:600;color:#333;margin-bottom:6px;display:block;">M√©todo de pago de la venta:</label>
				<div class="payment-method">
				  <div class="radio-group">
					<input type="radio" id="pagoVentaEfectivo" name="metodoVenta" value="Efectivo" checked>
					<label for="pagoVentaEfectivo">üíµ Efectivo</label>
				  </div>
				  <div class="radio-group">
					<input type="radio" id="pagoVentaNequi" name="metodoVenta" value="Nequi">
					<label for="pagoVentaNequi">üì± Nequi</label>
				  </div>
				</div>
			  </div>

			  <!-- M√©todo de pago del GASTO (si hay gasto > 0) -->
			  <div id="metodoGastoWrap" style="display:none; margin-top:12px;">
				<label style="font-weight:600;color:#333;margin-bottom:6px;display:block;">M√©todo de pago del gasto:</label>
				<div class="payment-method">
				  <div class="radio-group">
					<input type="radio" id="pagoGastoEfectivo" name="metodoGasto" value="Efectivo" checked>
					<label for="pagoGastoEfectivo">üíµ Efectivo</label>
				  </div>
				  <div class="radio-group">
					<input type="radio" id="pagoGastoNequi" name="metodoGasto" value="Nequi">
					<label for="pagoGastoNequi">üì± Nequi</label>
				  </div>
				</div>
				<small style="color:#666;">Este m√©todo solo aplica al registro de gasto.</small>
			  </div>

			  <div id="modalPagoError" class="error-message" style="display:none;margin-top:12px;">.</div>
			</div>
			<div class="modal-footer">
			  <button class="btn-secondary" onclick="cerrarModalPago()">Cancelar</button>
			  <button class="btn-primary" onclick="confirmarGuardarDesdeModal()">Confirmar y guardar</button>
			</div>
		</div>
	</div>
	<div id="modalCobrarBackdrop" class="modal-backdrop" style="display:none;">
	  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalCobrarTitulo">
		
			<div class="modal-header">
			  <h3 id="modalCobrarTitulo">Registrar Pago</h3>
			  <button class="modal-close" onclick="cerrarModalCobrar()" aria-label="Cerrar">&times;</button>
			</div>

			<div class="modal-body">
			  <p class="modal-instruction">Selecciona el m√©todo de pago para esta venta:</p>

			  <div class="payment-options">
					<label class="payment-radio">
					  <input type="radio" id="cobroEfectivo" name="metodoCobro" value="Efectivo" checked>
					  <div class="radio-content">
						<span class="icon">üíµ</span>
						<span class="text">Efectivo</span>
					  </div>
					</label>

					<label class="payment-radio">
					  <input type="radio" name="metodoCobro" value="Nequi">
					  <div class="radio-content">
						<span class="icon">üì±</span>
						<span class="text">Nequi</span>
					  </div>
					</label>
			  </div>

			  <div id="modalCobrarError" class="error-message" style="display:none;"></div>
			</div>

			<div class="modal-footer">
			  <button class="btn-secondary" onclick="cerrarModalCobrar()">Cancelar</button>
			  <button id="btnConfirmarCobro" class="btn-primary" onclick="confirmarCobro()">Confirmar Cobro</button>
			</div>
	  </div>
	</div>

    <!-- MODAL: Cobro por Cliente (CxC) -->
    <div id="modalCobroClienteBackdrop" class="modal-backdrop" style="display:none;">
      <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalCobroClienteTitulo">
        <div class="modal-header">
          <h3 id="modalCobroClienteTitulo">Cobrar cuenta</h3>
          <button class="modal-close" onclick="cerrarModalCobroCliente()" aria-label="Cerrar">‚úñ</button>
        </div>

		<!-- Dentro de #modalCobroClienteBackdrop .modal-body -->
		<div class="input-field" style="margin-top:10px;">
			<label for="negocioCobroCliente">Negocios en los que debe (opcional):</label>
			<select id="negocioCobroCliente"></select>
		</div>

        <div class="modal-body">
          <p><strong>Cliente:</strong> <span id="cxcClienteNombre"></span></p>
          <p><strong>Total por cobrar:</strong> <span id="cxcClienteDeuda">$0</span></p>
          <hr>

          <div class="modal-radio">
            <label class="radio-item">
              <input type="radio" name="tipoCobroCliente" value="total" checked onclick="toggleMontoParcial(false)">
              <span>Pago total</span>
            </label>
            <label class="radio-item">
              <input type="radio" name="tipoCobroCliente" value="parcial" onclick="toggleMontoParcial(true)">
              <span>Pago parcial</span>
            </label>
          </div>

          <div id="montoParcialWrap" class="input-field" style="display:none; margin-top:10px;">
            <label for="montoParcial">Monto a cobrar (COP):</label>
            <input type="number" id="montoParcial" min="1" step="1" placeholder="Ej: 20000">
            <small style="color:#666;">No puede exceder el total por cobrar.</small>
          </div>

          <div class="payment-options" style="margin-top:12px;">
            <label class="payment-radio">
              <input type="radio" name="metodoCobroCliente" value="Efectivo" checked>
              <div class="radio-content">
                <span class="icon">üíµ</span><span class="text">Efectivo</span>
              </div>
            </label>

            <label class="payment-radio">
              <input type="radio" name="metodoCobroCliente" value="Nequi">
              <div class="radio-content">
                <span class="icon">üì±</span><span class="text">Nequi</span>
              </div>
            </label>
          </div>

          <div id="modalCobroClienteError" class="error-message" style="display:none;"></div>
        </div>

        <div class="modal-footer">
          <button class="btn-secondary" onclick="cerrarModalCobroCliente()">Cancelar</button>
          <button class="btn-primary" onclick="confirmarCobroCliente()">Confirmar cobro</button>
        </div>
      </div>
    </div>
	
	<!-- MODAL Verificaci√≥n de credenciales para eliminar producto personalizado -->
	<div id="modalCredencialesBackdrop" class="modal-backdrop" style="display:none;">
		<div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalCredencialesTitulo">
			<div class="modal-header">
				<h3 id="modalCredencialesTitulo">Confirmar con contrase√±a</h3>
				<button class="modal-close" onclick="cerrarModalCredenciales()" aria-label="Cerrar">‚úñ</button>
			</div>
			<div class="modal-body">
				<p style="color:#555;margin-bottom:12px;">
					Por seguridad, ingresa tu contrase√±a para eliminar este producto.
				</p>

				<!-- Si quieres pedir tambi√©n correo, descomenta:
				<div class="input-field" style="margin-bottom:10px;">
					<label for="credEmail">Correo:</label>
					<input type="email" id="credEmail" placeholder="tu@correo.com">
				</div>
				-->

				<div class="input-field">
					<label for="credPassword">Contrase√±a:</label>
					<input type="password" id="credPassword" placeholder="********">
				</div>

				<div id="credError" class="error-message" style="display:none;"></div>
			</div>
			<div class="modal-footer">
				<button class="btn-secondary" onclick="cerrarModalCredenciales()">Cancelar</button>
				<button class="btn-primary" onclick="confirmarCredenciales()">Confirmar</button>
			</div>
		</div>
	</div>
    <script>
	
		// ==== MAPA DE NOMBRES ====
		const nombresNegocios = {
			Negocio1: "Negocio Fritos",
			Negocio2: "Negocio Almuerzos",
			Negocio3: "Negocio Licorer√≠a",
			Negocio4: "Negocio Comidas R√°pidas"
		};
		
		// üîµ SALDO INICIAL FIJO POR NEGOCIO
		const saldoInicial = {
			Negocio1: { efectivo: 310000, nequi: 0 },
			Negocio2: { efectivo: 250000, nequi: 0 },
			Negocio3: { efectivo: 0, nequi: 746000 },
			Negocio4: { efectivo: 0, nequi: 150000 }
		};
		
		// üîµ PRODUCTOS POR NEGOCIO
		const productos = {

		  Negocio1: [ // Fritos
			{ nombre: "Arepa de huevo", precio: 3000 },
			{ nombre: "Patacones", precio: 3000 },
			{ nombre: "Deditos", precio: 1500 },
			{ nombre: "Papa carne", precio: 2000 },
			{ nombre: "Papa pollo", precio: 2000 },
			{ nombre: "Empanada carne", precio: 2000 },
			{ nombre: "Empanada pollo", precio: 2000 },
			{ nombre: "Cariba√±olas", precio: 2000 }
		  ],

		  Negocio2: [ // Almuerzos
			{ nombre: "Corriente", precio: 15000 },
			{ nombre: "Mojarra", precio: 25000 },
			{ nombre: "Sopa 8k", precio: 8000 },
			{ nombre: "Sopa 10k", precio: 10000 },
			{ nombre: "Sopa 13k", precio: 13000 }
		  ],

		  Negocio3: [ // Licorer√≠a
			{ nombre: "Coste√±ita x38", precio: 85000 },
			{ nombre: "Coste√±ita peque√±a", precio: 3000 },
			{ nombre: "Coste√±a", precio: 4000 },
			{ nombre: "√Åguila negra peque√±a", precio: 4000 },
			{ nombre: "√Åguila negra grande", precio: 7000 },
			{ nombre: "Gaseosa personal", precio: 2000 }
		  ],

		  Negocio4: [] // Comidas r√°pidas (por ahora manual)
		};
		
		// === Formateador COP (sin decimales) ===
		const COP = (n) => new Intl.NumberFormat('es-CO', {
		  style: 'currency',
		  currency: 'COP',
		  minimumFractionDigits: 0,
		  maximumFractionDigits: 0
		}).format(Number(n) || 0);

		// ===== Cach√© en memoria (TTL sencillo) =====
		const __cache = new Map(); // key -> { data, ts }
		const CACHE_TTL_MS = 60 * 1000; // 60s; ajusta si quieres

		function setCache(key, data){
			__cache.set(key, { data, ts: Date.now() });
		}
		function getCache(key){
			const hit = __cache.get(key);
			if (!hit) return null;
			if (Date.now() - hit.ts > CACHE_TTL_MS) { __cache.delete(key); return null; }
			return hit.data;
		}
		function invalidateCacheByPrefix(prefix){
			for (const k of __cache.keys()){
				if (k.startsWith(prefix)) __cache.delete(k);
			}
		}
		/**
		 * Llamar SIEMPRE tras guardar/cobrar.
		 * fechaAfectada: 'YYYY-MM-DD' (la fecha de la transacci√≥n/pago)
		 */
		async function refreshAfterSave(fechaAfectada) {
			try {
				// 1) Invalidar cach√©s del modelo TX
				if (fechaAfectada) {
				invalidateCacheByPrefix(`txDia:${fechaAfectada}:`);
				}
				invalidateCacheByPrefix('txRng:');
				invalidateCacheByPrefix('txCxc:');

				// (Opcional) si a√∫n quedan vistas legacy en QA:
				// invalidateCacheByPrefix(`dia:${fechaAfectada}:`);
				// invalidateCacheByPrefix('rng:');
				// invalidateCacheByPrefix('cxc:');

				// 2) Refrescar √∫nicamente la pesta√±a activa
				const activeTab = document.querySelector('.content.active')?.id;
				if (activeTab === 'resumen')        await actualizarResumen();
				else if (activeTab === 'metodos')   await actualizarAnalisisPagos();
				else if (activeTab === 'acumulado') await actualizarAcumulado();
				// 'informes' recalcula cuando el usuario previsualiza/exporta
			} catch (e) {
				console.warn('refreshAfterSave() warning:', e);
			}
		}

		/**
		* Inserta/reemplaza una transacci√≥n actualizada en las entradas de cach√©
		* relevantes: txDia:<fecha>:*, txRng:<desde>:<hasta>:*, txCxc:*
		*/
		function patchTxInCaches(tx) {
			if (!tx || !tx.id || !tx.fecha || !tx.negocio) return;

			// Obtener la clave de negocio (Negocio1..4) a partir del nombre visible
			const negocioKey = Object.entries(nombresNegocios)
				.find(([, nombre]) => nombre === tx.negocio)?.[0];

			if (!negocioKey) return;

			// Reemplazo gen√©rico dentro del diccionario {Negocio1:[],...}
			function replaceInDict(dict) {
				if (!dict || !dict[negocioKey]) return;
				const arr = dict[negocioKey];
				const i = arr.findIndex(x => x.id === tx.id);
				if (i >= 0) arr[i] = tx; else arr.push(tx);
			}

			for (const k of __cache.keys()) {
				// D√≠a
				if (k.startsWith(`txDia:${tx.fecha}:`)) {
				const data = getCache(k);
				replaceInDict(data);
				setCache(k, data);
				}
				// Rango (best effort por fecha dentro del rango)
				if (k.startsWith('txRng:')) {
				const [, desde, hasta] = k.split(':'); // txRng:<desde>:<hasta>:<negocioSel>
				if (tx.fecha >= desde && tx.fecha <= hasta) {
					const data = getCache(k);
					replaceInDict(data);
					setCache(k, data);
				}
				}
				// CxC: si qued√≥ Pagado o pendiente=0 => remover; si sigue Debe => reemplazar
				if (k.startsWith('txCxc:')) {
				const data = getCache(k);
				if (!data || !data[negocioKey]) continue;
				const pend = Number(tx?.totales?.pendiente || 0);
				if (tx.estadoPago !== 'Debe' || pend <= 0) {
					data[negocioKey] = data[negocioKey].filter(x => x.id !== tx.id);
				} else {
					const j = data[negocioKey].findIndex(x => x.id === tx.id);
					if (j >= 0) data[negocioKey][j] = tx; else data[negocioKey].push(tx);
				}
				setCache(k, data);
				}
			}
		}

        /* =========================
          Cat√°logos personalizados
          ========================= */

        // Clave de almacenamiento local
        const CATALOGOS_KEY = 'catalogos';

        // Carga el objeto completo { Negocio1: [...], Negocio2: [...], ... }
        function loadCatalogos() {
          try { return JSON.parse(localStorage.getItem(CATALOGOS_KEY) || '{}'); }
          catch { return {}; }
        }

        // Guarda el objeto completo
        function saveCatalogos(obj) {
          localStorage.setItem(CATALOGOS_KEY, JSON.stringify(obj));
        }

        // Obtiene el array del negocio (si no existe, []), solo personalizados
        function getCatalogoPersonalizado(negocioKey) {
          const all = loadCatalogos();
          return Array.isArray(all[negocioKey]) ? all[negocioKey] : [];
        }

        // Reemplaza la lista combinada que se usa para vender: BASE + PERSONALIZADOS
        function getCatalogoCombinado(negocioKey) {
          const base = Array.isArray(productos[negocioKey]) ? productos[negocioKey] : [];
          const custom = getCatalogoPersonalizado(negocioKey);
          // Concatenamos ambos cat√°logos (si quieres deduplicar por nombre, te lo dejo luego)
          return [...base, ...custom];
        }

        // Agrega producto al negocio desde Configuraci√≥n
        function cfgAgregarProducto() {
			const negocioKey = document.getElementById('cfgNegocio').value;
			const nombre = (document.getElementById('cfgNombreProd').value || '').trim();
			const precio = parseInt(document.getElementById('cfgPrecioProd').value, 10) || 0;

			if (!nombre) { mostrarError('Escribe el nombre del producto.'); return; }
			if (precio <= 0) { mostrarError('Escribe un precio v√°lido mayor a 0.'); return; }

			dbAgregarProducto(negocioKey, nombre, precio)
				.then(async () => {
				// Limpiar inputs
				document.getElementById('cfgNombreProd').value = '';
				document.getElementById('cfgPrecioProd').value = '';

				// Si estoy en ese negocio en "Entrada de Datos", refrescar selector
				try {
					if (document.getElementById('business').value === negocioKey) {
					await fetchPersonalizadosDB(negocioKey); // refresca cache
					await cargarProductos();
					}
				} catch (e) {}
				renderCatalogoUI();
				mostrarExito();
				})
				.catch(e => {
				console.error(e);
				mostrarError('No se pudo guardar el producto en la nube.');
			});
		}

		function abrirModalCredenciales() {
			const err = document.getElementById('credError');
			if (err) { err.style.display = 'none'; err.textContent = ''; }
			// Si pides correo, puedes precargar el del usuario actual:
			// const user = window.auth?.currentUser;
			// if (user) document.getElementById('credEmail').value = user.email || '';
			document.getElementById('credPassword').value = '';
			document.getElementById('modalCredencialesBackdrop').style.display = 'flex';
		}

		function cerrarModalCredenciales() {
			document.getElementById('modalCredencialesBackdrop').style.display = 'none';
		}

		let __credBusy = false;

		function setCredBusy(state) {
			__credBusy = !!state;
			const btn = document.querySelector('#modalCredencialesBackdrop .btn-primary');
			if (btn) btn.disabled = !!state;
		}

		async function confirmarCredenciales() {
			if (__credBusy) return;
			setCredBusy(true);

			const err = document.getElementById('credError');
			const passEl = document.getElementById('credPassword');

			// Helper para mostrar error y (opcionalmente) limpiar password
			const showError = (msg, { clearPwd = false, focusPwd = false, shake = false } = {}) => {
				if (err) {
					err.textContent = msg;
					err.style.display = 'block';
				}
				if (clearPwd && passEl) passEl.value = '';
				if (focusPwd && passEl) passEl.focus();
				if (shake && passEl) {
					passEl.classList.add('input-shake');
					setTimeout(() => passEl.classList.remove('input-shake'), 300);
				}
			};

			try {
				// Validaciones de entorno/sesi√≥n
				if (!window.auth) {
					showError('No se pudo acceder a la sesi√≥n actual.');
					return;
				}

				const user = window.auth.currentUser;
				if (!user) {
					showError('No hay sesi√≥n activa. Inicia sesi√≥n nuevamente.');
					setTimeout(() => { window.location.href = 'login.html'; }, 1200);
					return;
				}

				const email = user.email;
				const password = (passEl?.value || '');

				if (!password) {
					showError('Ingresa tu contrase√±a.');
					if (passEl) passEl.focus();
					return;
				}

				// Reautenticaci√≥n
				const cred = window.EmailAuthProvider.credential(email, password);
				await window.reauthenticateWithCredential(user, cred);

				// OK ‚Üí eliminar
				await __eliminarProductoPersonalizadoConfirmado();

				cerrarModalCredenciales();
				mostrarExito();

			} catch (e) {
				console.error(e);
				// Error de credenciales: feedback + cooldown del bot√≥n
				showError('Credenciales inv√°lidas. Intenta nuevamente.', { clearPwd: true, focusPwd: true, shake: true });

				const btn = document.querySelector('#modalCredencialesBackdrop .btn-primary');
				if (btn) {
					btn.disabled = true;
					setTimeout(() => { btn.disabled = false; }, 1000);
				}

			} finally {
				// IMPORTANTE: liberar busy salvo que el bot√≥n est√© en cooldown por error.
				// Si quieres que __credBusy se libere incluso en cooldown, deja solo setCredBusy(false).
				setCredBusy(false);
			}
		}

		// (Opcional) Limpia mensaje de error cuando el usuario empieza a tipear.
		document.getElementById('credPassword')?.addEventListener('input', () => {
		const err = document.getElementById('credError');
		if (err && err.style.display !== 'none') {
			err.style.display = 'none';
			err.textContent = '';
		}
		});

		// (Opcional) Confirmar con Enter en el input de password:
		document.getElementById('credPassword')?.addEventListener('keydown', (ev) => {
		if (ev.key === 'Enter') confirmarCredenciales();
		});

		async function __eliminarProductoPersonalizadoConfirmado() {
			if (!__pendingDeleteDocId || !__pendingDeleteNegocioKey) return;
			
			await dbEliminarProducto(__pendingDeleteDocId, __pendingDeleteNegocioKey);
			// Guardamos para usarlo luego de refrescar UI
			const negocioKeyUsado = __pendingDeleteNegocioKey;

			// Limpiar estado
			__pendingDeleteDocId = null;
			__pendingDeleteNegocioKey = null;

			// Refrescar UI (configuraci√≥n y, si aplica, selector en Entrada)
			renderCatalogoUI();
			try {
				if (document.getElementById('business').value === negocioKeyUsado) {
				await cargarProductos();
				}
			} catch (e) {}
		}

        // Estado temporal a nivel de archivo para saber qu√© borrar tras verificar
		let __pendingDeleteDocId = null;
		let __pendingDeleteNegocioKey = null;

		function cfgEliminarProducto(docId) {
			const negocioKey = document.getElementById('cfgNegocio').value;

			// Guardar intenci√≥n de borrado
			__pendingDeleteDocId = docId;
			__pendingDeleteNegocioKey = negocioKey;

			// Abrir modal para pedir contrase√±a
			abrirModalCredenciales();
		}

        // Renderiza la tabla de productos personalizados del negocio seleccionado
        async function renderCatalogoUI() {
			const wrap = document.getElementById('cfgTablaWrap');
			if (!wrap) return;

			const negocioKey = document.getElementById('cfgNegocio')?.value || 'Negocio1';
			// Lee de DB y actualiza cache
			const personalizados = await fetchPersonalizadosDB(negocioKey);

			if (!personalizados.length) {
				wrap.innerHTML = '<p style="color:#999;">Este negocio no tiene productos personalizados.</p>';
				return;
			}

			let rows = '';
			personalizados.forEach((p) => {
				rows += `
				<tr>
					<td>${p.nombre}</td>
					<td style="text-align:right;">${COP(p.precio)}</td>
					<td style="text-align:center;">
					<button class="btn-danger" type="button" onclick="cfgEliminarProducto('${p.id}')">Eliminar</button>
					</td>
				</tr>
				`;
			});

			wrap.innerHTML = `
				<table>
				<thead>
					<tr>
					<th>Producto (personalizado)</th>
					<th style="width:180px;">Precio</th>
					<th style="width:140px;">Acciones</th>
					</tr>
				</thead>
				<tbody>${rows}</tbody>
				</table>
			`;
		}
				
		// ======= üîó Helpers para DB de Cat√°logos Personalizados =======

		// Cache en memoria para evitar consultas repetidas
		const __catalogoCache = {}; // { NegocioX: [{id, negocioKey, nombre, precio, ownerUid, createdAt}, ...] }
		let catalogoActual = [];    // Combinado (base + personalizados) del negocio actualmente seleccionado

		// Espera a que haya usuario autenticado (necesario para guardar por ownerUid)
		async function waitForAuthUser() {
			while (!(window.auth && window.auth.currentUser)) {
			await new Promise(r => setTimeout(r, 50));
			}
		}

		// Lee productos personalizados desde Firestore por negocio actual y usuario
		async function fetchPersonalizadosDB(negocioKey) {
			try {
			await waitForAuthUser();
			const uid = window.auth.currentUser?.uid;
			if (!uid) return [];

			// query(collection(db,'catalogos'), where('ownerUid','==',uid), where('negocioKey','==',negocioKey))
			const q = window.query(
				window.collection(window.db, 'catalogos'),
				window.where('ownerUid', '==', uid),
				window.where('negocioKey', '==', negocioKey)
			);

			const snap = await window.getDocs(q);
			const items = [];
			snap.forEach(d => items.push({ id: d.id, ...d.data() }));

			// Cache en memoria
			__catalogoCache[negocioKey] = items;
			return items;
			} catch (e) {
			console.warn('No se pudo leer cat√°logo personalizado desde DB. Uso fallback vac√≠o.', e);
			return [];
			}
		}

		// Devuelve el cat√°logo COMBINADO (base + personalizados desde DB)
		async function getCatalogoCombinadoAsync(negocioKey) {
			const base = Array.isArray(productos[negocioKey]) ? productos[negocioKey] : [];
			const personalizados = Array.isArray(__catalogoCache[negocioKey])
			? __catalogoCache[negocioKey]
			: await fetchPersonalizadosDB(negocioKey);

			// Combina: mapeamos los personalizados al mismo shape {nombre, precio}
			const personalizadosMapeados = personalizados.map(p => ({ nombre: p.nombre, precio: Number(p.precio) || 0 }));
			return [...base, ...personalizadosMapeados];
		}

		// Crea un producto personalizado en Firestore
		async function dbAgregarProducto(negocioKey, nombre, precio) {
			await waitForAuthUser();
			const uid = window.auth.currentUser?.uid;
			if (!uid) throw new Error('No hay usuario autenticado');

			await window.addDoc(window.collection(window.db, 'catalogos'), {
			ownerUid: uid,
			negocioKey,
			nombre,
			precio: Number(precio) || 0,
			createdAt: new Date()
			});

			// Invalida/actualiza cache
			await fetchPersonalizadosDB(negocioKey);
		}

		// Elimina un producto personalizado de Firestore (por docId)
		async function dbEliminarProducto(docId, negocioKey) {
			await window.deleteDoc(window.doc(window.db, 'catalogos', docId));
			// Refrescar cache
			await fetchPersonalizadosDB(negocioKey);
		}

		// Migraci√≥n 1 sola vez: si NO hay docs en la DB para el usuario, sube los que existan en localStorage
		/*async function migrarCatalogosLocalesALaDB() {
			try {
			await waitForAuthUser();
			const uid = window.auth.currentUser?.uid;
			if (!uid) return;

			// ¬øEl usuario ya tiene cat√°logo en la nube?
			const q = window.query(
				window.collection(window.db, 'catalogos'),
				window.where('ownerUid', '==', uid)
			);
			const snap = await window.getDocs(q);
			if (!snap.empty) return; // Ya hay data, no migrar

			const all = loadCatalogos(); // {Negocio1: [{nombre,precio}, ...], ...}
			const ops = [];
			for (const [negocioKey, arr] of Object.entries(all)) {
				(arr || []).forEach(p => {
				ops.push(
					window.addDoc(window.collection(window.db, 'catalogos'), {
					ownerUid: uid,
					negocioKey,
					nombre: p.nombre,
					precio: Number(p.precio) || 0,
					createdAt: new Date()
					})
				);
				});
			}
			if (ops.length > 0) {
				await Promise.all(ops);
				// limpia local ya que migramos
				localStorage.removeItem(CATALOGOS_KEY);
				console.log('Cat√°logo personalizado migrado a Firestore.');
			}
			} catch (e) {
			console.warn('Fallo migraci√≥n de cat√°logo local a DB (se intentar√° m√°s tarde):', e);
			}
		}*/

		// ====== CARGAR PRODUCTOS AUTOM√ÅTICAMENTE (desde DB) ======
		async function cargarProductos() {
			const negocio = document.getElementById("business").value;
			const select = document.getElementById("productoSelect");
			const precioWrap = document.getElementById("precioPersonalizadoWrap");
			const precioInput = document.getElementById("precioPersonalizado");

			select.innerHTML = "";

			// ‚¨áÔ∏è ahora viene de Firestore + base:
			catalogoActual = await getCatalogoCombinadoAsync(negocio);

			if (!catalogoActual || catalogoActual.length === 0) {
			const opt = document.createElement("option");
			opt.value = "manual";
			opt.textContent = "Venta Manual";
			select.appendChild(opt);
			document.getElementById("totalVentaPreview").textContent = "$0";
			precioWrap.style.display = "none";
			precioInput.value = "";
			return;
			}

			catalogoActual.forEach((p, index) => {
			const option = document.createElement("option");
			option.value = index; // √≠ndice dentro del combinado
			option.textContent = `${p.nombre} - $${p.precio}`;
			select.appendChild(option);
			});

			// Mostrar/ocultar extras seg√∫n producto
			const idx = parseInt(select.value, 10);
			const prod = catalogoActual[idx];

			// Mojarra (solo Negocio2)
			if (negocio === "Negocio2" && prod && prod.nombre.toLowerCase().includes("mojarra")) {
			precioWrap.style.display = "block";
			} else {
			precioWrap.style.display = "none";
			precioInput.value = "";
			}

			// Tipo de corriente (solo Negocio2)
			const tipoCorrienteWrap = document.getElementById("tipoCorrienteWrap");
			const tipoCorrienteInput = document.getElementById("tipoCorriente");
			if (negocio === "Negocio2" && prod && prod.nombre.toLowerCase().includes("corriente")) {
			tipoCorrienteWrap.style.display = "block";
			} else {
			tipoCorrienteWrap.style.display = "none";
			if (tipoCorrienteInput) tipoCorrienteInput.value = "";
			}

			calcularTotalVenta();
		}

		// ====== CALCULAR TOTAL (incluye precio personalizado para Mojarra y Tipo de corriente - usando catalogoActual) ======
        function calcularTotalVenta() {
			const negocio = document.getElementById("business").value;
			const select = document.getElementById("productoSelect");
			const index = select.value;
			const cantidad = parseInt(document.getElementById("cantidad").value, 10) || 0;

			const precioWrap = document.getElementById("precioPersonalizadoWrap");
			const precioInput = document.getElementById("precioPersonalizado");

			const catalogo = catalogoActual; // ya cargado

			if (index === 'manual' || !catalogo || !catalogo[index]) {
			document.getElementById("totalVentaPreview").textContent = "$0";
			return;
			}

			const prod = catalogo[index];
			let precioUnitario = prod.precio || 0;

			// Mojarra personalizada (> 25.000) solo Negocio2
			if (negocio === "Negocio2" && prod && prod.nombre.toLowerCase().includes("mojarra")) {
			precioWrap.style.display = "block";
			const personalizado = parseInt(precioInput.value, 10);
			if (!isNaN(personalizado) && personalizado > 25000) {
				precioUnitario = personalizado;
			}
			} else {
			precioWrap.style.display = "none";
			if (precioInput) precioInput.value = "";
			}

			// Tipo de corriente (solo Negocio2)
			const tipoCorrienteWrap = document.getElementById("tipoCorrienteWrap");
			const tipoCorrienteInput = document.getElementById("tipoCorriente");
			if (negocio === "Negocio2" && prod && prod.nombre.toLowerCase().includes("corriente")) {
			tipoCorrienteWrap.style.display = "block";
			} else {
			tipoCorrienteWrap.style.display = "none";
			if (tipoCorrienteInput) tipoCorrienteInput.value = "";
			}

			const total = precioUnitario * (cantidad || 1);
			document.getElementById("totalVentaPreview").textContent = COP(total);
		}

        // Inicializar localStorage
        function inicializarSistema() {
            if (!localStorage.getItem('contabilidad')) {
                const datosInicial = {
                    Negocio1: [],
                    Negocio2: [],
                    Negocio3: [],
                    Negocio4: []
                };
                localStorage.setItem('contabilidad', JSON.stringify(datosInicial));
            }
            setFechaActual();
            actualizarTotalRegistros();
			cargarProductos();
			updateGastoInputsState();
        }

		async function fetchTxPorRango(desdeISO, hastaISO, negocioSel='Todos'){
			const cacheKey = `rng:${desdeISO}:${hastaISO}:${negocioSel}`;
			const hit = getCache(cacheKey);
			if (hit) return hit;

			const datos = { Negocio1: [], Negocio2: [], Negocio3: [], Negocio4: [] };
			const negocios = (negocioSel==='Todos') ? Object.keys(nombresNegocios) : [negocioSel];

			for (const neg of negocios){
				const nombre = nombresNegocios[neg] || neg;
				const qRef = window.query(
				window.collection(window.db, 'registros'),
				window.where('negocio','==', nombre),
				window.where('fecha','>=', desdeISO),
				window.where('fecha','<=', hastaISO)
				);
				const snap = await window.getDocs(qRef);
				snap.forEach(d => datos[neg].push({ id: d.id, ...d.data() }));
			}
			setCache(cacheKey, datos);
			return datos;
		}

		/*async function fetchDeudas(negocioSel='Todos', {desdeISO=null, hastaISO=null, cliente=null} = {}){
			const keyRango = `${desdeISO||''}-${hastaISO||''}`;
			const cacheKey = `cxc:${negocioSel}:${keyRango}:${cliente || ''}`;
			const hit = getCache(cacheKey);
			if (hit) return hit;

			const datos = { Negocio1: [], Negocio2: [], Negocio3: [], Negocio4: [] };
			const negocios = (negocioSel==='Todos') ? Object.keys(nombresNegocios) : [negocioSel];

			for (const neg of negocios){
				const nombre = nombresNegocios[neg] || neg;
				let qArgs = [
				window.collection(window.db, 'registros'),
				window.where('negocio','==', nombre),
				window.where('estadoPago','==','Debe'),
				];
				if (cliente && cliente.trim()) {
					qArgs.push(window.where('cliente','==', cliente.trim()));
				}
				if (desdeISO) qArgs.push(window.where('fecha','>=', desdeISO));
				if (hastaISO) qArgs.push(window.where('fecha','<=', hastaISO));

				const qRef = window.query(...qArgs);
				const snap = await window.getDocs(qRef);
				snap.forEach(d => datos[neg].push({ id: d.id, ...d.data() }));
			}
			setCache(cacheKey, datos);
			return datos;
		}*/

		// POR D√çA (transacciones)
		async function fetchPorDiaTx(fechaISO, negocioSel='Todos') {
			await waitForFirebaseReady(); // üëà aseg√∫rate de tener esta funci√≥n ya declarada
			const cacheKey = `txDia:${fechaISO}:${negocioSel}`;
			const hit = getCache(cacheKey);
			if (hit) return hit;

			const datos = { Negocio1: [], Negocio2: [], Negocio3: [], Negocio4: [] };
			const negocios = (negocioSel==='Todos') ? Object.keys(nombresNegocios) : [negocioSel];

			for (const neg of negocios) {
				const nombre = nombresNegocios[neg] ?? neg;
				const qRef = window.query(
				window.collection(window.db, 'transacciones'),
				window.where('fecha','==', fechaISO),
				window.where('negocio','==', nombre)
				);
				const snap = await window.getDocs(qRef);
				snap.forEach(d => datos[neg].push({ id: d.id, ...d.data() }));
			}
			setCache(cacheKey, datos);
			return datos;
		}

		// POR RANGO (transacciones)
		async function fetchTxPorRango(desdeISO, hastaISO, negocioSel='Todos') {
			await waitForFirebaseReady();
			const cacheKey = `txRng:${desdeISO}:${hastaISO}:${negocioSel}`;
			const hit = getCache(cacheKey);
			if (hit) return hit;

			const datos = { Negocio1: [], Negocio2: [], Negocio3: [], Negocio4: [] };
			const negocios = (negocioSel==='Todos') ? Object.keys(nombresNegocios) : [negocioSel];

			for (const neg of negocios) {
				const nombre = nombresNegocios[neg] ?? neg;
				const qRef = window.query(
				window.collection(window.db, 'transacciones'),
				window.where('negocio','==', nombre),
				window.where('fecha','>=', desdeISO),
				window.where('fecha','<=', hastaISO)
				);
				const snap = await window.getDocs(qRef);
				snap.forEach(d => datos[neg].push({ id: d.id, ...d.data() }));
			}
			setCache(cacheKey, datos);
			return datos;
		}

		// DEUDAS (transacciones)
		async function fetchDeudasTx(negocioSel='Todos', {desdeISO=null, hastaISO=null, cliente=null} = {}) {
			await waitForFirebaseReady();
			const keyRango = `${desdeISO ?? ''}-${hastaISO ?? ''}`;
			const cacheKey = `txCxc:${negocioSel}:${keyRango}:${cliente ?? ''}`;
			const hit = getCache(cacheKey);
			if (hit) return hit;

			const datos = { Negocio1: [], Negocio2: [], Negocio3: [], Negocio4: [] };
			const negocios = (negocioSel==='Todos') ? Object.keys(nombresNegocios) : [negocioSel];

			for (const neg of negocios) {
				const nombre = nombresNegocios[neg] ?? neg;
				const args = [
				window.collection(window.db,'transacciones'),
				window.where('negocio','==', nombre),
				window.where('estadoPago','==','Debe')
				];
				if (cliente && cliente.trim()) args.push(window.where('cliente','==', cliente.trim()));
				if (desdeISO) args.push(window.where('fecha','>=', desdeISO));
				if (hastaISO) args.push(window.where('fecha','<=', hastaISO));
				const qRef = window.query(...args);
				const snap = await window.getDocs(qRef);
				snap.forEach(d => datos[neg].push({ id: d.id, ...d.data() }));
			}
			setCache(cacheKey, datos);
			return datos;
		}
		
		// === Helper: fecha local en formato YYYY-MM-DD (sin UTC) ===
		function hoyLocalISO() {
		  const d = new Date();
		  const y = d.getFullYear();
		  const m = String(d.getMonth() + 1).padStart(2, '0');
		  const day = String(d.getDate()).padStart(2, '0');
		  return `${y}-${m}-${day}`;
		}

        // Establecer fecha actual
        function setFechaActual() {
		  const hoy = hoyLocalISO();
		  document.getElementById('fecha').value = hoy;
		  document.getElementById('fechaFiltro').value = hoy;
		}

		function esPagoInicialEquivalente(p, t) {
			// Detecta el patr√≥n del "pago inicial = total de la venta" (sin flag 'origen')
			const ventasBrutas = Number(t?.totales?.ventasBrutas ?? 0);
			if (!ventasBrutas) return false;
			const m = Number(p?.monto ?? 0);
			const pa = Number(p?.pendienteAntes ?? 0);
			const pd = Number(p?.pendienteDespues ?? -1);
			return (p?.tipo === 'total' && m === ventasBrutas && pa === ventasBrutas && pd === 0);
		}

        // Guardar datos: ventas (por carrito) + gasto opcional.
		// - estadoPago: 'pagado' | 'debe' | 'soloGasto'
		// - nombreCliente: string | null
		// - metodoVenta: 'Efectivo' | 'Nequi' | null (solo si 'pagado' y hay carrito)
		// - metodoGasto: 'Efectivo' | 'Nequi' | null (si hay gasto)
		// - soloGasto: true para ignorar carrito y registrar SOLO el gasto
		async function guardarDatos({
			estadoPago = 'pagado', 
			nombreCliente = null, 
			metodoVenta = null, 
			metodoGasto = null, 
			soloGasto = false, 
			horaPedido = null
			} = {}) {

			const negocioKey = document.getElementById('business').value;
			const negocio = nombresNegocios[negocioKey];
			const fecha = document.getElementById('fecha').value;
			const gastos = parseFloat(document.getElementById('gastos').value) || 0;
			let descripcionGasto = (document.getElementById('descripcion').value || '').trim();
			const hayCarrito = carrito.length > 0;
			const hayGasto = gastos > 0;

			if (!fecha) { mostrarError('Debes seleccionar la fecha'); return; }
			if (!hayCarrito && !hayGasto) { mostrarError('Agrega al menos una l√≠nea al pedido o registra un gasto.'); return; }

			const estadoFmt = (estadoPago === 'debe') ? 'Debe'
								: (estadoPago === 'pagado') ? 'Pagado'
								: 'SoloGasto';

			if (estadoFmt === 'Pagado' && hayCarrito && !metodoVenta) {
				mostrarError('Selecciona el m√©todo de pago de la venta.');
				return;
			}
			if (hayGasto && !metodoGasto) {
				mostrarError('Selecciona el m√©todo de pago del gasto.');
				return;
			}
			if (estadoFmt === 'Debe' && hayCarrito && !(nombreCliente && nombreCliente.trim())) {
				mostrarError('Debes ingresar el nombre del cliente que qued√≥ debiendo.');
				return;
			}
			if (estadoFmt === 'SoloGasto' && !hayGasto) {
				mostrarError('Seleccionaste "Solo gasto" pero no hay valor de gasto.');
				return;
			}

			// Construcci√≥n de items y totales
			const items = hayCarrito ? carrito.map(it => ({
				producto: it.producto,
				cantidad: Number(it.cantidad) || 0,
				precioUnitario: Number(it.precioUnitario) || 0,
				total: Number(it.ventas) || 0
			})) : [];

			const ventasBrutas = items.reduce((s, it) => s + (Number(it.total) || 0), 0);
			// üëá Importante: NO crear pago inicial para ventas "Pagado".
			// La entrada a caja de una venta pagada se cuenta por t.metodoVenta en los KPIs.
			const pagos = [];

			const pendiente = (estadoFmt === 'Debe') ? ventasBrutas : 0;

			const gastoObj = hayGasto ? {
				descripcion: descripcionGasto || 'Gasto del d√≠a',
				metodo: metodoGasto,
				monto: gastos
			} : null;

			try {
				const txDoc = {
				negocio,
				fecha,
				horaPedido: horaPedido || null,
				estadoPago: estadoFmt,
				cliente: (estadoFmt === 'Debe') ? (nombreCliente || null) : null,
				metodoVenta: (estadoFmt === 'Pagado' ? metodoVenta : null),
				metodoGasto: hayGasto ? metodoGasto : null,
				items,
				pagos,                 // puede iniciar vac√≠o (Debe) o con 1 pago (Pagado)
				gasto: gastoObj,       // null si no hay gasto
				totales: {
					ventasBrutas,
					gastos: gastos || 0,
					pendiente
				},
				createdAt: new Date(),
				updatedAt: new Date()
				};

				// ‚¨áÔ∏è NUEVA colecci√≥n
				await window.addDoc(window.collection(window.db, "transacciones"), txDoc);

				// Limpieza + UX
				carrito = [];
				renderCarrito();
				document.getElementById('gastos').value = '';
				document.getElementById('descripcion').value = '';
				mostrarExito();

				// Invalida caches y refresca vistas necesarias
				refreshAfterSave(fecha);

				const activeTab = document.querySelector('.content.active')?.id;
				try {
				if (activeTab === 'resumen') await actualizarResumen();
				else if (activeTab === 'metodos') await actualizarAnalisisPagos();
				else if (activeTab === 'acumulado') await actualizarAcumulado();
				} catch (e) {}

			} catch (error) {
				console.error(error);
				mostrarError("Error guardando en la nube");
			}
		}
		
		// ====== CARRITO (pedido en pantalla) ======
		let carrito = []; // {producto, cantidad, precioUnitario, ventas}

		// Render del carrito
		function renderCarrito() {
			const tbody = document.querySelector('#carritoTabla tbody');
			const section = document.getElementById('carritoSection');
			const totalEl = document.getElementById('carritoTotal');

			if (!tbody || !section || !totalEl) return;

			tbody.innerHTML = '';
			let totalPedido = 0;

			carrito.forEach((item, idx) => {
			  const tr = document.createElement('tr');
			  const totalLinea = item.ventas || 0;
			  totalPedido += totalLinea;

			  tr.innerHTML = `
				<td>${item.producto}</td>
				<td>${item.cantidad}</td>
				<td>${COP(item.precioUnitario)}</td>
				<td>${COP(totalLinea)}</td>
				<td><button class="btn-danger" type="button" onclick="quitarLinea(${idx})">‚úñ</button></td>
			  `;
			  tbody.appendChild(tr);
			});

			totalEl.textContent = COP(totalPedido);
			section.style.display = carrito.length > 0 ? 'block' : 'none';
			
			// üëá NUEVO: actualizar el estado de los inputs de gasto
			  updateGastoInputsState();
		}

		// Quitar l√≠nea del carrito
		function quitarLinea(idx) {
		  carrito.splice(idx, 1);
		  renderCarrito();
		}

		// Agregar l√≠nea al carrito
        function agregarAlCarrito() {
          const negocio = document.getElementById('business').value;
          const index = document.getElementById("productoSelect").value;
          const cantidad = parseInt(document.getElementById("cantidad").value, 10) || 0;

          const catalogo = catalogoActual; // ‚Üê ya cargado desde Firestore + base

          if (!catalogo || index === 'manual' || !catalogo[index]) {
            mostrarError('Selecciona un producto del cat√°logo para agregar al pedido.');
            return;
          }
          if (cantidad <= 0) {
            mostrarError('La cantidad debe ser mayor a 0');
            return;
          }

          const prod = catalogo[index];
          let precioUnitario = prod.precio || 0;

          // Mojarra con precio personalizado
          if (negocio === "Negocio2" && prod.nombre.toLowerCase().includes("mojarra")) {
            const personalizado = parseInt(document.getElementById("precioPersonalizado").value, 10);
            if (!isNaN(personalizado) && personalizado > 25000) {
              precioUnitario = personalizado;
            }
          }

          // Corriente: exigir tipo
          let nombreProductoParaLinea = prod.nombre;
          if (negocio === "Negocio2" && prod.nombre.toLowerCase().includes("corriente")) {
            const tipo = (document.getElementById("tipoCorriente").value || "").trim();
            if (!tipo) {
              mostrarError('Debes indicar el tipo de corriente (ej: pollo, res, mixta).');
              return;
            }
            nombreProductoParaLinea = `Corriente (${tipo})`;
          }

          const ventas = precioUnitario * cantidad;

          carrito.push({
            producto: nombreProductoParaLinea,
            cantidad,
            precioUnitario,
            ventas
          });

          document.getElementById('cantidad').value = '1';
          const p = document.getElementById('precioPersonalizado');
          if (p) p.value = '';

          calcularTotalVenta();
          renderCarrito();
        }

		// Vaciar carrito si cambia fecha/negocio (para no mezclar cortes)
		function resetCarritoSiCambiaCorte() {
		  carrito = [];
		  renderCarrito();
		  const tipoCorriente = document.getElementById('tipoCorriente');
		  if (tipoCorriente) tipoCorriente.value = '';
		  const wrap = document.getElementById('tipoCorrienteWrap');
		  if (wrap) wrap.style.display = 'none';
		  updateGastoInputsState();
		}

		// Hookear cambios de fecha y negocio
		document.getElementById('business').addEventListener('change', resetCarritoSiCambiaCorte);
		document.getElementById('fecha').addEventListener('change', resetCarritoSiCambiaCorte);

        // Agrupa l√≠neas del d√≠a por producto para mostrar conteo y total
		function agruparPlatosDesdeTransacciones(transacciones) {
			const mapa = new Map(); // producto -> {cantidadTotal, totalVentas}
			transacciones.forEach(t => {
				const items = Array.isArray(t.items) ? t.items : [];
				items.forEach(it => {
				const key = it.producto || '(sin nombre)';
				const prev = mapa.get(key) || { cantidadTotal: 0, totalVentas: 0 };
				prev.cantidadTotal += Number(it.cantidad||0);
				prev.totalVentas   += Number(it.total||0);
				mapa.set(key, prev);
				});
			});

			if (mapa.size === 0) return '';

			let rows = '';
			mapa.forEach((val, prod) => {
				rows += `
				<tr>
					<td>${prod}</td>
					<td style="text-align:center;">${val.cantidadTotal}</td>
					<td style="text-align:right;">${COP(val.totalVentas)}</td>
				</tr>
				`;
			});

			return `
				<div style="margin-top:10px;">
				<h4>Platos vendidos</h4>
				<table>
					<thead>
					<tr>
						<th>Producto</th>
						<th>Cant.</th>
						<th>Total (COP)</th>
					</tr>
					</thead>
					<tbody>
					${rows}
					</tbody>
				</table>
				</div>
			`;
		}

		function agruparPlatosPorProducto(registros) {
			if (!Array.isArray(registros) || registros.length === 0) return '';
			const mapa = new Map(); // producto -> { cantidad, total }
			registros.forEach(r => {
				if (r.tipo === 'movimiento' && r.producto) {
				const prev = mapa.get(r.producto) ?? { cantidad:0, total:0 };
				prev.cantidad += Number(r.cantidad ?? 0);
				prev.total    += Number(r.ventas   ?? 0);
				mapa.set(r.producto, prev);
				}
			});
			if (mapa.size === 0) return '';
			let rows = '';
			mapa.forEach((v, k) => {
				rows += `
				<tr>
					<td>${k}</td>
					<td style="text-align:center;">${v.cantidad}</td>
					<td style="text-align:right;">${COP(v.total)}</td>
				</tr>
				`;
			});
			return `
				<div style="margin-top:10px;">
				<h4>Platos vendidos</h4>
				<table>
					<thead><tr><th>Producto</th><th>Cant.</th><th>Total (COP)</th></tr></thead>
					<tbody>${rows}</tbody>
				</table>
				</div>
			`;
		}
		
		// === Resumen Diario basado en TRANSACCIONES (robusto) ===
		async function actualizarResumen() {
			const fecha = document.getElementById('fechaFiltro').value;
			const soloDeudas = !!document.getElementById('soloDeudas')?.checked;
			const DEBUG = false;

			const datos = await fetchPorDiaTx(fecha, 'Todos'); // üëà ahora seguro
			const container = document.getElementById('resumenContent');
			let html = '';

			for (const [negocioKey, transacciones] of Object.entries(datos)) {
				const txDelDia = Array.isArray(transacciones) ? transacciones : [];

				let ventasEfectivo = 0, ventasNequi = 0, ventasOtros = 0, totalGastos = 0;
				let ventasBrutasDelDia = 0;

				txDelDia.forEach(t => {
				const vb = Number(t?.totales?.ventasBrutas ?? 0);
				ventasBrutasDelDia += vb; // entregado hoy (Pagado + Debe)

				// Ventas "Pagado" del d√≠a por metodoVenta
				if (t.estadoPago === 'Pagado' && vb > 0 && t.fecha === fecha) {
					const mv = (t.metodoVenta ?? '').toString().trim().toLowerCase();
					if (mv === 'efectivo') ventasEfectivo += vb;
					else if (mv === 'nequi') ventasNequi += vb;
					else ventasOtros += vb;
				}

				// Abonos con fecha del d√≠a
				if (Array.isArray(t.pagos)) {
					t.pagos.forEach(p => {
					if (esPagoInicialEquivalente(p, t)) return;
					if (p.fecha === fecha) {
						const m = Number(p.monto ?? 0);
						const mm = (p.metodo ?? '').toString().trim().toLowerCase();
						if (mm === 'efectivo') ventasEfectivo += m;
						else if (mm === 'nequi') ventasNequi += m;
						else ventasOtros += m;
					}
					});
				}

				// Gastos del d√≠a
				if (t.gasto && Number(t.gasto.monto ?? 0) > 0 && t.fecha === fecha) {
					totalGastos += Number(t.gasto.monto ?? 0);
				}
				});

				const totalVentasCaja = ventasEfectivo + ventasNequi + ventasOtros;
				const balance = totalVentasCaja - totalGastos;

				if (DEBUG) {
				console.group(`Resumen ${nombresNegocios[negocioKey]} - ${fecha}`);
				console.table({ ventasEfectivo, ventasNequi, ventasOtros, totalGastos, totalVentasCaja, ventasBrutasDelDia, transacciones: txDelDia.length });
				console.groupEnd();
				}

				const txParaTabla = soloDeudas
				? txDelDia.filter(t => t.estadoPago === 'Debe' && Number(t?.totales?.pendiente ?? 0) > 0)
				: txDelDia;

				html += `
				<div class="business-section">
					<h4>${nombresNegocios[negocioKey]}</h4>

					<div class="summary-grid">
					<div class="summary-box">
						<h4>Ventas (caja)</h4>
						<div class="value" style="color:#007bff;">${COP(totalVentasCaja)}</div>
					</div>
					<div class="summary-box">
						<h4>Gastos</h4>
						<div class="value" style="color:#dc3545;">-${COP(totalGastos)}</div>
					</div>
					<div class="summary-box" style="border-color:#667eea;background:#f0f4ff;">
						<h4>Balance del D√≠a</h4>
						<div class="value" style="color:#667eea;">${COP(balance)}</div>
					</div>
					</div>

					<div class="summary-card" style="margin-top:8px;">
					<div>Ventas brutas del d√≠a (entregadas): <strong>${COP(ventasBrutasDelDia)}</strong></div>
					</div>

					<hr style="margin:15px 0;">
					<div style="display:flex;justify-content:space-between;gap:20px;flex-wrap:wrap;">
					<div>üíµ <strong>Saldo en Efectivo (hoy):</strong><br>
						<span style="color:#28a745;font-weight:bold;">${COP(ventasEfectivo - totalGastos)}</span>
					</div>
					<div>üì± <strong>Saldo en Nequi (hoy):</strong><br>
						<span style="color:#007bff;font-weight:bold;">${COP(ventasNequi)}</span>
					</div>
					${ventasOtros > 0 ? `
						<div>üí≥ <strong>Otros m√©todos (hoy):</strong><br>
						<span style="color:#6c757d;font-weight:bold;">${COP(ventasOtros)}</span>
						</div>` : ''}
					</div>

					${
					txParaTabla.length > 0
						? `<div class="table-responsive">
							<table class="tabla-registros">
							${generarTablaTransacciones(txParaTabla, { mostrarAcciones: true })}
							</table>
						</div>`
						: '<p style="color:#999;margin-top:15px;">No hay transacciones para esta fecha</p>'
					}

					${agruparPlatosDesdeTransacciones(txDelDia)}
				</div>
				`;
			}

			container.innerHTML = html || '<p>No hay datos</p>';
		}
		
		// === Cuentas por Cobrar (Acumulado) ‚Äî basado en TRANSACCIONES ===
		async function actualizarCuentasPorCobrar() {
			const container = document.getElementById('cxcContent');
			if (!container) return;

			// NUEVO: leer transacciones en 'Debe'
			const datos = await fetchDeudasTx('Todos'); // <-- usa la versi√≥n TX

			const mapaClientes = new Map();
			let totalGeneral = 0;
			let totalVentasPendientes = 0;

			for (const registros of Object.values(datos)) {
				registros.forEach(t => {
				if (t && t.estadoPago === 'Debe') {
					const pendiente = Number(t?.totales?.pendiente ?? 0);
					if (pendiente > 0) {
					const cliente = (t.cliente && String(t.cliente).trim())
						? t.cliente.trim()
						: 'Sin nombre';

					const prev = mapaClientes.get(cliente) || { totalPendiente: 0, cantidadVentas: 0 };
					prev.totalPendiente += pendiente;
					prev.cantidadVentas += 1;
					mapaClientes.set(cliente, prev);

					totalGeneral += pendiente;
					totalVentasPendientes += 1;
					}
				}
				});
			}

			const filas = [...mapaClientes.entries()]
				.sort((a,b) => b[1].totalPendiente - a[1].totalPendiente)
				.map(([cliente, info]) => `
				<tr>
					<td>${cliente}</td>
					<td style="text-align:center;">${info.cantidadVentas}</td>
					<td style="text-align:right;">${COP(info.totalPendiente)}</td>
					<td style="text-align:center;">
					<button class="btn-success" type="button"
							onclick="abrirModalCobroCliente('${cliente.replace(/'/g,"\\'")}', ${info.totalPendiente})">
						Cobrar
					</button>
					</td>
				</tr>
				`).join('');

			const clientesUnicos = mapaClientes.size;

			container.innerHTML = `
				<div class="business-section" style="border-left-color:#dc3545;">
				<h3>üí≥ Cuentas por Cobrar (Acumulado)</h3>
				<div class="summary-grid">
					<div class="summary-box"><h4>Total por Cobrar</h4><div class="value" style="color:#dc3545;">${COP(totalGeneral)}</div></div>
					<div class="summary-box"><h4>Clientes con deuda</h4><div class="value">${clientesUnicos}</div></div>
					<div class="summary-box"><h4>Ventas pendientes</h4><div class="value">${totalVentasPendientes}</div></div>
				</div>
				${
					clientesUnicos > 0
					? `<table>
						<thead><tr>
							<th>Cliente</th>
							<th style="width:140px;"># Ventas</th>
							<th style="width:200px;">Total Pendiente (COP)</th>
							<th style="width:140px;">Acciones</th>
						</tr></thead>
						<tbody>${filas}</tbody>
						</table>`
					: '<p style="color:#28a745;margin-top:10px;">No hay deudas pendientes. ‚úÖ</p>'
				}
				</div>
			`;
		}
		
		//modal por cliente
		let clienteACobrar = null;
		let deudaClienteActual = 0;

		async function abrirModalCobroCliente(cliente, deuda, negocioKey = null) {
		  clienteACobrar = cliente;
		  deudaClienteActual = Number(deuda) || 0;

		  // guarda el filtro de negocio si lo recibes (Negocio1|Negocio2|...)
		  window.filtroNegocioCobroCliente = negocioKey; // puede ser null -> 'Todos'

		  const sel = document.getElementById('negocioCobroCliente');
		  if (sel) {
				try {
					// 1) Traer deudas del cliente en TODOS los negocios (ya filtra por cliente en la query)
					const datos = await fetchDeudasTx('Todos', { cliente: clienteACobrar });
					
					// 2) Determinar en cu√°les negocios hay pendiente > 0 (modelo nuevo: t.totales.pendiente)
					const negociosConDeuda = [];
					for (const [negKey, regs] of Object.entries(datos)) {
						const tiene = regs.some(t => Number(t?.totales?.pendiente ?? 0) > 0);
						if (tiene) negociosConDeuda.push(negKey);
					}

					// 3) Reconstruir las opciones del select
					sel.innerHTML = '';

					if (negociosConDeuda.length === 0) {
						// Caso raro: sin deudas; dejar 'Todos' y deshabilitado
						const opt = document.createElement('option');
						opt.value = '';
						opt.textContent = 'Todos';
						sel.appendChild(opt);
						sel.disabled = true;
						window.filtroNegocioCobroCliente = null;

					} else if (negociosConDeuda.length === 1) {
						// Un solo negocio ‚Üí fijar y bloquear (no hay nada para elegir)
						const only = negociosConDeuda[0];
						const opt = document.createElement('option');
						opt.value = only;
						opt.textContent = nombresNegocios[only] || only;
						sel.appendChild(opt);
						sel.value = only;
						sel.disabled = true;
						window.filtroNegocioCobroCliente = only;

					} else {
						// Varios negocios ‚Üí incluir 'Todos' y HABILITAR el selector
						const optTodos = document.createElement('option');
						optTodos.value = '';
						optTodos.textContent = 'Todos';
						sel.appendChild(optTodos);

						negociosConDeuda.forEach(negKeyIt => {
							const opt = document.createElement('option');
							opt.value = negKeyIt;
							opt.textContent = nombresNegocios[negKeyIt] || negKeyIt;
							sel.appendChild(opt);
						});

						sel.disabled = false;
						sel.value = negocioKey || '';
						window.filtroNegocioCobroCliente = negocioKey || null;

						// üëâ Listener para actualizar el filtro cuando el usuario cambie la selecci√≥n
						sel.onchange = () => {
							const v = sel.value;
							window.filtroNegocioCobroCliente = v ? v : null;
						};

						// üëâ Cada vez que cambie el negocio, recalcula el m√°ximo sugerido del parcial
						sel.onchange = async () => {
							const v = sel.value;
							window.filtroNegocioCobroCliente = v ? v : null;

							// Relee deudas solo para calcular el m√°ximo del campo (sin render pesado)
							try {
								const args = [window.collection(window.db, 'transacciones'), window.where('estadoPago','==','Debe'), window.where('cliente','==', clienteACobrar)];
								if (window.filtroNegocioCobroCliente) {
								args.push(window.where('negocio','==', nombresNegocios[window.filtroNegocioCobroCliente] || window.filtroNegocioCobroCliente));
								}
								const qRef = window.query(...args);
								const snap = await window.getDocs(qRef);
								let max = 0;
								snap.forEach(d => { const x = d.data(); max += Number(x?.totales?.pendiente || 0); });

								const input = document.getElementById('montoParcial');
								if (input) {
								input.max = String(Math.max(0, Math.floor(max)));
								// Si el valor actual excede, aj√∫stalo para evitar error al confirmar
								const val = Number(input.value || 0);
								if (val > max) input.value = String(Math.max(0, Math.floor(max)));
								}
							} catch (e) { /* no bloquear el flujo si falla */ }
						};
					}
				} catch (e) {
						console.warn('No se pudo poblar el selector de negocio por cliente:', e);
						// Si hay error, deja el select como est√© y no bloquees el modal
					}
		   	}

		  document.getElementById('cxcClienteNombre').textContent = clienteACobrar;
		  document.getElementById('cxcClienteDeuda').textContent = COP(deudaClienteActual);

		  document.querySelector('input[name="tipoCobroCliente"][value="total"]').checked = true;
		  toggleMontoParcial(false);
		  const monto = document.getElementById('montoParcial');
		  if (monto) monto.value = '';

		  document.querySelector('input[name="metodoCobroCliente"][value="Efectivo"]').checked = true;

		  const err = document.getElementById('modalCobroClienteError');
		  err.style.display = 'none'; err.textContent = '';

		  document.getElementById('modalCobroClienteBackdrop').style.display = 'flex';
		}

		function cerrarModalCobroCliente() {
		  document.getElementById('modalCobroClienteBackdrop').style.display = 'none';
		  clienteACobrar = null;
		  deudaClienteActual = 0;
		}

		function toggleMontoParcial(show) {
		  const wrap = document.getElementById('montoParcialWrap');
		  if (wrap) wrap.style.display = show ? 'block' : 'none';
		}
		
		function updateModalPagoUI() {
			const estado = document.querySelector('input[name="estadoPago"]:checked')?.value || 'pagado';
			const hayCarrito = (carrito && carrito.length > 0);
			const gastos = parseFloat(document.getElementById('gastos').value) || 0;
			const hayGasto = gastos > 0;

			// Nombre cliente solo si 'Debe' y hay ventas
			const nombreWrap = document.getElementById('nombreClienteWrap');
			if (nombreWrap) nombreWrap.style.display = (estado === 'debe' && hayCarrito) ? 'block' : 'none';

			// M√©todo de pago de la venta solo si 'pagado' y hay ventas
			const ventaWrap = document.getElementById('metodoVentaWrap');
			if (ventaWrap) ventaWrap.style.display = (estado === 'pagado' && hayCarrito) ? 'block' : 'none';

			// M√©todo del gasto si hay gasto (independiente del estado)
			const gastoWrap = document.getElementById('metodoGastoWrap');
			if (gastoWrap) gastoWrap.style.display = hayGasto ? 'block' : 'none';
		}
		
		// === Cobro por cliente: total/parcial con m√©todo ===
		async function confirmarCobroCliente() {
		  const err = document.getElementById('modalCobroClienteError');

		  try {
			if (!clienteACobrar) {
			  err.textContent = '‚úó No hay cliente seleccionado.'; err.style.display = 'block';
			  return;
			}

			const tipo = document.querySelector('input[name="tipoCobroCliente"]:checked')?.value || 'total';
			const metodo = document.querySelector('input[name="metodoCobroCliente"]:checked')?.value || 'Efectivo';

			let montoParcial = 0;
			if (tipo === 'parcial') {
			  montoParcial = parseInt(document.getElementById('montoParcial').value, 10) || 0;
			  if (montoParcial <= 0) {
				err.textContent = '‚úó Ingresa un monto v√°lido para el pago parcial.'; err.style.display = 'block';
				return;
			  }
			  if (montoParcial > deudaClienteActual) {
				err.textContent = '‚úó El monto parcial no puede exceder la deuda total del cliente.'; err.style.display = 'block';
				return;
			  }
			}

			// --- NUEVO: leer de transacciones y actualizar en el mismo doc ---
			const sel = document.getElementById('negocioCobroCliente');
			const negocioFiltro = (sel && sel.value) ? sel.value : (window.filtroNegocioCobroCliente || null);

			// Cargar transacciones 'Debe' del cliente (opcionalmente filtradas por negocio)
			const qArgs = [window.collection(db, 'transacciones'), window.where('estadoPago', '==', 'Debe'), where('cliente', '==', clienteACobrar)];
			if (negocioFiltro) qArgs.push(window.where('negocio','==', nombresNegocios[negocioFiltro] || negocioFiltro));
			const qRef = window.query(...qArgs);
			const snap = await window.getDocs(qRef);

			const deudas = [];
			snap.forEach(d => {
				const x = d.data();
				const pendiente = Number(x?.totales?.pendiente || 0);
				if (pendiente > 0) deudas.push({ id: d.id, ...x, pendiente });
			});

			// Orden FIFO por createdAt/fecha
			deudas.sort((a,b)=>{
			const ta = (a.createdAt && a.createdAt.toMillis) ? a.createdAt.toMillis() : new Date(a.fecha).getTime();
			const tb = (b.createdAt && b.createdAt.toMillis) ? b.createdAt.toMillis() : new Date(b.fecha).getTime();
			return ta - tb;
			});

			// ‚úÖ VALIDACI√ìN CLAVE PARA PARCIALES SEG√öN NEGOCIO FILTRADO
			if (tipo === 'parcial') {
				// Deuda m√°xima v√°lida seg√∫n el filtro actual (si hay filtro, deudas ya viene filtrado por negocio)
				const deudaMaxSegunFiltro = deudas.reduce((s, r) => s + Number(r.pendiente || 0), 0);

				if (montoParcial > deudaMaxSegunFiltro) {
					err.textContent = `‚úó El monto parcial (${COP(montoParcial)}) supera la deuda del negocio seleccionado (${COP(deudaMaxSegunFiltro)}).`;
					err.style.display = 'block';
					return; // üëà No contin√∫es si excede
				}
			}

			if (tipo === 'total') {
				for (const r of deudas) {
					const ref = window.doc(window.db, 'transacciones', r.id);
					const pagosPrev = Array.isArray(r.pagos) ? [...r.pagos] : [];
					const pendienteAntes = Number(r.pendiente || 0);
					if (pendienteAntes <= 0) continue;

					const pago = {
						fecha: hoyLocalISO(),
						metodo,
						monto: pendienteAntes,
						tipo: 'total',
						pendienteAntes,
						pendienteDespues: 0,
						descripcion: `Pago total de la deuda de ${COP(pendienteAntes)} realizado con ${metodo}`,
						ts: new Date().toISOString()
					};

					pagosPrev.push(pago);
					await window.updateDoc(ref, {
						pagos: pagosPrev,
						'totales.pendiente': 0,
						estadoPago: 'Pagado',
						updatedAt: new Date()
					});

					// üîß Parche de cach√© con datos coherentes
					const txActualizada = {
						id: r.id,
						...r,
						pagos: pagosPrev,
						totales: { ...(r.totales || {}), pendiente: 0 },
						estadoPago: 'Pagado',
						updatedAt: new Date()
					};
					patchTxInCaches(txActualizada);
				}
			} else {
				// Pago PARCIAL: distribuir 'montoParcial' por FIFO
				// ... dentro del else { // pago parcial
				let restante = montoParcial;
				for (const r of deudas) {
					if (restante <= 0) break;
					const aplicar = Math.min(restante, Number(r.pendiente || 0));
					const nuevoPend = Number(r.pendiente || 0) - aplicar;

					const ref = window.doc(window.db, 'transacciones', r.id);
					const pagosPrev = Array.isArray(r.pagos) ? [...r.pagos] : [];
					const pago = {
						fecha: hoyLocalISO(),
						metodo,
						monto: aplicar,
						tipo: (nuevoPend > 0 ? 'parcial' : 'total'),
						pendienteAntes: Number(r.pendiente || 0),
						pendienteDespues: nuevoPend,
						descripcion: (nuevoPend > 0)
						? `Pago parcial de ${COP(aplicar)} realizado con ${metodo}`
						: `Pago total de la deuda de ${COP(aplicar)} realizado con ${metodo}`,
						ts: new Date().toISOString()
					};
					pagosPrev.push(pago);

					await window.updateDoc(ref, {
						pagos: pagosPrev,
						'totales.pendiente': nuevoPend,
						estadoPago: (nuevoPend <= 0) ? 'Pagado' : 'Debe',
						updatedAt: new Date()
					});

					// üîß Parche de cach√© con el objeto del loop (r)
					const txActualizada = {
						id: r.id,
						...r,
						pagos: pagosPrev,
						totales: { ...(r.totales || {}), pendiente: nuevoPend },
						estadoPago: (nuevoPend <= 0) ? 'Pagado' : 'Debe',
						updatedAt: new Date()
					};
					patchTxInCaches(txActualizada);

					restante -= aplicar;
				}
			}

			await refreshAfterSave(hoyLocalISO());

			cerrarModalCobroCliente();
			mostrarExito();

			// Refrescar tableros
			try { await actualizarCuentasPorCobrar(); } catch (e) {}
			try { await actualizarResumen(); } catch (e) {}
			try { await actualizarAnalisisPagos(); } catch (e) {}
			try { await actualizarAcumulado(); } catch (e) {}

		  } catch (e) {
			console.error(e);
			err.textContent = '‚úó Error registrando el cobro del cliente. Por favor cierre el modal y vuelva a realizar la operaci√≥n';
			err.style.display = 'block';
		  }
		}
		
        // Actualizar cuentas acumuladas
        async function actualizarAcumulado() {
			const desde = '2000-01-01';
			const hasta = hoyLocalISO();
			const datosTx = await fetchTxPorRango(desde, hasta, 'Todos');
			const container = document.getElementById('acumuladoContent');
			let html = '';

			for (const [negocio, arr] of Object.entries(datosTx)) {
				let totalVentasProductos = 0; // suma de ventasBrutas (items) sin abonos
				let totalGastos = 0;

				let vEf=0, vNq=0, gEf=0, gNq=0;

				(arr ?? []).forEach(t => {
				const vb = Number(t?.totales?.ventasBrutas ?? 0);
				const gm = Number(t?.gasto?.monto ?? 0);

				totalVentasProductos += vb;
				if (gm > 0) totalGastos += gm;

				// Entrada por ventas ‚ÄúPagado‚Äù
				if (t.estadoPago === 'Pagado' && vb > 0) {
					if (t.metodoVenta === 'Efectivo') vEf += vb;
					if (t.metodoVenta === 'Nequi')    vNq += vb;
				}
				// Abonos
				if (Array.isArray(t.pagos)) {
					t.pagos.forEach(p => {
					const m = Number(p.monto ?? 0);
					if (p.metodo === 'Efectivo') vEf += m;
					if (p.metodo === 'Nequi')    vNq += m;
					});
				}
				// Gastos por m√©todo
				if (gm > 0) {
					const mg = t.metodoGasto ?? t.gasto?.metodo ?? null;
					if (mg === 'Efectivo') gEf += gm;
					else if (mg === 'Nequi') gNq += gm;
				}
				});

				const saldoEfectivo = Number(saldoInicial[negocio]?.efectivo ?? 0) + vEf - gEf;
				const saldoNequi    = Number(saldoInicial[negocio]?.nequi ?? 0)    + vNq - gNq;
				const saldoTotal    = saldoEfectivo + saldoNequi;

				html += `
				<div class="summary-box">
					<h4>${nombresNegocios[negocio]}</h4>
					<p><strong>Capital Inicial:</strong> ${COP((saldoInicial[negocio]?.efectivo ?? 0) + (saldoInicial[negocio]?.nequi ?? 0))}</p>
					<p><strong>Ventas Totales:</strong> ${COP(totalVentasProductos)}</p>
					<p><strong>Gastos Totales:</strong> -${COP(totalGastos)}</p>
					<hr>
					<p><strong>Saldo Total Real:</strong> ${COP(saldoTotal)}</p>
					<hr>
					<p>üíµ Saldo Efectivo: ${COP(saldoEfectivo)}</p>
					<p>üì± Saldo Nequi: ${COP(saldoNequi)}</p>
				</div>
				`;
			}
			container.innerHTML = html;
		}

		// === Reemplaza COMPLETAMENTE tu funci√≥n por esta ===
		async function actualizarAnalisisPagos() {
			const negocioFiltro = document.getElementById('negocioFiltro').value;
			const filtroFecha = document.getElementById('filtroFechaPagos').value; // 'fecha' | 'actual'
			const incluirInicial = !!document.getElementById('toggleCapitalInicial')?.checked;
			const container = document.getElementById('analisisPagosContent');
			const fechaPagosContainer = document.getElementById('fechaPagosContainer');

			let desde, hasta;
			if (filtroFecha === 'fecha') {
				fechaPagosContainer.style.display = 'block';
				const inputFecha = document.getElementById('fechaSeleccionadaPagos');
				if (!inputFecha.value) inputFecha.value = hoyLocalISO();
				desde = inputFecha.value; hasta = inputFecha.value;
			} else {
				fechaPagosContainer.style.display = 'none';
				desde = '2000-01-01'; hasta = hoyLocalISO();
			}

			const negocios = (negocioFiltro === 'Todos') ? Object.keys(nombresNegocios) : [negocioFiltro];

			let totalGlobalEfectivo = 0, totalGlobalNequi = 0;
			let htmlPorNegocio = '';

			for (const neg of negocios) {
				const datos = await fetchTxPorRango(desde, hasta, neg);
				const arr = datos[neg] ?? [];

				// Ventas y abonos por m√©todo
				let vEf=0, vNq=0, gEf=0, gNq=0;

				arr.forEach(t=>{
				const vb = Number(t?.totales?.ventasBrutas ?? 0);

				// Ventas ‚ÄúPagado‚Äù por m√©todoVenta
				if (t.estadoPago === 'Pagado' && vb > 0) {
					if (t.metodoVenta === 'Efectivo') vEf += vb;
					if (t.metodoVenta === 'Nequi')    vNq += vb;
				}
				// Abonos dentro del rango por m√©todo
				if (Array.isArray(t.pagos)) {
					t.pagos.forEach(p=>{
					if (p.fecha >= desde && p.fecha <= hasta) {
						const m = Number(p.monto ?? 0);
						if (p.metodo === 'Efectivo') vEf += m;
						if (p.metodo === 'Nequi')    vNq += m;
					}
					});
				}
				// Gastos: adjudica por metodoGasto
				if (t.gasto && Number(t.gasto.monto ?? 0) > 0) {
					const mg = t.metodoGasto ?? t.gasto.metodo ?? null;
					if (mg === 'Efectivo') gEf += Number(t.gasto.monto ?? 0);
					else if (mg === 'Nequi') gNq += Number(t.gasto.monto ?? 0);
				}
				});

				const inicialEf = incluirInicial ? (Number(saldoInicial[neg]?.efectivo ?? 0)) : 0;
				const inicialNq = incluirInicial ? (Number(saldoInicial[neg]?.nequi ?? 0)) : 0;

				const saldoEfectivo = inicialEf + vEf - gEf;
				const saldoNequi    = inicialNq + vNq - gNq;
				const totalSaldo    = saldoEfectivo + saldoNequi;

				totalGlobalEfectivo += saldoEfectivo;
				totalGlobalNequi    += saldoNequi;

				const pctEfectivo = totalSaldo > 0 ? ((saldoEfectivo/totalSaldo)*100).toFixed(1) : 0;
				const pctNequi    = totalSaldo > 0 ? ((saldoNequi/totalSaldo)*100).toFixed(1) : 0;

				htmlPorNegocio += `
				<div class="business-section">
					<h4>${nombresNegocios[neg]}</h4>
					<div class="summary-grid">
					<div class="summary-box">
						<h4>üíµ Saldo en Efectivo</h4>
						<div class="value">${COP(saldoEfectivo)}</div>
						<p style="color:#666;margin-top:10px;">${pctEfectivo}%</p>
					</div>
					<div class="summary-box">
						<h4>üì± Saldo en Nequi</h4>
						<div class="value">${COP(saldoNequi)}</div>
						<p style="color:#666;margin-top:10px;">${pctNequi}%</p>
					</div>
					<div class="summary-box">
						<h4>üí∞ Total Saldos</h4>
						<div class="value">${COP(totalSaldo)}</div>
					</div>
					</div>
					<div class="summary-card" style="margin-top:10px;">
					<h3>Detalle</h3>
					<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;">
						<div>
						<strong>Inicial Efectivo:</strong> ${COP(inicialEf)}<br>
						<strong>Ventas/Abonos Efectivo:</strong> ${COP(vEf)}<br>
						<strong>Gastos en Efectivo:</strong> -${COP(gEf)}
						</div>
						<div>
						<strong>Inicial Nequi:</strong> ${COP(inicialNq)}<br>
						<strong>Ventas/Abonos Nequi:</strong> ${COP(vNq)}<br>
						<strong>Gastos en Nequi:</strong> -${COP(gNq)}
						</div>
					</div>
					</div>
				</div>
				`;
			}

			const totalGlobal = totalGlobalEfectivo + totalGlobalNequi;
			const pctGlobalEfectivo = totalGlobal > 0 ? ((totalGlobalEfectivo/totalGlobal)*100).toFixed(1) : 0;
			const pctGlobalNequi    = totalGlobal > 0 ? ((totalGlobalNequi/totalGlobal)*100).toFixed(1) : 0;

			const baseTitulo = (filtroFecha === 'fecha')
				? `SALDOS DEL D√çA (${desde})` : 'SALDOS TOTALES (Acumulado)';
			const resumenTitulo = incluirInicial ? `${baseTitulo} ‚Äî (incluye capital inicial)` : baseTitulo;

			const headerHTML = `
				<div class="business-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
				<h4 style="color: white; text-align: center; margin-bottom: 20px; font-size: 1.1em;">${resumenTitulo}</h4>
				<div class="summary-grid">
					<div class="summary-box" style="background: rgba(255,255,255,0.95); border: none;">
					<h4 style="color: #28a745;">üíµ Saldo Efectivo</h4>
					<div class="value" style="color: #28a745;">${COP(totalGlobalEfectivo)}</div>
					<p style="color: #666; margin-top: 10px; font-weight: bold;">${pctGlobalEfectivo}%</p>
					</div>
					<div class="summary-box" style="background: rgba(255,255,255,0.95); border: none;">
					<h4 style="color: #007bff;">üì± Saldo Nequi</h4>
					<div class="value" style="color: #007bff;">${COP(totalGlobalNequi)}</div>
					<p style="color: #666; margin-top: 10px; font-weight: bold;">${pctGlobalNequi}%</p>
					</div>
					<div class="summary-box" style="background: rgba(255,255,255,0.95); border: none;">
					<h4 style="color: #667eea;">üí∞ Total General</h4>
					<div class="value" style="color: #667eea;">${COP(totalGlobal)}</div>
					</div>
				</div>
				</div>
			`;
			container.innerHTML = headerHTML + htmlPorNegocio;
		}
		
		// === Reemplazar COMPLETO ===
		function generarTablaRegistros(registros, opts = {}) {
			const { mostrarAcciones = true } = opts;

			// Encabezado (incluye "Acciones" solo si se pide)
			const header = `
				<thead>
				<tr>
					<th>Fecha</th>
					<th>Producto</th>
					<th>Cant.</th>
					<th>Precio</th>
					<th>Ventas</th>
					<th>Gastos</th>
					<th>M√©todo</th>
					<th>Estado</th>
					<th>Cliente</th>
					<th>Descripci√≥n</th>
					<th>Pendiente</th>
					${mostrarAcciones ? '<th>Acciones</th>' : ''}
				</tr>
				</thead>
			`;

			let body = '<tbody>';

			registros.forEach(r => {
				const ventasNum = Number(r.ventas || 0);
				const gastosNum = Number(r.gastos || 0);
				const precioFmt = (r.precioUnitario != null) ? COP(r.precioUnitario) : '-';
				const ventasFmt = (r.tipo === "movimiento") ? COP(ventasNum) : "-";
				const estadoFmt = r.estadoPago || '-';
				const clienteFmt = r.cliente || '-';
				const gastosFmt = (r.tipo === "movimiento") ? '-' + COP(gastosNum) : "-";
				const metodoFmt = (r.tipo === "movimiento")
				? (r.metodo === 'Efectivo' ? 'üíµ Efectivo'
					: (r.metodo === 'Nequi' ? 'üì± Nequi' : (r.metodo || '-')))
				: "-";

				const pendienteFmt = (r.estadoPago === 'Debe')
				? COP((r.montoPendiente != null ? r.montoPendiente : r.ventas) || 0)
				: '-';

				const puedeCobrar =
				r.tipo === 'movimiento' && ventasNum > 0 && estadoFmt === 'Debe' && !!r.id;

				const acciones = (mostrarAcciones && puedeCobrar)
				? `<button class="btn-success" type="button" onclick="abrirModalCobrar('${r.id}')">Cobrar</button>`
				: (mostrarAcciones ? '-' : '');

				const fechaHoraFmt = (r.horaPedido && String(r.horaPedido).trim())
				? `${r.fecha} ${r.horaPedido}`
				: (r.fecha || '-');

				body += `
				<tr>
					<td>${fechaHoraFmt}</td>
					<td>${r.producto || '-'}</td>
					<td>${r.cantidad ?? '-'}</td>
					<td>${precioFmt}</td>
					<td style="color:#007bff;">${ventasFmt}</td>
					<td style="color:#dc3545;">${gastosFmt}</td>
					<td>${metodoFmt}</td>
					<td>${estadoFmt}</td>
					<td>${clienteFmt}</td>
					<td>${r.descripcion || '-'}</td>
					<td style="color:#d39e00;font-weight:600;">${pendienteFmt}</td>
					${mostrarAcciones ? `<td>${acciones}</td>` : ''}
				</tr>
				`;
			});

			body += '</tbody>';
			return header + body;
		}

		/**
		* Renderiza una tabla de transacciones (1 fila por TX) con opci√≥n de expandir items[].
		* - Cada fila muestra: Fecha(+hora), # items, Ventas (brutas), Gasto, M√©todo Venta, Estado, Cliente, Pendiente y Acciones.
		* - Bot√≥n "Ver √≠tems" despliega una subtabla con los items[].
		* - Si la transacci√≥n est√° en "Debe", muestra bot√≥n "Cobrar" que abre tu modal con el ID de la transacci√≥n.
		*/
		function generarTablaTransacciones(transacciones, { mostrarAcciones = true } = {}) {
			const header = `
				<thead>
				<tr>
					<th>Fecha</th>
					<th># √çtems</th>
					<th>Ventas (brutas)</th>
					<th>Gasto</th>
					<th>M√©todo venta</th>
					<th>Estado</th>
					<th>Cliente</th>
					<th>Pendiente</th>
					<th>Notas</th>
					${mostrarAcciones ? '<th>Acciones</th>' : ''}
				</tr>
				</thead>
			`;

			let body = '<tbody>';

			transacciones.forEach(t => {
				
				const fechaHoraFmt = (t.horaPedido && String(t.horaPedido).trim())
				? `${t.fecha} ${t.horaPedido}`
				: (t.fecha || '-');

				const items = Array.isArray(t.items) ? t.items : [];
				const numItems = items.length;

				const ventasBrutas = Number(t?.totales?.ventasBrutas || 0);
				const gastos = Number(t?.totales?.gastos || 0);
				const pendiente = (t.estadoPago === 'Debe')
				? Number(t?.totales?.pendiente ?? ventasBrutas)
				: 0;

				// ===== M√âTODO VENTA (BADGES) =====
				let metodoVentaStr = '-';
				const parts = [];

				const mkBadge = (tipo, monto) => {
				const cls = (tipo === 'Efectivo') ? 'efec' : (tipo === 'Nequi') ? 'nequi' : 'otro';
				const ico = (tipo === 'Efectivo') ? 'üíµ' : (tipo === 'Nequi') ? 'üì±' : 'üí≥';
				const val = Math.abs(Number(monto || 0));     // üëà valor absoluto
				return `<span class="badge-met ${cls}"><span class="ico">${ico}</span>${tipo}<span class="val"> (${COP(val)})</span></span>`;
				};

				// Venta sin pagos
				if (t.estadoPago === 'Pagado' && t.metodoVenta && ventasBrutas > 0 && (!Array.isArray(t.pagos) || t.pagos.length === 0)) {
				const tipo = (t.metodoVenta === 'Efectivo' || t.metodoVenta === 'Nequi') ? t.metodoVenta : 'Otros';
				parts.push(mkBadge(tipo, ventasBrutas));
				} else {
				// Con pagos
				const totales = { Efectivo:0, Nequi:0, Otros:0 };

				if (Array.isArray(t.pagos) && t.pagos.length > 0) {
					t.pagos.forEach(p=>{
					const tipo = (p.metodo==='Efectivo'||p.metodo==='Nequi')?p.metodo:'Otros';
					totales[tipo] += Number(p.monto||0);
					});
				} else {
					if (ventasBrutas > 0 && t.estadoPago==='Debe') {
					parts.push(`<span class="badge-met otro"><span class="ico">üí≥</span>Cr√©dito</span>`);
					}
				}

				if (totales.Efectivo>0) parts.push(mkBadge('Efectivo', totales.Efectivo));
				if (totales.Nequi>0) parts.push(mkBadge('Nequi', totales.Nequi));
				if (totales.Otros>0) parts.push(mkBadge('Otros', totales.Otros));
				}

				metodoVentaStr = parts.length ? `<div class="metodo-badges">${parts.join('')}</div>` : '-';

				// ===== NOTA (√∫ltimo pago) =====
				let nota = '-';
				if (Array.isArray(t.pagos) && t.pagos.length > 0) {
				let last = null;
				const conTs = t.pagos.filter(p => !!p.ts);

				if (conTs.length > 0) {
					last = conTs.reduce((a,b)=>String(b.ts)>String(a.ts)?b:a);
				} else {
					last = t.pagos[t.pagos.length - 1];
				}

				if (last.descripcion) nota = last.descripcion;
				else {
					const tipoTxt = last.tipo==='total' ? 'Pago total' : 'Pago parcial';
					nota = `${tipoTxt} de ${COP(Number(last.monto||0))} con ${last.metodo}`;
				}
				}

				const puedeCobrar = (t.estadoPago === 'Debe') && t.id;
				const btnItemsId = `btn_items_${t.id}`;
				const detalleId  = `detalle_items_${t.id}`;

				const accionesHTML = mostrarAcciones
				? `
					<div style="display:flex; gap:6px; flex-wrap:wrap;">
					<button class="btn-secondary" type="button" id="${btnItemsId}" onclick="toggleDetalleItems('${detalleId}')">Ver √≠tems</button>
					${puedeCobrar ? `<button class="btn-success" type="button" onclick="abrirModalCobrar('${t.id}')">Cobrar</button>` : ''}
					</div>
				`
				: '';

				body += `
				<tr>
					<td>${fechaHoraFmt}</td>
					<td style="text-align:center;">${numItems}</td>
					<td style="color:#007bff; text-align:right;">${COP(ventasBrutas)}</td>
					<td style="color:#dc3545; text-align:right;">${gastos ? '-' + COP(gastos) : '-$0'}</td>
					<td>${metodoVentaStr}</td>
					<td>${t.estadoPago||'-'}</td>
					<td>${t.cliente||'-'}</td>
					<td style="color:#d39e00; font-weight:600; text-align:right;">${pendiente?COP(pendiente):'-'}</td>
					<td>${nota}</td>
					${mostrarAcciones?`<td>${accionesHTML}</td>`:''}
				</tr>
				`;

				const colspan = mostrarAcciones ? 10 : 9;

				const detalleTabla = items.length
				? `
					<table style="width:100%; margin-top:8px;">
					<thead>
						<tr>
						<th>Producto</th>
						<th>Cant.</th>
						<th>Precio Unit.</th>
						<th>Total</th>
						</tr>
					</thead>
					<tbody>
						${items.map(it=>`
						<tr>
							<td>${it.producto}</td>
							<td style="text-align:center;">${it.cantidad??'-'}</td>
							<td style="text-align:right;">${it.precioUnitario!=null?COP(it.precioUnitario):'-'}</td>
							<td style="text-align:right;">${COP(Number(it.total||0))}</td>
						</tr>
						`).join('')}
					</tbody>
					</table>`
				: `<div style="color:#999;">(Transacci√≥n sin √≠tems)</div>`;

				body += `
				<tr id="${detalleId}" style="display:none; background:#fafafa;">
					<td colspan="${colspan}">
					${detalleTabla}
					</td>
				</tr>
				`;
			});

			body += '</tbody>';
			return header + body;
		}

		// Helper para abrir/cerrar la subtabla de √≠tems
		function toggleDetalleItems(detalleRowId) {
			const row = document.getElementById(detalleRowId);
			if (!row) return;
			row.style.display = (row.style.display === 'none' || !row.style.display) ? 'table-row' : 'none';
		}

        // Limpiar formulario
        function limpiarFormulario() {
		  document.getElementById('gastos').value = '';
		  document.getElementById('descripcion').value = '';
		  document.getElementById('cantidad').value = '1';
		  document.getElementById('totalVentaPreview').textContent = '$0';
		  const precioInput = document.getElementById("precioPersonalizado");
		  if (precioInput) precioInput.value = '';
		  setFechaActual();
		  cargarProductos(); // recarga selector de productos
		  const tipoCorriente = document.getElementById('tipoCorriente');
		  if (tipoCorriente) tipoCorriente.value = '';
		  document.getElementById('tipoCorrienteWrap').style.display = 'none';
		  updateGastoInputsState();
		}

        // Mostrar mensajes
        function mostrarExito() {
            const msg = document.getElementById('successMsg');
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 3000);
        }

        function mostrarError(texto) {
            const msg = document.getElementById('errorMsg');
            msg.textContent = '‚úó ' + texto;
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 3000);
        }
		
		// Habilita/deshabilita inputs de gasto seg√∫n el estado del carrito
		function updateGastoInputsState() {
		  const gastosEl = document.getElementById('gastos');
		  const descEl   = document.getElementById('descripcion');

		  if (!gastosEl || !descEl) return;

		  const disabled = (carrito && carrito.length > 0);

		  // Si hay productos en carrito, limpiar y deshabilitar
		  if (disabled) {
			gastosEl.value = '';
			descEl.value = '';
		  }

		  gastosEl.disabled = disabled;
		  descEl.disabled = disabled;

		  // Si el modal "Guardar Registro" est√° abierto, refrescar su UI
		  // para que no muestre "M√©todo de gasto" si est√° deshabilitado
		  try { updateModalPagoUI(); } catch (e) {}
		}
				
		// ==== MODAL DE CONFIRMACI√ìN DE PAGO ====
		function abrirModalPago() {
			const gastos = parseFloat(document.getElementById('gastos').value) || 0;
			const hayCarrito = carrito.length > 0;
			const hayGasto = gastos > 0;

			if (!hayCarrito && !hayGasto) {
			  mostrarError('Agrega al menos una l√≠nea al pedido o registra un gasto.');
			  return;
			}

			// Estado por defecto:
			// - Si hay ventas, por defecto 'pagado'
			// - Si NO hay ventas y s√≠ gasto, por defecto 'soloGasto'
			const defaultEstado = hayCarrito ? 'pagado' : 'soloGasto';
			const radio = document.querySelector(`input[name="estadoPago"][value="${defaultEstado}"]`);
			if (radio) radio.checked = true;

			// Reset campos
			const err = document.getElementById('modalPagoError');
			if (err) err.style.display = 'none';
			const nombre = document.getElementById('nombreClienteDeudor');
			if (nombre) nombre.value = '';

			// Mostrar modal + ajustar visibilidad de secciones
			document.getElementById('modalPagoBackdrop').style.display = 'flex';
			updateModalPagoUI();
		}

		function cerrarModalPago() {
		  document.getElementById('modalPagoBackdrop').style.display = 'none';
		  document.getElementById('horaPedido').value = "";
		}

		function toggleNombreCliente(mostrar) {
		  const wrap = document.getElementById('nombreClienteWrap');
		  wrap.style.display = mostrar ? 'block' : 'none';
		}

		async function confirmarGuardarDesdeModal() {
			const estado = document.querySelector('input[name="estadoPago"]:checked')?.value ?? 'pagado';
			const nombre = (document.getElementById('nombreClienteDeudor')?.value ?? '').trim();
			const err = document.getElementById('modalPagoError');
			const gastos = parseFloat(document.getElementById('gastos').value) ?? 0;
			const hayCarrito = carrito.length > 0;
			const hayGasto = gastos > 0;

			// Leer m√©todos (si visibles/corresponden)
			let metodoVenta = null;
			let metodoGasto = null;
			const ventaWrapVisible = document.getElementById('metodoVentaWrap')?.style.display !== 'none';
			if (ventaWrapVisible) {
				metodoVenta = document.querySelector('input[name="metodoVenta"]:checked')?.value ?? null;
			}
			const gastoWrapVisible = document.getElementById('metodoGastoWrap')?.style.display !== 'none';
			if (gastoWrapVisible) {
				metodoGasto = document.querySelector('input[name="metodoGasto"]:checked')?.value ?? null;
			}

			// Validaciones r√°pidas (las mismas que ya tienes)
			if (estado === 'debe' && hayCarrito && !nombre) {
				err.textContent = '‚úó Debes ingresar el nombre del cliente que qued√≥ debiendo.';
				err.style.display = 'block';
				return;
			}
			if (estado === 'pagado' && hayCarrito && !metodoVenta) {
				err.textContent = '‚úó Selecciona el m√©todo de pago de la venta.';
				err.style.display = 'block';
				return;
			}
			if (hayGasto && !metodoGasto) {
				err.textContent = '‚úó Selecciona el m√©todo de pago del gasto.';
				err.style.display = 'block';
				return;
			}
			if (estado === 'soloGasto' && hayCarrito) {
				const seguro = confirm('Seleccionaste "Solo gasto", pero hay productos en el carrito. Se ignorar√°n estas ventas y solo se registrar√° el gasto. ¬øDeseas continuar?');
				if (!seguro) return;
			}

			// üëá NUEVO: leer hora ANTES de cerrar el modal
			const horaPedido = (document.getElementById('horaPedido')?.value ?? '').trim() || null;

			err.style.display = 'none';
			cerrarModalPago();

			// Guardar con hora
			await guardarDatos({
				estadoPago: estado,
				nombreCliente: nombre || null,
				metodoVenta,
				metodoGasto,
				soloGasto: (estado === 'soloGasto'),
				horaPedido // üëà NUEVO
			});

			// (Opcional) Limpiar input de hora despu√©s de guardar
			const horaEl = document.getElementById('horaPedido');
			if (horaEl) horaEl.value = '';
		}
		
        // Exportar datos
        async function exportarDatos() {
			const datos = await fetchTxPorRango('2000-01-01', hoyLocalISO(), 'Todos');
			const datosFormateados = {};
			for (const [negocio, arr] of Object.entries(datos)) {
				const nombreReal = nombresNegocios[negocio] ?? negocio;
				datosFormateados[nombreReal] = arr;
			}
			const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(datosFormateados, null, 2));
			const link = document.createElement('a');
			link.href = dataStr;
			link.download = 'transacciones_' + hoyLocalISO() + '.json';
			link.click();
		}

		// Descargar Excel (actualizado)
		async function descargarExcel() {
		const datos = await fetchTxPorRango('2000-01-01', hoyLocalISO(), 'Todos');
		let csv = 'Negocio,Fecha,Hora,#Items,Ventas Brutas,Gasto,Estado,Cliente,Metodo Venta,Pagos, Pendiente, Detalle Items\n';
		for (const [negocio, arr] of Object.entries(datos)) {
			const nom = nombresNegocios[negocio] ?? negocio;
			(arr ?? []).forEach(t => {
			const itemsTxt = Array.isArray(t.items) ? t.items.map(i => `${i.producto} x${i.cantidad}=${i.total}`).join(' | ') : '';
			const pagosTxt = Array.isArray(t.pagos) ? t.pagos.map(p => `${p.metodo}:${p.monto}`).join(' ') : '';
			const row = [
				nom, (t.fecha ?? ''), (t.horaPedido ?? ''), (Array.isArray(t.items)?t.items.length:0),
				(t.totales?.ventasBrutas ?? 0), (t.totales?.gastos ?? 0),
				(t.estadoPago ?? ''), (t.cliente ?? ''), (t.metodoVenta ?? ''),
				pagosTxt, (t.totales?.pendiente ?? 0), itemsTxt
			].map(v => `"${String(v).replace(/"/g,'""')}"`).join(',');
			csv += row + '\n';
			});
		}
		const link = document.createElement('a');
		link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
		link.download = 'transacciones_' + hoyLocalISO() + '.csv';
		link.click();
		}

        // Limpiar todo
        function limpiarTodos() {
            if (confirm('¬øEst√°s seguro de que deseas limpiar TODOS los datos? Esta acci√≥n no se puede deshacer.')) {
                localStorage.removeItem('contabilidad');
                inicializarSistema();
                actualizarTotalRegistros();
                mostrarExito();
            }
        }

        // Actualizar total de registros
        // Requiere exponer getCountFromServer en <script type="module"> como window.getCountFromServer
		async function actualizarTotalRegistros() {
			try {
				const q = window.query(window.collection(window.db, 'transacciones'));
				const snap = await window.getCountFromServer(q);
				document.getElementById('totalRegistros').textContent = snap.data().count ?? 0;
			} catch (e) {
				console.warn('No se pudo obtener el conteo; omito para evitar lecturas grandes.', e);
			}
		}
        
		// Productos y c√°lculo
		document.getElementById("business").addEventListener("change", cargarProductos);
		document.getElementById("productoSelect").addEventListener("change", calcularTotalVenta);
		document.getElementById("cantidad").addEventListener("input", calcularTotalVenta);
		document.getElementById("precioPersonalizado").addEventListener("input", calcularTotalVenta);

		// Espera a que el <script type="module"> exponga las globals de Firebase
		async function waitForFirebaseReady() {
			while (!(window.db && window.getDocs && window.collection && window.updateDoc)) {
			// Espera 20ms y vuelve a chequear
			await new Promise(r => setTimeout(r, 20));
			}
		}

		// Inicializa SOLO cuando Firebase globals est√©n listas
		window.addEventListener('DOMContentLoaded', async () => {
			try {
				await waitForFirebaseReady();
				// Espera usuario autenticado (el m√≥dulo redirige si no hay sesi√≥n)
				await waitForAuthUser();
				// Migrar cat√°logo local -> DB si aplica (una sola vez)
				await migrarCatalogosLocalesALaDB();
			} catch (e) {
			console.error('Firebase no se inicializ√≥ a tiempo:', e);
			} finally {
			// Tu inicializaci√≥n normal
			inicializarSistema();
			}
		});
		
		async function switchTab(tabName, ev) {
			const contents = document.querySelectorAll('.content');
			const buttons  = document.querySelectorAll('.tab-button');

			// Desactivar todo
			contents.forEach(c => c.classList.remove('active'));
			buttons.forEach(b => b.classList.remove('active'));

			// Activar contenido
			document.getElementById(tabName).classList.add('active');
			if (ev && ev.target) ev.target.classList.add('active');

			// Cargar datos al entrar a cada pesta√±a
			if (tabName === 'resumen') {
				await actualizarResumen();
				await actualizarCuentasPorCobrar();
			}

			if (tabName === 'acumulado') {
				await actualizarAcumulado();
			}

			if (tabName === 'metodos') {
				await actualizarAnalisisPagos();
			}

			if (tabName === 'configuracion') {
				renderCatalogoUI();
			}

			if (tabName === 'informes') {
				try {
					// [Eliminado] llamadas inmediatas a todos los informes
					// Lazy-load: se cargan al abrir cada <details> por primera vez (ver listeners abajo)
				} catch (e) { console.warn(e); }
				restoreInformesState();
				initInformesAccordionHotkeys();
				// === Listeners de carga perezosa ===
				const mensual = document.getElementById('secMensual');
				const periodo = document.getElementById('secPeriodo');
				const pl      = document.getElementById('secPL');
				if (mensual && !mensual.__wired) {
					mensual.__wired = true;
					mensual.addEventListener('toggle', async () => {
					if (mensual.open && !mensual.__loaded) {
						const mesEl = document.getElementById('mesReporte');
						if (mesEl && !mesEl.value) {
						const d = new Date(); const y = d.getFullYear(); const m = String(d.getMonth()+1).padStart(2,'0');
						mesEl.value = `${y}-${m}`;
						}
						await previsualizarInforme();
						mensual.__loaded = true;
					}
					});
					if (mensual.open) mensual.dispatchEvent(new Event('toggle'));
				}
				if (periodo && !periodo.__wired) {
					periodo.__wired = true;
					periodo.addEventListener('toggle', async () => {
						if (periodo.open && !periodo.__loaded) {
						const dEl = document.getElementById('infDesdePeriodo');
						const hEl = document.getElementById('infHastaPeriodo');
						if (dEl && !dEl.value) dEl.value = primerDiaMesActualISO();
						if (hEl && !hEl.value) hEl.value = hoyLocalISO();
						await previsualizarPeriodoInforme();
						await renderCxcPeriodoEnInformes();
						periodo.__loaded = true;
						}
					});
					if (periodo.open) periodo.dispatchEvent(new Event('toggle'));
				}
				if (pl && !pl.__wired) {
					pl.__wired = true;
					pl.addEventListener('toggle', async () => {
						if (pl.open && !pl.__loaded) {
						const dp = document.getElementById('plDesde');
						const hp = document.getElementById('plHasta');
						if (dp && !dp.value) dp.value = primerDiaMesActualISO();
						if (hp && !hp.value) hp.value = hoyLocalISO();
						await previsualizarPL();
						pl.__loaded = true;
						}
					});
					if (pl.open) pl.dispatchEvent(new Event('toggle'));
				}
			}
		}
		
		// ===== Cobrar ventas en "Debe" =====
		let ventaACobrarId = null;

		function abrirModalCobrar(id) {
			ventaACobrarId = id;
			document.getElementById('modalCobrarError').style.display = 'none';
			// Default: Efectivo
			const ef = document.getElementById('cobroEfectivo');
			if (ef) ef.checked = true;
			document.getElementById('modalCobrarBackdrop').style.display = 'flex';
		}

		function cerrarModalCobrar() {
			document.getElementById('modalCobrarBackdrop').style.display = 'none';
			ventaACobrarId = null;
		}

		async function confirmarCobro() {
			const err = document.getElementById('modalCobrarError');
			try {
				if (!ventaACobrarId) { 
				err.textContent = '‚úó No se encontr√≥ la venta a cobrar.'; 
				err.style.display = 'block'; 
				return; 
				}

				const metodoSel = document.querySelector('input[name="metodoCobro"]:checked')?.value || 'Efectivo';

				// Leer doc transacci√≥n
				const ref = window.doc(window.db, "transacciones", ventaACobrarId);
				const snap = await window.getDoc(ref);
				if (!snap.exists()) { 
				err.textContent = '‚úó La transacci√≥n ya no existe.'; 
				err.style.display = 'block'; 
				return; 
				}

				const t = snap.data();
				const ventasBrutas = Number(t?.totales?.ventasBrutas || 0);
				const pendienteAntes = Number(t?.totales?.pendiente || 0);
				if (pendienteAntes <= 0) { cerrarModalCobrar(); mostrarExito(); return; }

				// Este cobro liquida TODO el pendiente restante (pago TOTAL)
				const monto = pendienteAntes;
				const pagosPrev = Array.isArray(t.pagos) ? [...t.pagos] : [];

				const pago = {
				fecha: hoyLocalISO(),
				metodo: metodoSel,
				monto: monto,
				tipo: 'total', // total porque saldamos 100% del pendiente
				pendienteAntes,
				pendienteDespues: 0,
				descripcion: `Pago total de la deuda de ${COP(pendienteAntes)} realizado con ${metodoSel}`,
				ts: new Date().toISOString()
				};
				pagosPrev.push(pago);

				await window.updateDoc(ref, {
				pagos: pagosPrev,
				'totales.pendiente': 0,
				estadoPago: 'Pagado',
				updatedAt: new Date()
				});
				const txActualizada = {
					id: ventaACobrarId,             // id correcto de la transacci√≥n
					...t,                           // base: datos originales del snapshot
					pagos: pagosPrev,
					totales: { ...(t.totales || {}), pendiente: 0 },
					estadoPago: 'Pagado',
					updatedAt: new Date()
				};
				patchTxInCaches(txActualizada);
				
				await refreshAfterSave(hoyLocalISO()); // invalida txDia/txRng/txCxc y refresca pesta√±a activa

				cerrarModalCobrar();
				mostrarExito();

				// Refrescar tableros
				try { await actualizarCuentasPorCobrar(); } catch {}
				try { await actualizarResumen(); } catch {}
				try { await actualizarAnalisisPagos(); } catch {}
				try { await actualizarAcumulado(); } catch {}

			} catch (e) {
				console.error(e);
				err.textContent = '‚úó Error registrando el cobro.';
				err.style.display = 'block';
			}
		}

		/* =============== INFORMES MENSUALES (PDF) =============== */

		// Helpers de fecha
		function getYYYYMMFromInput() {
			const v = (document.getElementById('mesReporte')?.value || '').trim(); // 'YYYY-MM'
			if (!/^\d{4}-\d{2}$/.test(v)) return null;
			return v;
		}
		function nombreMes(yyyyMM) {
			const [y, m] = yyyyMM.split('-').map(s => parseInt(s,10));
			const f = new Date(y, m-1, 1);
			return f.toLocaleDateString('es-CO', { month: 'long', year: 'numeric' });
		}

		// Filtra por mes 'YYYY-MM'
		function esDelMes(reg, yyyyMM) {
			const f = (reg.fecha || '').trim();
			return f.startsWith(`${yyyyMM}-`); // ej: '2026-02-'
		}

		// Construir datos del informe (por negocio y global)
		function construirResumenMensual(datosPorNegocio, yyyyMM, negocioFiltro='Todos') {
			// Mes seleccionado
			const yyyy = parseInt(yyyyMM.slice(0,4), 10);
			const mm   = parseInt(yyyyMM.slice(5,7), 10);
			const cierreMes = new Date(yyyy, mm, 0); // √∫ltimo d√≠a del mes
			const cierreISO = `${cierreMes.getFullYear()}-${String(cierreMes.getMonth()+1).padStart(2,'0')}-${String(cierreMes.getDate()).padStart(2,'0')}`;

			const negocios = (negocioFiltro === 'Todos') ? Object.keys(datosPorNegocio) : [negocioFiltro];

			const result = {
				global: { ventas: 0, gastos: 0, balance: 0 },
				negocios: {}
			};

			for (const neg of negocios) {
				const regsAll = datosPorNegocio[neg] || [];
				const regsMes = regsAll.filter(r => esDelMes(r, yyyyMM));

				// ======== VENTAS (BASE CAJA) ========
				// Ventas pagadas: tienen producto, ventas>0, m√©todo (Efectivo/Nequi) y NO est√°n excluidas.
				const ventasPagadasProductos = regsMes.reduce((sum, r) => {
				const esMov   = r.tipo === 'movimiento';
				const esVenta = Number(r.ventas || 0) > 0;
				const tieneProducto = !!r.producto;
				const tieneMetodo   = r.metodo === 'Efectivo' || r.metodo === 'Nequi';
				const excluida      = r.excluirDeAnalisis === true;
				if (esMov && esVenta && tieneProducto && tieneMetodo && !excluida) {
					return sum + Number(r.ventas || 0);
				}
				return sum;
				}, 0);

				// Abonos del mes (entran a caja el d√≠a del cobro)
				const ventasPorAbonos = regsMes.reduce((sum, r) => {
				const esMov = r.tipo === 'movimiento';
				const esAbono = r.esAbono === true;
				const esVenta = Number(r.ventas || 0) > 0;
				return (esMov && esAbono && esVenta) ? sum + Number(r.ventas || 0) : sum;
				}, 0);

				const ventasCaja = ventasPagadasProductos + ventasPorAbonos;

				// ======== GASTOS (como ya lo ten√≠as) ========
				let gastos = 0;
				const gastoCatMap = new Map();
				regsMes.forEach(r => {
				if (r.tipo === 'movimiento' && Number(r.gastos || 0) > 0) {
					const t = Number(r.gastos || 0);
					gastos += t;
					const cat = ((r.descripcion || 'Sin descripci√≥n').trim() || 'Sin descripci√≥n');
					gastoCatMap.set(cat, (gastoCatMap.get(cat) || 0) + t);
				}
				});

				// ======== TOP PRODUCTOS (por lo vendido/entregado, NO abonos) ========
				const prodMap = new Map();
				regsMes.forEach(r => {
				const esMov   = r.tipo === 'movimiento';
				const esVenta = Number(r.ventas || 0) > 0;
				const tieneProducto = !!r.producto;
				const esAbono = r.esAbono === true;
				if (esMov && esVenta && tieneProducto && !esAbono) {
					const prev = prodMap.get(r.producto) || { cantidad: 0, total: 0 };
					prev.cantidad += Number(r.cantidad || 0);
					prev.total    += Number(r.ventas   || 0);
					prodMap.set(r.producto, prev);
				}
				});
				const topProductos = [...prodMap.entries()]
				.map(([producto, info]) => ({ producto, cantidad: info.cantidad, total: info.total }))
				.sort((a,b) => b.total - a.total)
				.slice(0, 10);

				// ======== CUENTAS POR COBRAR (CxC) ========
				// 1) Cr√©dito originado en el mes: ventas con producto & estado 'Debe' en el mes (no abonos)
				const creditoOriginadoMes = regsMes.reduce((sum, r) => {
				const esMov   = r.tipo === 'movimiento';
				const esVenta = Number(r.ventas || 0) > 0;
				const tieneProducto = !!r.producto;
				const esDebe = r.estadoPago === 'Debe';
				const esAbono = r.esAbono === true;
				return (esMov && esVenta && tieneProducto && esDebe && !esAbono)
					? sum + Number(r.ventas || 0)
					: sum;
				}, 0);

				// 2) Abonos aplicados a ventas ORIGINADAS en este mes:
				//    - r.esAbono === true dentro del mes
				//    - y su r.originalId apunta a un doc de este negocio cuya 'fecha' ‚àà mes y fue 'Debe'
				const ventasDelMesPorId = new Map(); // idVentaOriginal -> ventas de esa venta (para filtrar)
				regsMes.forEach(r => {
				const esMov   = r.tipo === 'movimiento';
				const esVenta = Number(r.ventas || 0) > 0;
				const tieneProducto = !!r.producto;
				const esDebe = r.estadoPago === 'Debe';
				if (esMov && esVenta && tieneProducto && esDebe && r.id) {
					ventasDelMesPorId.set(r.id, true);
				}
				});

				const abonosAventasDelMes = regsMes.reduce((sum, r) => {
				const esAbono = r.esAbono === true;
				const v = Number(r.ventas || 0);
				if (esAbono && v > 0 && r.originalId && ventasDelMesPorId.has(r.originalId)) {
					return sum + v;
				}
				return sum;
				}, 0);

				// 3) Pendiente al cierre de ventas originadas este mes
				const pendienteOriginadoMes = Math.max(0, creditoOriginadoMes - abonosAventasDelMes);

				// 4) Pendiente total acumulado al cierre (todas las deudas vivas hasta fin de mes)
				//    buscamos en TODO el arreglo del negocio (no solo el mes) las ventas en 'Debe' con pendiente > 0
				const pendienteTotalAcumulado = regsAll.reduce((sum, r) => {
				const esMov   = r.tipo === 'movimiento';
				const esVenta = Number(r.ventas || 0) > 0;
				const tieneProducto = !!r.producto;
				const esDebe = r.estadoPago === 'Debe';
				const fechaOk = (r.fecha && r.fecha <= cierreISO); // fecha string YYYY-MM-DD
				if (esMov && esVenta && tieneProducto && esDebe && fechaOk) {
					const pendiente = Number((r.montoPendiente != null ? r.montoPendiente : r.ventas) || 0);
					return pendiente > 0 ? sum + pendiente : sum;
				}
				return sum;
				}, 0);

				// (Opcional) Top deudores originados en el mes: por cliente
				const mapaDeudoresMes = new Map(); // cliente -> { originado, abonado, pendiente }
				regsMes.forEach(r => {
				const esVentaDebeMes = (r.tipo === 'movimiento' && Number(r.ventas||0)>0 && !!r.producto && r.estadoPago==='Debe');
				if (esVentaDebeMes) {
					const cliente = (r.cliente && String(r.cliente).trim()) ? r.cliente.trim() : 'Sin nombre';
					const prev = mapaDeudoresMes.get(cliente) || { originado:0, abonado:0, pendiente:0 };
					prev.originado += Number(r.ventas || 0);
					mapaDeudoresMes.set(cliente, prev);
				}
				});
				regsMes.forEach(r => {
				const esAbono = r.esAbono === true;
				if (esAbono && r.originalId) {
					// localizar el doc original en regsMes (solo cuenta si la venta original fue de este mes)
					const original = regsMes.find(x => x.id === r.originalId);
					if (original && original.estadoPago === 'Debe') {
					const cliente = (original.cliente && String(original.cliente).trim()) ? original.cliente.trim() : 'Sin nombre';
					const prev = mapaDeudoresMes.get(cliente) || { originado:0, abonado:0, pendiente:0 };
					prev.abonado += Number(r.ventas || 0);
					mapaDeudoresMes.set(cliente, prev);
					}
				}
				});
				// Calcula pendiente por cliente (de lo originado en el mes)
				const deudoresMes = [...mapaDeudoresMes.entries()]
				.map(([cliente, kpi]) => ({ cliente, originado: kpi.originado, abonado: kpi.abonado, pendiente: Math.max(0, kpi.originado - kpi.abonado) }))
				.sort((a,b) => b.pendiente - a.pendiente);

				// ======== Armar resultado negocio ========
				const balance = ventasCaja - gastos;
				const gastosCat = [...gastoCatMap.entries()]
				.map(([categoria, total]) => ({ categoria, total }))
				.sort((a,b) => b.total - a.total)
				.slice(0, 10);

				result.negocios[neg] = {
				ventas: ventasCaja,
				gastos,
				balance,
				topProductos,
				gastosCat,
				// KPIs de CxC
				cxc: {
					originadoMes: creditoOriginadoMes,
					abonosAplicadosMes: abonosAventasDelMes,
					pendienteOriginadoMes,
					pendienteTotalAcumulado,
					deudoresMes // top deudores del mes (origen)
				}
				};

				result.global.ventas += ventasCaja;
				result.global.gastos += gastos;
			}

			result.global.balance = result.global.ventas - result.global.gastos;
			return result;
		}

		function monthRangeFromYYYYMM(yyyyMM){
			const [y, m] = yyyyMM.split('-').map(Number);
			const desde = `${yyyyMM}-01`;
			const hasta = `${y}-${String(m).padStart(2,'0')}-${String(new Date(y, m, 0).getDate()).padStart(2,'0')}`;
			return { desde, hasta };
		}

		/**
		* Devuelve KPIs para un rango y negocio usando TRANSACCIONES.
		* √ösalo en previsualizaci√≥n mensual, por per√≠odo y P&L.
		*/
		async function kpisDesdeTransacciones(desdeISO, hastaISO, negocioSel='Todos') {
			const datos = await fetchTxPorRango(desdeISO, hastaISO, negocioSel); // <‚Äî TX

			let ventasEfec = 0, ventasNequi = 0, gastos = 0;
			const detalleItems = []; // si quieres tabla de 12 columnas con items

			const negocios = (negocioSel === 'Todos') ? Object.keys(datos) : [negocioSel];
			for (const negKey of negocios) {
				const arr = datos[negKey] || [];

				arr.forEach(t => {
				const ventasBrutas = Number(t?.totales?.ventasBrutas ?? 0);

				// Ventas Pagado
				if (t.estadoPago === 'Pagado' && ventasBrutas > 0) {
					if (t.metodoVenta === 'Efectivo') ventasEfec += ventasBrutas;
					if (t.metodoVenta === 'Nequi')    ventasNequi += ventasBrutas;
				}

				// Abonos dentro del rango
				if (Array.isArray(t.pagos)) {
					t.pagos.forEach(p => {
					if (p.fecha >= desdeISO && p.fecha <= hastaISO) {
						const m = Number(p?.monto ?? 0);
						if (p.metodo === 'Efectivo') ventasEfec += m;
						if (p.metodo === 'Nequi')    ventasNequi += m;
					}
					});
				}

				// Gastos del rango
				if (t.gasto && Number(t.gasto.monto ?? 0) > 0 && t.fecha >= desdeISO && t.fecha <= hastaISO) {
					gastos += Number(t.gasto.monto ?? 0);
				}

				// Detalle (opcional): 12 columnas ‚Äî puedes mapear items aqu√≠ si tu informe lo usa
				if (Array.isArray(t.items)) {
					t.items.forEach(it => {
					detalleItems.push({
						fecha: t.fecha,
						negocio: t.negocio,
						producto: it.producto,
						cantidad: Number(it.cantidad ?? 0),
						precioUnit: Number(it.precioUnitario ?? 0),
						total: Number(it.total ?? 0),
						metodoVenta: t.metodoVenta ?? '',
						cliente: t.cliente ?? '',
						estadoPago: t.estadoPago ?? '',
						descripcion: t.gasto?.descripcion ?? '',
					});
					});
				}
				});
			}

			return {
				ventasEfec, ventasNequi, gastos,
				totalVentas: ventasEfec + ventasNequi,
				balance: (ventasEfec + ventasNequi) - gastos,
				detalleItems
			};
		}

		// Previsualizaci√≥n simple en pantalla (HTML)
		async function previsualizarInforme() {
			const yyyyMM = getYYYYMMFromInput();
			if (!yyyyMM) { mostrarError('Selecciona un mes v√°lido (YYYY-MM).'); return; }

			const negocioSel = document.getElementById('negocioReporte')?.value ?? 'Todos';
			const { desde: primerDia, hasta: ultimoDia } = monthRangeFromYYYYMM(yyyyMM);

			// Carga por transacciones del mes (filtra por negocio si aplica)
			const datosTx = await fetchTxPorRango(primerDia, ultimoDia, negocioSel); // {Negocio1:[...], ...}

			// Para "pendiente total acumulado al cierre", necesitamos todas las deudas <= √∫ltimo d√≠a
			const deudasCierre = await fetchDeudasTx(negocioSel, { hastaISO: ultimoDia }); // Debe hasta cierre

			const negocios = (negocioSel === 'Todos') ? Object.keys(datosTx) : [negocioSel];
			const resumen = { global: { ventas:0, gastos:0, balance:0 }, negocios: {} };

			for (const neg of negocios) {
				const arr = datosTx[neg] ?? [];

				// Ventas de caja del mes
				let ventasEf = 0, ventasNq = 0;
				let gastosMes = 0;

				// Top productos (agrego por items)
				const prodMap = new Map();

				arr.forEach(t => {
				const ventasBrutas = Number(t?.totales?.ventasBrutas ?? 0);
				// Ventas ‚ÄúPagado‚Äù del mes por m√©todoVenta
				if (t.estadoPago === 'Pagado' && ventasBrutas > 0) {
					if (t.metodoVenta === 'Efectivo') ventasEf += ventasBrutas;
					if (t.metodoVenta === 'Nequi')    ventasNq += ventasBrutas;
				}
				// Abonos del mes: suman a caja por m√©todo del pago
				if (Array.isArray(t.pagos)) {
					t.pagos.forEach(p => {
					if (p.fecha >= primerDia && p.fecha <= ultimoDia) {
						const m = Number(p.monto ?? 0);
						if (p.metodo === 'Efectivo') ventasEf += m;
						if (p.metodo === 'Nequi')    ventasNq += m;
					}
					});
				}
				// Gastos del mes (por fecha de la TX)
				if (t.gasto && Number(t.gasto.monto ?? 0) > 0) {
					gastosMes += Number(t.gasto.monto ?? 0);
				}
				// Top productos (solo lo vendido/entregado: items[])
				if (Array.isArray(t.items)) {
					t.items.forEach(it => {
					const prev = prodMap.get(it.producto) ?? { cantidad:0, total:0 };
					prev.cantidad += Number(it.cantidad ?? 0);
					prev.total    += Number(it.total ?? 0);
					prodMap.set(it.producto, prev);
					});
				}
				});

				const ventasCaja = ventasEf + ventasNq;
				const balance    = ventasCaja - gastosMes;
				const topProductos = [...prodMap.entries()]
				.map(([producto, info]) => ({ producto, cantidad: info.cantidad, total: info.total }))
				.sort((a,b)=> b.total - a.total).slice(0, 10);

				// CxC del mes (originado)
				const originadoMes = arr.reduce((s,t) =>
				(t.estadoPago === 'Debe') ? s + Number(t?.totales?.ventasBrutas ?? 0) : s, 0);

				// Pendiente total acumulado al cierre (incluye meses previos)
				// Filtra deudasCierre para este negocio
				const pendAcumCierre = (deudasCierre[neg] ?? []).reduce((s,t)=>
				s + Number(t?.totales?.pendiente ?? 0), 0);

				resumen.negocios[neg] = {
				ventas: ventasCaja, gastos: gastosMes, balance,
				topProductos,
				cxc: {
					originadoMes,
					abonosAplicadosMes: 0, // (opcional: si quieres s√≥lo abonos a ventas originadas en el mes, habr√≠a que cruzar ids)
					pendienteOriginadoMes: Math.max(0, originadoMes - 0),
					pendienteTotalAcumulado: pendAcumCierre
				}
				};
				resumen.global.ventas  += ventasCaja;
				resumen.global.gastos  += gastosMes;
			}
			resumen.global.balance = resumen.global.ventas - resumen.global.gastos;

			// Render en pantalla (muy similar al tuyo)
			const cont = document.getElementById('previewInforme');
			let html = `
				<div class="business-section">
				<h4>Resumen - ${nombreMes(yyyyMM)} (${negocioSel === 'Todos' ? 'Todos los negocios' : (nombresNegocios[negocioSel]??negocioSel)})</h4>
				<table>
					<thead><tr><th>Negocio</th><th>Ventas (caja)</th><th>Gastos</th><th>Balance</th></tr></thead>
					<tbody>
			`;
			for (const [neg, info] of Object.entries(resumen.negocios)) {
				html += `
				<tr>
					<td>${nombresNegocios[neg] ?? neg}</td>
					<td style="color:#007bff;">${COP(info.ventas)}</td>
					<td style="color:#dc3545;">-${COP(info.gastos)}</td>
					<td style="font-weight:600;color:${info.balance>=0 ? '#28a745' : '#dc3545'};">${COP(info.balance)}</td>
				</tr>
				`;
			}
			html += `
					</tbody>
				</table>
				<div class="summary-card">
					<h3 style="margin-bottom:6px;">Totales</h3>
					<div>Ventas (caja): <strong>${COP(resumen.global.ventas)}</strong></div>
					<div>Gastos: <strong>-${COP(resumen.global.gastos)}</strong></div>
					<div>Balance: <strong>${COP(resumen.global.balance)}</strong></div>
				</div>
			`;
			for (const [neg, info] of Object.entries(resumen.negocios)) {
				const c = info.cxc ?? { originadoMes:0, abonosAplicadosMes:0, pendienteOriginadoMes:0, pendienteTotalAcumulado:0 };
				html += `
				<div class="summary-card" style="margin-top:10px;">
					<h3 style="margin-bottom:6px;">Cuentas por Cobrar ‚Äî ${nombresNegocios[neg]??neg}</h3>
					<div>Cr√©dito originado en el mes: <strong>${COP(c.originadoMes)}</strong></div>
					<div>Abonos aplicados (mes): <strong>-${COP(c.abonosAplicadosMes)}</strong></div>
					<div>Pendiente al cierre (de lo originado en el mes): <strong>${COP(c.pendienteOriginadoMes)}</strong></div>
					<div>Pendiente total acumulado al cierre: <strong>${COP(c.pendienteTotalAcumulado)}</strong></div>
				</div>
				`;
			}
			html += `</div>`;
			cont.innerHTML = html;
		}

		// Exportar PDF (Informe mensual) ‚Äî versi√≥n 100% Transacciones y con CxC/deudores
		async function exportarInformeMensualPDF() {
			// 1) === Inputs del mes y negocio (DEBEN ir antes de la capa de datos) ===
			const yyyyMM = getYYYYMMFromInput();
			if (!yyyyMM) { mostrarError('Selecciona un mes v√°lido (YYYY-MM).'); return; }
			const negocioSel = document.getElementById('negocioReporte')?.value ?? 'Todos';
			const { desde: primerDia, hasta: ultimoDia } = monthRangeFromYYYYMM(yyyyMM);

			// 2) ==========================
			//        CAPA DE DATOS (TX)
			// ==========================
			const datosTx = await fetchTxPorRango(primerDia, ultimoDia, negocioSel);      // {Negocio1:[...], ...}
			const deudasCierre = await fetchDeudasTx(negocioSel, { hastaISO: ultimoDia }); // Debe vigentes <= √∫ltimo d√≠a

			const negocios = (negocioSel === 'Todos') ? Object.keys(datosTx) : [negocioSel];
			const resumen = { global: { ventas:0, gastos:0, balance:0 }, negocios: {} };

			for (const neg of negocios) {
				const arr = datosTx[neg] ?? [];
				let ventasEf=0, ventasNq=0, gastosMes=0;
				let ventasBrutasMes = 0;
				const prodMap = new Map();

				// 2.1 Ventas de caja (Pagado + abonos del mes), gastos del mes y top productos
				arr.forEach(t=>{
				const vb = Number(t?.totales?.ventasBrutas ?? 0);
				ventasBrutasMes += vb;

				if (t.estadoPago === 'Pagado' && vb > 0) {
					if (t.metodoVenta === 'Efectivo') ventasEf += vb;
					if (t.metodoVenta === 'Nequi')    ventasNq += vb;
				}
				if (Array.isArray(t.pagos)) {
					t.pagos.forEach(p=>{
					if (p.fecha >= primerDia && p.fecha <= ultimoDia) {
						const m = Number(p.monto ?? 0);
						if (p.metodo === 'Efectivo') ventasEf += m;
						if (p.metodo === 'Nequi')    ventasNq += m;
					}
					});
				}
				if (t.gasto && Number(t.gasto.monto ?? 0) > 0) {
					gastosMes += Number(t.gasto.monto ?? 0);
				}

				if (Array.isArray(t.items)) {
					t.items.forEach(it=>{
					const prev = prodMap.get(it.producto) ?? {cantidad:0,total:0};
					prev.cantidad += Number(it.cantidad ?? 0);
					prev.total    += Number(it.total ?? 0);
					prodMap.set(it.producto, prev);
					});
				}
				});

				const ventasCaja = ventasEf + ventasNq;
				const balance    = ventasCaja - gastosMes;

				// 2.2 Cr√©dito originado en el mes (ventas creadas en Debe dentro del mes)
				const originadoMes = arr.reduce((s,t) =>
				(t.estadoPago === 'Debe') ? s + Number(t?.totales?.ventasBrutas ?? 0) : s, 0);

				// 2.3 Pendiente total acumulado al cierre + deudores (agrupados por cliente)
				const deudasDeNegocio = deudasCierre[neg] ?? [];
				const pendAcumCierre = deudasDeNegocio.reduce(
				(s,t)=> s + Number(t?.totales?.pendiente ?? 0), 0
				);
				const mapaClientes = new Map();
				deudasDeNegocio.forEach(t => {
				const pend = Number(t?.totales?.pendiente ?? 0);
				if (pend > 0) {
					const cliente = (t.cliente && String(t.cliente).trim()) ? t.cliente.trim() : 'Sin nombre';
					const prev = mapaClientes.get(cliente) ?? { originado:0, abonado:0, pendiente:0, ventas:0 };
					prev.pendiente += pend;
					prev.ventas += 1;
					mapaClientes.set(cliente, prev);
				}
				});
				const deudoresMes = [...mapaClientes.entries()]
				.map(([cliente, k]) => ({ cliente, originado: 0, abonado: 0, pendiente: k.pendiente }))
				.sort((a,b) => b.pendiente - a.pendiente);

				// 2.4 Persistir KPIs del negocio
				resumen.negocios[neg] = {
				ventas: ventasCaja,            // caja
				ventasBrutas: ventasBrutasMes, // entregadas (Pagado+Debe)
				gastos: gastosMes,
				balance,
				topProductos: [...prodMap.entries()]
					.map(([producto,i]) => ({producto, cantidad:i.cantidad, total:i.total}))
					.sort((a,b)=> b.total - a.total)
					.slice(0,10),
				cxc: {
					originadoMes,
					abonosAplicadosMes: 0, // si luego quieres contarlos, te paso el cruce por id
					pendienteOriginadoMes: Math.max(0, originadoMes - 0),
					pendienteTotalAcumulado: pendAcumCierre,
					deudoresMes
				}
				};

				resumen.global.ventas += ventasCaja;
				resumen.global.gastos += gastosMes;
			}
			resumen.global.balance = resumen.global.ventas - resumen.global.gastos;

			// 3) ==========================
			//          PDF
			// ==========================
			const { jsPDF } = window.jspdf;
			const doc = new jsPDF({ unit:'pt', format:'a4' });
			const margin = 36; // 0.5in
			const pageWidth  = doc.internal.pageSize.getWidth();
			const pageHeight = doc.internal.pageSize.getHeight();

			function header() {
				doc.setFillColor(102,126,234); // #667eea
				doc.rect(0,0,pageWidth,54,'F');
				doc.setFont('helvetica','bold');
				doc.setTextColor('#ffffff');
				doc.setFontSize(14);
				doc.text('Sistema de Contabilidad ‚Äî Informe mensual', margin, 28);
				doc.setFont('helvetica','normal');
				doc.setFontSize(11);
				doc.text(`${nombreMes(yyyyMM)} ¬∑ ${negocioSel==='Todos' ? 'Todos los negocios' : (nombresNegocios[negocioSel]||negocioSel)}`, margin, 46);
			}

			function footer() {
				const str = `Generado ${new Date().toLocaleString('es-CO')} ¬∑ P√°g. ${doc.internal.getNumberOfPages()}`;
				doc.setFontSize(9);
				doc.setTextColor('#777');
				doc.text(str, pageWidth - margin, pageHeight - 14, { align:'right' });
			}

			header();

			// Tabla Resumen por negocio (puedes a√±adir columna ‚ÄúVentas brutas‚Äù si quieres)
			const resumenRows = Object.entries(resumen.negocios).map(([neg, inf]) => ([
				(nombresNegocios[neg] || neg),
				COP(inf.ventas),               // caja
				`-${COP(inf.gastos)}`,
				COP(inf.balance)
			]));

			doc.autoTable({
				startY: 70,
				head: [['Negocio', 'Ventas (caja)', 'Gastos', 'Balance']],
				body: resumenRows,
				theme: 'striped',
				headStyles: { fillColor: [102,126,234] },
				styles: { fontSize: 9.5, cellPadding: 5 },
				columnStyles: { 1: { halign: 'right' }, 2: { halign: 'right' }, 3: { halign: 'right' } },
				didDrawPage: (data) => { if (data.pageNumber > 1) header(); },
				margin: { left: margin, right: margin }
			});

			// Totales globales
			const afterResumenY = doc.lastAutoTable?.finalY || 90;
			doc.setFontSize(11);
			doc.setTextColor('#333');
			doc.setFont('helvetica','bold');
			doc.text('Totales del per√≠odo:', margin, afterResumenY + 24);
			doc.setFont('helvetica','normal');
			doc.setTextColor('#000');
			doc.text(`Ventas (caja): ${COP(resumen.global.ventas)} ¬∑ Gastos: -${COP(resumen.global.gastos)} ¬∑ Balance: ${COP(resumen.global.balance)}`, margin, afterResumenY + 42);
			let yCursor = afterResumenY + 58;

			// Secciones por negocio (Top productos, Gastos por categor√≠a y CxC)
			for (const [neg, inf] of Object.entries(resumen.negocios)) {
				if (yCursor > pageHeight - 180) { doc.addPage(); header(); yCursor = 70; }

				doc.setFont('helvetica','bold');
				doc.setFontSize(12);
				doc.setTextColor('#333');
				doc.text(`‚Ä¢ ${nombresNegocios[neg] || neg}`, margin, yCursor);
				yCursor += 10;

				// KPIs cortos
				doc.setFont('helvetica','normal');
				doc.setFontSize(10);
				doc.text(`Ventas (caja): ${COP(inf.ventas)} ¬∑ Gastos: -${COP(inf.gastos)} ¬∑ Balance: ${COP(inf.balance)}`, margin, yCursor + 14);

				// Top productos
				const prodBody = (inf.topProductos.length ? inf.topProductos : [{producto:'(sin datos)',cantidad:0,total:0}])
				.map(p => [p.producto, String(p.cantidad), COP(p.total)]);
				doc.autoTable({
				startY: yCursor + 28,
				head: [['Top productos', 'Cant.', 'Total en Ventas']],
				body: prodBody,
				theme: 'grid',
				headStyles: { fillColor: [102,126,234] },
				styles: { fontSize: 9, cellPadding: 5 },
				columnStyles: { 1: { halign: 'center', cellWidth: 60 }, 2: { halign: 'right',  cellWidth: 80 } },
				margin: { left: margin, right: margin },
				didDrawPage: (data) => { if (data.pageNumber > 1) header(); }
				});

				const afterProdY = doc.lastAutoTable?.finalY || (yCursor + 28);

				// Gastos por categor√≠a (si no la calculas en la capa de datos, puedes dejar el placeholder)
				const gastosBody = (inf.gastosCat?.length ? inf.gastosCat : [{categoria:'(sin datos)', total:0}])
				.map(g => [g.categoria, `-${COP(g.total)}`]);
				doc.autoTable({
				startY: afterProdY + 12,
				head: [['Gastos por categor√≠a', 'Total']],
				body: gastosBody,
				theme: 'grid',
				headStyles: { fillColor: [220,53,69] }, // rojo
				styles: { fontSize: 9, cellPadding: 5 },
				columnStyles: { 1: { halign: 'right', cellWidth: 100 } },
				margin: { left: margin, right: margin },
				didDrawPage: (data) => { if (data.pageNumber > 1) header(); }
				});

				// CxC (del per√≠odo): KPIs + Tabla de deudores (ya vienen en inf.cxc)
				yCursor = doc.lastAutoTable?.finalY + 22;
				const k = inf.cxc || { originadoMes:0, abonosAplicadosMes:0, pendienteOriginadoMes:0, pendienteTotalAcumulado:0, deudoresMes:[] };
				if (yCursor > pageHeight - 180) { doc.addPage(); header(); yCursor = 70; }

				doc.setFont('helvetica','bold');
				doc.setFontSize(11);
				doc.text('Cuentas por Cobrar (estado del per√≠odo)', margin, yCursor);
				doc.setFont('helvetica','normal');
				doc.setFontSize(10);

				const cxcRows = [
				['Cr√©dito originado en el mes',            COP(k.originadoMes)],
				['Abonos aplicados a ese cr√©dito (mes)',   `-${COP(k.abonosAplicadosMes)}`],
				['Pendiente al cierre (de lo originado)',  COP(k.pendienteOriginadoMes)],
				['Pendiente total acumulado al cierre',    COP(k.pendienteTotalAcumulado)]
				];
				doc.autoTable({
				startY: yCursor + 10,
				head: [['Concepto', 'Valor']],
				body: cxcRows,
				theme: 'grid',
				headStyles: { fillColor: [52,58,64] }, // gris oscuro
				styles: { fontSize: 9, cellPadding: 5 },
				columnStyles: { 1: { halign: 'right', cellWidth: 180 } },
				margin: { left: margin, right: margin },
				didDrawPage: (data) => { if (data.pageNumber > 1) header(); }
				});

				const afterCxcY = doc.lastAutoTable?.finalY || (yCursor + 10);

				if (k.deudoresMes && k.deudoresMes.length) {
				if (afterCxcY > pageHeight - 160) { doc.addPage(); header(); }
				const bodyDeud = k.deudoresMes.slice(0, 10).map(d => [
					d.cliente,
					COP(d.originado),
					`-${COP(d.abonado)}`,
					COP(d.pendiente)
				]);
				doc.autoTable({
					startY: Math.max(afterCxcY + 12, 70),
					head: [['Top deudores del mes', 'Originado', 'Abonado', 'Pendiente']],
					body: bodyDeud,
					theme: 'grid',
					headStyles: { fillColor: [220,53,69] },
					styles: { fontSize: 9, cellPadding: 5 },
					columnStyles: {
					1: { halign: 'right', cellWidth: 90 },
					2: { halign: 'right', cellWidth: 90 },
					3: { halign: 'right', cellWidth: 90 }
					},
					margin: { left: margin, right: margin },
					didDrawPage: (data) => { if (data.pageNumber > 1) header(); }
				});
				yCursor = doc.lastAutoTable?.finalY + 22;
				} else {
				yCursor = afterCxcY + 18;
				}
			}

			// Footer en todas las p√°ginas
			const totalPages = doc.internal.getNumberOfPages();
			for (let i=1; i<=totalPages; i++) {
				doc.setPage(i);
				footer();
			}

			const fileName = `informe_mensual_${yyyyMM}${negocioSel==='Todos' ? '' : '_' + negocioSel}.pdf`;
			doc.save(fileName);
		}

		/*// ===== Helpers de fechas para el per√≠odo en Informes =====
		function primerDiaMesActualISO() {
			const d = new Date();
			const y = d.getFullYear();
			const m = d.getMonth() + 1;
			return `${y}-${String(m).padStart(2,'0')}-01`;
		}
		function esFechaEnRango(fechaISO, desdeISO, hastaISO) {
			if (!fechaISO) return false;
			if (desdeISO && fechaISO < desdeISO) return false;
			if (hastaISO && fechaISO > hastaISO) return false;
			return true;
		}*/

		// ===== Previsualizaci√≥n del PER√çODO dentro de Informes (r√©plica de Resumen Diario) =====
		async function previsualizarPeriodoInforme() {
			const desde = document.getElementById('infDesdePeriodo').value;
			const hasta = document.getElementById('infHastaPeriodo').value;
			const soloDeudas = !!document.getElementById('infSoloDeudasPeriodo')?.checked;
			const negocioSel = document.getElementById('infNegocioReporte')?.value ?? 'Todos';
			if (!desde || !hasta) { mostrarError('Selecciona un rango de fechas v√°lido.'); return; }
			if (hasta < desde) { mostrarError('La fecha final no puede ser menor a la inicial.'); return; }

			const datosTx = await fetchTxPorRango(desde, hasta, negocioSel);
			const container = document.getElementById('previewPeriodoInforme');
			let html = '';

			const negocios = (negocioSel === 'Todos') ? Object.keys(datosTx) : [negocioSel];
			for (const neg of negocios) {
				const arr = (datosTx[neg] ?? []).filter(t => t.fecha >= desde && t.fecha <= hasta);

				let ventasEf=0, ventasNq=0, gastos=0;
				arr.forEach(t=>{
				const vb = Number(t?.totales?.ventasBrutas ?? 0);
				if (t.estadoPago === 'Pagado' && vb>0) {
					if (t.metodoVenta === 'Efectivo') ventasEf += vb;
					if (t.metodoVenta === 'Nequi')    ventasNq += vb;
				}
				if (Array.isArray(t.pagos)) {
					t.pagos.forEach(p=>{
					if (p.fecha>=desde && p.fecha<=hasta) {
						const m = Number(p.monto ?? 0);
						if (p.metodo==='Efectivo') ventasEf += m;
						if (p.metodo==='Nequi')    ventasNq += m;
					}
					});
				}
				if (t.gasto && Number(t.gasto.monto ?? 0)>0) gastos += Number(t.gasto.monto ?? 0);
				});

				const totalVentas = ventasEf + ventasNq;
				const balance = totalVentas - gastos;
				const saldoEf = ventasEf - gastos; // (gastos no discriminados por m√©todo en este resumen)
				const saldoNq = ventasNq;

				const txParaTabla = soloDeudas
				? arr.filter(t => t.estadoPago === 'Debe' && Number(t?.totales?.pendiente ?? 0) > 0)
				: arr;

				html += `
				<div class="business-section">
					<h4>${nombresNegocios[neg]}</h4>
					<div class="summary-grid">
					<div class="summary-box"><h4>Ventas (caja)</h4><div class="value" style="color:#007bff;">${COP(totalVentas)}</div></div>
					<div class="summary-box"><h4>Gastos</h4><div class="value" style="color:#dc3545;">-${COP(gastos)}</div></div>
					<div class="summary-box" style="border-color:#667eea;background:#f0f4ff;">
						<h4>Balance del Per√≠odo</h4><div class="value" style="color:#667eea;">${COP(balance)}</div>
					</div>
					</div>
					<hr style="margin:15px 0;">
					<div style="display:flex;justify-content:space-between;">
					<div>üíµ <strong>Saldo en Efectivo:</strong><br><span style="color:#28a745;font-weight:bold;">${COP(saldoEf)}</span></div>
					<div>üì± <strong>Saldo en Nequi:</strong><br><span style="color:#007bff;font-weight:bold;">${COP(saldoNq)}</span></div>
					</div>
					${
					txParaTabla.length > 0
						? `<div class="table-responsive"><table class="tabla-registros">
							${generarTablaTransacciones(txParaTabla, { mostrarAcciones: false })}
						</table></div>`
						: '<p style="color:#999;margin-top:15px;">No hay transacciones para este per√≠odo</p>'
					}
					${agruparPlatosDesdeTransacciones(arr)}
				</div>
				`;
			}
			container.innerHTML = html || '<p>No hay datos</p>';
			try { await renderCxcPeriodoEnInformes(); } catch (e) {}
		}

		// ===== CxC del PER√çODO dentro de Informes (basado en TRANSACCIONES) =====
		async function renderCxcPeriodoEnInformes() {
			const cont = document.getElementById('infCxcPeriodo');
			if (!cont) return;

			const negocioSel = document.getElementById('infNegocioReporte')?.value || 'Todos';
			const acumulado = !!document.getElementById('infCxcAcumuladoPeriodo')?.checked;

			let desde, hasta;
			if (acumulado) {
				desde = '2000-01-01';
				hasta = hoyLocalISO();
			} else {
				desde = document.getElementById('infDesdePeriodo').value;
				hasta = document.getElementById('infHastaPeriodo').value;
				if (!desde || !hasta || hasta < desde) {
				cont.innerHTML = '<p style="color:#999;">Define un rango v√°lido para ver CxC del per√≠odo.</p>';
				return;
				}
			}

			// Leer transacciones en Debe dentro del rango/negocio
			const datos = await fetchDeudasTx(negocioSel, { desdeISO: desde, hastaISO: hasta });

			const mapaClientes = new Map();
			let totalGeneral = 0;
			let totalVentasPendientes = 0;

			const negocios = (negocioSel === 'Todos') ? Object.keys(datos) : [negocioSel];
			for (const neg of negocios) {
				const registros = datos[neg] || [];
				registros.forEach(t => {
				if (t.estadoPago === 'Debe') {
					const pendiente = Number(t?.totales?.pendiente ?? 0);
					if (pendiente > 0) {
					const cliente = (t.cliente && String(t.cliente).trim()) ? t.cliente.trim() : 'Sin nombre';
					const prev = mapaClientes.get(cliente) || { totalPendiente: 0, cantidadVentas: 0 };
					prev.totalPendiente += pendiente;
					prev.cantidadVentas += 1;
					mapaClientes.set(cliente, prev);

					totalGeneral += pendiente;
					totalVentasPendientes += 1;
					}
				}
				});
			}

			const filas = [...mapaClientes.entries()]
				.sort((a,b) => b[1].totalPendiente - a[1].totalPendiente)
				.map(([cliente, info]) => `
				<tr>
					<td>${cliente}</td>
					<td style="text-align:center;">${info.cantidadVentas}</td>
					<td style="text-align:right;">${COP(info.totalPendiente)}</td>
				</tr>
				`).join('');

			const clientesUnicos = mapaClientes.size;
			const tituloNegocio = (negocioSel === 'Todos') ? 'Acumulado' : (nombresNegocios[negocioSel] || negocioSel);

			cont.innerHTML = `
				<div class="business-section" style="border-left-color:#dc3545;">
				<h3>üí≥ Cuentas por Cobrar (${acumulado ? 'Acumulado' : 'Del per√≠odo'} ‚Äî ${tituloNegocio})</h3>
				<div class="summary-grid">
					<div class="summary-box"><h4>Total por Cobrar</h4><div class="value" style="color:#dc3545;">${COP(totalGeneral)}</div></div>
					<div class="summary-box"><h4>Clientes con deuda</h4><div class="value">${clientesUnicos}</div></div>
					<div class="summary-box"><h4>Ventas pendientes</h4><div class="value">${totalVentasPendientes}</div></div>
				</div>
				${
					clientesUnicos > 0
					? `<table>
						<thead><tr><th>Cliente</th><th style="width:140px;"># Ventas</th><th style="width:200px;">Total Pendiente (COP)</th></tr></thead>
						<tbody>${filas}</tbody>
						</table>`
					: '<p style="color:#28a745;margin-top:10px;">No hay deudas pendientes. ‚úÖ</p>'
				}
				</div>
			`;
		}

		function getNotaTransaccion(t) {
			try {
				const COPfmt = (n) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(Number(n || 0));
				const ventasBrutas = Number(t?.totales?.ventasBrutas ?? 0);
				const pendiente    = Number(t?.totales?.pendiente ?? 0);

				// 1) ¬øHay pagos? -> tomar el m√°s reciente
				if (Array.isArray(t?.pagos) && t.pagos.length > 0) {
				// preferimos el que tenga mayor ts (ISO) o el √∫ltimo del array
				let last = null;
				const conTs = t.pagos.filter(p => !!p.ts);
				if (conTs.length > 0) {
					last = conTs.reduce((acc, cur) => (!acc || String(cur.ts) > String(acc.ts)) ? cur : acc, null);
				} else {
					last = t.pagos[t.pagos.length - 1];
				}
				if (last) {
					if (last.descripcion && String(last.descripcion).trim()) return last.descripcion.trim();
					const tipoTxt = (last.tipo === 'total') ? 'Pago total' : 'Pago parcial';
					return `${tipoTxt} de ${COPfmt(Number(last.monto || 0))} con ${last.metodo}`;
				}
				}

				// 2) Sin pagos: si fue "Pagado", mostrar m√©todoVenta y total
				if (t?.estadoPago === 'Pagado' && ventasBrutas > 0) {
				const etiqueta = (t.metodoVenta === 'Efectivo') ? 'Efectivo'
								: (t.metodoVenta === 'Nequi')    ? 'Nequi'
								: (t.metodoVenta || 'M√©todo');
				return `Venta pagada con ${etiqueta} (${COPfmt(ventasBrutas)})`;
				}

				// 3) Si est√° en "Debe" y no hay pagos
				if (t?.estadoPago === 'Debe') {
				return `Venta a cr√©dito (pendiente: ${COPfmt(pendiente > 0 ? pendiente : ventasBrutas)})`;
				}

				// 4) Si hay gasto y tiene descripci√≥n, √∫sala como nota de respaldo
				if (t?.gasto && t.gasto.descripcion && String(t.gasto.descripcion).trim()) {
				return t.gasto.descripcion.trim();
				}

				return '-';
			} catch {
				return '-';
			}
		}

		// ===== PDF del PER√çODO (compacto: KPIs + Top productos) =====
		// ===== PDF del PER√çODO (TX) =====
		async function exportarInformePeriodoPDF() {
			const desde = document.getElementById('infDesdePeriodo').value;
			const hasta = document.getElementById('infHastaPeriodo').value;
			const negocioSel = document.getElementById('infNegocioReporte')?.value ?? 'Todos';
			const incluirDetalle = !!document.getElementById('infIncluirDetalle')?.checked;

			if (!desde || !hasta || hasta < desde) {
				mostrarError('Selecciona un rango v√°lido.');
				return;
			}

			// ========= CAPA DE DATOS (TX) =========
			// Cargamos s√≥lo transacciones del rango (por negocio si aplica)
			const datosTx = await fetchTxPorRango(desde, hasta, negocioSel); // {Negocio1:[...], ...}
			const negocios = (negocioSel === 'Todos') ? Object.keys(datosTx) : [negocioSel];

			const kpis = {};              // { NegocioX: { ventas, gastos, balance, topProductos:[] } }
			const detallePorNegocio = {}; // { NegocioX: [transacciones del rango] }

			for (const neg of negocios) {
				const arr = (datosTx[neg] ?? []).filter(t => t.fecha && t.fecha >= desde && t.fecha <= hasta);
				detallePorNegocio[neg] = arr;

				let vEf = 0, vNq = 0, g = 0;
				const prodMap = new Map();

				arr.forEach(t => {
				const vb = Number(t?.totales?.ventasBrutas ?? 0);

				// Ventas ‚ÄúPagado‚Äù por m√©todoVenta
				if (t.estadoPago === 'Pagado' && vb > 0) {
					if (t.metodoVenta === 'Efectivo') vEf += vb;
					if (t.metodoVenta === 'Nequi')    vNq += vb;
				}
				// Abonos dentro del rango
				if (Array.isArray(t.pagos)) {
					t.pagos.forEach(p => {
					if (p.fecha >= desde && p.fecha <= hasta) {
						const m = Number(p.monto ?? 0);
						if (p.metodo === 'Efectivo') vEf += m;
						if (p.metodo === 'Nequi')    vNq += m;
					}
					});
				}
				// Gastos del rango
				if (t.gasto && Number(t.gasto.monto ?? 0) > 0) {
					g += Number(t.gasto.monto ?? 0);
				}
				// Top productos (por √≠tems entregados)
				if (Array.isArray(t.items)) {
					t.items.forEach(i => {
					const prev = prodMap.get(i.producto) ?? { cantidad:0, total:0 };
					prev.cantidad += Number(i.cantidad ?? 0);
					prev.total    += Number(i.total ?? 0);
					prodMap.set(i.producto, prev);
					});
				}
				});

				const ventas  = vEf + vNq;
				const balance = ventas - g;
				const top     = [...prodMap.entries()]
								.map(([producto, info]) => ({ producto, cantidad: info.cantidad, total: info.total }))
								.sort((a,b) => b.total - a.total)
								.slice(0, 10);

				kpis[neg] = { ventas, gastos: g, balance, topProductos: top };
			}

			// ========= RENDER PDF (igual estilo que usas) =========
			const { jsPDF } = window.jspdf;
			const doc = new jsPDF({
				orientation: incluirDetalle ? 'landscape' : 'portrait',
				unit: 'pt',
				format: 'a4'
			});
			const margin = 36;
			const pageWidth  = doc.internal.pageSize.getWidth();
			const pageHeight = doc.internal.pageSize.getHeight();

			function header() {
				doc.setFillColor(102,126,234);
				doc.rect(0,0,pageWidth,54,'F');
				doc.setFont('helvetica','bold'); doc.setTextColor('#fff'); doc.setFontSize(14);
				doc.text('Sistema de Contabilidad ‚Äî Resumen por Per√≠odo', margin, 28);
				doc.setFont('helvetica','normal'); doc.setFontSize(11);
				const tituloNegocio = (negocioSel === 'Todos') ? 'Todos los negocios' : (nombresNegocios[negocioSel] ?? negocioSel);
				doc.text(`Del ${desde} al ${hasta} ¬∑ ${tituloNegocio}`, margin, 46);
			}
			function footer() {
				const str = `Generado ${new Date().toLocaleString('es-CO')} ¬∑ P√°g. ${doc.internal.getNumberOfPages()}`;
				doc.setFontSize(9); doc.setTextColor('#777');
				doc.text(str, pageWidth - margin, pageHeight - 14, { align:'right' });
			}

			header();

			// ========== Tabla Resumen por negocio ==========
			const resumenRows = Object.entries(kpis).map(([neg, inf]) => [
				(nombresNegocios[neg] ?? neg), COP(inf.ventas), `-${COP(inf.gastos)}`, COP(inf.balance)
			]);
			doc.autoTable({
				startY: 70,
				head: [['Negocio', 'Ventas (caja)', 'Gastos', 'Balance']],
				body: resumenRows,
				theme: 'striped',
				headStyles: { fillColor: [102,126,234] },
				styles: { fontSize: 10, cellPadding: 6 },
				columnStyles: { 1:{halign:'right'}, 2:{halign:'right'}, 3:{halign:'right'} },
				didDrawPage: (data) => { if (data.pageNumber > 1) header(); },
				margin: { left: margin, right: margin }
			});

			let y = (doc.lastAutoTable?.finalY || 90) + 16;

			// ========== Por negocio: KPIs + Top productos ==========
			for (const [neg, inf] of Object.entries(kpis)) {
				if (y > pageHeight - 160) { doc.addPage(); header(); y = 70; }
				doc.setFont('helvetica','bold'); doc.setFontSize(12); doc.setTextColor('#333');
				doc.text(`${nombresNegocios[neg] ?? neg}`, margin, y);
				doc.setFont('helvetica','normal'); doc.setFontSize(10);
				doc.text(`Ventas (caja): ${COP(inf.ventas)} ¬∑ Gastos: -${COP(inf.gastos)} ¬∑ Balance: ${COP(inf.balance)}`, margin, y + 14);

				// Top productos
				const bodyTop = (inf.topProductos.length ? inf.topProductos : [{producto:'(sin datos)', cantidad:0, total:0}])
								.map(p => [p.producto, String(p.cantidad), COP(p.total)]);
				doc.autoTable({
				startY: y + 28,
				head: [['Top productos', 'Cant.', 'Ventas']],
				body: bodyTop,
				theme: 'grid',
				headStyles: { fillColor: [102,126,234] },
				styles: { fontSize: 9, cellPadding: 5 },
				columnStyles: { 1:{ halign:'center', cellWidth: 60 }, 2:{ halign:'right', cellWidth: 80 } },
				margin: { left: margin, right: margin },
				didDrawPage: (data) => { if (data.pageNumber > 1) header(); }
				});
				y = doc.lastAutoTable?.finalY + 18;

				// ========== (Opcional) DETALLE 12 columnas ==========
				if (incluirDetalle) {
				const registros = detallePorNegocio[neg] ?? [];
				const filasDetalle = registros.flatMap(t => {
					const base = [];
					if (Array.isArray(t.items) && t.items.length) {
					return t.items.map(i => ([
						t.fecha ?? '',                                  // Fecha
						i.producto ?? '-',                              // Producto
						(i.cantidad ?? '-').toString(),                 // Cant.
						(i.precioUnitario != null ? COP(i.precioUnitario) : '-'), // Precio
						COP(Number(i.total ?? 0)),                      // Ventas
						(t.gasto && t.gasto.monto ? '-' + COP(Number(t.gasto.monto)) : '-$0'), // Gasto (si aplica a la tx)
						(t.metodoVenta ?? ''),                          // M√©todo venta
						(t.estadoPago ?? ''),                           // Estado
						(t.cliente ?? ''),                              // Cliente
						(t.gasto?.descripcion ?? ''),                   // Descripci√≥n (gasto)
						(t.estadoPago === 'Debe' ? COP(Number(t?.totales?.pendiente ?? i.total ?? 0)) : '-') // Pendiente
					]));
					} else {
					// TX sin items: crea una fila neutra
					base.push([
						t.fecha ?? '', '-', '-', '-', COP(Number(t?.totales?.ventasBrutas ?? 0)),
						(t.gasto && t.gasto.monto ? '-' + COP(Number(t.gasto.monto)) : '-$0'),
						(t.metodoVenta ?? ''), (t.estadoPago ?? ''), (t.cliente ?? ''), (t.gasto?.descripcion ?? ''), 
						(t.estadoPago === 'Debe' ? COP(Number(t?.totales?.pendiente ?? 0)) : '-')
					]);
					return base;
					}
				});

				// ====== (Dentro de exportarInformePeriodoPDF) construir DETALLE ======
				if (incluirDetalle) {
					const registros = detallePorNegocio[neg] ?? [];

					// Build rows usando NOTAS en vez de Descripci√≥n
					const filasDetalle = registros.flatMap(t => {
						const nota = getNotaTransaccion(t); // üëà NUEVO
						// Si hay items, una fila por √≠tem (con misma nota de la transacci√≥n)
						if (Array.isArray(t.items) && t.items.length) {
						return t.items.map(i => ([
							t.fecha ?? '',                              // Fecha
							i.producto ?? '-',                          // Producto
							(i.cantidad ?? '-').toString(),             // Cant.
							(i.precioUnitario != null ? COP(i.precioUnitario) : '-'), // Precio
							COP(Number(i.total ?? 0)),                  // Ventas
							(t.gasto && t.gasto.monto ? '-' + COP(Number(t.gasto.monto)) : '-$0'), // Gastos
							(t.metodoVenta ?? ''),                      // M√©todo
							(t.estadoPago ?? ''),                       // Estado
							(t.cliente ?? ''),                          // Cliente
							nota,                                       // üëà NOTAS (no descripci√≥n del gasto)
							(t.estadoPago === 'Debe' ? COP(Number(t?.totales?.pendiente ?? i.total ?? 0)) : '-') // Pendiente
						]));
						} else {
						// Transacci√≥n sin √≠tems: fila √∫nica con totales y la nota
						return [[
							t.fecha ?? '', '-', '-', '-',
							COP(Number(t?.totales?.ventasBrutas ?? 0)), // Ventas
							(t.gasto && t.gasto.monto ? '-' + COP(Number(t.gasto.monto)) : '-$0'),
							(t.metodoVenta ?? ''), (t.estadoPago ?? ''), (t.cliente ?? ''),
							nota,                                        // üëà NOTAS aqu√≠ tambi√©n
							(t.estadoPago === 'Debe' ? COP(Number(t?.totales?.pendiente ?? 0)) : '-')
						]];
						}
					});

					if (y > pageHeight - 120) { doc.addPage(); header(); y = 70; }
					doc.setFont('helvetica','bold'); doc.setFontSize(11);
					doc.text('Detalle de registros del per√≠odo', margin, y);
					y += 6;
					doc.autoTable({
						startY: y + 8,
						head: [[
						'Fecha','Producto','Cant.','Precio','Ventas','Gastos',
						'M√©todo','Estado','Cliente','Notas','Pendiente' // üëà Cambiado a ‚ÄúNotas‚Äù
						]],
						body: filasDetalle,
						theme: 'grid',
						headStyles: { fillColor: [52,58,64], textColor: 255 },
						styles: { fontSize: 8.5, cellPadding: 4, overflow: 'linebreak' },
						columnStyles: {
						0:{cellWidth:60}, 1:{cellWidth:115}, 2:{cellWidth:35, halign:'right'},
						3:{cellWidth:60, halign:'right'}, 4:{cellWidth:70, halign:'right'},
						5:{cellWidth:55, halign:'right'}, 6:{cellWidth:60},
						7:{cellWidth:55}, 8:{cellWidth:90},
						9:{cellWidth:110},                    // üëà ancho para NOTAS
						10:{cellWidth:60, halign:'right'}
						},
						margin: { left: margin, right: margin },
						didDrawPage: (data) => { if (data.pageNumber > 1) header(); }
					});
					y = doc.lastAutoTable?.finalY + 18;
				}
				}
			}

			// Footer en todas las p√°ginas
			const totalPages = doc.internal.getNumberOfPages();
			for (let i=1;i<=totalPages;i++){ doc.setPage(i); footer(); }

			const sufijo = (negocioSel === 'Todos') ? 'Todos' : negocioSel;
			doc.save(`informe_periodo_${desde}_a_${hasta}_${sufijo}.pdf`);
		}

		// ====== Helpers ======
		function esFechaEnRango(fechaISO, desdeISO, hastaISO) {
			if (!fechaISO) return false;
			if (desdeISO && fechaISO < desdeISO) return false;
			if (hastaISO && fechaISO > hastaISO) return false;
			return true;
		}
		function primerDiaMesActualISO() {
			const d = new Date(); const y = d.getFullYear(); const m = d.getMonth()+1;
			return `${y}-${String(m).padStart(2,'0')}-01`;
		}

		// ====== C√°lculo del P&L (base caja) ======
		/*
		Devuelve:
		{
			global: { ventasEf, ventasNq, abonosEf, abonosNq, ventasTotales, gastos, costos, utilidad, capitalInformativo },
			negocios: {
			NegocioX: {
				ventasEf, ventasNq, abonosEf, abonosNq, ventasTotales, gastos, costos, utilidad,
				topProductos:[], gastosCat:[]
			}, ...
			}
		}
		*/
		async function construirPL(desdeISO, hastaISO, negocioSel='Todos', incluirCostos=false) {
			const datos = await fetchTxPorRango(desdeISO, hastaISO, negocioSel); // ‚Üê usar par√°metros
			const negocios = (negocioSel === 'Todos') ? Object.keys(datos) : [negocioSel];

			const result = {
				global: {
					ventasEf:0, ventasNq:0, abonosEf:0, abonosNq:0,
					ventasTotales:0, gastos:0, costos:0, utilidad:0,
					capitalInformativo: 0 // suma de capital inicial de los negocios filtrados (solo informativo)
				},
				negocios: {}
			};

			for (const neg of negocios) {
				const regs = (datos[neg] || []).filter(r => esFechaEnRango(r.fecha, desdeISO, hastaISO));

				// Capital inicial (solo para nota, no entra al P&L)
				const capEf = Number(saldoInicial[neg]?.efectivo || 0);
				const capNq = Number(saldoInicial[neg]?.nequi || 0);
				const capitalInformativo = capEf + capNq;
				result.global.capitalInformativo += capitalInformativo;

				// Ventas pagadas (con m√©todo) ‚Äî base caja
				let ventasEf = 0, ventasNq = 0;
				regs.forEach(r => {
				if (r.tipo === 'movimiento' &&
					Number(r.ventas||0) > 0 &&
					(r.estadoPago === 'Pagado' || r.estadoPago == null) &&
					r.excluirDeAnalisis !== true) {
					if (r.metodo === 'Efectivo') ventasEf += Number(r.ventas||0);
					if (r.metodo === 'Nequi')    ventasNq += Number(r.ventas||0);
				}
				});

				// Abonos del per√≠odo (siempre entran a caja)
				let abonosEf = 0, abonosNq = 0;
				regs.forEach(r => {
				if (r.tipo === 'movimiento' && r.esAbono === true && Number(r.ventas||0) > 0) {
					if (r.metodo === 'Efectivo') abonosEf += Number(r.ventas||0);
					if (r.metodo === 'Nequi')    abonosNq += Number(r.ventas||0);
				}
				});

				const ventasTotales = ventasEf + ventasNq + abonosEf + abonosNq;

				// Gastos del per√≠odo (cualquier m√©todo)
				const gastos = regs.reduce((sum, r) =>
				(r.tipo === 'movimiento') ? sum + Number(r.gastos||0) : sum
				, 0);

				// Costos del per√≠odo ‚Äî por ahora 0 (hook futuro)
				const costos = incluirCostos ? 0 : 0;

				const utilidad = ventasTotales - gastos - costos;

				// Top productos (ventas por producto en el per√≠odo, no cuenta abonos)
				const mapaProd = new Map();
				regs.forEach(r => {
				if (r.tipo === 'movimiento' && r.producto && r.cantidad && Number(r.ventas||0) > 0 && r.esAbono !== true) {
					const prev = mapaProd.get(r.producto) || { cantidad:0, total:0 };
					prev.cantidad += Number(r.cantidad)||0;
					prev.total    += Number(r.ventas)||0;
					mapaProd.set(r.producto, prev);
				}
				});
				const topProductos = [...mapaProd.entries()]
				.map(([producto,info]) => ({ producto, cantidad: info.cantidad, total: info.total }))
				.sort((a,b)=> b.total - a.total).slice(0,10);

				// Gastos por categor√≠a (descripci√≥n)
				const mapaCat = new Map();
				regs.forEach(r => {
				const g = Number(r.gastos||0);
				if (r.tipo === 'movimiento' && g > 0) {
					const cat = ((r.descripcion || 'Sin descripci√≥n').trim() || 'Sin descripci√≥n');
					mapaCat.set(cat, (mapaCat.get(cat)||0) + g);
				}
				});
				const gastosCat = [...mapaCat.entries()]
				.map(([categoria, total]) => ({ categoria, total }))
				.sort((a,b)=> b.total - a.total).slice(0,10);

				result.negocios[neg] = {
				ventasEf, ventasNq, abonosEf, abonosNq, ventasTotales, gastos, costos, utilidad,
				topProductos, gastosCat, capitalInformativo
				};

				// Global
				result.global.ventasEf += ventasEf;
				result.global.ventasNq += ventasNq;
				result.global.abonosEf += abonosEf;
				result.global.abonosNq += abonosNq;
				result.global.ventasTotales += ventasTotales;
				result.global.gastos += gastos;
				result.global.costos += costos;
				result.global.utilidad += utilidad;
			}

			return result;
		}

		// ====== Previsualizaci√≥n HTML ======
		// === Previsualizaci√≥n Estado de Resultados (P&L) ‚Äî BASE CAJA ===
		// Ventas (caja) = Ventas "Pagado" por metodoVenta + Abonos del per√≠odo
		// Gastos = sum(t.gasto.monto) del per√≠odo
		// Costos = 0 (hasta que tengas fuente de costos)
		// Notas: muestra capital inicial (informativo), no entra en utilidad.

		async function previsualizarPL() {
			try {
				const desde = document.getElementById('plDesde')?.value;
				const hasta = document.getElementById('plHasta')?.value;
				const negocioSel = document.getElementById('plNegocio')?.value ?? 'Todos';
				const incluirCostos = !!document.getElementById('plIncluirCostos')?.checked;
				const cont = document.getElementById('plPreview');

				if (!desde || !hasta || hasta < desde) {
				cont.innerHTML = `<div class="error-message" style="display:block;">Selecciona un rango v√°lido.</div>`;
				return;
				}

				// === CAPA DE DATOS (Transacciones) ===
				// Estructura agregada similar a exportarPLPDF()
				const datosTx = await fetchTxPorRango(desde, hasta, negocioSel); // {Negocio1:[...], ...}
				const negocios = (negocioSel === 'Todos') ? Object.keys(datosTx) : [negocioSel];

				const pl = {
				global: {
					ventasEf:0, ventasNq:0, abonosEf:0, abonosNq:0,
					ventasTotales:0, gastos:0, costos:0, utilidad:0,
					capitalInformativo: 0
				},
				negocios: {}
				};

				for (const neg of negocios) {
				const regs = (datosTx[neg] ?? []).filter(r => r.fecha && r.fecha >= desde && r.fecha <= hasta);

				// Capital inicial (informativo)
				const capEf = Number(saldoInicial[neg]?.efectivo ?? 0);
				const capNq = Number(saldoInicial[neg]?.nequi ?? 0);
				const capitalInformativo = capEf + capNq;
				pl.global.capitalInformativo += capitalInformativo;

				let ventasEf=0, ventasNq=0, abonosEf=0, abonosNq=0, gastos=0, costos=0;

				const prodMap = new Map();     // top productos
				const gastoCatMap = new Map(); // gastos por categor√≠a (usaremos descripci√≥n como categor√≠a simple)

				regs.forEach(r => {
					const vb = Number(r?.totales?.ventasBrutas ?? 0);

					// Ventas "Pagado" por metodoVenta
					if (r.estadoPago === 'Pagado' && vb > 0) {
					if (r.metodoVenta === 'Efectivo') ventasEf += vb;
					if (r.metodoVenta === 'Nequi')    ventasNq += vb;
					}

					// Abonos del per√≠odo (pagos[])
					if (Array.isArray(r.pagos)) {
					r.pagos.forEach(p => {
						if (p.fecha >= desde && p.fecha <= hasta) {
						const m = Number(p.monto ?? 0);
						if (p.metodo === 'Efectivo') abonosEf += m;
						if (p.metodo === 'Nequi')    abonosNq += m;
						}
					});
					}

					// Gastos del per√≠odo
					if (r.gasto && Number(r.gasto.monto ?? 0) > 0) {
					const g = Number(r.gasto.monto ?? 0);
					gastos += g;
					const cat = (r.gasto.descripcion && String(r.gasto.descripcion).trim()) || 'Gasto';
					gastoCatMap.set(cat, (gastoCatMap.get(cat) ?? 0) + g);
					}

					// Top productos a partir de items[]
					if (Array.isArray(r.items)) {
					r.items.forEach(i => {
						const prev = prodMap.get(i.producto) ?? { cantidad:0, total:0 };
						prev.cantidad += Number(i.cantidad ?? 0);
						prev.total    += Number(i.total ?? 0);
						prodMap.set(i.producto, prev);
					});
					}
				});

				if (incluirCostos) {
					// Si m√°s adelante cargas costos por √≠tem/producto, s√∫malos aqu√≠:
					costos = 0;
				}

				const ingresos = (ventasEf + ventasNq) + (abonosEf + abonosNq); // base caja
				const utilidad = ingresos - (gastos + costos);

				// Armar vista por negocio
				const topProductos = [...prodMap.entries()]
					.map(([producto, info]) => ({ producto, cantidad: info.cantidad, total: info.total }))
					.sort((a,b)=> b.total - a.total)
					.slice(0, 10);

				const gastosCat = [...gastoCatMap.entries()]
					.map(([categoria, total]) => ({ categoria, total }))
					.sort((a,b)=> b.total - a.total)
					.slice(0, 10);

				pl.negocios[neg] = {
					ventasEf, ventasNq, abonosEf, abonosNq,
					ventasTotales: ingresos,
					gastos, costos, utilidad,
					topProductos, gastosCat,
					capitalInformativo
				};

				// Sumar a la banda global
				pl.global.ventasEf      += ventasEf;
				pl.global.ventasNq      += ventasNq;
				pl.global.abonosEf      += abonosEf;
				pl.global.abonosNq      += abonosNq;
				pl.global.gastos        += gastos;
				pl.global.costos        += costos;
				pl.global.ventasTotales += ingresos;
				}
				pl.global.utilidad = pl.global.ventasTotales - (pl.global.gastos + pl.global.costos);

				// === RENDER HTML de la previsualizaci√≥n ===
				const COPfmt = (n) => new Intl.NumberFormat('es-CO', { style:'currency', currency:'COP', minimumFractionDigits:0, maximumFractionDigits:0 }).format(Number(n||0));
				const tituloNegocio = (negocioSel === 'Todos') ? 'Todos los negocios' : (nombresNegocios[negocioSel] ?? negocioSel);

				let html = `
				<div class="business-section">
					<h4>Estado de Resultados (base caja) ¬∑ ${tituloNegocio}</h4>
					<div class="summary-grid">
					<div class="summary-box">
						<h4>Ingresos</h4>
						<div class="value" style="color:#007bff;">${COPfmt(pl.global.ventasTotales)}</div>
						<div style="font-size:12px;color:#666;margin-top:6px;">
						Efectivo: ${COPfmt(pl.global.ventasEf + pl.global.abonosEf)} ¬∑ Nequi: ${COPfmt(pl.global.ventasNq + pl.global.abonosNq)}
						</div>
					</div>
					<div class="summary-box">
						<h4>Gastos</h4>
						<div class="value" style="color:#dc3545;">-${COPfmt(pl.global.gastos)}</div>
					</div>
					<div class="summary-box">
						<h4>Utilidad</h4>
						<div class="value" style="color:${pl.global.utilidad>=0 ? '#28a745':'#dc3545'}">${COPfmt(pl.global.utilidad)}</div>
						<div style="font-size:12px;color:#666;margin-top:6px;">Costos: -${COPfmt(pl.global.costos)} (opcional)</div>
					</div>
					</div>
					<div class="summary-card" style="margin-top:8px;">
					<strong>Capital inicial (informativo):</strong> ${COPfmt(pl.global.capitalInformativo)}
					</div>
				</div>
				`;

				// Por negocio
				for (const [neg, inf] of Object.entries(pl.negocios)) {
				const nom = nombresNegocios[neg] ?? neg;

				// Top productos
				const filasTop = (inf.topProductos.length ? inf.topProductos : [{producto:'(sin datos)',cantidad:0,total:0}])
					.map(p => `<tr><td>${p.producto}</td><td style="text-align:center;">${p.cantidad}</td><td style="text-align:right;">${COPfmt(p.total)}</td></tr>`).join('');

				// Gastos por categor√≠a
				const filasGasto = (inf.gastosCat.length ? inf.gastosCat : [{categoria:'(sin datos)', total:0}])
					.map(g => `<tr><td>${g.categoria}</td><td style="text-align:right;">-${COPfmt(g.total)}</td></tr>`).join('');

				// ===== DETALLE INGRESOS (estilo unificado) =====
				const detalleIngresosHTML = `
					<div class="summary-box">
					<div class="kpi-card">
						<div class="kpi-card__header">
						DETALLE INGRESOS
						<span class="kpi-badge">Base caja</span>
						</div>
						<table>
						<thead>
							<tr>
							<th>Concepto</th>
							<th style="text-align:right;">Valor</th>
							</tr>
						</thead>
						<tbody>
							<tr>
							<td>Ventas ‚ÄúPagado‚Äù ‚Äî <span class="kpi-muted">Efectivo</span></td>
							<td style="text-align:right;" class="kpi-efectivo">${COP(inf.ventasEf)}</td>
							</tr>
							<tr>
							<td>Ventas ‚ÄúPagado‚Äù ‚Äî <span class="kpi-muted">Nequi</span></td>
							<td style="text-align:right;" class="kpi-nequi">${COP(inf.ventasNq)}</td>
							</tr>
							<tr>
							<td>Abonos ‚Äî <span class="kpi-muted">Efectivo</span></td>
							<td style="text-align:right;" class="kpi-efectivo">${COP(inf.abonosEf)}</td>
							</tr>
							<tr>
							<td>Abonos ‚Äî <span class="kpi-muted">Nequi</span></td>
							<td style="text-align:right;" class="kpi-nequi">${COP(inf.abonosNq)}</td>
							</tr>
							<tr>
							<td style="font-weight:700;">Ingresos del per√≠odo (caja)</td>
							<td style="text-align:right; font-weight:700;">${COP(inf.ventasTotales)}</td>
							</tr>
							<tr>
							<td>Gastos del per√≠odo</td>
							<td style="text-align:right;" class="kpi-neg">-${COP(inf.gastos)}</td>
							</tr>
							<tr>
							<td>Costos (opcional)</td>
							<td style="text-align:right;" class="kpi-neg">-${COP(inf.costos)}</td>
							</tr>
							<tr>
							<td style="font-weight:700;">Utilidad (caja)</td>
							<td style="text-align:right; font-weight:700; color:${inf.utilidad >= 0 ? '#28a745' : '#dc3545'};">
								${COP(inf.utilidad)}
							</td>
							</tr>
						</tbody>
						</table>
					</div>
					</div>
				`;

				// üëâ Mant√©n Top productos y Gastos por categor√≠a; sustituye la 3¬™ caja por detalleIngresosHTML
				html += `
					<div class="business-section">
					<h4>${nom}</h4>
					<div style="margin:6px 0 10px;color:#333;">
						Ingresos: <strong>${COPfmt(inf.ventasTotales)}</strong> ¬∑
						Gastos: <strong>-${COPfmt(inf.gastos)}</strong> ¬∑
						Costos: <strong>-${COPfmt(inf.costos)}</strong> ¬∑
						Utilidad: <strong style="color:${inf.utilidad>=0?'#28a745':'#dc3545'}">${COPfmt(inf.utilidad)}</strong>
					</div>

					<div class="summary-grid">
						<!-- TOP PRODUCTOS -->
						<div class="summary-box">
							<div class="kpi-card">
								<div class="kpi-card__header">TOP PRODUCTOS</div>
								<table>
								<thead>
									<tr>
									<th>Producto</th>
									<th>Cant.</th>
									<th style="text-align:right;">Ventas</th>
									</tr>
								</thead>
								<tbody>
									${filasTop}
								</tbody>
								</table>
							</div>
						</div>
						
						<!-- GASTOS POR CATEGOR√çA -->
						<div class="summary-box">
							<div class="kpi-card">
								<div class="kpi-card__header">GASTOS POR CATEGOR√çA</div>
								<table>
								<thead>
									<tr>
									<th>Categor√≠a</th>
									<th style="text-align:right;">Total</th>
									</tr>
								</thead>
								<tbody>
									${filasGasto}
								</tbody>
								</table>
							</div>
						</div>

						<!-- DETALLE INGRESOS (nuevo estilo) -->
						${detalleIngresosHTML}
					</div>

					<div class="summary-card" style="margin-top:8px;">
						<strong>Capital inicial (informativo):</strong> ${COPfmt(inf.capitalInformativo)}
					</div>
					</div>
				`;
				}

				cont.innerHTML = html;

			} catch (e) {
				console.error('previsualizarPL() error:', e);
				const cont = document.getElementById('plPreview');
				if (cont) cont.innerHTML = `<div class="error-message" style="display:block;">Error generando la previsualizaci√≥n del P&L.</div>`;
			}
		}

		// ===== Estado de Resultados (P&L) ‚Äî TX =====
		async function exportarPLPDF() {
			const desde = document.getElementById('plDesde')?.value;
			const hasta = document.getElementById('plHasta')?.value;
			const negocioSel = document.getElementById('plNegocio')?.value ?? 'Todos';
			const incluirCostos = !!document.getElementById('plIncluirCostos')?.checked;

			if (!desde || !hasta || hasta < desde) {
				mostrarError('Selecciona un rango v√°lido para P&L.');
				return;
			}

			// ========= CAPA DE DATOS (TX) =========
			const datosTx = await fetchTxPorRango(desde, hasta, negocioSel); // {Negocio1:[...], ...}
			const negocios = (negocioSel === 'Todos') ? Object.keys(datosTx) : [negocioSel];

			const pl = {
				global: {
				ventasEf:0, ventasNq:0, abonosEf:0, abonosNq:0,
				ventasTotales:0, gastos:0, costos:0, utilidad:0,
				capitalInformativo: 0
				},
				negocios: {}
			};

			for (const neg of negocios) {
				const regs = (datosTx[neg] ?? []).filter(r => r.fecha && r.fecha >= desde && r.fecha <= hasta);

				// Capital inicial (nota informativa, no entra a utilidad)
				const capEf = Number(saldoInicial[neg]?.efectivo ?? 0);
				const capNq = Number(saldoInicial[neg]?.nequi ?? 0);
				const capitalInformativo = capEf + capNq;
				pl.global.capitalInformativo += capitalInformativo;

				// Ingresos por m√©todo (base caja)
				let ventasEf=0, ventasNq=0, abonosEf=0, abonosNq=0, gastos=0, costos=0;

				const prodMap = new Map();      // Top productos
				const gastoCatMap = new Map();  // Gastos por "categor√≠a" (usamos descripci√≥n como categor√≠a simple)

				regs.forEach(r => {
				const vb = Number(r?.totales?.ventasBrutas ?? 0);

				// Ventas ‚ÄúPagado‚Äù: van por metodoVenta
				if (r.estadoPago === 'Pagado' && vb > 0) {
					if (r.metodoVenta === 'Efectivo') ventasEf += vb;
					if (r.metodoVenta === 'Nequi')    ventasNq += vb;
				}
				// Abonos en el per√≠odo
				if (Array.isArray(r.pagos)) {
					r.pagos.forEach(p => {
					if (p.fecha >= desde && p.fecha <= hasta) {
						const m = Number(p.monto ?? 0);
						if (p.metodo === 'Efectivo') abonosEf += m;
						if (p.metodo === 'Nequi')    abonosNq += m;
					}
					});
				}
				// Gastos
				if (r.gasto && Number(r.gasto.monto ?? 0) > 0) {
					const g = Number(r.gasto.monto ?? 0);
					gastos += g;
					const cat = (r.gasto.descripcion && String(r.gasto.descripcion).trim()) || 'Gasto';
					gastoCatMap.set(cat, (gastoCatMap.get(cat) ?? 0) + g);
				}

				// Top productos (por items entregados)
				if (Array.isArray(r.items)) {
					r.items.forEach(i => {
					const prev = prodMap.get(i.producto) ?? { cantidad:0, total:0 };
					prev.cantidad += Number(i.cantidad ?? 0);
					prev.total    += Number(i.total ?? 0);
					prodMap.set(i.producto, prev);
					});
				}
				});

				// (Opcional) costos: si decides cargarlos luego, s√∫malos aqu√≠ cuando tengas el dato
				if (incluirCostos) {
				costos = 0; // hoy no hay fuente de costos, lo dejamos en 0
				}

				const ingresos = (ventasEf + ventasNq) + (abonosEf + abonosNq);
				const utilidad = ingresos - (gastos + costos);

				// Armar PL de negocio
				const topProductos = [...prodMap.entries()]
				.map(([producto, info]) => ({ producto, cantidad: info.cantidad, total: info.total }))
				.sort((a,b)=> b.total - a.total).slice(0, 10);

				const gastosCat = [...gastoCatMap.entries()]
				.map(([categoria, total]) => ({ categoria, total }))
				.sort((a,b)=> b.total - a.total).slice(0, 10);

				pl.negocios[neg] = {
				ventasEf, ventasNq, abonosEf, abonosNq,
				ventasTotales: ingresos,
				gastos, costos, utilidad,
				topProductos, gastosCat,
				capitalInformativo
				};

				// Suma a global
				pl.global.ventasEf     += ventasEf;
				pl.global.ventasNq     += ventasNq;
				pl.global.abonosEf     += abonosEf;
				pl.global.abonosNq     += abonosNq;
				pl.global.gastos       += gastos;
				pl.global.costos       += costos;
				pl.global.ventasTotales+= ingresos;
			}
			pl.global.utilidad = pl.global.ventasTotales - (pl.global.gastos + pl.global.costos);

			// ========= RENDER PDF =========
			const { jsPDF } = window.jspdf;
			const doc = new jsPDF({ unit:'pt', format:'a4' });
			const margin = 36;
			const pw = doc.internal.pageSize.getWidth();
			const ph = doc.internal.pageSize.getHeight();

			function header() {
				doc.setFillColor(102,126,234);
				doc.rect(0,0,pw,54,'F');
				doc.setFont('helvetica','bold'); doc.setTextColor('#fff'); doc.setFontSize(14);
				doc.text('Sistema de Contabilidad ‚Äî Estado de Resultados (P&L)', margin, 28);
				doc.setFont('helvetica','normal'); doc.setFontSize(11);
				const tituloNegocio = (negocioSel === 'Todos') ? 'Todos los negocios' : (nombresNegocios[negocioSel] ?? negocioSel);
				doc.text(`Del ${desde} al ${hasta} ¬∑ ${tituloNegocio}`, margin, 46);
			}
			function footer() {
				const str = `Generado ${new Date().toLocaleString('es-CO')} ¬∑ P√°g. ${doc.internal.getNumberOfPages()}`;
				doc.setFontSize(9); doc.setTextColor('#777');
				doc.text(str, pw - margin, ph - 14, { align:'right' });
			}

			header();

			// Resumen global
			const globalRows = [
				['Ingresos ‚Äî Efectivo', COP(pl.global.ventasEf + pl.global.abonosEf)],
				['Ingresos ‚Äî Nequi',    COP(pl.global.ventasNq + pl.global.abonosNq)],
				['Ingresos Totales',    COP(pl.global.ventasTotales)],
				['Gastos',              `-${COP(pl.global.gastos)}`],
				['Costos',              `-${COP(pl.global.costos)}`],
				['Utilidad (Base caja)', COP(pl.global.utilidad)],
				['Capital inicial (informativo)', COP(pl.global.capitalInformativo)]
			];
			doc.autoTable({
				startY: 70,
				head: [['Concepto', 'Valor']],
				body: globalRows,
				theme: 'grid',
				headStyles: { fillColor: [52,58,64] },
				styles: { fontSize: 10, cellPadding: 6 },
				columnStyles: { 1:{halign:'right'} },
				didDrawPage: (data) => { if (data.pageNumber > 1) header(); },
				margin: { left: margin, right: margin }
			});

			let y = (doc.lastAutoTable?.finalY || 90) + 18;

			// Por negocio: KPIs + Top productos + Gastos por categor√≠a
			for (const [neg, inf] of Object.entries(pl.negocios)) {
				if (y > ph - 180) { doc.addPage(); header(); y = 70; }
				doc.setFont('helvetica','bold'); doc.setFontSize(12); doc.setTextColor('#333');
				doc.text(`${nombresNegocios[neg] ?? neg}`, margin, y);
				doc.setFont('helvetica','normal'); doc.setFontSize(10);
				doc.text(
				`Ingresos: ${COP(inf.ventasEf + inf.abonosEf + inf.ventasNq + inf.abonosNq)}  ¬∑  ` +
				`Gastos: -${COP(inf.gastos)}  ¬∑  Costos: -${COP(inf.costos)}  ¬∑  ` +
				`Utilidad: ${COP(inf.utilidad)}`,
				margin, y + 14
				);

				// Top productos
				const prodBody = (inf.topProductos.length ? inf.topProductos : [{producto:'(sin datos)',cantidad:0,total:0}])
				.map(p => [p.producto, String(p.cantidad), COP(p.total)]);
				doc.autoTable({
				startY: y + 28,
				head: [['Top productos', 'Cant.', 'Ventas']],
				body: prodBody,
				theme: 'grid',
				headStyles: { fillColor: [102,126,234] },
				styles: { fontSize: 9, cellPadding: 5 },
				columnStyles: { 1: { halign:'center', cellWidth: 60 }, 2: { halign:'right', cellWidth: 80 } },
				margin: { left: margin, right: margin },
				didDrawPage: (data) => { if (data.pageNumber > 1) header(); }
				});
				const afterProdY = doc.lastAutoTable?.finalY || (y + 28);

				// Gastos por categor√≠a
				const gastosBody = (inf.gastosCat.length ? inf.gastosCat : [{categoria:'(sin datos)', total:0}])
				.map(g => [g.categoria, `-${COP(g.total)}`]);
				doc.autoTable({
				startY: afterProdY + 12,
				head: [['Gastos por categor√≠a', 'Total']],
				body: gastosBody,
				theme: 'grid',
				headStyles: { fillColor: [220,53,69] },
				styles: { fontSize: 9, cellPadding: 5 },
				columnStyles: { 1: { halign:'right', cellWidth: 100 } },
				margin: { left: margin, right: margin },
				didDrawPage: (data) => { if (data.pageNumber > 1) header(); }
				});

				y = doc.lastAutoTable?.finalY + 22;
			}

			// Footer en todas las p√°ginas
			const totalPages = doc.internal.getNumberOfPages();
			for (let i=1; i<=totalPages; i++) { doc.setPage(i); footer(); }

			const sufijo = (negocioSel === 'Todos') ? 'Todos' : negocioSel;
			doc.save(`PL_${desde}_a_${hasta}_${sufijo}.pdf`);
		}

		/* ===== Acorde√≥n de Informes: abrir/cerrar todo + recordar estado ===== */
		function toggleInformes(open) {
			document.querySelectorAll('#informes details').forEach(d => d.open = !!open);
			saveInformesState();
		}

		function saveInformesState() {
			const state = {};
			document.querySelectorAll('#informes details').forEach(d => state[d.id] = d.open ? 1 : 0);
			localStorage.setItem('informesState', JSON.stringify(state));
		}

		function restoreInformesState() {
			const raw = localStorage.getItem('informesState');
			if (!raw) return;
			try {
				const state = JSON.parse(raw);
				Object.entries(state).forEach(([id, val]) => {
				const el = document.getElementById(id);
				if (el) el.open = !!val;
				});
			} catch {}
		}

		// Alt + clic en cada summary = abrir SOLO ese informe
		function initInformesAccordionHotkeys() {
			document.querySelectorAll('#informes details > summary').forEach(sm => {
				sm.addEventListener('click', (ev) => {
				// guardamos state despu√©s de que cambie el "open"
				setTimeout(saveInformesState, 0);
				if (ev.altKey) {
					const me = sm.parentElement?.id;
					if (!me) return;
					document.querySelectorAll('#informes details').forEach(d => d.open = (d.id === me));
					ev.preventDefault();
					saveInformesState();
				}
				});
			});
		}

		function refreshAfterSave(fechaAfectada){
			// Invalida cache del d√≠a, del per√≠odo que podr√≠a incluir hoy y de CxC
			invalidateCacheByPrefix(`dia:${fechaAfectada}:`);
			invalidateCacheByPrefix(`rng:`);      // si quieres ser fino, invalida s√≥lo rangos que contengan la fecha
			invalidateCacheByPrefix(`cxc:`);      // deudas pueden cambiar

			// NO hagas lecturas aqu√≠; deja que cada pesta√±a, cuando el usuario la vea,
			// consulte de nuevo (cach√© vac√≠a -> nueva query).
		}

		// Ejecuta una sola vez para migrar ventas/gastos de 'registros' -> 'transacciones'.
		// Espera a que el m√≥dulo exponga las globals
		async function ejecutarMigracionPaginada() {
			await waitForFirebaseReady(); // ya existe en tu app 

			const hasGlobals =
				window.db && window.collection && window.getDocs &&
				window.orderBy && window.startAfter && window.limit &&
				window.writeBatch && window.doc;
			if (!hasGlobals) {
				console.error('‚ùå Faltan globals de Firestore en window.*');
				return;
			}

			console.log('Iniciando migraci√≥n (paginada por __name__)‚Ä¶');

			const db = window.db;
			const pageSize = 300; // ajusta seg√∫n tu cuota/velocidad
			let lastDoc = null;
			let totalCandidatos = 0;
			let totalCreados = 0;
			let totalMarcados = 0;
			let page = 0;

			while (true) {
				page++;

				// P√°gina por ID (sin filtros), para no dejar fuera los docs sin 'migrado'
				const base = [
				window.collection(db, 'registros'),
				window.orderBy(window.documentId ? window.documentId() : '__name__')
				];
				if (lastDoc) base.push(window.startAfter(lastDoc));
				base.push(window.limit(pageSize));

				const q = window.query(...base);
				const snap = await window.getDocs(q); // lee p√°gina  

				if (snap.empty) {
				console.log('No hay m√°s p√°ginas por leer.');
				break;
				}

				// Selecci√≥n en cliente: solo los que no est√©n migrados
				const candidatos = snap.docs.filter(d => (d.data()?.migrado !== true));
				console.log(`P√°gina ${page}: le√≠dos=${snap.size}, candidatos=${candidatos.length}`);
				totalCandidatos += candidatos.length;

				if (candidatos.length > 0) {
				const batch = window.writeBatch(db);
				let creados = 0, marcados = 0;

				for (const d of candidatos) {
					const r = d.data();
					const id = d.id;

					// === Mapping m√≠nimo; aj√∫stalo si tienes m√°s campos ===
					const fecha  = r.fecha ?? '';
					const negocio = r.negocio ?? '';
					const ventas = Number(r.ventas ?? 0);
					const gastos = Number(r.gastos ?? 0);
					const estadoPago = r.estadoPago ?? (ventas > 0 ? 'Pagado' : 'SoloGasto');
					const cliente = (estadoPago === 'Debe') ? (r.cliente ?? null) : null;

					const items = Array.isArray(r.items)
					? r.items
					: (ventas > 0 && r.producto
						? [{ producto: r.producto,
							cantidad: Number(r.cantidad ?? 1),
							precioUnitario: Number(r.precioUnitario ?? ventas),
							total: ventas }]
						: []);

					const txDoc = {
					negocio,
					fecha,
					horaPedido: r.hora ?? null,
					estadoPago,
					cliente,
					metodoVenta: (estadoPago === 'Pagado') ? (r.metodo ?? null) : null,
					metodoGasto: (gastos > 0) ? (r.metodoGasto ?? r.metodo ?? null) : null,
					items,
					pagos: [],
					gasto: (gastos > 0) ? {
						descripcion: r.descripcion ?? 'Gasto migrado',
						metodo: (r.metodoGasto ?? r.metodo ?? null),
						monto: gastos
					} : null,
					totales: {
						ventasBrutas: ventas,
						gastos,
						pendiente: (estadoPago === 'Debe') ? ventas : 0
					},
					createdAt: r.createdAt ?? new Date(),
					updatedAt: new Date(),
					_migradoDesde: 'registros',
					_idOriginal: id
					};

					const newId = (window.crypto?.randomUUID?.() || `${id}_${Date.now()}`);
					const txRef  = window.doc(db, 'transacciones', newId);
					const srcRef = window.doc(db, 'registros', id);

					batch.set(txRef, txDoc);
					creados++;
					batch.update(srcRef, { migrado: true, migradoAt: new Date() });
					marcados++;
				}

				await batch.commit();
				console.log(`P√°gina ${page}: creados=${creados}, marcados=${marcados}`);
				totalCreados += creados;
				totalMarcados += marcados;
				} else {
				console.log(`P√°gina ${page}: sin candidatos para migrar.`);
				}

				// Avanza el cursor a la √∫ltima doc de esta p√°gina
				lastDoc = snap.docs[snap.docs.length - 1];
				if (snap.size < pageSize) {
				// Fin (√∫ltima p√°gina)
				break;
				}
			}

			console.log(`‚úÖ Migraci√≥n finalizada. Candidatos=${totalCandidatos}, Creados=${totalCreados}, Marcados=${totalMarcados}`);
		}
    </script>
	<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.1/dist/jspdf.plugin.autotable.min.js"></script>
	<script type="module">
	  import { initializeApp } 
	  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";

	  import { 
		getAuth, 
		onAuthStateChanged, 
		signOut,
		signInWithEmailAndPassword,
		reauthenticateWithCredential,
		EmailAuthProvider
	  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

	  import { 
		getFirestore, 
		collection, 
		addDoc, 
		getDocs,
		getDoc,
		query, 
		where,
		orderBy,
		startAfter,
		limit,
		doc,
		writeBatch,
		setDoc,
		updateDoc,
		deleteDoc,
		serverTimestamp,
		getCountFromServer
	  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

	  const firebaseConfig = {
		apiKey: "AIzaSyA_C9CYbLYpkJhaME5j9OgzlVjN83iwY78",
		authDomain: "cuentaselancla.firebaseapp.com",
		projectId: "cuentaselancla",
		storageBucket: "cuentaselancla.firebasestorage.app",
		messagingSenderId: "538778905068",
		appId: "1:538778905068:web:4e48f2ef1510d68d6138c9"
	  };

	  // üî• INICIALIZAR UNA SOLA VEZ
	  const app = initializeApp(firebaseConfig);
	  const auth = getAuth(app);
	  const db = getFirestore(app);

	  // üî• HACER VARIABLES GLOBALES
	  window.db = db;
	  window.collection = collection;
	  window.addDoc = addDoc;
	  window.getDocs = getDocs;
	  window.getDoc  = getDoc;
	  window.query = query;
	  window.where = where;
	  window.orderBy = orderBy;
	  window.startAfter = startAfter;
	  window.limit = limit;
	  window.doc = doc;
	  window.writeBatch = writeBatch;
	  window.setDoc = setDoc;
	  window.updateDoc = updateDoc;
	  window.deleteDoc = deleteDoc;
	  window.serverTimestamp = serverTimestamp;
	  window.cxcSeleccionado = null;
	  window.getCountFromServer = getCountFromServer;
	  window.filtroNegocioCobroCliente = null;

	  // Hacer accesible la sesi√≥n y m√©todos de auth a scripts no-m√≥dulo
	  window.auth = auth;
	  window.signInWithEmailAndPassword = signInWithEmailAndPassword;
	  window.reauthenticateWithCredential = reauthenticateWithCredential;
	  window.EmailAuthProvider = EmailAuthProvider;

	  // üîê VALIDAR SESI√ìN
 	  onAuthStateChanged(auth, (user) => {
		  if (user) {
			console.log("Usuario autenticado:", user.email);
			startInactivityTimer();
		  } else {
			console.log("No hay sesi√≥n activa");
			setTimeout(() => {
			  window.location.href = "login.html";
			}, 500);
		  }
		});

	  // üö™ CERRAR SESI√ìN
	  window.logout = function() {
		signOut(auth).then(() => {
		  window.location.href = "login.html";
		});
	  };
	  
		// ============== AUTO-LOGOUT POR INACTIVIDAD (5 MIN) ==============
		const INACTIVITY_LIMIT_MS = 5 * 60 * 1000; // 5 minutos
		let inactivityTimer = null;

		function resetInactivityTimer() {
			if (inactivityTimer) clearTimeout(inactivityTimer);
			inactivityTimer = setTimeout(async () => {
			try {
				await signOut(auth);
			} catch (e) {
				console.warn('Error haciendo signOut por inactividad', e);
			} finally {
				window.location.href = 'login.html';
			}
			}, INACTIVITY_LIMIT_MS);
		}

		function startInactivityTimer() {
			resetInactivityTimer();

			const resetEvents = ['mousemove','keydown','click','touchstart','scroll','visibilitychange'];
			resetEvents.forEach(evt => {
			document.addEventListener(evt, () => {
				// Solo reinicia si la pesta√±a est√° activa o el usuario volvi√≥ a verla
				if (evt !== 'visibilitychange' || document.visibilityState === 'visible') {
				resetInactivityTimer();
				}
			}, { passive: true });
			});
		}
	</script>
</body>
</html>
