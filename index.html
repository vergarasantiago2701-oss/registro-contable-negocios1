<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Contabilidad - Restaurantes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
            flex-wrap: wrap;
        }
        
        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: #f5f5f5;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            min-width: 150px;
        }
        
        .tab-button:hover {
            background: #efefef;
        }
        
        .tab-button.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        
        .content {
            display: none;
            padding: 30px;
        }
        
        .content.active {
            display: block;
        }
        
        .business-selector {
            margin-bottom: 30px;
        }
        
        .business-selector label {
            font-weight: 600;
            color: #333;
            margin-right: 10px;
            font-size: 1.1em;
        }
        
        .business-selector select {
            padding: 10px 15px;
            font-size: 1em;
            border: 2px solid #667eea;
            border-radius: 5px;
            cursor: pointer;
            background: white;
            color: #333;
        }
        
        .form-group {
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .form-group.full {
            grid-template-columns: 1fr;
        }
        
        .input-field {
            display: flex;
            flex-direction: column;
        }
        
        .input-field label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        
        .input-field input,
        .input-field select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }
        
        .input-field input:focus,
        .input-field select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 25px;
            justify-content: center;
        }
        
        button {
            padding: 12px 30px;
            font-size: 1em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
            border: 2px solid #ddd;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .payment-method {
            display: flex;
            gap: 20px;
            margin: 15px 0;
        }
        
        .radio-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .radio-group input[type="radio"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }
        
        .radio-group label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        table th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        table td {
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
        }
        
        table tr:hover {
            background: #f5f5f5;
        }
        
        .summary-card {
            background: #f9f9f9;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin: 15px 0;
            border-radius: 5px;
        }
        
        .summary-card h3 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .summary-box {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        
        .summary-box h4 {
            color: #666;
            margin-bottom: 10px;
            font-size: 0.9em;
            text-transform: uppercase;
        }
        
        .summary-box .value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            border: 1px solid #c3e6cb;
            display: none;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            border: 1px solid #f5c6cb;
            display: none;
        }
        
        .business-section {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #667eea;
        }
        
        .business-section h3 {
            color: #333;
            margin-bottom: 15px;
        }
        
        @media (max-width: 768px) {
            .form-group {
                grid-template-columns: 1fr;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .tab-button {
                font-size: 0.85em;
                min-width: 100px;
                padding: 10px 15px;
            }
        }
		/* ===== MODAL ===== */
		.modal-backdrop{
		position: fixed; inset: 0;
		background: rgba(0,0,0,0.45);
		display: flex; align-items: center; justify-content: center;
		padding: 16px; z-index: 9999;
		}
		.modal-card{
		width: 100%; max-width: 520px;
		background: #fff; border-radius: 10px;
		box-shadow: 0 20px 60px rgba(0,0,0,0.35);
		overflow: hidden; border: 1px solid #e5e5e5;
		}
		.modal-header{
		display: flex; align-items: center; justify-content: space-between;
		padding: 16px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
		color: #fff;
		}
		.modal-body{ padding: 18px 20px; }
		.modal-footer{
		padding: 14px 20px; display: flex; justify-content: flex-end; gap: 10px; background: #fafafa;
		border-top: 1px solid #eee;
		}
		.modal-close{
		background: transparent; border: none; color: #fff; font-size: 18px; cursor: pointer;
		}
		.modal-radio{ display: grid; gap: 10px; margin-top: 10px; }
		.radio-item{ display: flex; gap: 10px; align-items: center; cursor: pointer; }
		
		/*inputs deshabilitados*/
		input:disabled {
		  background-color: #f5f5f5;
		  color: #999;
		  cursor: not-allowed;
		}
		/* Efecto "shake" para errores de ingreso */
		@keyframes shake {
			10%, 90% { transform: translateX(-1px); }
			20%, 80% { transform: translateX(2px); }
			30%, 50%, 70% { transform: translateX(-4px); }
			40%, 60% { transform: translateX(4px); }
			}
			.input-shake {
			animation: shake 0.3s ease-in-out;
			border-color: #dc3545 !important; /* rojo de error */
		}
		/* Contenedor con scroll horizontal solo para la tabla ‚Äúgrande‚Äù */
		.table-responsive{
		  width: 100%;
		  overflow-x: auto;
		  -webkit-overflow-scrolling: touch;
		}
		
		/* La tabla de 12 columnas debe tener un ancho m√≠nimo y layout fijo */
		#resumenContent table.tabla-registros{
		  table-layout: fixed;
		  width: 100%;
		  min-width: 1100px; /* ajusta si necesitas m√°s o menos */
		}
		
		#resumenContent table.tabla-registros th,
		#resumenContent table.tabla-registros td{
		  white-space: normal;
		  word-break: break-word;
		  overflow-wrap: anywhere;
		  padding: 8px 6px;
		  font-size: 13px;
		  line-height: 1.2;
		}
		
		/* Anchos por columna (1..12) solo para la tabla grande */
		#resumenContent table.tabla-registros th:nth-child(1),
		#resumenContent table.tabla-registros td:nth-child(1){ width: 90px;  max-width: 90px; }
		
		#resumenContent table.tabla-registros th:nth-child(2),
		#resumenContent table.tabla-registros td:nth-child(2){ width: 150px; max-width: 150px; }
		
		#resumenContent table.tabla-registros th:nth-child(3),
		#resumenContent table.tabla-registros td:nth-child(3){ width: 60px;  max-width: 60px;  }
		
		#resumenContent table.tabla-registros th:nth-child(4),
		#resumenContent table.tabla-registros td:nth-child(4){ width: 90px;  max-width: 90px;  }
		
		#resumenContent table.tabla-registros th:nth-child(5),
		#resumenContent table.tabla-registros td:nth-child(5){ width: 90px;  max-width: 90px;  }
		
		#resumenContent table.tabla-registros th:nth-child(6),
		#resumenContent table.tabla-registros td:nth-child(6){ width: 90px;  max-width: 90px;  }
		
		#resumenContent table.tabla-registros th:nth-child(7),
		#resumenContent table.tabla-registros td:nth-child(7){ width: 90px;  max-width: 90px;  }
		
		#resumenContent table.tabla-registros th:nth-child(8),
		#resumenContent table.tabla-registros td:nth-child(8){ width: 80px;  max-width: 80px;  }
		
		#resumenContent table.tabla-registros th:nth-child(9),
		#resumenContent table.tabla-registros td:nth-child(9){ width: 130px; max-width: 130px; }
		
		#resumenContent table.tabla-registros th:nth-child(10),
		#resumenContent table.tabla-registros td:nth-child(10){ width: 180px; max-width: 180px; }
		
		#resumenContent table.tabla-registros th:nth-child(11),
		#resumenContent table.tabla-registros td:nth-child(11){ width: 110px; max-width: 110px; }
		
		#resumenContent table.tabla-registros th:nth-child(12),
		#resumenContent table.tabla-registros td:nth-child(12){ width: 110px; max-width: 110px; }
		
		/* Evita que el bot√≥n expanda la columna */
		#resumenContent table.tabla-registros td:nth-child(12) .btn-success{
		  width: 100%;
		  max-width: 100%;
		  padding: 8px 0;
		  white-space: nowrap;
		}
		
		/* Modo compacto m√≥vil: oculta columnas menos cr√≠ticas y reduce min-width */
		@media (max-width: 768px){
		  /* 4=Precio, 9=Cliente, 10=Descripci√≥n */
		  #resumenContent table.tabla-registros th:nth-child(4),
		  #resumenContent table.tabla-registros td:nth-child(4),
		  #resumenContent table.tabla-registros th:nth-child(9),
		  #resumenContent table.tabla-registros td:nth-child(9),
		  #resumenContent table.tabla-registros th:nth-child(10),
		  #resumenContent table.tabla-registros td:nth-child(10){
		    display: none;
		  }
		  #resumenContent table.tabla-registros{ min-width: 820px; }
		}

		/* ===== Acorde√≥n de Informes ===== */
		#informes details {
			border: 1px solid #e6e6e6;
			border-radius: 8px;
			background: #fff;
			margin: 14px 0;
			overflow: hidden;
		}
		#informes details[open] {
			box-shadow: 0 4px 18px rgba(0,0,0,0.06);
		}
		#informes details > summary {
			list-style: none;
			cursor: pointer;
			padding: 14px 16px;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: #fff;
			font-weight: 700;
			display: flex;
			align-items: center;
			justify-content: space-between;
		}
		#informes details > summary::-webkit-details-marker { display:none; }

		#informes .summary-title {
			display: inline-flex; align-items: center; gap: 10px;
		}
		#informes .chev {
			transition: transform .25s ease;
		}
		#informes details[open] .chev {
			transform: rotate(90deg);
		}

		#informes .panel-body {
			padding: 16px;
			background: #fafafa;
		}

		#informes .acc-actions {
			display:flex; gap:8px; margin: 6px 0 10px;
			justify-content:flex-end;
		}
		#informes .acc-actions .btn-secondary { padding: 8px 14px; }
		#informes .help-tip {
			font-size: 12px; color: #666; margin: 4px 0 10px;
		}
    </style>
</head>
<body>
    <div class="container">
        <div class="header" style="position:relative;">
			
			<button onclick="logout()" class="btn-danger" style="
				position:absolute;
				top:20px;
				right:20px;">
				Cerrar sesi√≥n
			</button>

			<h1>üìä Sistema de Contabilidad</h1>
			<p>Gesti√≥n de Negocios - Base, Ventas y Gastos</p>

		</div>
        
        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('entrada', event)">Entrada de Datos</button>
			<button class="tab-button" onclick="switchTab('resumen', event)">Resumen Diario</button>
			<button class="tab-button" onclick="switchTab('acumulado', event)">Cuentas Acumuladas</button>
			<button class="tab-button" onclick="switchTab('metodos', event)">An√°lisis Pagos</button>
			<button class="tab-button" onclick="switchTab('configuracion', event)">Configuraci√≥n</button>
			<button class="tab-button" onclick="switchTab('informes', event)">Informes</button>
        </div>
        
        <!-- PESTA√ëA 1: ENTRADA DE DATOS -->
        <div id="entrada" class="content active">
            <div class="success-message" id="successMsg">‚úì Datos guardados correctamente</div>
            <div class="error-message" id="errorMsg"></div>
            
            <div class="business-selector">
                <label for="business">Selecciona Negocio:</label>
                <select id="business">
                    <option value="Negocio1">Negocio Fritos</option>
                    <option value="Negocio2">Negocio Almuerzos</option>
                    <option value="Negocio3">Negocio Licorer√≠a</option>
                    <option value="Negocio4">Negocio Comidas R√°pidas</option>
                </select>
            </div>
            
            <h3 style="color: #333; margin-bottom: 10px;">Registrar Movimiento del D√≠a</h3>
            <p style="color:#666; margin-bottom:20px; font-size:0.9em;">
			  Registra <strong>ventas por producto</strong> y/o <strong>gastos</strong> para el negocio y fecha.
			</p>
            
            <div class="form-group full">
                <div class="input-field">
                    <label for="fecha">Fecha:</label>
                    <input type="date" id="fecha" value="">
                </div>
            </div>
            
            <div class="form-group">
			  <div class="input-field">
				<div class="form-group">
				  <div class="input-field">
					<label>Producto:</label>
					<select id="productoSelect"></select>
				  </div>

				  <div class="input-field">
					<label>Cantidad:</label>
					<input type="number" id="cantidad" min="1" value="1">
				  </div>
				</div>

				<!-- Se muestra solo cuando sea Mojarra en Negocio2 -->
				<div class="input-field" style="display:none;" id="precioPersonalizadoWrap">
				  <label>Precio personalizado (solo Mojarra &gt; $25.000):</label>
				  <input type="number" id="precioPersonalizado" min="25001" step="1" placeholder="Ej: 26000">
				  <small style="color:#666;">Si el precio es mayor a $25.000, escribe aqu√≠ el valor exacto.</small>
				</div>

				<!-- Se muestra solo cuando sea Corriente en Negocio2 -->
				<div class="input-field" style="display:none;" id="tipoCorrienteWrap">
					<label>Tipo de corriente:</label>
					<input type="text" id="tipoCorriente" placeholder="Ej: pollo, res, mixta">
					<small style="color:#666;">Obligatorio para Corriente (Negocio Almuerzos).</small>
				</div>

				<div class="summary-card">
				  <strong>Total Venta:</strong>
				  <span id="totalVentaPreview">$0</span>
				</div>
				
				<!-- Bot√≥n para apilar la l√≠nea al carrito -->
				<div class="button-group" style="margin-top:10px;">
				  <button class="btn-success" type="button" onclick="agregarAlCarrito()">‚ûï Agregar al pedido</button>
				</div>

				<!-- Tabla del carrito (pedido actual, no guardado a√∫n) -->
				<div class="business-section" id="carritoSection" style="display:none;">
				  <h4>Pedido actual (no guardado)</h4>
				  <table id="carritoTabla">
					<thead>
					  <tr>
						<th>Producto</th>
						<th>Cant.</th>
						<th>Precio Unit.</th>
						<th>Total</th>
						<th></th>
					  </tr>
					</thead>
					<tbody></tbody>
				  </table>
				  <div style="margin-top:10px; text-align:right;">
					<strong>Total pedido:</strong> <span id="carritoTotal">$0</span>
				  </div>
				</div>
			  </div>
			</div>
            
            <div class="form-group">
                <div class="input-field">
                    <label for="gastos">Gastos ($):</label>
                    <input type="number" id="gastos" placeholder="0" step="0.01" min="0">
                </div>
                <div class="input-field">
                    <label for="descripcion">Descripci√≥n de Gasto:</label>
                    <input type="text" id="descripcion" placeholder="Ej: Compra de ingredientes">
                </div>
            </div>
            
            <!-- <div class="form-group full">
                <div class="input-field">
                    <label>M√©todo de Pago (Ventas):</label>
                    <div class="payment-method">
                        <div class="radio-group">
                            <input type="radio" id="efectivo" name="metodo" value="Efectivo" checked>
                            <label for="efectivo">üíµ Efectivo</label>
                        </div>
                        <div class="radio-group">
                            <input type="radio" id="nequi" name="metodo" value="Nequi">
                            <label for="nequi">üì± Nequi</label>
                        </div>
                    </div>
                </div>
            </div> -->
            
            <div class="button-group">
                <button class="btn-primary" onclick="abrirModalPago()">Guardar Registro</button>
                <button class="btn-secondary" onclick="limpiarFormulario()">Limpiar</button>
            </div>
        </div>
        
        <!-- PESTA√ëA 2: RESUMEN DIARIO -->
        <div id="resumen" class="content">
            <h3 style="color: #333; margin-bottom: 20px;">Resumen Diario</h3>
            
            <div class="input-field" style="margin-bottom: 20px; max-width: 300px;">
                <label for="fechaFiltro">Filtrar por Fecha:</label>
                <input type="date" id="fechaFiltro" onchange="actualizarResumen()">
            </div>
            
			<div class="input-field" style="margin-bottom: 10px; max-width: 300px;">
			<label class="radio-group" style="gap:8px;">
				<input type="checkbox" id="soloDeudas" onchange="actualizarResumen()">
				<span>Mostrar solo deudas (ventas en "Debe")</span>
			</label>
			</div>

			<!-- Contenedor de la secci√≥n de Cuentas por Cobrar -->
			<div id="cxcContent"></div>
            <div id="resumenContent"></div>
        </div>
        
        <!-- PESTA√ëA 3: CUENTAS ACUMULADAS -->
        <div id="acumulado" class="content">
            <h3 style="color: #333; margin-bottom: 20px;">Cuentas Acumuladas por Negocio</h3>
            
            <div class="summary-grid" id="acumuladoContent"></div>
        </div>
        
        <!-- PESTA√ëA 4: AN√ÅLISIS PAGOS -->
        <div id="metodos" class="content">
            <h3 style="color: #333; margin-bottom: 20px;">An√°lisis de M√©todos de Pago</h3>
            
            <div class="form-group">
                <div class="input-field">
                    <label for="negocioFiltro">Negocio:</label>
                    <select id="negocioFiltro" onchange="actualizarAnalisisPagos()">
                        <option value="Todos">Todos los Negocios</option>
                        <option value="Negocio1">Negocio Fritos</option>
                        <option value="Negocio2">Negocio Almuerzos</option>
                        <option value="Negocio3">Negocio Licorer√≠a</option>
                        <option value="Negocio4">Negocio Comidas R√°pidas</option>
                    </select>
                </div>
                <div class="input-field">
                    <label for="filtroFechaPagos">Filtrar por Fecha:</label>
                    <select id="filtroFechaPagos" onchange="actualizarAnalisisPagos()">
                        <option value="actual">Estado Actual (Acumulado)</option>
                        <option value="fecha">Por Fecha Espec√≠fica</option>
                    </select>
                </div>
				<!-- Toggle incluir capital inicial -->
				<div class="input-field">
					<label for="toggleCapitalInicial" style="user-select:none;">Opciones:</label>
					<label class="radio-group" style="gap:10px;">
						<input type="checkbox" id="toggleCapitalInicial" onchange="actualizarAnalisisPagos()">
						<span>Incluir capital inicial</span>
					</label>
				</div>
            </div>
            
            <div id="fechaPagosContainer" style="display: none; margin-bottom: 20px;">
                <div class="input-field" style="max-width: 300px;">
                    <label for="fechaSeleccionadaPagos">Selecciona Fecha:</label>
                    <input type="date" id="fechaSeleccionadaPagos" onchange="actualizarAnalisisPagos()">
                </div>
            </div>
            
            <div id="analisisPagosContent"></div>
        </div>
        
        <!-- PESTA√ëA 5: CONFIGURACI√ìN -->
        <div id="configuracion" class="content">
            <h3 style="color: #333; margin-bottom: 20px;">Configuraci√≥n del Sistema</h3>
            
            <div class="business-section">
                <h4>Gesti√≥n de Datos</h4>
                <div class="button-group">
                    <button class="btn-secondary" onclick="exportarDatos()">üì• Exportar Datos</button>
                    <button class="btn-secondary" onclick="descargarExcel()">üìä Descargar Excel</button>
                    <!--<button class="btn-danger" onclick="limpiarTodos()">üóëÔ∏è Limpiar Datos Locales</button>-->
                </div>
            </div>
            
            <div class="business-section">
                <h4>Informaci√≥n del Sistema</h4>
                <p><strong>Versi√≥n:</strong> 1.10</p>
                <p><strong>Negocios Registrados:</strong> 4</p>
                <p><strong>Datos Almacenados:</strong> <span id="totalRegistros">0</span> registros</p>
            </div>

            <!-- === Cat√°logo de productos (Config) === -->
            <div class="business-section">
              <h4>Cat√°logo de productos por negocio</h4>
              <p style="color:#666;margin:8px 0 14px;">
                Agrega productos personalizados (se suman al cat√°logo base del negocio). Se guardan en la nube.
              </p>

              <div class="form-group">
                <div class="input-field">
                  <label for="cfgNegocio">Negocio:</label>
                  <select id="cfgNegocio" onchange="renderCatalogoUI()">
                    <option value="Negocio1">Negocio Fritos</option>
                    <option value="Negocio2">Negocio Almuerzos</option>
                    <option value="Negocio3">Negocio Licorer√≠a</option>
                    <option value="Negocio4">Negocio Comidas R√°pidas</option>
                  </select>
                </div>

                <div class="input-field">
                  <label for="cfgNombreProd">Nombre del producto:</label>
                  <input id="cfgNombreProd" type="text" placeholder="Ej: Perro hawaiano">
                </div>
                <div class="input-field">
                  <label for="cfgPrecioProd">Precio (COP):</label>
                  <input id="cfgPrecioProd" type="number" min="1" step="1" placeholder="Ej: 12000">
                </div>
              </div>

              <div class="button-group" style="justify-content:flex-start;">
                <button class="btn-success" type="button" onclick="cfgAgregarProducto()">‚ûï Agregar producto</button>
              </div>

              <div id="cfgTablaWrap" style="margin-top:14px;">
                <!-- Aqu√≠ se renderiza la tabla del cat√°logo del negocio seleccionado -->
              </div>
            </div>			
        </div>
		<!-- PESTA√ëA 6: INFORMES -->
		<div id="informes" class="content">

			<!-- Acciones globales del acorde√≥n -->
			<div class="acc-actions">
				<button class="btn-secondary" type="button" onclick="toggleInformes(true)">Expandir todo</button>
				<button class="btn-secondary" type="button" onclick="toggleInformes(false)">Replegar todo</button>
			</div>
			<div class="help-tip">Sugerencia: <strong>Alt + clic</strong> sobre el t√≠tulo abre <em>solo ese</em> informe.</div>

			<!-- ====== Informe mensual ====== -->
			<details id="secMensual" open>
				<summary>
				<span class="summary-title"><span class="chev">‚ñ∂</span> Informe mensual</span>
				</summary>
				<div class="panel-body">
				<h3 style="color:#333;margin-bottom:16px;">Informe mensual</h3>
				<div class="form-group">
					<div class="input-field">
					<label for="mesReporte">Mes:</label>
					<input type="month" id="mesReporte">
					</div>
					<div class="input-field">
					<label for="negocioReporte">Negocio:</label>
					<select id="negocioReporte">
						<option value="Todos">Todos</option>
						<option value="Negocio1">Negocio Fritos</option>
						<option value="Negocio2">Negocio Almuerzos</option>
						<option value="Negocio3">Negocio Licorer√≠a</option>
						<option value="Negocio4">Negocio Comidas R√°pidas</option>
					</select>
					</div>
				</div>
				<div class="button-group" style="justify-content:flex-start;">
					<button class="btn-secondary" type="button" onclick="previsualizarInforme()">üëÄ Previsualizar</button>
					<button class="btn-primary" type="button" onclick="exportarInformeMensualPDF()">üßæ Exportar PDF</button>
				</div>
				<div id="previewInforme" style="margin-top:16px;"></div>
				</div>
			</details>

			<!-- ====== Resumen por Per√≠odo ====== -->
			<details id="secPeriodo">
				<summary>
				<span class="summary-title"><span class="chev">‚ñ∂</span> Resumen por Per√≠odo</span>
				</summary>
				<div class="panel-body">
				<h3 style="color:#333;margin-bottom:16px;">Resumen por Per√≠odo</h3>
				<div class="form-group">
					<div class="input-field">
					<label for="infDesdePeriodo">Desde:</label>
					<input type="date" id="infDesdePeriodo">
					</div>
					<div class="input-field">
					<label for="infHastaPeriodo">Hasta:</label>
					<input type="date" id="infHastaPeriodo">
					</div>
					<div class="input-field">
					<label for="infNegocioReporte">Negocio:</label>
					<select id="infNegocioReporte" onchange="previsualizarPeriodoInforme(); renderCxcPeriodoEnInformes();">
						<option value="Todos">Todos</option>
						<option value="Negocio1">Negocio Fritos</option>
						<option value="Negocio2">Negocio Almuerzos</option>
						<option value="Negocio3">Negocio Licorer√≠a</option>
						<option value="Negocio4">Negocio Comidas R√°pidas</option>
					</select>
					</div>
					<div class="input-field">
					<label class="radio-group" style="gap:8px;">
						<input type="checkbox" id="infSoloDeudasPeriodo" onchange="previsualizarPeriodoInforme()">
						<span>Mostrar solo deudas (ventas en "Debe")</span>
					</label>
					</div>
					<div class="input-field">
					<label class="radio-group" style="gap:8px;">
						<input type="checkbox" id="infCxcAcumuladoPeriodo" checked onchange="renderCxcPeriodoEnInformes()">
						<span>CxC acumulado (todas las fechas)</span>
					</label>
					</div>
					<div class="input-field">
					<label class="radio-group" style="gap:8px;">
						<input type="checkbox" id="infIncluirDetalle" checked>
						<span>Incluir tabla de detalle (12 columnas)</span>
					</label>
					</div>
				</div>
				<div class="button-group" style="justify-content:flex-start;margin-top:4px;">
					<button class="btn-secondary" type="button" onclick="previsualizarPeriodoInforme()">üëÄ Previsualizar per√≠odo</button>
					<button class="btn-primary" type="button" onclick="exportarInformePeriodoPDF()">üßæ Exportar PDF del per√≠odo</button>
				</div>
				<div id="infCxcPeriodo" style="margin-top:14px;"></div>
				<div id="previewPeriodoInforme" style="margin-top:10px;"></div>
				</div>
			</details>

			<!-- ====== Estado de Resultados (P&L) ====== -->
			<details id="secPL">
				<summary>
				<span class="summary-title"><span class="chev">‚ñ∂</span> Estado de Resultados (P&amp;L)</span>
				</summary>
				<div class="panel-body">
				<h3 style="color:#333;margin-bottom:16px;">Estado de Resultados (P&amp;L)</h3>
				<div class="form-group">
					<div class="input-field">
					<label for="plDesde">Desde:</label>
					<input type="date" id="plDesde">
					</div>
					<div class="input-field">
					<label for="plHasta">Hasta:</label>
					<input type="date" id="plHasta">
					</div>
					<div class="input-field">
					<label for="plNegocio">Negocio:</label>
					<select id="plNegocio">
						<option value="Todos">Todos</option>
						<option value="Negocio1">Negocio Fritos</option>
						<option value="Negocio2">Negocio Almuerzos</option>
						<option value="Negocio3">Negocio Licorer√≠a</option>
						<option value="Negocio4">Negocio Comidas R√°pidas</option>
					</select>
					</div>
					<div class="input-field">
					<label class="radio-group" style="gap:8px;">
						<input type="checkbox" id="plIncluirCostos" onchange="previsualizarPL()">
						<span>Incluir costos (cuando los registremos)</span>
					</label>
					</div>
				</div>
				<div class="button-group" style="justify-content:flex-start;">
					<button class="btn-secondary" type="button" onclick="previsualizarPL()">üëÄ Previsualizar P&amp;L</button>
					<button class="btn-primary" type="button" onclick="exportarPLPDF()">üßæ Exportar PDF (P&amp;L)</button>
				</div>
				<div id="plPreview" style="margin-top:12px;"></div>
				</div>
			</details>

		</div>
    </div>
	<!-- MODAL Confirmaci√≥n de pago -->
	<div id="modalPagoBackdrop" class="modal-backdrop" style="display:none;">
		<div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalPagoTitulo">
			<div class="modal-header">
			<h3 id="modalPagoTitulo">Confirmar estado de pago</h3>
			<button class="modal-close" onclick="cerrarModalPago()" aria-label="Cerrar">‚úñ</button>
			</div>

			<div class="modal-body">
			  <p style="color:#555;margin-bottom:12px;">
				Indica c√≥mo registrar√°s este movimiento.
			  </p>

			  <div class="modal-radio">
				<label class="radio-item">
				  <input type="radio" name="estadoPago" value="pagado" checked onchange="updateModalPagoUI()">
				  <span>El cliente <strong>pag√≥ todo</strong></span>
				</label>
				<label class="radio-item">
				  <input type="radio" name="estadoPago" value="debe" onchange="updateModalPagoUI()">
				  <span>El cliente <strong>qued√≥ debiendo</strong></span>
				</label>
				<label class="radio-item">
				  <input type="radio" name="estadoPago" value="soloGasto" onchange="updateModalPagoUI()">
				  <span><strong>Solo gasto</strong> (sin ventas)</span>
				</label>
			  </div>

			  <!-- Nombre cliente (solo si 'Debe' y hay ventas en carrito) -->
			  <div id="nombreClienteWrap" style="display:none; margin-top:12px;">
				<label for="nombreClienteDeudor" style="font-weight:600;color:#333;margin-bottom:6px;">
				  Nombre del cliente (obligatorio si debe):
				</label>
				<input type="text" id="nombreClienteDeudor" placeholder="Ej: Juan P√©rez"
					   style="width:100%;padding:10px;border:2px solid #ddd;border-radius:6px;">
				<small style="color:#666;">Este nombre se guardar√° con cada l√≠nea de venta como cuenta por cobrar.</small>
			  </div>

			  <!-- M√©todo de pago de la VENTA (solo si 'pagado' y hay carrito) -->
			  <div id="metodoVentaWrap" style="display:none; margin-top:12px;">
				<label style="font-weight:600;color:#333;margin-bottom:6px;display:block;">M√©todo de pago de la venta:</label>
				<div class="payment-method">
				  <div class="radio-group">
					<input type="radio" id="pagoVentaEfectivo" name="metodoVenta" value="Efectivo" checked>
					<label for="pagoVentaEfectivo">üíµ Efectivo</label>
				  </div>
				  <div class="radio-group">
					<input type="radio" id="pagoVentaNequi" name="metodoVenta" value="Nequi">
					<label for="pagoVentaNequi">üì± Nequi</label>
				  </div>
				</div>
			  </div>

			  <!-- M√©todo de pago del GASTO (si hay gasto > 0) -->
			  <div id="metodoGastoWrap" style="display:none; margin-top:12px;">
				<label style="font-weight:600;color:#333;margin-bottom:6px;display:block;">M√©todo de pago del gasto:</label>
				<div class="payment-method">
				  <div class="radio-group">
					<input type="radio" id="pagoGastoEfectivo" name="metodoGasto" value="Efectivo" checked>
					<label for="pagoGastoEfectivo">üíµ Efectivo</label>
				  </div>
				  <div class="radio-group">
					<input type="radio" id="pagoGastoNequi" name="metodoGasto" value="Nequi">
					<label for="pagoGastoNequi">üì± Nequi</label>
				  </div>
				</div>
				<small style="color:#666;">Este m√©todo solo aplica al registro de gasto.</small>
			  </div>

			  <div id="modalPagoError" class="error-message" style="display:none;margin-top:12px;">.</div>
			</div>
			<div class="modal-footer">
			  <button class="btn-secondary" onclick="cerrarModalPago()">Cancelar</button>
			  <button class="btn-primary" onclick="confirmarGuardarDesdeModal()">Confirmar y guardar</button>
			</div>
		</div>
	</div>
	<div id="modalCobrarBackdrop" class="modal-backdrop" style="display:none;">
	  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalCobrarTitulo">
		
			<div class="modal-header">
			  <h3 id="modalCobrarTitulo">Registrar Pago</h3>
			  <button class="modal-close" onclick="cerrarModalCobrar()" aria-label="Cerrar">&times;</button>
			</div>

			<div class="modal-body">
			  <p class="modal-instruction">Selecciona el m√©todo de pago para esta venta:</p>

			  <div class="payment-options">
					<label class="payment-radio">
					  <input type="radio" id="cobroEfectivo" name="metodoCobro" value="Efectivo" checked>
					  <div class="radio-content">
						<span class="icon">üíµ</span>
						<span class="text">Efectivo</span>
					  </div>
					</label>

					<label class="payment-radio">
					  <input type="radio" name="metodoCobro" value="Nequi">
					  <div class="radio-content">
						<span class="icon">üì±</span>
						<span class="text">Nequi</span>
					  </div>
					</label>
			  </div>

			  <div id="modalCobrarError" class="error-message" style="display:none;"></div>
			</div>

			<div class="modal-footer">
			  <button class="btn-secondary" onclick="cerrarModalCobrar()">Cancelar</button>
			  <button id="btnConfirmarCobro" class="btn-primary" onclick="confirmarCobro()">Confirmar Cobro</button>
			</div>
	  </div>
	</div>

    <!-- MODAL: Cobro por Cliente (CxC) -->
    <div id="modalCobroClienteBackdrop" class="modal-backdrop" style="display:none;">
      <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalCobroClienteTitulo">
        <div class="modal-header">
          <h3 id="modalCobroClienteTitulo">Cobrar cuenta</h3>
          <button class="modal-close" onclick="cerrarModalCobroCliente()" aria-label="Cerrar">‚úñ</button>
        </div>

		<!-- Dentro de #modalCobroClienteBackdrop .modal-body -->
		<div class="input-field" style="margin-top:10px;">
			<label for="negocioCobroCliente">Negocios en los que debe (opcional):</label>
			<select id="negocioCobroCliente"></select>
		</div>

        <div class="modal-body">
          <p><strong>Cliente:</strong> <span id="cxcClienteNombre"></span></p>
          <p><strong>Total por cobrar:</strong> <span id="cxcClienteDeuda">$0</span></p>
          <hr>

          <div class="modal-radio">
            <label class="radio-item">
              <input type="radio" name="tipoCobroCliente" value="total" checked onclick="toggleMontoParcial(false)">
              <span>Pago total</span>
            </label>
            <label class="radio-item">
              <input type="radio" name="tipoCobroCliente" value="parcial" onclick="toggleMontoParcial(true)">
              <span>Pago parcial</span>
            </label>
          </div>

          <div id="montoParcialWrap" class="input-field" style="display:none; margin-top:10px;">
            <label for="montoParcial">Monto a cobrar (COP):</label>
            <input type="number" id="montoParcial" min="1" step="1" placeholder="Ej: 20000">
            <small style="color:#666;">No puede exceder el total por cobrar.</small>
          </div>

          <div class="payment-options" style="margin-top:12px;">
            <label class="payment-radio">
              <input type="radio" name="metodoCobroCliente" value="Efectivo" checked>
              <div class="radio-content">
                <span class="icon">üíµ</span><span class="text">Efectivo</span>
              </div>
            </label>

            <label class="payment-radio">
              <input type="radio" name="metodoCobroCliente" value="Nequi">
              <div class="radio-content">
                <span class="icon">üì±</span><span class="text">Nequi</span>
              </div>
            </label>
          </div>

          <div id="modalCobroClienteError" class="error-message" style="display:none;"></div>
        </div>

        <div class="modal-footer">
          <button class="btn-secondary" onclick="cerrarModalCobroCliente()">Cancelar</button>
          <button class="btn-primary" onclick="confirmarCobroCliente()">Confirmar cobro</button>
        </div>
      </div>
    </div>
	
	<!-- MODAL Verificaci√≥n de credenciales para eliminar producto personalizado -->
	<div id="modalCredencialesBackdrop" class="modal-backdrop" style="display:none;">
		<div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalCredencialesTitulo">
			<div class="modal-header">
				<h3 id="modalCredencialesTitulo">Confirmar con contrase√±a</h3>
				<button class="modal-close" onclick="cerrarModalCredenciales()" aria-label="Cerrar">‚úñ</button>
			</div>
			<div class="modal-body">
				<p style="color:#555;margin-bottom:12px;">
					Por seguridad, ingresa tu contrase√±a para eliminar este producto.
				</p>

				<!-- Si quieres pedir tambi√©n correo, descomenta:
				<div class="input-field" style="margin-bottom:10px;">
					<label for="credEmail">Correo:</label>
					<input type="email" id="credEmail" placeholder="tu@correo.com">
				</div>
				-->

				<div class="input-field">
					<label for="credPassword">Contrase√±a:</label>
					<input type="password" id="credPassword" placeholder="********">
				</div>

				<div id="credError" class="error-message" style="display:none;"></div>
			</div>
			<div class="modal-footer">
				<button class="btn-secondary" onclick="cerrarModalCredenciales()">Cancelar</button>
				<button class="btn-primary" onclick="confirmarCredenciales()">Confirmar</button>
			</div>
		</div>
	</div>
    <script>
	
		// ==== MAPA DE NOMBRES ====
		const nombresNegocios = {
			Negocio1: "Negocio Fritos",
			Negocio2: "Negocio Almuerzos",
			Negocio3: "Negocio Licorer√≠a",
			Negocio4: "Negocio Comidas R√°pidas"
		};
		
		// üîµ SALDO INICIAL FIJO POR NEGOCIO
		const saldoInicial = {
			Negocio1: { efectivo: 310000, nequi: 0 },
			Negocio2: { efectivo: 250000, nequi: 0 },
			Negocio3: { efectivo: 0, nequi: 746000 },
			Negocio4: { efectivo: 0, nequi: 150000 }
		};
		
		// üîµ PRODUCTOS POR NEGOCIO
		const productos = {

		  Negocio1: [ // Fritos
			{ nombre: "Arepa de huevo", precio: 3000 },
			{ nombre: "Patacones", precio: 3000 },
			{ nombre: "Deditos", precio: 1500 },
			{ nombre: "Papa carne", precio: 2000 },
			{ nombre: "Papa pollo", precio: 2000 },
			{ nombre: "Empanada carne", precio: 2000 },
			{ nombre: "Empanada pollo", precio: 2000 },
			{ nombre: "Cariba√±olas", precio: 2000 }
		  ],

		  Negocio2: [ // Almuerzos
			{ nombre: "Corriente", precio: 15000 },
			{ nombre: "Mojarra", precio: 25000 },
			{ nombre: "Sopa 8k", precio: 8000 },
			{ nombre: "Sopa 10k", precio: 10000 },
			{ nombre: "Sopa 13k", precio: 13000 }
		  ],

		  Negocio3: [ // Licorer√≠a
			{ nombre: "Coste√±ita x38", precio: 85000 },
			{ nombre: "Coste√±ita peque√±a", precio: 3000 },
			{ nombre: "Coste√±a", precio: 4000 },
			{ nombre: "√Åguila negra peque√±a", precio: 4000 },
			{ nombre: "√Åguila negra grande", precio: 7000 },
			{ nombre: "Gaseosa personal", precio: 2000 }
		  ],

		  Negocio4: [] // Comidas r√°pidas (por ahora manual)
		};
		
		// === Formateador COP (sin decimales) ===
		const COP = (n) => new Intl.NumberFormat('es-CO', {
		  style: 'currency',
		  currency: 'COP',
		  minimumFractionDigits: 0,
		  maximumFractionDigits: 0
		}).format(Number(n) || 0);

		// ===== Cach√© en memoria (TTL sencillo) =====
		const __cache = new Map(); // key -> { data, ts }
		const CACHE_TTL_MS = 60 * 1000; // 60s; ajusta si quieres

		function setCache(key, data){
			__cache.set(key, { data, ts: Date.now() });
		}
		function getCache(key){
			const hit = __cache.get(key);
			if (!hit) return null;
			if (Date.now() - hit.ts > CACHE_TTL_MS) { __cache.delete(key); return null; }
			return hit.data;
		}
		function invalidateCacheByPrefix(prefix){
			for (const k of __cache.keys()){
				if (k.startsWith(prefix)) __cache.delete(k);
			}
		}

        /* =========================
          Cat√°logos personalizados
          ========================= */

        // Clave de almacenamiento local
        const CATALOGOS_KEY = 'catalogos';

        // Carga el objeto completo { Negocio1: [...], Negocio2: [...], ... }
        function loadCatalogos() {
          try { return JSON.parse(localStorage.getItem(CATALOGOS_KEY) || '{}'); }
          catch { return {}; }
        }

        // Guarda el objeto completo
        function saveCatalogos(obj) {
          localStorage.setItem(CATALOGOS_KEY, JSON.stringify(obj));
        }

        // Obtiene el array del negocio (si no existe, []), solo personalizados
        function getCatalogoPersonalizado(negocioKey) {
          const all = loadCatalogos();
          return Array.isArray(all[negocioKey]) ? all[negocioKey] : [];
        }

        // Reemplaza la lista combinada que se usa para vender: BASE + PERSONALIZADOS
        function getCatalogoCombinado(negocioKey) {
          const base = Array.isArray(productos[negocioKey]) ? productos[negocioKey] : [];
          const custom = getCatalogoPersonalizado(negocioKey);
          // Concatenamos ambos cat√°logos (si quieres deduplicar por nombre, te lo dejo luego)
          return [...base, ...custom];
        }

        // Agrega producto al negocio desde Configuraci√≥n
        function cfgAgregarProducto() {
			const negocioKey = document.getElementById('cfgNegocio').value;
			const nombre = (document.getElementById('cfgNombreProd').value || '').trim();
			const precio = parseInt(document.getElementById('cfgPrecioProd').value, 10) || 0;

			if (!nombre) { mostrarError('Escribe el nombre del producto.'); return; }
			if (precio <= 0) { mostrarError('Escribe un precio v√°lido mayor a 0.'); return; }

			dbAgregarProducto(negocioKey, nombre, precio)
				.then(async () => {
				// Limpiar inputs
				document.getElementById('cfgNombreProd').value = '';
				document.getElementById('cfgPrecioProd').value = '';

				// Si estoy en ese negocio en "Entrada de Datos", refrescar selector
				try {
					if (document.getElementById('business').value === negocioKey) {
					await fetchPersonalizadosDB(negocioKey); // refresca cache
					await cargarProductos();
					}
				} catch (e) {}
				renderCatalogoUI();
				mostrarExito();
				})
				.catch(e => {
				console.error(e);
				mostrarError('No se pudo guardar el producto en la nube.');
			});
		}

		function abrirModalCredenciales() {
			const err = document.getElementById('credError');
			if (err) { err.style.display = 'none'; err.textContent = ''; }
			// Si pides correo, puedes precargar el del usuario actual:
			// const user = window.auth?.currentUser;
			// if (user) document.getElementById('credEmail').value = user.email || '';
			document.getElementById('credPassword').value = '';
			document.getElementById('modalCredencialesBackdrop').style.display = 'flex';
		}

		function cerrarModalCredenciales() {
			document.getElementById('modalCredencialesBackdrop').style.display = 'none';
		}

		let __credBusy = false;

		function setCredBusy(state) {
			__credBusy = !!state;
			const btn = document.querySelector('#modalCredencialesBackdrop .btn-primary');
			if (btn) btn.disabled = !!state;
		}

		async function confirmarCredenciales() {
			if (__credBusy) return;
			setCredBusy(true);

			const err = document.getElementById('credError');
			const passEl = document.getElementById('credPassword');

			// Helper para mostrar error y (opcionalmente) limpiar password
			const showError = (msg, { clearPwd = false, focusPwd = false, shake = false } = {}) => {
				if (err) {
					err.textContent = msg;
					err.style.display = 'block';
				}
				if (clearPwd && passEl) passEl.value = '';
				if (focusPwd && passEl) passEl.focus();
				if (shake && passEl) {
					passEl.classList.add('input-shake');
					setTimeout(() => passEl.classList.remove('input-shake'), 300);
				}
			};

			try {
				// Validaciones de entorno/sesi√≥n
				if (!window.auth) {
					showError('No se pudo acceder a la sesi√≥n actual.');
					return;
				}

				const user = window.auth.currentUser;
				if (!user) {
					showError('No hay sesi√≥n activa. Inicia sesi√≥n nuevamente.');
					setTimeout(() => { window.location.href = 'login.html'; }, 1200);
					return;
				}

				const email = user.email;
				const password = (passEl?.value || '');

				if (!password) {
					showError('Ingresa tu contrase√±a.');
					if (passEl) passEl.focus();
					return;
				}

				// Reautenticaci√≥n
				const cred = window.EmailAuthProvider.credential(email, password);
				await window.reauthenticateWithCredential(user, cred);

				// OK ‚Üí eliminar
				await __eliminarProductoPersonalizadoConfirmado();

				cerrarModalCredenciales();
				mostrarExito();

			} catch (e) {
				console.error(e);
				// Error de credenciales: feedback + cooldown del bot√≥n
				showError('Credenciales inv√°lidas. Intenta nuevamente.', { clearPwd: true, focusPwd: true, shake: true });

				const btn = document.querySelector('#modalCredencialesBackdrop .btn-primary');
				if (btn) {
					btn.disabled = true;
					setTimeout(() => { btn.disabled = false; }, 1000);
				}

			} finally {
				// IMPORTANTE: liberar busy salvo que el bot√≥n est√© en cooldown por error.
				// Si quieres que __credBusy se libere incluso en cooldown, deja solo setCredBusy(false).
				setCredBusy(false);
			}
		}

		// (Opcional) Limpia mensaje de error cuando el usuario empieza a tipear.
		document.getElementById('credPassword')?.addEventListener('input', () => {
		const err = document.getElementById('credError');
		if (err && err.style.display !== 'none') {
			err.style.display = 'none';
			err.textContent = '';
		}
		});

		// (Opcional) Confirmar con Enter en el input de password:
		document.getElementById('credPassword')?.addEventListener('keydown', (ev) => {
		if (ev.key === 'Enter') confirmarCredenciales();
		});

		async function __eliminarProductoPersonalizadoConfirmado() {
			if (!__pendingDeleteDocId || !__pendingDeleteNegocioKey) return;
			
			await dbEliminarProducto(__pendingDeleteDocId, __pendingDeleteNegocioKey);
			// Guardamos para usarlo luego de refrescar UI
			const negocioKeyUsado = __pendingDeleteNegocioKey;

			// Limpiar estado
			__pendingDeleteDocId = null;
			__pendingDeleteNegocioKey = null;

			// Refrescar UI (configuraci√≥n y, si aplica, selector en Entrada)
			renderCatalogoUI();
			try {
				if (document.getElementById('business').value === negocioKeyUsado) {
				await cargarProductos();
				}
			} catch (e) {}
		}

        // Estado temporal a nivel de archivo para saber qu√© borrar tras verificar
		let __pendingDeleteDocId = null;
		let __pendingDeleteNegocioKey = null;

		function cfgEliminarProducto(docId) {
			const negocioKey = document.getElementById('cfgNegocio').value;

			// Guardar intenci√≥n de borrado
			__pendingDeleteDocId = docId;
			__pendingDeleteNegocioKey = negocioKey;

			// Abrir modal para pedir contrase√±a
			abrirModalCredenciales();
		}

        // Renderiza la tabla de productos personalizados del negocio seleccionado
        async function renderCatalogoUI() {
			const wrap = document.getElementById('cfgTablaWrap');
			if (!wrap) return;

			const negocioKey = document.getElementById('cfgNegocio')?.value || 'Negocio1';
			// Lee de DB y actualiza cache
			const personalizados = await fetchPersonalizadosDB(negocioKey);

			if (!personalizados.length) {
				wrap.innerHTML = '<p style="color:#999;">Este negocio no tiene productos personalizados.</p>';
				return;
			}

			let rows = '';
			personalizados.forEach((p) => {
				rows += `
				<tr>
					<td>${p.nombre}</td>
					<td style="text-align:right;">${COP(p.precio)}</td>
					<td style="text-align:center;">
					<button class="btn-danger" type="button" onclick="cfgEliminarProducto('${p.id}')">Eliminar</button>
					</td>
				</tr>
				`;
			});

			wrap.innerHTML = `
				<table>
				<thead>
					<tr>
					<th>Producto (personalizado)</th>
					<th style="width:180px;">Precio</th>
					<th style="width:140px;">Acciones</th>
					</tr>
				</thead>
				<tbody>${rows}</tbody>
				</table>
			`;
		}
				
		// ======= üîó Helpers para DB de Cat√°logos Personalizados =======

		// Cache en memoria para evitar consultas repetidas
		const __catalogoCache = {}; // { NegocioX: [{id, negocioKey, nombre, precio, ownerUid, createdAt}, ...] }
		let catalogoActual = [];    // Combinado (base + personalizados) del negocio actualmente seleccionado

		// Espera a que haya usuario autenticado (necesario para guardar por ownerUid)
		async function waitForAuthUser() {
			while (!(window.auth && window.auth.currentUser)) {
			await new Promise(r => setTimeout(r, 50));
			}
		}

		// Lee productos personalizados desde Firestore por negocio actual y usuario
		async function fetchPersonalizadosDB(negocioKey) {
			try {
			await waitForAuthUser();
			const uid = window.auth.currentUser?.uid;
			if (!uid) return [];

			// query(collection(db,'catalogos'), where('ownerUid','==',uid), where('negocioKey','==',negocioKey))
			const q = window.query(
				window.collection(window.db, 'catalogos'),
				window.where('ownerUid', '==', uid),
				window.where('negocioKey', '==', negocioKey)
			);

			const snap = await window.getDocs(q);
			const items = [];
			snap.forEach(d => items.push({ id: d.id, ...d.data() }));

			// Cache en memoria
			__catalogoCache[negocioKey] = items;
			return items;
			} catch (e) {
			console.warn('No se pudo leer cat√°logo personalizado desde DB. Uso fallback vac√≠o.', e);
			return [];
			}
		}

		// Devuelve el cat√°logo COMBINADO (base + personalizados desde DB)
		async function getCatalogoCombinadoAsync(negocioKey) {
			const base = Array.isArray(productos[negocioKey]) ? productos[negocioKey] : [];
			const personalizados = Array.isArray(__catalogoCache[negocioKey])
			? __catalogoCache[negocioKey]
			: await fetchPersonalizadosDB(negocioKey);

			// Combina: mapeamos los personalizados al mismo shape {nombre, precio}
			const personalizadosMapeados = personalizados.map(p => ({ nombre: p.nombre, precio: Number(p.precio) || 0 }));
			return [...base, ...personalizadosMapeados];
		}

		// Crea un producto personalizado en Firestore
		async function dbAgregarProducto(negocioKey, nombre, precio) {
			await waitForAuthUser();
			const uid = window.auth.currentUser?.uid;
			if (!uid) throw new Error('No hay usuario autenticado');

			await window.addDoc(window.collection(window.db, 'catalogos'), {
			ownerUid: uid,
			negocioKey,
			nombre,
			precio: Number(precio) || 0,
			createdAt: new Date()
			});

			// Invalida/actualiza cache
			await fetchPersonalizadosDB(negocioKey);
		}

		// Elimina un producto personalizado de Firestore (por docId)
		async function dbEliminarProducto(docId, negocioKey) {
			await window.deleteDoc(window.doc(window.db, 'catalogos', docId));
			// Refrescar cache
			await fetchPersonalizadosDB(negocioKey);
		}

		// Migraci√≥n 1 sola vez: si NO hay docs en la DB para el usuario, sube los que existan en localStorage
		async function migrarCatalogosLocalesALaDB() {
			try {
			await waitForAuthUser();
			const uid = window.auth.currentUser?.uid;
			if (!uid) return;

			// ¬øEl usuario ya tiene cat√°logo en la nube?
			const q = window.query(
				window.collection(window.db, 'catalogos'),
				window.where('ownerUid', '==', uid)
			);
			const snap = await window.getDocs(q);
			if (!snap.empty) return; // Ya hay data, no migrar

			const all = loadCatalogos(); // {Negocio1: [{nombre,precio}, ...], ...}
			const ops = [];
			for (const [negocioKey, arr] of Object.entries(all)) {
				(arr || []).forEach(p => {
				ops.push(
					window.addDoc(window.collection(window.db, 'catalogos'), {
					ownerUid: uid,
					negocioKey,
					nombre: p.nombre,
					precio: Number(p.precio) || 0,
					createdAt: new Date()
					})
				);
				});
			}
			if (ops.length > 0) {
				await Promise.all(ops);
				// limpia local ya que migramos
				localStorage.removeItem(CATALOGOS_KEY);
				console.log('Cat√°logo personalizado migrado a Firestore.');
			}
			} catch (e) {
			console.warn('Fallo migraci√≥n de cat√°logo local a DB (se intentar√° m√°s tarde):', e);
			}
		}

		// ====== CARGAR PRODUCTOS AUTOM√ÅTICAMENTE (desde DB) ======
		async function cargarProductos() {
			const negocio = document.getElementById("business").value;
			const select = document.getElementById("productoSelect");
			const precioWrap = document.getElementById("precioPersonalizadoWrap");
			const precioInput = document.getElementById("precioPersonalizado");

			select.innerHTML = "";

			// ‚¨áÔ∏è ahora viene de Firestore + base:
			catalogoActual = await getCatalogoCombinadoAsync(negocio);

			if (!catalogoActual || catalogoActual.length === 0) {
			const opt = document.createElement("option");
			opt.value = "manual";
			opt.textContent = "Venta Manual";
			select.appendChild(opt);
			document.getElementById("totalVentaPreview").textContent = "$0";
			precioWrap.style.display = "none";
			precioInput.value = "";
			return;
			}

			catalogoActual.forEach((p, index) => {
			const option = document.createElement("option");
			option.value = index; // √≠ndice dentro del combinado
			option.textContent = `${p.nombre} - $${p.precio}`;
			select.appendChild(option);
			});

			// Mostrar/ocultar extras seg√∫n producto
			const idx = parseInt(select.value, 10);
			const prod = catalogoActual[idx];

			// Mojarra (solo Negocio2)
			if (negocio === "Negocio2" && prod && prod.nombre.toLowerCase().includes("mojarra")) {
			precioWrap.style.display = "block";
			} else {
			precioWrap.style.display = "none";
			precioInput.value = "";
			}

			// Tipo de corriente (solo Negocio2)
			const tipoCorrienteWrap = document.getElementById("tipoCorrienteWrap");
			const tipoCorrienteInput = document.getElementById("tipoCorriente");
			if (negocio === "Negocio2" && prod && prod.nombre.toLowerCase().includes("corriente")) {
			tipoCorrienteWrap.style.display = "block";
			} else {
			tipoCorrienteWrap.style.display = "none";
			if (tipoCorrienteInput) tipoCorrienteInput.value = "";
			}

			calcularTotalVenta();
		}

		// ====== CALCULAR TOTAL (incluye precio personalizado para Mojarra y Tipo de corriente - usando catalogoActual) ======
        function calcularTotalVenta() {
			const negocio = document.getElementById("business").value;
			const select = document.getElementById("productoSelect");
			const index = select.value;
			const cantidad = parseInt(document.getElementById("cantidad").value, 10) || 0;

			const precioWrap = document.getElementById("precioPersonalizadoWrap");
			const precioInput = document.getElementById("precioPersonalizado");

			const catalogo = catalogoActual; // ya cargado

			if (index === 'manual' || !catalogo || !catalogo[index]) {
			document.getElementById("totalVentaPreview").textContent = "$0";
			return;
			}

			const prod = catalogo[index];
			let precioUnitario = prod.precio || 0;

			// Mojarra personalizada (> 25.000) solo Negocio2
			if (negocio === "Negocio2" && prod && prod.nombre.toLowerCase().includes("mojarra")) {
			precioWrap.style.display = "block";
			const personalizado = parseInt(precioInput.value, 10);
			if (!isNaN(personalizado) && personalizado > 25000) {
				precioUnitario = personalizado;
			}
			} else {
			precioWrap.style.display = "none";
			if (precioInput) precioInput.value = "";
			}

			// Tipo de corriente (solo Negocio2)
			const tipoCorrienteWrap = document.getElementById("tipoCorrienteWrap");
			const tipoCorrienteInput = document.getElementById("tipoCorriente");
			if (negocio === "Negocio2" && prod && prod.nombre.toLowerCase().includes("corriente")) {
			tipoCorrienteWrap.style.display = "block";
			} else {
			tipoCorrienteWrap.style.display = "none";
			if (tipoCorrienteInput) tipoCorrienteInput.value = "";
			}

			const total = precioUnitario * (cantidad || 1);
			document.getElementById("totalVentaPreview").textContent = COP(total);
		}

        // Inicializar localStorage
        function inicializarSistema() {
            if (!localStorage.getItem('contabilidad')) {
                const datosInicial = {
                    Negocio1: [],
                    Negocio2: [],
                    Negocio3: [],
                    Negocio4: []
                };
                localStorage.setItem('contabilidad', JSON.stringify(datosInicial));
            }
            setFechaActual();
            actualizarTotalRegistros();
			cargarProductos();
			updateGastoInputsState();
        }
		// ===== Helpers de consulta (filtradas) =====
		async function fetchPorDia(fechaISO, negocioSel='Todos'){
			const cacheKey = `dia:${fechaISO}:${negocioSel}`;
			const hit = getCache(cacheKey);
			if (hit) return hit;

			const datos = { Negocio1: [], Negocio2: [], Negocio3: [], Negocio4: [] };
			const negocios = (negocioSel==='Todos') ? Object.keys(nombresNegocios) : [negocioSel];

			// 1 consulta por negocio (evita traer todo)
			for (const neg of negocios){
				const nombre = nombresNegocios[neg] || neg;
				const qRef = window.query(
				window.collection(window.db, 'registros'),
				window.where('fecha','==', fechaISO),
				window.where('negocio','==', nombre)
				);
				const snap = await window.getDocs(qRef);
				snap.forEach(d => datos[neg].push({ id: d.id, ...d.data() }));
			}
			setCache(cacheKey, datos);
			return datos;
		}

		async function fetchPorRango(desdeISO, hastaISO, negocioSel='Todos'){
			const cacheKey = `rng:${desdeISO}:${hastaISO}:${negocioSel}`;
			const hit = getCache(cacheKey);
			if (hit) return hit;

			const datos = { Negocio1: [], Negocio2: [], Negocio3: [], Negocio4: [] };
			const negocios = (negocioSel==='Todos') ? Object.keys(nombresNegocios) : [negocioSel];

			for (const neg of negocios){
				const nombre = nombresNegocios[neg] || neg;
				const qRef = window.query(
				window.collection(window.db, 'registros'),
				window.where('negocio','==', nombre),
				window.where('fecha','>=', desdeISO),
				window.where('fecha','<=', hastaISO)
				);
				const snap = await window.getDocs(qRef);
				snap.forEach(d => datos[neg].push({ id: d.id, ...d.data() }));
			}
			setCache(cacheKey, datos);
			return datos;
		}

		async function fetchDeudas(negocioSel='Todos', {desdeISO=null, hastaISO=null, cliente=null} = {}){
			const keyRango = `${desdeISO||''}-${hastaISO||''}`;
			const cacheKey = `cxc:${negocioSel}:${keyRango}:${cliente || ''}`;
			const hit = getCache(cacheKey);
			if (hit) return hit;

			const datos = { Negocio1: [], Negocio2: [], Negocio3: [], Negocio4: [] };
			const negocios = (negocioSel==='Todos') ? Object.keys(nombresNegocios) : [negocioSel];

			for (const neg of negocios){
				const nombre = nombresNegocios[neg] || neg;
				let qArgs = [
				window.collection(window.db, 'registros'),
				window.where('negocio','==', nombre),
				window.where('estadoPago','==','Debe'),
				];
				if (cliente && cliente.trim()) {
					qArgs.push(window.where('cliente','==', cliente.trim()));
				}
				if (desdeISO) qArgs.push(window.where('fecha','>=', desdeISO));
				if (hastaISO) qArgs.push(window.where('fecha','<=', hastaISO));

				const qRef = window.query(...qArgs);
				const snap = await window.getDocs(qRef);
				snap.forEach(d => datos[neg].push({ id: d.id, ...d.data() }));
			}
			setCache(cacheKey, datos);
			return datos;
		}
		
		// === Helper: fecha local en formato YYYY-MM-DD (sin UTC) ===
		function hoyLocalISO() {
		  const d = new Date();
		  const y = d.getFullYear();
		  const m = String(d.getMonth() + 1).padStart(2, '0');
		  const day = String(d.getDate()).padStart(2, '0');
		  return `${y}-${m}-${day}`;
		}

        // Establecer fecha actual
        function setFechaActual() {
		  const hoy = hoyLocalISO();
		  document.getElementById('fecha').value = hoy;
		  document.getElementById('fechaFiltro').value = hoy;
		}

          // Guardar datos: ventas (por carrito) + gasto opcional.
		  // - estadoPago: 'pagado' | 'debe' | 'soloGasto'
		  // - nombreCliente: string | null
		  // - metodoVenta: 'Efectivo' | 'Nequi' | null (solo si 'pagado' y hay carrito)
		  // - metodoGasto: 'Efectivo' | 'Nequi' | null (si hay gasto)
		  // - soloGasto: true para ignorar carrito y registrar SOLO el gasto
		  async function guardarDatos({ estadoPago = 'pagado', nombreCliente = null, metodoVenta = null, metodoGasto = null, soloGasto = false } = {}) {
			const negocioKey = document.getElementById('business').value;
			const negocio = nombresNegocios[negocioKey];
			const fecha = document.getElementById('fecha').value;
			const gastos = parseFloat(document.getElementById('gastos').value) || 0;
			let descripcion = document.getElementById('descripcion').value || '';
			const hayCarrito = carrito.length > 0;
			const hayGasto = gastos > 0;

			if (!fecha) {
			  mostrarError('Debes seleccionar la fecha');
			  return;
			}

			if (!hayCarrito && !hayGasto) {
			  mostrarError('Agrega al menos una l√≠nea al pedido o registra un gasto.');
			  return;
			}

			// Normalizar estado
			const estadoFmt = (estadoPago === 'debe') ? 'Debe'
							 : (estadoPago === 'pagado') ? 'Pagado'
							 : 'soloGasto';

			// Validaciones m√≠nimas
			if (estadoFmt === 'Pagado' && hayCarrito && !metodoVenta) {
			  mostrarError('Selecciona el m√©todo de pago de la venta.');
			  return;
			}
			if (hayGasto && !metodoGasto) {
			  mostrarError('Selecciona el m√©todo de pago del gasto.');
			  return;
			}
			if (estadoFmt === 'Debe' && hayCarrito && !(nombreCliente && nombreCliente.trim())) {
			  mostrarError('Debes ingresar el nombre del cliente que qued√≥ debiendo.');
			  return;
			}
			if (estadoFmt === 'soloGasto' && !hayGasto) {
			  mostrarError('Seleccionaste "Solo gasto" pero no hay valor de gasto.');
			  return;
			}

			try {
			  // 1) Si NO es soloGasto, guardamos las VENTAS del carrito
			  if (!soloGasto && hayCarrito) {
				for (const item of carrito) {
				  await addDoc(collection(db, "registros"), {
					tipo: "movimiento",
					negocio,
					fecha,
					producto: item.producto,
					tipoCorriente: null,
					cantidad: item.cantidad,
					precioUnitario: item.precioUnitario,
					ventas: item.ventas,
					gastos: 0,
					// m√©todo:
					// - Pagado: usar metodoVenta
					// - Debe  : null (se asigna al cobrar)
					metodo: (estadoFmt === 'Pagado') ? metodoVenta : null,
					estadoPago: (estadoFmt === 'soloGasto') ? null : estadoFmt, // soloGasto no aplica
					cliente: (estadoFmt === 'Debe') ? (nombreCliente || null) : null,
					descripcion: `${item.producto} x ${item.cantidad}`,
					createdAt: new Date()
				  });
				}
			  }

			  // 2) Si hay GASTO, guardarlo (no aplica estadoPago ni cliente)
			  if (hayGasto) {
				await addDoc(collection(db, "registros"), {
				  tipo: "movimiento",
				  negocio,
				  fecha,
				  producto: null,
				  cantidad: null,
				  precioUnitario: null,
				  ventas: 0,
				  gastos,
				  metodo: metodoGasto,          // ‚Üê m√©todo del gasto (obligatorio si hay gasto)
				  estadoPago: null,
				  cliente: null,
				  descripcion: descripcion || 'Gasto del d√≠a',
				  createdAt: new Date()
				});
			  }

			  // Limpieza y feedback
			  carrito = [];
			  renderCarrito();
			  document.getElementById('gastos').value = '';
			  document.getElementById('descripcion').value = '';
			  mostrarExito();

			  // ‚úÖ NUEVO: invalidar cach√© y no disparar cascadas costosas
			  refreshAfterSave(fecha);  
			  // (Opcional) refrescar SOLO la vista visible para mejor UX.
			  // Ejemplo: si est√°s en la pesta√±a 'resumen', recarga esa √∫nicamente:
			  const activeTab = document.querySelector('.content.active')?.id;
			  try {
				if (activeTab === 'resumen') await actualizarResumen();
				else if (activeTab === 'metodos') await actualizarAnalisisPagos();
				else if (activeTab === 'acumulado') await actualizarAcumulado();
				// 'informes' recarga bajo demanda
			  } catch (e) {}

			} catch (error) {
			  console.error(error);
			  mostrarError("Error guardando en la nube");
			}
		  }
		
		// ====== CARRITO (pedido en pantalla) ======
		let carrito = []; // {producto, cantidad, precioUnitario, ventas}

		// Render del carrito
		function renderCarrito() {
			const tbody = document.querySelector('#carritoTabla tbody');
			const section = document.getElementById('carritoSection');
			const totalEl = document.getElementById('carritoTotal');

			if (!tbody || !section || !totalEl) return;

			tbody.innerHTML = '';
			let totalPedido = 0;

			carrito.forEach((item, idx) => {
			  const tr = document.createElement('tr');
			  const totalLinea = item.ventas || 0;
			  totalPedido += totalLinea;

			  tr.innerHTML = `
				<td>${item.producto}</td>
				<td>${item.cantidad}</td>
				<td>${COP(item.precioUnitario)}</td>
				<td>${COP(totalLinea)}</td>
				<td><button class="btn-danger" type="button" onclick="quitarLinea(${idx})">‚úñ</button></td>
			  `;
			  tbody.appendChild(tr);
			});

			totalEl.textContent = COP(totalPedido);
			section.style.display = carrito.length > 0 ? 'block' : 'none';
			
			// üëá NUEVO: actualizar el estado de los inputs de gasto
			  updateGastoInputsState();
		}

		// Quitar l√≠nea del carrito
		function quitarLinea(idx) {
		  carrito.splice(idx, 1);
		  renderCarrito();
		}

		// Agregar l√≠nea al carrito
        function agregarAlCarrito() {
          const negocio = document.getElementById('business').value;
          const index = document.getElementById("productoSelect").value;
          const cantidad = parseInt(document.getElementById("cantidad").value, 10) || 0;

          const catalogo = catalogoActual; // ‚Üê ya cargado desde Firestore + base

          if (!catalogo || index === 'manual' || !catalogo[index]) {
            mostrarError('Selecciona un producto del cat√°logo para agregar al pedido.');
            return;
          }
          if (cantidad <= 0) {
            mostrarError('La cantidad debe ser mayor a 0');
            return;
          }

          const prod = catalogo[index];
          let precioUnitario = prod.precio || 0;

          // Mojarra con precio personalizado
          if (negocio === "Negocio2" && prod.nombre.toLowerCase().includes("mojarra")) {
            const personalizado = parseInt(document.getElementById("precioPersonalizado").value, 10);
            if (!isNaN(personalizado) && personalizado > 25000) {
              precioUnitario = personalizado;
            }
          }

          // Corriente: exigir tipo
          let nombreProductoParaLinea = prod.nombre;
          if (negocio === "Negocio2" && prod.nombre.toLowerCase().includes("corriente")) {
            const tipo = (document.getElementById("tipoCorriente").value || "").trim();
            if (!tipo) {
              mostrarError('Debes indicar el tipo de corriente (ej: pollo, res, mixta).');
              return;
            }
            nombreProductoParaLinea = `Corriente (${tipo})`;
          }

          const ventas = precioUnitario * cantidad;

          carrito.push({
            producto: nombreProductoParaLinea,
            cantidad,
            precioUnitario,
            ventas
          });

          document.getElementById('cantidad').value = '1';
          const p = document.getElementById('precioPersonalizado');
          if (p) p.value = '';

          calcularTotalVenta();
          renderCarrito();
        }

		// Vaciar carrito si cambia fecha/negocio (para no mezclar cortes)
		function resetCarritoSiCambiaCorte() {
		  carrito = [];
		  renderCarrito();
		  const tipoCorriente = document.getElementById('tipoCorriente');
		  if (tipoCorriente) tipoCorriente.value = '';
		  const wrap = document.getElementById('tipoCorrienteWrap');
		  if (wrap) wrap.style.display = 'none';
		  updateGastoInputsState();
		}

		// Hookear cambios de fecha y negocio
		document.getElementById('business').addEventListener('change', resetCarritoSiCambiaCorte);
		document.getElementById('fecha').addEventListener('change', resetCarritoSiCambiaCorte);

        // Agrupa l√≠neas del d√≠a por producto para mostrar conteo y total
		function agruparPlatosPorProducto(registrosDelDia) {
		  const mapa = new Map(); // clave: producto, valor: {cantidadTotal, totalVentas}
		  registrosDelDia.forEach(r => {
			if (r.tipo === 'movimiento' && r.producto && r.cantidad && r.ventas) {
			  const key = r.producto;
			  const prev = mapa.get(key) || { cantidadTotal: 0, totalVentas: 0 };
			  prev.cantidadTotal += Number(r.cantidad) || 0;
			  prev.totalVentas += Number(r.ventas) || 0;
			  mapa.set(key, prev);
			}
		  });
		  // A HTML
		  if (mapa.size === 0) return '';
		  let rows = '';
		  mapa.forEach((val, prod) => {
			rows += `
			  <tr>
				<td>${prod}</td>
				<td style="text-align:center;">${val.cantidadTotal}</td>
				<td style="text-align:right;">${COP(val.totalVentas)}</td>
			  </tr>
			`;
		  });
		  return `
			<div style="margin-top:10px;">
			  <h4>Platos vendidos</h4>
			  <table>
				<thead>
				  <tr>
					<th>Producto</th>
					<th>Cant.</th>
					<th>Total (COP)</th>
				  </tr>
				</thead>
				<tbody>
				  ${rows}
				</tbody>
			  </table>
			</div>
		  `;
		}
		
		// === Reemplaza por completo la funci√≥n ===
		async function actualizarResumen() {
			const fecha = document.getElementById('fechaFiltro').value;
			const soloDeudas = !!document.getElementById('soloDeudas')?.checked;
			const excluirDeudasResumen = true;

			const datos = await fetchPorDia(fecha, 'Todos'); // <--- NUEVO
			const container = document.getElementById('resumenContent');
			let html = '';

			for (const [negocio, registros] of Object.entries(datos)) {
				const delDia = registros; // ya vienen filtrados por fecha
				const registrosParaSaldos = excluirDeudasResumen
				? delDia.filter(r =>
					r.tipo === "movimiento" &&
					(r.estadoPago === 'Pagado' || r.estadoPago == null) &&
					r.excluirDeAnalisis !== true
					)
				: delDia;

				let ventasEfectivo = 0, ventasNequi = 0, totalGastos = 0;
				registrosParaSaldos.forEach(r => {
				const v = Number(r.ventas || 0);
				if (r.metodo === "Efectivo") ventasEfectivo += v;
				if (r.metodo === "Nequi") ventasNequi += v;
				});
				delDia.forEach(r => { if (r.tipo === "movimiento") totalGastos += Number(r.gastos || 0); });

				const totalVentas = ventasEfectivo + ventasNequi;
				const balance = totalVentas - totalGastos;
				const saldoEfectivo = ventasEfectivo - totalGastos;
				const saldoNequi = ventasNequi;

				const registrosParaTabla = soloDeudas
				? delDia.filter(r =>
					r.tipo === 'movimiento' &&
					Number(r.ventas) > 0 &&
					r.estadoPago === 'Debe'
					)
				: delDia;

				html += `
				<div class="business-section">
					<h4>${nombresNegocios[negocio]}</h4>
					<div class="summary-grid">
					<div class="summary-box"><h4>Ventas</h4><div class="value" style="color:#007bff;">${COP(totalVentas)}</div></div>
					<div class="summary-box"><h4>Gastos</h4><div class="value" style="color:#dc3545;">-${COP(totalGastos)}</div></div>
					<div class="summary-box" style="border-color:#667eea;background:#f0f4ff;"><h4>Balance del D√≠a</h4><div class="value" style="color:#667eea;">${COP(balance)}</div></div>
					</div>
					<hr style="margin:15px 0;">
					<div style="display:flex;justify-content:space-between;">
					<div>üíµ <strong>Saldo en Efectivo:</strong><br><span style="color:#28a745;font-weight:bold;">${COP(saldoEfectivo)}</span></div>
					<div>üì± <strong>Saldo en Nequi:</strong><br><span style="color:#007bff;font-weight:bold;">${COP(saldoNequi)}</span></div>
					</div>
					${registrosParaTabla.length > 0
					? `<div class="table-responsive"><table class="tabla-registros">${generarTablaRegistros(registrosParaTabla)}</table></div>`
					: '<p style="color:#999;margin-top:15px;">No hay registros para esta fecha</p>'}
					${agruparPlatosPorProducto(registrosParaTabla)}
				</div>
				`;
			}
			container.innerHTML = html || '<p>No hay datos</p>';
		}
		
		// === Reemplaza por completo la funci√≥n ===
		async function actualizarCuentasPorCobrar() {
			const container = document.getElementById('cxcContent');
			if (!container) return;

			const datos = await fetchDeudas('Todos'); // <--- NUEVO (solo deudas)
			const mapaClientes = new Map();
			let totalGeneral = 0;
			let totalVentasPendientes = 0;

			for (const registros of Object.values(datos)) {
				registros.forEach(r => {
				const pendiente = Number((r.montoPendiente != null ? r.montoPendiente : r.ventas) || 0);
				if (pendiente > 0) {
					const cliente = (r.cliente && String(r.cliente).trim()) ? r.cliente.trim() : 'Sin nombre';
					const prev = mapaClientes.get(cliente) || { totalPendiente: 0, cantidadVentas: 0 };
					prev.totalPendiente += pendiente;
					prev.cantidadVentas += 1;
					mapaClientes.set(cliente, prev);
					totalGeneral += pendiente;
					totalVentasPendientes += 1;
				}
				});
			}

			const filas = [...mapaClientes.entries()]
				.sort((a,b) => b[1].totalPendiente - a[1].totalPendiente)
				.map(([cliente, info]) => `
				<tr>
					<td>${cliente}</td>
					<td style="text-align:center;">${info.cantidadVentas}</td>
					<td style="text-align:right;">${COP(info.totalPendiente)}</td>
					<td style="text-align:center;">
					<button class="btn-success" type="button" onclick="abrirModalCobroCliente('${cliente.replace(/'/g,"\\'")}', ${info.totalPendiente})">
						Cobrar
					</button>
					</td>
				</tr>
				`).join('');

			const clientesUnicos = mapaClientes.size;
			container.innerHTML = `
				<div class="business-section" style="border-left-color:#dc3545;">
				<h3>üí≥ Cuentas por Cobrar (Acumulado)</h3>
				<div class="summary-grid">
					<div class="summary-box"><h4>Total por Cobrar</h4><div class="value" style="color:#dc3545;">${COP(totalGeneral)}</div></div>
					<div class="summary-box"><h4>Clientes con deuda</h4><div class="value">${clientesUnicos}</div></div>
					<div class="summary-box"><h4>Ventas pendientes</h4><div class="value">${totalVentasPendientes}</div></div>
				</div>
				${ clientesUnicos > 0
					? `<table>
						<thead><tr><th>Cliente</th><th style="width:140px;"># Ventas</th><th style="width:200px;">Total Pendiente (COP)</th><th style="width:140px;">Acciones</th></tr></thead>
						<tbody>${filas}</tbody>
					</table>`
					: '<p style="color:#28a745;margin-top:10px;">No hay deudas pendientes. ‚úÖ</p>'
				}
				</div>
			`;
		}
		
		//modal por cliente
		let clienteACobrar = null;
		let deudaClienteActual = 0;

		async function abrirModalCobroCliente(cliente, deuda, negocioKey = null) {
		  clienteACobrar = cliente;
		  deudaClienteActual = Number(deuda) || 0;

		  // guarda el filtro de negocio si lo recibes (Negocio1|Negocio2|...)
		  window.filtroNegocioCobroCliente = negocioKey; // puede ser null -> 'Todos'

		  const sel = document.getElementById('negocioCobroCliente');
		  if (sel) {
				try {
					// 1) Traer deudas del cliente en TODOS los negocios (ya filtra por cliente en la query)
					const datos = await fetchDeudas('Todos', { cliente: clienteACobrar });

					// 2) Determinar en cu√°les negocios hay pendiente > 0
					const negociosConDeuda = [];
					for (const [negKey, regs] of Object.entries(datos)) {
						const tiene = regs.some(r => {
							const pendiente = Number((r.montoPendiente != null ? r.montoPendiente : r.ventas) || 0);
							return pendiente > 0;
						});
						if (tiene) negociosConDeuda.push(negKey);
					}

					// 3) Reconstruir las opciones del select
					sel.innerHTML = '';
					if (negociosConDeuda.length === 0) {
						// (Caso raro si viniste desde bot√≥n Cobrar: no hay deudas)
						const opt = document.createElement('option');
						opt.value = '';
						opt.textContent = 'Todos';
						sel.appendChild(opt);
						sel.disabled = true;
						window.filtroNegocioCobroCliente = null;
					} else if (negociosConDeuda.length === 1) {
						// Solo un negocio ‚Üí fijar y bloquear selector
						const only = negociosConDeuda[0];
						const opt = document.createElement('option');
						opt.value = only;
						opt.textContent = nombresNegocios[only] || only;
						sel.appendChild(opt);
						sel.value = only;
						sel.disabled = true;
						window.filtroNegocioCobroCliente = only;
					} else {
						// Varios negocios ‚Üí incluir 'Todos' al inicio
						const optTodos = document.createElement('option');
						optTodos.value = '';
						optTodos.textContent = 'Todos';
						sel.appendChild(optTodos);
						negociosConDeuda.forEach(negKeyIt => {
							const opt = document.createElement('option');
							opt.value = negKeyIt;
							opt.textContent = nombresNegocios[negKeyIt] || negKeyIt;
							sel.appendChild(opt);
						});
						sel.disabled = false;
						sel.value = negocioKey || '';
						window.filtroNegocioCobroCliente = negocioKey || null;
					}
				} catch (e) {
						console.warn('No se pudo poblar el selector de negocio por cliente:', e);
						// Si hay error, deja el select como est√© y no bloquees el modal
					}
		   	}

		  document.getElementById('cxcClienteNombre').textContent = clienteACobrar;
		  document.getElementById('cxcClienteDeuda').textContent = COP(deudaClienteActual);

		  document.querySelector('input[name="tipoCobroCliente"][value="total"]').checked = true;
		  toggleMontoParcial(false);
		  const monto = document.getElementById('montoParcial');
		  if (monto) monto.value = '';

		  document.querySelector('input[name="metodoCobroCliente"][value="Efectivo"]').checked = true;

		  const err = document.getElementById('modalCobroClienteError');
		  err.style.display = 'none'; err.textContent = '';

		  document.getElementById('modalCobroClienteBackdrop').style.display = 'flex';
		}

		function cerrarModalCobroCliente() {
		  document.getElementById('modalCobroClienteBackdrop').style.display = 'none';
		  clienteACobrar = null;
		  deudaClienteActual = 0;
		}

		function toggleMontoParcial(show) {
		  const wrap = document.getElementById('montoParcialWrap');
		  if (wrap) wrap.style.display = show ? 'block' : 'none';
		}
		
		function updateModalPagoUI() {
			const estado = document.querySelector('input[name="estadoPago"]:checked')?.value || 'pagado';
			const hayCarrito = (carrito && carrito.length > 0);
			const gastos = parseFloat(document.getElementById('gastos').value) || 0;
			const hayGasto = gastos > 0;

			// Nombre cliente solo si 'Debe' y hay ventas
			const nombreWrap = document.getElementById('nombreClienteWrap');
			if (nombreWrap) nombreWrap.style.display = (estado === 'debe' && hayCarrito) ? 'block' : 'none';

			// M√©todo de pago de la venta solo si 'pagado' y hay ventas
			const ventaWrap = document.getElementById('metodoVentaWrap');
			if (ventaWrap) ventaWrap.style.display = (estado === 'pagado' && hayCarrito) ? 'block' : 'none';

			// M√©todo del gasto si hay gasto (independiente del estado)
			const gastoWrap = document.getElementById('metodoGastoWrap');
			if (gastoWrap) gastoWrap.style.display = hayGasto ? 'block' : 'none';
		}
		
		// === Cobro por cliente: total/parcial con m√©todo ===
		async function confirmarCobroCliente() {
		  const err = document.getElementById('modalCobroClienteError');

		  try {
			if (!clienteACobrar) {
			  err.textContent = '‚úó No hay cliente seleccionado.'; err.style.display = 'block';
			  return;
			}

			const tipo = document.querySelector('input[name="tipoCobroCliente"]:checked')?.value || 'total';
			const metodo = document.querySelector('input[name="metodoCobroCliente"]:checked')?.value || 'Efectivo';

			let montoParcial = 0;
			if (tipo === 'parcial') {
			  montoParcial = parseInt(document.getElementById('montoParcial').value, 10) || 0;
			  if (montoParcial <= 0) {
				err.textContent = '‚úó Ingresa un monto v√°lido para el pago parcial.'; err.style.display = 'block';
				return;
			  }
			  if (montoParcial > deudaClienteActual) {
				err.textContent = '‚úó El monto parcial no puede exceder la deuda total del cliente.'; err.style.display = 'block';
				return;
			  }
			}
			

			// Cargar todas las ventas "Debe" del cliente (de todos los negocios)
			// Cargar ventas "Debe" del cliente (de todos los negocios) SIN escanear toda la colecci√≥n
			const sel = document.getElementById('negocioCobroCliente');
			const negocioFiltro = (sel && sel.value) ? sel.value : (window.filtroNegocioCobroCliente || 'Todos');
			const datos = await fetchDeudas(negocioFiltro, { cliente: clienteACobrar }); // cliente negocio si aplica
			const deudas = [];
			for (const regs of Object.values(datos)) {
				regs.forEach(r => {
					const cliente = (r.cliente && String(r.cliente).trim()) ? r.cliente.trim() : 'Sin nombre';
					if (r.tipo === 'movimiento' && cliente === clienteACobrar) {
					const pendiente = Number((r.montoPendiente != null ? r.montoPendiente : r.ventas) || 0);
					if (pendiente > 0) deudas.push({ ...r, pendiente });
					}
				});
			}

			if (deudas.length === 0) {
			  err.textContent = '‚úó No hay deudas pendientes para este cliente.'; err.style.display = 'block';
			  return;
			}

			// üîí Validaci√≥n adicional para "Pago parcial" cuando hay filtro por negocio
			if (tipo === 'parcial') {
				const totalPendienteFiltro = deudas.reduce((s, r) => s + Number(r.pendiente || 0), 0);
				if (montoParcial > totalPendienteFiltro) {
					err.textContent = `‚úó El monto parcial (${COP(montoParcial)}) excede el pendiente del negocio seleccionado (${COP(totalPendienteFiltro)}). ` +
									`Elige "Todos" o reduce el monto.`;
					err.style.display = 'block';
					return;
				}
				const input = document.getElementById('montoParcial');
				if (input) input.max = String(totalPendienteFiltro);
			}

			// Orden FIFO: por createdAt (si existe) o por fecha
			deudas.sort((a, b) => {
			  const ta = (a.createdAt && a.createdAt.toMillis) ? a.createdAt.toMillis() : new Date(a.fecha).getTime();
			  const tb = (b.createdAt && b.createdAt.toMillis) ? b.createdAt.toMillis() : new Date(b.fecha).getTime();
			  return ta - tb;
			});

			if (tipo === 'total') {
				await Promise.all(deudas.map(async (r) => {
					const pendiente = Number((r.montoPendiente != null ? r.montoPendiente : r.ventas) || 0);

					if (pendiente > 0) {
					// Crear un ABONO por el pendiente con el m√©todo elegido (p.ej., Nequi)
					await addDoc(collection(db, "registros"), {
						tipo: "movimiento",
						negocio: r.negocio,
						fecha: hoyLocalISO(),
						producto: null,
						cantidad: null,
						precioUnitario: null,
						ventas: pendiente,           // üëà SOLO el pendiente (28.000 en tu caso)
						gastos: 0,
						metodo: metodo,              // üëà ‚ÄúNequi‚Äù si elegiste Nequi
						estadoPago: 'Pagado',
						cliente: clienteACobrar,
						esAbono: true,
						originalId: r.id,            // üîó referencia al documento original
						descripcion: `Cobro final de deuda (venta del ${r.fecha})`,
						createdAt: new Date()
					});
					}

					// Marcar el original como Pagado y excluirlo del an√°lisis de flujos
					await updateDoc(doc(db, "registros", r.id), {
					estadoPago: 'Pagado',
					montoPendiente: 0,
					excluirDeAnalisis: true       // üëà evita doble conteo del original
					// NO tocar 'metodo' ni 'ventas' del original
					});
				}));
			} else {
			  // Pago parcial: repartir el monto por orden FIFO creando "abonos" como movimientos Pagados
			  let restante = montoParcial;
			  for (const r of deudas) {
				if (restante <= 0) break;

				const aplicar = Math.min(restante, r.pendiente);
				const nuevoPendiente = r.pendiente - aplicar;

				// 1) Crear un movimiento de "abono" (entra a caja hoy por el m√©todo elegido)
				await addDoc(collection(db, "registros"), {
				  tipo: "movimiento",
				  negocio: r.negocio,               // mismo negocio del √≠tem original
				  fecha: hoyLocalISO(), // hoy (hora local)
				  producto: null,                   // es un abono, no un √≠tem vendido
				  cantidad: null,
				  precioUnitario: null,
				  ventas: aplicar,
				  gastos: 0,
				  metodo: metodo,
				  estadoPago: 'Pagado',
				  cliente: clienteACobrar,
				  esAbono: true,                    // flag para identificar abonos
				  descripcion: `Cobro parcial de deuda (venta del ${r.fecha})`,
				  originalId: r.id,
				  createdAt: new Date()
				});

				// 2) Marcar el original con montoPendiente y bandera para no duplicar en an√°lisis
				const updatePayload = {
				  montoPendiente: nuevoPendiente,
				  excluirDeAnalisis: true
				};
				if (nuevoPendiente <= 0) {
				  updatePayload.estadoPago = 'Pagado';
				} else {
				  updatePayload.estadoPago = 'Debe';
				}
				await updateDoc(doc(db, "registros", r.id), updatePayload);

				restante -= aplicar;
			  }
			}

			cerrarModalCobroCliente();
			mostrarExito();

			// Refrescar tableros
			try { await actualizarCuentasPorCobrar(); } catch (e) {}
			try { await actualizarResumen(); } catch (e) {}
			try { await actualizarAnalisisPagos(); } catch (e) {}
			try { await actualizarAcumulado(); } catch (e) {}

		  } catch (e) {
			console.error(e);
			err.textContent = '‚úó Error registrando el cobro del cliente.';
			err.style.display = 'block';
		  }
		}
		
        // Actualizar cuentas acumuladas
        async function actualizarAcumulado() {
			// ‚ÄúAcumulado‚Äù = desde un origen muy antiguo hasta hoy
			const datos = await fetchPorRango('2000-01-01', hoyLocalISO(), 'Todos');

			const container = document.getElementById('acumuladoContent');
			let html = '';

			for (const [negocio, registros] of Object.entries(datos)) {
				// Saldos iniciales (informativos para este tablero)
				let saldoEfectivo = Number(saldoInicial[negocio]?.efectivo || 0);
				let saldoNequi    = Number(saldoInicial[negocio]?.nequi || 0);

				// Ventas de productos (NO abonos) ‚Äì solo info
				const totalVentasProductos = registros.reduce((sum, r) => {
				const esMov = r.tipo === 'movimiento';
				const esVenta = Number(r.ventas || 0) > 0;
				const tieneProducto = !!r.producto;
				const esAbono = r.esAbono === true ||
					(typeof r.descripcion === 'string' && r.descripcion.toLowerCase().includes('cobro parcial'));
				return (esMov && esVenta && tieneProducto && !esAbono)
					? sum + Number(r.ventas || 0)
					: sum;
				}, 0);

				// Gastos totales
				const totalGastos = registros.reduce((sum, r) => {
				if (r.tipo === 'movimiento') return sum + Number(r.gastos || 0);
				return sum;
				}, 0);

				// Flujos reales por m√©todo (ventas pagadas + abonos) - gastos
				registros.forEach(r => {
				if (r.tipo !== 'movimiento') return;
				if (r.excluirDeAnalisis === true) return;
				const v = Number(r.ventas || 0);
				const g = Number(r.gastos || 0);
				if (r.metodo === 'Efectivo') saldoEfectivo += v - g;
				if (r.metodo === 'Nequi')    saldoNequi    += v - g;
				});

				const saldoTotal = saldoEfectivo + saldoNequi;

				html += `
				<div class="summary-box">
					<h4>${nombresNegocios[negocio]}</h4>
					<p><strong>Capital Inicial:</strong> ${COP((saldoInicial[negocio]?.efectivo || 0) + (saldoInicial[negocio]?.nequi || 0))}</p>
					<p><strong>Ventas Totales:</strong> ${COP(totalVentasProductos)}</p>
					<p><strong>Gastos Totales:</strong> -${COP(totalGastos)}</p>
					<hr>
					<p><strong>Saldo Total Real:</strong> ${COP(saldoTotal)}</p>
					<hr>
					<p>üíµ Saldo Efectivo: ${COP(saldoEfectivo)}</p>
					<p>üì± Saldo Nequi: ${COP(saldoNequi)}</p>
				</div>
				`;
			}

			container.innerHTML = html;
		}

		// === Reemplaza COMPLETAMENTE tu funci√≥n por esta ===
		async function actualizarAnalisisPagos() {
			// Filtros y referencias a elementos
			const negocioFiltro = document.getElementById('negocioFiltro').value;
			const filtroFecha   = document.getElementById('filtroFechaPagos').value; // 'fecha' | 'acumulado'
			const incluirInicial = !!document.getElementById('toggleCapitalInicial')?.checked;

			const container            = document.getElementById('analisisPagosContent');
			const fechaPagosContainer  = document.getElementById('fechaPagosContainer');

			// Mostrar/ocultar selector de fecha
			if (filtroFecha === 'fecha') {
				fechaPagosContainer.style.display = 'block';
				const inputFecha = document.getElementById('fechaSeleccionadaPagos');
				if (!inputFecha.value) {
				inputFecha.value = hoyLocalISO();
				}
			} else {
				fechaPagosContainer.style.display = 'none';
			}

			// === Carga de datos optimizada (sin traer toda la colecci√≥n) ===
			let datos; // { Negocio1:[], Negocio2:[], ... }
			if (filtroFecha === 'fecha') {
				const f = document.getElementById('fechaSeleccionadaPagos').value;
				datos = await fetchPorDia(f, (negocioFiltro === 'Todos' ? 'Todos' : negocioFiltro));
			} else {
				// Acumulado hasta hoy. Si tu hist√≥rico es muy grande, podr√≠as limitar a 60-90 d√≠as.
				const desde = '2000-01-01';
				const hasta = hoyLocalISO();
				datos = await fetchPorRango(desde, hasta, (negocioFiltro === 'Todos' ? 'Todos' : negocioFiltro));
			}

			// Qu√© negocios mostrar
			const negocios = (negocioFiltro === 'Todos') ? Object.keys(datos) : [negocioFiltro];

			// Totales globales (para la banda superior)
			let totalGlobalEfectivo = 0;
			let totalGlobalNequi    = 0;

			let htmlPorNegocio = '';

			for (const negocio of negocios) {
				// Cada "registros" ya viene filtrado (por d√≠a o por rango) desde Firestore
				let registros = datos[negocio] || [];

				// Si el modo es 'fecha', por seguridad filtramos por el valor seleccionado (aunque ya venga filtrado del back)
				if (filtroFecha === 'fecha') {
				const fechaSeleccionada = document.getElementById('fechaSeleccionadaPagos').value;
				registros = registros.filter(r => r.fecha === fechaSeleccionada);
				}

				// --- C√°lculos por m√©todo (ventas pagadas y gastos) ---
				const ventasPagadasEfectivo = registros
				.filter(r =>
					r.tipo === 'movimiento' &&
					Number(r.ventas) > 0 &&
					r.metodo === 'Efectivo' &&
					(r.estadoPago === 'Pagado' || r.estadoPago == null) &&
					r.excluirDeAnalisis !== true
				)
				.reduce((sum, r) => sum + (Number(r.ventas) || 0), 0);

				const ventasPagadasNequi = registros
				.filter(r =>
					r.tipo === 'movimiento' &&
					Number(r.ventas) > 0 &&
					r.metodo === 'Nequi' &&
					(r.estadoPago === 'Pagado' || r.estadoPago == null) &&
					r.excluirDeAnalisis !== true
				)
				.reduce((sum, r) => sum + (Number(r.ventas) || 0), 0);

				const gastosEfectivo = registros
				.filter(r => r.tipo === 'movimiento' && Number(r.gastos) > 0 && r.metodo === 'Efectivo')
				.reduce((sum, r) => sum + (Number(r.gastos) || 0), 0);

				const gastosNequi = registros
				.filter(r => r.tipo === 'movimiento' && Number(r.gastos) > 0 && r.metodo === 'Nequi')
				.reduce((sum, r) => sum + (Number(r.gastos) || 0), 0);

				// Capital inicial (opcional, controlado por el toggle)
				const inicialEfectivo = incluirInicial ? (saldoInicial[negocio]?.efectivo || 0) : 0;
				const inicialNequi    = incluirInicial ? (saldoInicial[negocio]?.nequi    || 0) : 0;

				// Saldos reales por m√©todo
				const saldoEfectivo = inicialEfectivo + ventasPagadasEfectivo - gastosEfectivo;
				const saldoNequi    = inicialNequi    + ventasPagadasNequi    - gastosNequi;
				const totalSaldo    = saldoEfectivo + saldoNequi;

				// Suma a los globales
				totalGlobalEfectivo += saldoEfectivo;
				totalGlobalNequi    += saldoNequi;

				const pctEfectivo = totalSaldo > 0 ? ((saldoEfectivo / totalSaldo) * 100).toFixed(1) : 0;
				const pctNequi    = totalSaldo > 0 ? ((saldoNequi    / totalSaldo) * 100).toFixed(1) : 0;

				// --- Render por negocio (mismo look & feel que tu versi√≥n) ---
				htmlPorNegocio += `
				<div class="business-section">
					<h4>${nombresNegocios[negocio]}</h4>

					<div class="summary-grid">
					<div class="summary-box">
						<h4>üíµ Saldo en Efectivo</h4>
						<div class="value">${COP(saldoEfectivo)}</div>
						<p style="color:#666;margin-top:10px;">${pctEfectivo}%</p>
					</div>
					<div class="summary-box">
						<h4>üì± Saldo en Nequi</h4>
						<div class="value">${COP(saldoNequi)}</div>
						<p style="color:#666;margin-top:10px;">${pctNequi}%</p>
					</div>
					<div class="summary-box">
						<h4>üí∞ Total Saldos</h4>
						<div class="value">${COP(totalSaldo)}</div>
					</div>
					</div>

					<div class="summary-card" style="margin-top:10px;">
					<h3>Detalle</h3>
					<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;">
						<div>
						<strong>Inicial Efectivo:</strong> ${COP(inicialEfectivo)}<br>
						<strong>Ventas (Pagadas) Efectivo:</strong> ${COP(ventasPagadasEfectivo)}<br>
						<strong>Gastos en Efectivo:</strong> -${COP(gastosEfectivo)}
						</div>
						<div>
						<strong>Inicial Nequi:</strong> ${COP(inicialNequi)}<br>
						<strong>Ventas (Pagadas) Nequi:</strong> ${COP(ventasPagadasNequi)}<br>
						<strong>Gastos en Nequi:</strong> -${COP(gastosNequi)}
						</div>
					</div>
					</div>
				</div>
				`;
			}

			// Bloque superior (global)
			const totalGlobal = totalGlobalEfectivo + totalGlobalNequi;
			const pctGlobalEfectivo = totalGlobal > 0 ? ((totalGlobalEfectivo / totalGlobal) * 100).toFixed(1) : 0;
			const pctGlobalNequi    = totalGlobal > 0 ? ((totalGlobalNequi    / totalGlobal) * 100).toFixed(1) : 0;

			const baseTitulo = (filtroFecha === 'fecha')
				? `SALDOS DEL D√çA (${document.getElementById('fechaSeleccionadaPagos').value})`
				: 'SALDOS TOTALES (Acumulado)';

			const resumenTitulo = incluirInicial ? `${baseTitulo} ‚Äî (incluye capital inicial)` : baseTitulo;

			const headerHTML = `
				<div class="business-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
				<h4 style="color: white; text-align: center; margin-bottom: 20px; font-size: 1.1em;">${resumenTitulo}</h4>
				<div class="summary-grid">
					<div class="summary-box" style="background: rgba(255,255,255,0.95); border: none;">
					<h4 style="color: #28a745;">üíµ Saldo Efectivo</h4>
					<div class="value" style="color: #28a745;">${COP(totalGlobalEfectivo)}</div>
					<p style="color: #666; margin-top: 10px; font-weight: bold;">${pctGlobalEfectivo}%</p>
					</div>
					<div class="summary-box" style="background: rgba(255,255,255,0.95); border: none;">
					<h4 style="color: #007bff;">üì± Saldo Nequi</h4>
					<div class="value" style="color: #007bff;">${COP(totalGlobalNequi)}</div>
					<p style="color: #666; margin-top: 10px; font-weight: bold;">${pctGlobalNequi}%</p>
					</div>
					<div class="summary-box" style="background: rgba(255,255,255,0.95); border: none;">
					<h4 style="color: #667eea;">üí∞ Total General</h4>
					<div class="value" style="color: #667eea;">${COP(totalGlobal)}</div>
					</div>
				</div>
				</div>
			`;

			container.innerHTML = (headerHTML + htmlPorNegocio) || '<p>No hay datos de pagos</p>';
		}
		
		// === Reemplazar COMPLETO ===
		function generarTablaRegistros(registros, opts = {}) {
			const { mostrarAcciones = true } = opts;

			// Encabezado (incluye "Acciones" solo si se pide)
			const header = `
				<thead>
				<tr>
					<th>Fecha</th>
					<th>Producto</th>
					<th>Cant.</th>
					<th>Precio</th>
					<th>Ventas</th>
					<th>Gastos</th>
					<th>M√©todo</th>
					<th>Estado</th>
					<th>Cliente</th>
					<th>Descripci√≥n</th>
					<th>Pendiente</th>
					${mostrarAcciones ? '<th>Acciones</th>' : ''}
				</tr>
				</thead>
			`;

			let body = '<tbody>';

			registros.forEach(r => {
				const ventasNum = Number(r.ventas || 0);
				const gastosNum = Number(r.gastos || 0);
				const precioFmt = (r.precioUnitario != null) ? COP(r.precioUnitario) : '-';
				const ventasFmt = (r.tipo === "movimiento") ? COP(ventasNum) : "-";
				const estadoFmt = r.estadoPago || '-';
				const clienteFmt = r.cliente || '-';
				const gastosFmt = (r.tipo === "movimiento") ? '-' + COP(gastosNum) : "-";
				const metodoFmt = (r.tipo === "movimiento")
				? (r.metodo === 'Efectivo' ? 'üíµ Efectivo'
					: (r.metodo === 'Nequi' ? 'üì± Nequi' : (r.metodo || '-')))
				: "-";

				const pendienteFmt = (r.estadoPago === 'Debe')
				? COP((r.montoPendiente != null ? r.montoPendiente : r.ventas) || 0)
				: '-';

				const puedeCobrar =
				r.tipo === 'movimiento' && ventasNum > 0 && estadoFmt === 'Debe' && !!r.id;

				const acciones = (mostrarAcciones && puedeCobrar)
				? `<button class="btn-success" type="button" onclick="abrirModalCobrar('${r.id}')">Cobrar</button>`
				: (mostrarAcciones ? '-' : '');

				body += `
				<tr>
					<td>${r.fecha}</td>
					<td>${r.producto || '-'}</td>
					<td>${r.cantidad ?? '-'}</td>
					<td>${precioFmt}</td>
					<td style="color:#007bff;">${ventasFmt}</td>
					<td style="color:#dc3545;">${gastosFmt}</td>
					<td>${metodoFmt}</td>
					<td>${estadoFmt}</td>
					<td>${clienteFmt}</td>
					<td>${r.descripcion || '-'}</td>
					<td style="color:#d39e00;font-weight:600;">${pendienteFmt}</td>
					${mostrarAcciones ? `<td>${acciones}</td>` : ''}
				</tr>
				`;
			});

			body += '</tbody>';
			return header + body;
		}

        // Limpiar formulario
        function limpiarFormulario() {
		  document.getElementById('gastos').value = '';
		  document.getElementById('descripcion').value = '';
		  document.getElementById('cantidad').value = '1';
		  document.getElementById('totalVentaPreview').textContent = '$0';
		  const precioInput = document.getElementById("precioPersonalizado");
		  if (precioInput) precioInput.value = '';
		  setFechaActual();
		  cargarProductos(); // recarga selector de productos
		  const tipoCorriente = document.getElementById('tipoCorriente');
		  if (tipoCorriente) tipoCorriente.value = '';
		  document.getElementById('tipoCorrienteWrap').style.display = 'none';
		  updateGastoInputsState();
		}

        // Mostrar mensajes
        function mostrarExito() {
            const msg = document.getElementById('successMsg');
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 3000);
        }

        function mostrarError(texto) {
            const msg = document.getElementById('errorMsg');
            msg.textContent = '‚úó ' + texto;
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 3000);
        }
		
		// Habilita/deshabilita inputs de gasto seg√∫n el estado del carrito
		function updateGastoInputsState() {
		  const gastosEl = document.getElementById('gastos');
		  const descEl   = document.getElementById('descripcion');

		  if (!gastosEl || !descEl) return;

		  const disabled = (carrito && carrito.length > 0);

		  // Si hay productos en carrito, limpiar y deshabilitar
		  if (disabled) {
			gastosEl.value = '';
			descEl.value = '';
		  }

		  gastosEl.disabled = disabled;
		  descEl.disabled = disabled;

		  // Si el modal "Guardar Registro" est√° abierto, refrescar su UI
		  // para que no muestre "M√©todo de gasto" si est√° deshabilitado
		  try { updateModalPagoUI(); } catch (e) {}
		}
				
		// ==== MODAL DE CONFIRMACI√ìN DE PAGO ====
		function abrirModalPago() {
			const gastos = parseFloat(document.getElementById('gastos').value) || 0;
			const hayCarrito = carrito.length > 0;
			const hayGasto = gastos > 0;

			if (!hayCarrito && !hayGasto) {
			  mostrarError('Agrega al menos una l√≠nea al pedido o registra un gasto.');
			  return;
			}

			// Estado por defecto:
			// - Si hay ventas, por defecto 'pagado'
			// - Si NO hay ventas y s√≠ gasto, por defecto 'soloGasto'
			const defaultEstado = hayCarrito ? 'pagado' : 'soloGasto';
			const radio = document.querySelector(`input[name="estadoPago"][value="${defaultEstado}"]`);
			if (radio) radio.checked = true;

			// Reset campos
			const err = document.getElementById('modalPagoError');
			if (err) err.style.display = 'none';
			const nombre = document.getElementById('nombreClienteDeudor');
			if (nombre) nombre.value = '';

			// Mostrar modal + ajustar visibilidad de secciones
			document.getElementById('modalPagoBackdrop').style.display = 'flex';
			updateModalPagoUI();
		}

		function cerrarModalPago() {
		  document.getElementById('modalPagoBackdrop').style.display = 'none';
		}

		function toggleNombreCliente(mostrar) {
		  const wrap = document.getElementById('nombreClienteWrap');
		  wrap.style.display = mostrar ? 'block' : 'none';
		}

		function confirmarGuardarDesdeModal() {
			const estado = document.querySelector('input[name="estadoPago"]:checked')?.value || 'pagado';
			const nombre = (document.getElementById('nombreClienteDeudor')?.value || '').trim();
			const err = document.getElementById('modalPagoError');

			const gastos = parseFloat(document.getElementById('gastos').value) || 0;
			const hayCarrito = carrito.length > 0;
			const hayGasto = gastos > 0;

			// Leer m√©todos (si visibles/corresponden)
			let metodoVenta = null;
			let metodoGasto = null;

			const ventaWrapVisible = document.getElementById('metodoVentaWrap')?.style.display !== 'none';
			if (ventaWrapVisible) {
			  metodoVenta = document.querySelector('input[name="metodoVenta"]:checked')?.value || null;
			}

			const gastoWrapVisible = document.getElementById('metodoGastoWrap')?.style.display !== 'none';
			if (gastoWrapVisible) {
			  metodoGasto = document.querySelector('input[name="metodoGasto"]:checked')?.value || null;
			}

			// Validaciones r√°pidas en el modal
			if (estado === 'debe' && hayCarrito && !nombre) {
			  err.textContent = '‚úó Debes ingresar el nombre del cliente que qued√≥ debiendo.';
			  err.style.display = 'block';
			  return;
			}
			if (estado === 'pagado' && hayCarrito && !metodoVenta) {
			  err.textContent = '‚úó Selecciona el m√©todo de pago de la venta.';
			  err.style.display = 'block';
			  return;
			}
			if (hayGasto && !metodoGasto) {
			  err.textContent = '‚úó Selecciona el m√©todo de pago del gasto.';
			  err.style.display = 'block';
			  return;
			}

			// üü° Confirmaci√≥n si seleccion√≥ 'Solo gasto' pero hay productos en el carrito
			if (estado === 'soloGasto' && hayCarrito) {
			  const seguro = confirm('Seleccionaste "Solo gasto", pero hay productos en el carrito. Se ignorar√°n estas ventas y solo se registrar√° el gasto. ¬øDeseas continuar?');
			  if (!seguro) return;
			}

			err.style.display = 'none';
			cerrarModalPago();

			// Guardar con los par√°metros finales
			guardarDatos({
			  estadoPago: estado,
			  nombreCliente: nombre || null,
			  metodoVenta,
			  metodoGasto,
			  soloGasto: (estado === 'soloGasto')
			});
		}
		
        // Exportar datos
        async function exportarDatos() {
			const datos = await fetchPorRango('2000-01-01', hoyLocalISO(), 'Todos');
			
			// Crear nuevo objeto con nombres reales
			const datosFormateados = {};

			for (const [negocio, registros] of Object.entries(datos)) {
				const nombreReal = nombresNegocios[negocio] || negocio;
				datosFormateados[nombreReal] = registros;
			}

			const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(datosFormateados, null, 2));
			
			const link = document.createElement('a');
			link.href = dataStr;
			link.download = 'contabilidad_' + hoyLocalISO() + '.json';
			link.click();
		}


        // Descargar Excel (actualizado correctamente)
		async function descargarExcel() {
		  const datos = await fetchPorRango('2000-01-01', hoyLocalISO(), 'Todos');
		  let csv = 'Negocio,Fecha,Producto,Tipo Corriente,Cantidad,Precio Unitario,Ventas,Gastos,M√©todo,Estado Pago,Cliente,Descripci√≥n\n';
		  for (const [negocio, registros] of Object.entries(datos)) {
			registros.forEach(r => {
			  if (r.tipo === "movimiento") {
				const descripcion = (r.descripcion || '').replace(/"/g, '""');
				function csvEsc(s) {
					s = (s ?? '').toString();
					return `"${s.replace(/"/g, '""')}"`;
					}

					// y √∫salo en todas las columnas string:
					csv += [
					csvEsc(nombresNegocios[negocio]),
					csvEsc(r.fecha),
					csvEsc(r.producto || ''),
					csvEsc(r.tipoCorriente || ''),
					r.cantidad ?? '',
					r.precioUnitario ?? '',
					r.ventas || 0,
					r.gastos || 0,
					csvEsc(r.metodo || ''),
					csvEsc(r.estadoPago || ''),
					csvEsc(r.cliente || ''),
					csvEsc(descripcion)
				].join(',') + '\n';


			  }
			});
		  }
		  const link = document.createElement('a');
		  link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
		  link.download = 'contabilidad_' + hoyLocalISO() + '.csv';
		  link.click();
		}

        // Limpiar todo
        function limpiarTodos() {
            if (confirm('¬øEst√°s seguro de que deseas limpiar TODOS los datos? Esta acci√≥n no se puede deshacer.')) {
                localStorage.removeItem('contabilidad');
                inicializarSistema();
                actualizarTotalRegistros();
                mostrarExito();
            }
        }

        // Actualizar total de registros
        // Requiere exponer getCountFromServer en <script type="module"> como window.getCountFromServer
		async function actualizarTotalRegistros() {
			try {
				const q = window.query(window.collection(window.db, 'registros'));
				const snap = await window.getCountFromServer(q);
				document.getElementById('totalRegistros').textContent = snap.data().count || 0;
			} catch (e) {
				console.warn('No se pudo obtener el conteo agregado; omito para evitar lecturas grandes.', e);
			}
		}
        
		// Productos y c√°lculo
		document.getElementById("business").addEventListener("change", cargarProductos);
		document.getElementById("productoSelect").addEventListener("change", calcularTotalVenta);
		document.getElementById("cantidad").addEventListener("input", calcularTotalVenta);
		document.getElementById("precioPersonalizado").addEventListener("input", calcularTotalVenta);

		// Espera a que el <script type="module"> exponga las globals de Firebase
		async function waitForFirebaseReady() {
			while (!(window.db && window.getDocs && window.collection && window.updateDoc)) {
			// Espera 20ms y vuelve a chequear
			await new Promise(r => setTimeout(r, 20));
			}
		}

		// Inicializa SOLO cuando Firebase globals est√©n listas
		window.addEventListener('DOMContentLoaded', async () => {
			try {
				await waitForFirebaseReady();
				// Espera usuario autenticado (el m√≥dulo redirige si no hay sesi√≥n)
				await waitForAuthUser();
				// Migrar cat√°logo local -> DB si aplica (una sola vez)
				await migrarCatalogosLocalesALaDB();
			} catch (e) {
			console.error('Firebase no se inicializ√≥ a tiempo:', e);
			} finally {
			// Tu inicializaci√≥n normal
			inicializarSistema();
			}
		});
		
		async function switchTab(tabName, ev) {
			const contents = document.querySelectorAll('.content');
			const buttons  = document.querySelectorAll('.tab-button');

			// Desactivar todo
			contents.forEach(c => c.classList.remove('active'));
			buttons.forEach(b => b.classList.remove('active'));

			// Activar contenido
			document.getElementById(tabName).classList.add('active');
			if (ev && ev.target) ev.target.classList.add('active');

			// Cargar datos al entrar a cada pesta√±a
			if (tabName === 'resumen') {
				await actualizarResumen();
				await actualizarCuentasPorCobrar();
			}

			if (tabName === 'acumulado') {
				await actualizarAcumulado();
			}

			if (tabName === 'metodos') {
				await actualizarAnalisisPagos();
			}

			if (tabName === 'configuracion') {
				renderCatalogoUI();
			}

			if (tabName === 'informes') {
				try {
					// [Eliminado] llamadas inmediatas a todos los informes
					// Lazy-load: se cargan al abrir cada <details> por primera vez (ver listeners abajo)
				} catch (e) { console.warn(e); }
				restoreInformesState();
				initInformesAccordionHotkeys();
				// === Listeners de carga perezosa ===
				const mensual = document.getElementById('secMensual');
				const periodo = document.getElementById('secPeriodo');
				const pl      = document.getElementById('secPL');
				if (mensual && !mensual.__wired) {
					mensual.__wired = true;
					mensual.addEventListener('toggle', async () => {
					if (mensual.open && !mensual.__loaded) {
						const mesEl = document.getElementById('mesReporte');
						if (mesEl && !mesEl.value) {
						const d = new Date(); const y = d.getFullYear(); const m = String(d.getMonth()+1).padStart(2,'0');
						mesEl.value = `${y}-${m}`;
						}
						await previsualizarInforme();
						mensual.__loaded = true;
					}
					});
					if (mensual.open) mensual.dispatchEvent(new Event('toggle'));
				}
				if (periodo && !periodo.__wired) {
					periodo.__wired = true;
					periodo.addEventListener('toggle', async () => {
						if (periodo.open && !periodo.__loaded) {
						const dEl = document.getElementById('infDesdePeriodo');
						const hEl = document.getElementById('infHastaPeriodo');
						if (dEl && !dEl.value) dEl.value = primerDiaMesActualISO();
						if (hEl && !hEl.value) hEl.value = hoyLocalISO();
						await previsualizarPeriodoInforme();
						await renderCxcPeriodoEnInformes();
						periodo.__loaded = true;
						}
					});
					if (periodo.open) periodo.dispatchEvent(new Event('toggle'));
				}
				if (pl && !pl.__wired) {
					pl.__wired = true;
					pl.addEventListener('toggle', async () => {
						if (pl.open && !pl.__loaded) {
						const dp = document.getElementById('plDesde');
						const hp = document.getElementById('plHasta');
						if (dp && !dp.value) dp.value = primerDiaMesActualISO();
						if (hp && !hp.value) hp.value = hoyLocalISO();
						await previsualizarPL();
						pl.__loaded = true;
						}
					});
					if (pl.open) pl.dispatchEvent(new Event('toggle'));
				}
			}
		}
		
		// ===== Cobrar ventas en "Debe" =====
		let ventaACobrarId = null;

		function abrirModalCobrar(id) {
			ventaACobrarId = id;
			document.getElementById('modalCobrarError').style.display = 'none';
			// Default: Efectivo
			const ef = document.getElementById('cobroEfectivo');
			if (ef) ef.checked = true;
			document.getElementById('modalCobrarBackdrop').style.display = 'flex';
		}

		function cerrarModalCobrar() {
			document.getElementById('modalCobrarBackdrop').style.display = 'none';
			ventaACobrarId = null;
		}

		async function confirmarCobro() {
			const err = document.getElementById('modalCobrarError');
			try {
			if (!ventaACobrarId) {
				err.textContent = '‚úó No se encontr√≥ la venta a cobrar.';
				err.style.display = 'block';
				return;
			}
			const metodoSel = document.querySelector('input[name="metodoCobro"]:checked')?.value || 'Efectivo';

			// Leer el doc original para saber cu√°nto est√° pendiente
			const ref  = doc(db, "registros", ventaACobrarId);
			const snap = await getDoc(ref);
			if (!snap.exists()) {
				err.textContent = '‚úó La venta ya no existe.';
				err.style.display = 'block';
				return;
			}

			const r = snap.data();
			const pendiente = Number((r.montoPendiente != null ? r.montoPendiente : r.ventas) || 0);
			const cliente   = (r.cliente && String(r.cliente).trim()) ? r.cliente.trim() : null;

			if (pendiente > 0) {
				// Crear el ABONO del pendiente con el m√©todo elegido
				await addDoc(collection(db, "registros"), {
				tipo: "movimiento",
				negocio: r.negocio,
				fecha: hoyLocalISO(),
				producto: null,
				cantidad: null,
				precioUnitario: null,
				ventas: pendiente,
				gastos: 0,
				metodo: metodoSel,
				estadoPago: 'Pagado',
				cliente: cliente,
				esAbono: true,
				originalId: ventaACobrarId,
				descripcion: `Cobro final de deuda (venta del ${r.fecha})`,
				createdAt: new Date()
				});
			}

			// Marcar el original como Pagado + excluir de an√°lisis de flujos
			await updateDoc(ref, {
				estadoPago: 'Pagado',
				montoPendiente: 0,
				excluirDeAnalisis: true
				// No tocar 'metodo' ni 'ventas' del original
			});

			cerrarModalCobrar();
			mostrarExito();

			} catch (e) {
			console.error(e);
			err.textContent = '‚úó Error registrando el cobro.';
			err.style.display = 'block';
			}
		}

		/* =============== INFORMES MENSUALES (PDF) =============== */

		// Helpers de fecha
		function getYYYYMMFromInput() {
			const v = (document.getElementById('mesReporte')?.value || '').trim(); // 'YYYY-MM'
			if (!/^\d{4}-\d{2}$/.test(v)) return null;
			return v;
		}
		function nombreMes(yyyyMM) {
			const [y, m] = yyyyMM.split('-').map(s => parseInt(s,10));
			const f = new Date(y, m-1, 1);
			return f.toLocaleDateString('es-CO', { month: 'long', year: 'numeric' });
		}

		// Filtra por mes 'YYYY-MM'
		function esDelMes(reg, yyyyMM) {
			const f = (reg.fecha || '').trim();
			return f.startsWith(`${yyyyMM}-`); // ej: '2026-02-'
		}

		// Construir datos del informe (por negocio y global)
		function construirResumenMensual(datosPorNegocio, yyyyMM, negocioFiltro='Todos') {
			// Mes seleccionado
			const yyyy = parseInt(yyyyMM.slice(0,4), 10);
			const mm   = parseInt(yyyyMM.slice(5,7), 10);
			const cierreMes = new Date(yyyy, mm, 0); // √∫ltimo d√≠a del mes
			const cierreISO = `${cierreMes.getFullYear()}-${String(cierreMes.getMonth()+1).padStart(2,'0')}-${String(cierreMes.getDate()).padStart(2,'0')}`;

			const negocios = (negocioFiltro === 'Todos') ? Object.keys(datosPorNegocio) : [negocioFiltro];

			const result = {
				global: { ventas: 0, gastos: 0, balance: 0 },
				negocios: {}
			};

			for (const neg of negocios) {
				const regsAll = datosPorNegocio[neg] || [];
				const regsMes = regsAll.filter(r => esDelMes(r, yyyyMM));

				// ======== VENTAS (BASE CAJA) ========
				// Ventas pagadas: tienen producto, ventas>0, m√©todo (Efectivo/Nequi) y NO est√°n excluidas.
				const ventasPagadasProductos = regsMes.reduce((sum, r) => {
				const esMov   = r.tipo === 'movimiento';
				const esVenta = Number(r.ventas || 0) > 0;
				const tieneProducto = !!r.producto;
				const tieneMetodo   = r.metodo === 'Efectivo' || r.metodo === 'Nequi';
				const excluida      = r.excluirDeAnalisis === true;
				if (esMov && esVenta && tieneProducto && tieneMetodo && !excluida) {
					return sum + Number(r.ventas || 0);
				}
				return sum;
				}, 0);

				// Abonos del mes (entran a caja el d√≠a del cobro)
				const ventasPorAbonos = regsMes.reduce((sum, r) => {
				const esMov = r.tipo === 'movimiento';
				const esAbono = r.esAbono === true;
				const esVenta = Number(r.ventas || 0) > 0;
				return (esMov && esAbono && esVenta) ? sum + Number(r.ventas || 0) : sum;
				}, 0);

				const ventasCaja = ventasPagadasProductos + ventasPorAbonos;

				// ======== GASTOS (como ya lo ten√≠as) ========
				let gastos = 0;
				const gastoCatMap = new Map();
				regsMes.forEach(r => {
				if (r.tipo === 'movimiento' && Number(r.gastos || 0) > 0) {
					const t = Number(r.gastos || 0);
					gastos += t;
					const cat = ((r.descripcion || 'Sin descripci√≥n').trim() || 'Sin descripci√≥n');
					gastoCatMap.set(cat, (gastoCatMap.get(cat) || 0) + t);
				}
				});

				// ======== TOP PRODUCTOS (por lo vendido/entregado, NO abonos) ========
				const prodMap = new Map();
				regsMes.forEach(r => {
				const esMov   = r.tipo === 'movimiento';
				const esVenta = Number(r.ventas || 0) > 0;
				const tieneProducto = !!r.producto;
				const esAbono = r.esAbono === true;
				if (esMov && esVenta && tieneProducto && !esAbono) {
					const prev = prodMap.get(r.producto) || { cantidad: 0, total: 0 };
					prev.cantidad += Number(r.cantidad || 0);
					prev.total    += Number(r.ventas   || 0);
					prodMap.set(r.producto, prev);
				}
				});
				const topProductos = [...prodMap.entries()]
				.map(([producto, info]) => ({ producto, cantidad: info.cantidad, total: info.total }))
				.sort((a,b) => b.total - a.total)
				.slice(0, 10);

				// ======== CUENTAS POR COBRAR (CxC) ========
				// 1) Cr√©dito originado en el mes: ventas con producto & estado 'Debe' en el mes (no abonos)
				const creditoOriginadoMes = regsMes.reduce((sum, r) => {
				const esMov   = r.tipo === 'movimiento';
				const esVenta = Number(r.ventas || 0) > 0;
				const tieneProducto = !!r.producto;
				const esDebe = r.estadoPago === 'Debe';
				const esAbono = r.esAbono === true;
				return (esMov && esVenta && tieneProducto && esDebe && !esAbono)
					? sum + Number(r.ventas || 0)
					: sum;
				}, 0);

				// 2) Abonos aplicados a ventas ORIGINADAS en este mes:
				//    - r.esAbono === true dentro del mes
				//    - y su r.originalId apunta a un doc de este negocio cuya 'fecha' ‚àà mes y fue 'Debe'
				const ventasDelMesPorId = new Map(); // idVentaOriginal -> ventas de esa venta (para filtrar)
				regsMes.forEach(r => {
				const esMov   = r.tipo === 'movimiento';
				const esVenta = Number(r.ventas || 0) > 0;
				const tieneProducto = !!r.producto;
				const esDebe = r.estadoPago === 'Debe';
				if (esMov && esVenta && tieneProducto && esDebe && r.id) {
					ventasDelMesPorId.set(r.id, true);
				}
				});

				const abonosAventasDelMes = regsMes.reduce((sum, r) => {
				const esAbono = r.esAbono === true;
				const v = Number(r.ventas || 0);
				if (esAbono && v > 0 && r.originalId && ventasDelMesPorId.has(r.originalId)) {
					return sum + v;
				}
				return sum;
				}, 0);

				// 3) Pendiente al cierre de ventas originadas este mes
				const pendienteOriginadoMes = Math.max(0, creditoOriginadoMes - abonosAventasDelMes);

				// 4) Pendiente total acumulado al cierre (todas las deudas vivas hasta fin de mes)
				//    buscamos en TODO el arreglo del negocio (no solo el mes) las ventas en 'Debe' con pendiente > 0
				const pendienteTotalAcumulado = regsAll.reduce((sum, r) => {
				const esMov   = r.tipo === 'movimiento';
				const esVenta = Number(r.ventas || 0) > 0;
				const tieneProducto = !!r.producto;
				const esDebe = r.estadoPago === 'Debe';
				const fechaOk = (r.fecha && r.fecha <= cierreISO); // fecha string YYYY-MM-DD
				if (esMov && esVenta && tieneProducto && esDebe && fechaOk) {
					const pendiente = Number((r.montoPendiente != null ? r.montoPendiente : r.ventas) || 0);
					return pendiente > 0 ? sum + pendiente : sum;
				}
				return sum;
				}, 0);

				// (Opcional) Top deudores originados en el mes: por cliente
				const mapaDeudoresMes = new Map(); // cliente -> { originado, abonado, pendiente }
				regsMes.forEach(r => {
				const esVentaDebeMes = (r.tipo === 'movimiento' && Number(r.ventas||0)>0 && !!r.producto && r.estadoPago==='Debe');
				if (esVentaDebeMes) {
					const cliente = (r.cliente && String(r.cliente).trim()) ? r.cliente.trim() : 'Sin nombre';
					const prev = mapaDeudoresMes.get(cliente) || { originado:0, abonado:0, pendiente:0 };
					prev.originado += Number(r.ventas || 0);
					mapaDeudoresMes.set(cliente, prev);
				}
				});
				regsMes.forEach(r => {
				const esAbono = r.esAbono === true;
				if (esAbono && r.originalId) {
					// localizar el doc original en regsMes (solo cuenta si la venta original fue de este mes)
					const original = regsMes.find(x => x.id === r.originalId);
					if (original && original.estadoPago === 'Debe') {
					const cliente = (original.cliente && String(original.cliente).trim()) ? original.cliente.trim() : 'Sin nombre';
					const prev = mapaDeudoresMes.get(cliente) || { originado:0, abonado:0, pendiente:0 };
					prev.abonado += Number(r.ventas || 0);
					mapaDeudoresMes.set(cliente, prev);
					}
				}
				});
				// Calcula pendiente por cliente (de lo originado en el mes)
				const deudoresMes = [...mapaDeudoresMes.entries()]
				.map(([cliente, kpi]) => ({ cliente, originado: kpi.originado, abonado: kpi.abonado, pendiente: Math.max(0, kpi.originado - kpi.abonado) }))
				.sort((a,b) => b.pendiente - a.pendiente);

				// ======== Armar resultado negocio ========
				const balance = ventasCaja - gastos;
				const gastosCat = [...gastoCatMap.entries()]
				.map(([categoria, total]) => ({ categoria, total }))
				.sort((a,b) => b.total - a.total)
				.slice(0, 10);

				result.negocios[neg] = {
				ventas: ventasCaja,
				gastos,
				balance,
				topProductos,
				gastosCat,
				// KPIs de CxC
				cxc: {
					originadoMes: creditoOriginadoMes,
					abonosAplicadosMes: abonosAventasDelMes,
					pendienteOriginadoMes,
					pendienteTotalAcumulado,
					deudoresMes // top deudores del mes (origen)
				}
				};

				result.global.ventas += ventasCaja;
				result.global.gastos += gastos;
			}

			result.global.balance = result.global.ventas - result.global.gastos;
			return result;
		}

		function monthRangeFromYYYYMM(yyyyMM){
			const [y, m] = yyyyMM.split('-').map(Number);
			const desde = `${yyyyMM}-01`;
			const hasta = `${y}-${String(m).padStart(2,'0')}-${String(new Date(y, m, 0).getDate()).padStart(2,'0')}`;
			return { desde, hasta };
		}

		// Previsualizaci√≥n simple en pantalla (HTML)
		async function previsualizarInforme() {
			const yyyyMM = getYYYYMMFromInput();
			if (!yyyyMM) { mostrarError('Selecciona un mes v√°lido (YYYY-MM).'); return; }

			const negocioSel = document.getElementById('negocioReporte')?.value || 'Todos';

			const { desde: primerDia, hasta: ultimoDia } = monthRangeFromYYYYMM(yyyyMM);

			// üîπ Cargar solo el rango del mes (evita traer todo)
			const datos = await fetchPorRango(primerDia, ultimoDia, negocioSel);

			// Construye el resumen mensual (tus KPIs)
			const resumen = construirResumenMensual(datos, yyyyMM, negocioSel);

			const cont = document.getElementById('previewInforme');

			// Render muy ligero: tabla resumen por negocio
			let html = `
				<div class="business-section">
				<h4>Resumen - ${nombreMes(yyyyMM)} (${negocioSel === 'Todos' ? 'Todos los negocios' : (nombresNegocios[negocioSel]||negocioSel)})</h4>
				<table>
					<thead>
					<tr>
						<th>Negocio</th>
						<th>Ventas (caja)</th>
						<th>Gastos</th>
						<th>Balance</th>
					</tr>
					</thead>
					<tbody>
			`;

			for (const [neg, info] of Object.entries(resumen.negocios)) {
				html += `
				<tr>
					<td>${nombresNegocios[neg] || neg}</td>
					<td style="color:#007bff;">${COP(info.ventas)}</td>
					<td style="color:#dc3545;">-${COP(info.gastos)}</td>
					<td style="font-weight:600;color:${info.balance>=0 ? '#28a745' : '#dc3545'};">${COP(info.balance)}</td>
				</tr>
				`;
			}

			html += `
					</tbody>
				</table>
				<div class="summary-card">
					<h3 style="margin-bottom:6px;">Totales</h3>
					<div>Ventas (caja): <strong>${COP(resumen.global.ventas)}</strong></div>
					<div>Gastos: <strong>-${COP(resumen.global.gastos)}</strong></div>
					<div>Balance: <strong>${COP(resumen.global.balance)}</strong></div>
				</div>
			`;

			// ‚¨á‚¨á Secci√≥n de CxC (despu√©s de "Totales") ‚¨á‚¨á
			for (const [neg, info] of Object.entries(resumen.negocios)) {
				const c = info.cxc || { originadoMes:0, abonosAplicadosMes:0, pendienteOriginadoMes:0, pendienteTotalAcumulado:0 };
				html += `
				<div class="summary-card" style="margin-top:10px;">
					<h3 style="margin-bottom:6px;">Cuentas por Cobrar ‚Äî ${nombresNegocios[neg] || neg}</h3>
					<div>Cr√©dito originado en el mes: <strong>${COP(c.originadoMes)}</strong></div>
					<div>Abonos aplicados (mes): <strong>-${COP(c.abonosAplicadosMes)}</strong></div>
					<div>Pendiente al cierre (de lo originado en el mes): <strong>${COP(c.pendienteOriginadoMes)}</strong></div>
					<div>Pendiente total acumulado al cierre (sumando meses anteriores): <strong>${COP(c.pendienteTotalAcumulado)}</strong></div>
				</div>
				`;
			}
			// ‚¨Ü‚¨Ü Fin del bloque CxC ‚¨Ü‚¨Ü

			html += `
				</div>
			`;

			cont.innerHTML = html;
		}

		// Exportar PDF
		async function exportarInformeMensualPDF() {
			const yyyyMM = getYYYYMMFromInput();
			if (!yyyyMM) { mostrarError('Selecciona un mes v√°lido (YYYY-MM).'); return; }

			const negocioSel = document.getElementById('negocioReporte')?.value || 'Todos';

			const { desde: primerDia, hasta: ultimoDia } = monthRangeFromYYYYMM(yyyyMM);

			// ‚¨áÔ∏è Trae solo los datos del mes y del negocio seleccionado
			const datos = await fetchPorRango(primerDia, ultimoDia, negocioSel);

			// Resumen mensual con tus KPIs (misma funci√≥n que usas en la previsualizaci√≥n)
			const resumen = construirResumenMensual(datos, yyyyMM, negocioSel);

			// ======== PDF =========
			const { jsPDF } = window.jspdf;
			const doc = new jsPDF({ unit:'pt', format:'a4' });
			const margin = 36; // 0.5in
			const pageWidth  = doc.internal.pageSize.getWidth();
			const pageHeight = doc.internal.pageSize.getHeight();

			function header() {
				doc.setFillColor(102,126,234); // #667eea
				doc.rect(0,0,pageWidth,54,'F');
				doc.setFont('helvetica','bold');
				doc.setTextColor('#ffffff');
				doc.setFontSize(14);
				doc.text('Sistema de Contabilidad ‚Äî Informe mensual', margin, 28);
				doc.setFont('helvetica','normal');
				doc.setFontSize(11);
				doc.text(`${nombreMes(yyyyMM)} ¬∑ ${negocioSel==='Todos' ? 'Todos los negocios' : (nombresNegocios[negocioSel]||negocioSel)}`, margin, 46);
			}

			function footer() {
				const str = `Generado ${new Date().toLocaleString('es-CO')} ¬∑ P√°g. ${doc.internal.getNumberOfPages()}`;
				doc.setFontSize(9);
				doc.setTextColor('#777');
				doc.text(str, pageWidth - margin, pageHeight - 14, { align:'right' });
			}

			header();

			// Tabla Resumen por negocio
			const resumenRows = Object.entries(resumen.negocios).map(([neg, inf]) => ([
				(nombresNegocios[neg] || neg),
				COP(inf.ventas),
				`-${COP(inf.gastos)}`,
				COP(inf.balance)
			]));

			// ‚¨áÔ∏è Ajustes ligeros para evitar el warning de ancho
			doc.autoTable({
				startY: 70,
				head: [['Negocio', 'Ventas (caja)', 'Gastos', 'Balance']],
				body: resumenRows,
				theme: 'striped',
				headStyles: { fillColor: [102,126,234] },
				styles: { fontSize: 9.5, cellPadding: 5 },   // antes: 10 / 6
				columnStyles: {
				1: { halign: 'right' },
				2: { halign: 'right' },
				3: { halign: 'right' },
				},
				didDrawPage: (data) => {
				if (data.pageNumber > 1) header();
				},
				margin: { left: margin, right: margin }
			});

			// Totales globales
			const afterResumenY = doc.lastAutoTable?.finalY || 90;
			doc.setFontSize(11);
			doc.setTextColor('#333');
			doc.setFont('helvetica','bold');
			doc.text('Totales del per√≠odo:', margin, afterResumenY + 24);
			doc.setFont('helvetica','normal');
			doc.setTextColor('#000');
			doc.text(`Ventas (caja): ${COP(resumen.global.ventas)} ¬∑ Gastos: -${COP(resumen.global.gastos)} ¬∑ Balance: ${COP(resumen.global.balance)}`, margin, afterResumenY + 42);
			let yCursor = afterResumenY + 58;

			// Secciones por negocio (Top productos, Gastos por categor√≠a y CxC)
			for (const [neg, inf] of Object.entries(resumen.negocios)) {
				if (yCursor > pageHeight - 180) { doc.addPage(); header(); yCursor = 70; }

				doc.setFont('helvetica','bold');
				doc.setFontSize(12);
				doc.setTextColor('#333');
				doc.text(`‚Ä¢ ${nombresNegocios[neg] || neg}`, margin, yCursor);
				yCursor += 10;

				// KPIs cortos
				doc.setFont('helvetica','normal');
				doc.setFontSize(10);
				doc.text(`Ventas (caja): ${COP(inf.ventas)} ¬∑ Gastos: -${COP(inf.gastos)} ¬∑ Balance: ${COP(inf.balance)}`, margin, yCursor + 14);

				// Top productos
				const prodBody = (inf.topProductos.length ? inf.topProductos : [{producto:'(sin datos)',cantidad:0,total:0}])
				.map(p => [p.producto, String(p.cantidad), COP(p.total)]);
				doc.autoTable({
				startY: yCursor + 28,
				head: [['Top productos', 'Cant.', 'Total en Ventas']],
				body: prodBody,
				theme: 'grid',
				headStyles: { fillColor: [102,126,234] },
				styles: { fontSize: 9, cellPadding: 5 },
				columnStyles: {
					1: { halign: 'center', cellWidth: 60 },
					2: { halign: 'right',  cellWidth: 80 },
				},
				margin: { left: margin, right: margin },
				didDrawPage: (data) => { if (data.pageNumber > 1) header(); }
				});

				const afterProdY = doc.lastAutoTable?.finalY || (yCursor + 28);

				// Gastos por categor√≠a
				const gastosBody = (inf.gastosCat.length ? inf.gastosCat : [{categoria:'(sin datos)', total:0}])
				.map(g => [g.categoria, `-${COP(g.total)}`]);
				doc.autoTable({
				startY: afterProdY + 12,
				head: [['Gastos por categor√≠a', 'Total']],
				body: gastosBody,
				theme: 'grid',
				headStyles: { fillColor: [220,53,69] }, // rojo
				styles: { fontSize: 9, cellPadding: 5 },
				columnStyles: { 1: { halign: 'right', cellWidth: 100 } },
				margin: { left: margin, right: margin },
				didDrawPage: (data) => { if (data.pageNumber > 1) header(); }
				});

				// Secci√≥n CxC (del mes y acumulado) ‚Äî ya la ten√≠as: la dejo igual
				yCursor = doc.lastAutoTable?.finalY + 22;
				const k = inf.cxc || { originadoMes:0, abonosAplicadosMes:0, pendienteOriginadoMes:0, pendienteTotalAcumulado:0, deudoresMes:[] };
				if (yCursor > pageHeight - 180) { doc.addPage(); header(); yCursor = 70; }

				doc.setFont('helvetica','bold');
				doc.setFontSize(11);
				doc.text('Cuentas por Cobrar (estado del per√≠odo)', margin, yCursor);
				doc.setFont('helvetica','normal');
				doc.setFontSize(10);

				const cxcRows = [
				['Cr√©dito originado en el mes',            COP(k.originadoMes)],
				['Abonos aplicados a ese cr√©dito (mes)',   `-${COP(k.abonosAplicadosMes)}`],
				['Pendiente al cierre (de lo originado)',  COP(k.pendienteOriginadoMes)],
				['Pendiente total acumulado al cierre',    COP(k.pendienteTotalAcumulado)]
				];
				doc.autoTable({
				startY: yCursor + 10,
				head: [['Concepto', 'Valor']],
				body: cxcRows,
				theme: 'grid',
				headStyles: { fillColor: [52,58,64] }, // gris oscuro
				styles: { fontSize: 9, cellPadding: 5 },
				columnStyles: { 1: { halign: 'right', cellWidth: 180 } },
				margin: { left: margin, right: margin },
				didDrawPage: (data) => { if (data.pageNumber > 1) header(); }
				});

				const afterCxcY = doc.lastAutoTable?.finalY || (yCursor + 10);

				if (k.deudoresMes && k.deudoresMes.length) {
				if (afterCxcY > pageHeight - 160) { doc.addPage(); header(); }
				const bodyDeud = k.deudoresMes.slice(0, 10).map(d => [
					d.cliente,
					COP(d.originado),
					`-${COP(d.abonado)}`,
					COP(d.pendiente)
				]);
				doc.autoTable({
					startY: Math.max(afterCxcY + 12, 70),
					head: [['Top deudores del mes', 'Originado', 'Abonado', 'Pendiente']],
					body: bodyDeud,
					theme: 'grid',
					headStyles: { fillColor: [220,53,69] },
					styles: { fontSize: 9, cellPadding: 5 },
					columnStyles: {
					1: { halign: 'right', cellWidth: 90 },
					2: { halign: 'right', cellWidth: 90 },
					3: { halign: 'right', cellWidth: 90 }
					},
					margin: { left: margin, right: margin },
					didDrawPage: (data) => { if (data.pageNumber > 1) header(); }
				});
				yCursor = doc.lastAutoTable?.finalY + 22;
				} else {
				yCursor = afterCxcY + 18;
				}
			}

			// Footer en todas las p√°ginas
			const totalPages = doc.internal.getNumberOfPages();
			for (let i=1; i<=totalPages; i++) {
				doc.setPage(i);
				footer();
			}

			const fileName = `informe_mensual_${yyyyMM}${negocioSel==='Todos' ? '' : '_' + negocioSel}.pdf`;
			doc.save(fileName);
		}

		/*// ===== Helpers de fechas para el per√≠odo en Informes =====
		function primerDiaMesActualISO() {
			const d = new Date();
			const y = d.getFullYear();
			const m = d.getMonth() + 1;
			return `${y}-${String(m).padStart(2,'0')}-01`;
		}
		function esFechaEnRango(fechaISO, desdeISO, hastaISO) {
			if (!fechaISO) return false;
			if (desdeISO && fechaISO < desdeISO) return false;
			if (hastaISO && fechaISO > hastaISO) return false;
			return true;
		}*/

		// ===== Previsualizaci√≥n del PER√çODO dentro de Informes (r√©plica de Resumen Diario) =====
		async function previsualizarPeriodoInforme() {
			const desde = document.getElementById('infDesdePeriodo').value;
			const hasta = document.getElementById('infHastaPeriodo').value;
			const soloDeudas = !!document.getElementById('infSoloDeudasPeriodo')?.checked;
			const negocioSel = document.getElementById('infNegocioReporte')?.value || 'Todos'; // üîµ NUEVO

			if (!desde || !hasta) { mostrarError('Selecciona un rango de fechas v√°lido.'); return; }
			if (hasta < desde) { mostrarError('La fecha final no puede ser menor a la inicial.'); return; }

			const datos = await fetchPorRango(desde, hasta, negocioSel);
			const container = document.getElementById('previewPeriodoInforme');
			let html = '';

			// Iterar solo los negocios seleccionados
			const negocios = (negocioSel === 'Todos') ? Object.keys(datos) : [negocioSel];

			for (const negocio of negocios) {
				const registros = datos[negocio] || [];
				const delRango = registros.filter(r => esFechaEnRango(r.fecha, desde, hasta));

				// (‚Ä¶ el resto de tu l√≥gica se mantiene igual ‚Ä¶)

				const excluirDeudasResumen = true;
				const registrosParaSaldos = excluirDeudasResumen
				? delRango.filter(r =>
					r.tipo === "movimiento" &&
					(r.estadoPago === 'Pagado' || r.estadoPago == null) &&
					r.excluirDeAnalisis !== true
					)
				: delRango;

				let ventasEfectivo = 0, ventasNequi = 0, totalGastos = 0;
				registrosParaSaldos.forEach(r => {
				const v = Number(r.ventas || 0);
				if (r.metodo === "Efectivo") ventasEfectivo += v;
				if (r.metodo === "Nequi")    ventasNequi   += v;
				});
				delRango.forEach(r => { if (r.tipo === "movimiento") totalGastos += Number(r.gastos || 0); });

				const totalVentas = ventasEfectivo + ventasNequi;
				const balance     = totalVentas - totalGastos;
				const saldoEf     = ventasEfectivo - totalGastos;
				const saldoNq     = ventasNequi;

				const registrosParaTabla = soloDeudas
				? delRango.filter(r =>
					r.tipo === 'movimiento' &&
					Number(r.ventas) > 0 &&
					r.estadoPago === 'Debe'
					)
				: delRango;

				html += `
				<div class="business-section">
					<h4>${nombresNegocios[negocio]}</h4>
					<div class="summary-grid">
					<div class="summary-box"><h4>Ventas (caja)</h4><div class="value" style="color:#007bff;">${COP(totalVentas)}</div></div>
					<div class="summary-box"><h4>Gastos</h4><div class="value" style="color:#dc3545;">-${COP(totalGastos)}</div></div>
					<div class="summary-box" style="border-color:#667eea;background:#f0f4ff;"><h4>Balance del Per√≠odo</h4><div class="value" style="color:#667eea;">${COP(balance)}</div></div>
					</div>
					<hr style="margin:15px 0;">
					<div style="display:flex;justify-content:space-between;">
					<div>üíµ <strong>Saldo en Efectivo:</strong><br><span style="color:#28a745;font-weight:bold;">${COP(saldoEf)}</span></div>
					<div>üì± <strong>Saldo en Nequi:</strong><br><span style="color:#007bff;font-weight:bold;">${COP(saldoNq)}</span></div>
					</div>
					${
					registrosParaTabla.length > 0
					? `<div class="table-responsive"><table class="tabla-registros">
						${generarTablaRegistros(registrosParaTabla, { mostrarAcciones: false })}
						</table></div>`
					: '<p style="color:#999;margin-top:15px;">No hay registros para este per√≠odo</p>'
					}
					${agruparPlatosPorProducto(registrosParaTabla)}
				</div>
				`;
			}

			container.innerHTML = html || '<p>No hay datos</p>';

			// CxC seg√∫n toggle
			try { await renderCxcPeriodoEnInformes(); } catch (e) {}
		}

		// ===== CxC del PER√çODO dentro de Informes (acumulado o del rango, SIN Acciones) =====
		async function renderCxcPeriodoEnInformes() {
			const cont = document.getElementById('infCxcPeriodo');
			if (!cont) return;

			const negocioSel = document.getElementById('infNegocioReporte')?.value || 'Todos';
			const acumulado  = !!document.getElementById('infCxcAcumuladoPeriodo')?.checked;

			let desde, hasta;
			if (acumulado) {
				desde = '2000-01-01';
				hasta = hoyLocalISO();
			} else {
				desde = document.getElementById('infDesdePeriodo').value;
				hasta = document.getElementById('infHastaPeriodo').value;
				if (!desde || !hasta || hasta < desde) {
				cont.innerHTML = '<p style="color:#999;">Define un rango v√°lido para ver CxC del per√≠odo.</p>';
				return;
				}
			}

			const datos = await fetchPorRango(desde, hasta, negocioSel);

			const mapaClientes = new Map();
			let totalGeneral = 0;
			let totalVentasPendientes = 0;

			const negocios = (negocioSel === 'Todos') ? Object.keys(datos) : [negocioSel];
			for (const neg of negocios) {
				const registros = datos[neg] || [];
				registros.forEach(r => {
				if (r.tipo === 'movimiento' && r.estadoPago === 'Debe') {
					const pendiente = Number((r.montoPendiente != null ? r.montoPendiente : r.ventas) || 0);
					if (pendiente > 0) {
					const cliente = (r.cliente && String(r.cliente).trim()) ? r.cliente.trim() : 'Sin nombre';
					const prev = mapaClientes.get(cliente) || { totalPendiente: 0, cantidadVentas: 0 };
					prev.totalPendiente += pendiente;
					prev.cantidadVentas += 1;
					mapaClientes.set(cliente, prev);
					totalGeneral += pendiente;
					totalVentasPendientes += 1;
					}
				}
				});
			}

			const filas = [...mapaClientes.entries()]
				.sort((a,b) => b[1].totalPendiente - a[1].totalPendiente)
				.map(([cliente, info]) => `
				<tr>
					<td>${cliente}</td>
					<td style="text-align:center;">${info.cantidadVentas}</td>
					<td style="text-align:right;">${COP(info.totalPendiente)}</td>
				</tr>
				`).join('');

			const clientesUnicos = mapaClientes.size;
			const tituloNegocio = (negocioSel === 'Todos') ? 'Acumulado' : (nombresNegocios[negocioSel] || negocioSel);

			cont.innerHTML = `
				<div class="business-section" style="border-left-color:#dc3545;">
				<h3>üí≥ Cuentas por Cobrar (${acumulado ? 'Acumulado' : 'Del per√≠odo'} ‚Äî ${tituloNegocio})</h3>
				<div class="summary-grid">
					<div class="summary-box"><h4>Total por Cobrar</h4><div class="value" style="color:#dc3545;">${COP(totalGeneral)}</div></div>
					<div class="summary-box"><h4>Clientes con deuda</h4><div class="value">${clientesUnicos}</div></div>
					<div class="summary-box"><h4>Ventas pendientes</h4><div class="value">${totalVentasPendientes}</div></div>
				</div>
				${
					clientesUnicos > 0
					? `<table>
						<thead><tr><th>Cliente</th><th style="width:140px;"># Ventas</th><th style="width:200px;">Total Pendiente (COP)</th></tr></thead>
						<tbody>${filas}</tbody>
						</table>`
					: '<p style="color:#28a745;margin-top:10px;">No hay deudas pendientes. ‚úÖ</p>'
				}
				</div>
			`;
		}

		// ===== PDF del PER√çODO (compacto: KPIs + Top productos) =====
		async function exportarInformePeriodoPDF() {
			const desde = document.getElementById('infDesdePeriodo').value;
			const hasta = document.getElementById('infHastaPeriodo').value;
			const negocioSel = document.getElementById('infNegocioReporte')?.value || 'Todos';
			const incluirDetalle = !!document.getElementById('infIncluirDetalle')?.checked;

			if (!desde || !hasta || hasta < desde) {
				mostrarError('Selecciona un rango v√°lido.');
				return;
			}

			const datos = await fetchPorRango(desde, hasta, negocioSel);

			// === Prepara KPIs y colecciones por negocio (respetando filtro) ===
			const negocios = (negocioSel === 'Todos') ? Object.keys(datos) : [negocioSel];
			const kpis = {};              // { NegocioX: { ventas, gastos, balance, topProductos:[] } }
			const detallePorNegocio = {}; // { NegocioX: [registrosDelRango] }

			for (const negocio of negocios) {
				const registros = datos[negocio] || [];
				const delRango = registros.filter(r => r.fecha && r.fecha >= desde && r.fecha <= hasta);
				detallePorNegocio[negocio] = delRango;

				// C√°lculo caja (como en pantalla)
				const registrosParaSaldos = delRango.filter(r =>
				r.tipo === 'movimiento' &&
				(r.estadoPago === 'Pagado' || r.estadoPago == null) &&
				r.excluirDeAnalisis !== true
				);

				let vEf=0, vNq=0, g=0;
				registrosParaSaldos.forEach(r => {
				const v = Number(r.ventas || 0);
				if (r.metodo === 'Efectivo') vEf += v;
				if (r.metodo === 'Nequi')    vNq += v;
				});
				delRango.forEach(r => { if (r.tipo === 'movimiento') g += Number(r.gastos || 0); });

				const ventas = vEf + vNq;
				const balance = ventas - g;

				// Top productos para el per√≠odo
				const mapa = new Map();
				delRango.forEach(r => {
				if (r.tipo === 'movimiento' && r.producto && r.cantidad && r.ventas) {
					const prev = mapa.get(r.producto) || { cantidad:0, total:0 };
					prev.cantidad += Number(r.cantidad)||0;
					prev.total    += Number(r.ventas)||0;
					mapa.set(r.producto, prev);
				}
				});
				const top = [...mapa.entries()]
				.map(([producto, info]) => ({ producto, cantidad: info.cantidad, total: info.total }))
				.sort((a,b) => b.total - a.total)
				.slice(0,10);

				kpis[negocio] = { ventas, gastos: g, balance, topProductos: top };
			}

			const tituloNegocio = (negocioSel === 'Todos') ? 'Todos los negocios' : (nombresNegocios[negocioSel] || negocioSel);

			// === jsPDF: si hay detalle, usamos A4 landscape para darle cabida a 11 columnas ===
			const { jsPDF } = window.jspdf;
			const doc = new jsPDF({
				orientation: incluirDetalle ? 'landscape' : 'portrait',
				unit: 'pt',
				format: 'a4'
			});

			const margin = 36;
			const pageWidth  = doc.internal.pageSize.getWidth();
			const pageHeight = doc.internal.pageSize.getHeight();

			function header() {
				doc.setFillColor(102,126,234); // #667eea
				doc.rect(0,0,pageWidth,54,'F');
				doc.setFont('helvetica','bold'); doc.setTextColor('#fff'); doc.setFontSize(14);
				doc.text('Sistema de Contabilidad ‚Äî Resumen por Per√≠odo', margin, 28);
				doc.setFont('helvetica','normal'); doc.setFontSize(11);
				doc.text(`Del ${desde} al ${hasta} ¬∑ ${tituloNegocio}`, margin, 46);
			}
			function footer() {
				const str = `Generado ${new Date().toLocaleString('es-CO')} ¬∑ P√°g. ${doc.internal.getNumberOfPages()}`;
				doc.setFontSize(9); doc.setTextColor('#777');
				doc.text(str, pageWidth - margin, pageHeight - 14, { align:'right' });
			}

			header();

			// ========== Tabla Resumen por negocio (siempre) ==========
			const resumenRows = Object.entries(kpis).map(([neg, inf]) => [
				(nombresNegocios[neg] || neg),
				COP(inf.ventas),
				`-${COP(inf.gastos)}`,
				COP(inf.balance)
			]);

			doc.autoTable({
				startY: 70,
				head: [['Negocio', 'Ventas (caja)', 'Gastos', 'Balance']],
				body: resumenRows,
				theme: 'striped',
				headStyles: { fillColor: [102,126,234] },
				styles: { fontSize: 10, cellPadding: 6 },
				columnStyles: { 1:{halign:'right'}, 2:{halign:'right'}, 3:{halign:'right'} },
				didDrawPage: (data) => { if (data.pageNumber>1) header(); },
				margin: { left: margin, right: margin }
			});

			let y = (doc.lastAutoTable?.finalY || 90) + 16; // margen extra para que no se pegue

			// ========== Por negocio: KPIs + Top productos ==========
			for (const [neg, inf] of Object.entries(kpis)) {
				if (y > pageHeight - 160) { doc.addPage(); header(); y = 70; }
				doc.setFont('helvetica','bold'); doc.setFontSize(12); doc.setTextColor('#333');
				doc.text(`${nombresNegocios[neg] || neg}`, margin, y);
				doc.setFont('helvetica','normal'); doc.setFontSize(10);
				doc.text(`Ventas (caja): ${COP(inf.ventas)}   ¬∑   Gastos: -${COP(inf.gastos)}   ¬∑   Balance: ${COP(inf.balance)}`, margin, y + 14);

				// Top productos
				const bodyTop = (inf.topProductos.length ? inf.topProductos : [{producto:'(sin datos)',cantidad:0,total:0}])
				.map(p => [p.producto, String(p.cantidad), COP(p.total)]);

				doc.autoTable({
				startY: y + 28,
				head: [['Top productos', 'Cant.', 'Ventas']],
				body: bodyTop,
				theme: 'grid',
				headStyles: { fillColor: [102,126,234] },
				styles: { fontSize: 9, cellPadding: 5 },
				columnStyles: {
					1:{ halign:'center', cellWidth: 60 },
					2:{ halign:'right',  cellWidth: 80 }
				},
				margin: { left: margin, right: margin },
				didDrawPage: (data) => { if (data.pageNumber>1) header(); }
				});

				y = doc.lastAutoTable?.finalY + 18;

				// ========== (Opcional) TABLA DETALLE 12 columnas ==========
				if (incluirDetalle) {
				// Mapeamos registros del rango (del negocio actual) con formato PDF
				const registros = detallePorNegocio[neg] || [];
				const filasDetalle = registros.map(r => {
					const ventasNum = Number(r.ventas || 0);
					const gastosNum = Number(r.gastos || 0);

					const metodoTxt = (r.metodo === 'Efectivo' || r.metodo === 'Nequi') ? r.metodo : (r.metodo || '-');
					const estadoTxt = r.estadoPago || '-';

					const precioFmt   = (r.precioUnitario != null) ? COP(r.precioUnitario) : '-';
					const ventasFmt   = (r.tipo === 'movimiento') ? COP(ventasNum) : '-';
					const gastosFmt   = (r.tipo === 'movimiento') ? (gastosNum ? '-' + COP(gastosNum) : '-$0') : '-';
					const pendienteFmt= (r.estadoPago === 'Debe')
										? COP((r.montoPendiente != null ? r.montoPendiente : r.ventas) || 0)
										: '-';

					return [
					r.fecha || '',                 // Fecha
					r.producto || '-',             // Producto
					(r.cantidad ?? '-').toString(),// Cant.
					precioFmt,                     // Precio
					ventasFmt,                     // Ventas
					gastosFmt,                     // Gastos
					metodoTxt,                     // M√©todo (sin emojis)
					estadoTxt,                     // Estado
					(r.cliente || '-'),            // Cliente
					(r.descripcion || '-'),        // Descripci√≥n (se parte en l√≠neas si es larga)
					pendienteFmt                   // Pendiente
					];
				});

				// Anchos pensados para A4 horizontal con m√°rgenes 36pt (770pt √∫tiles)
				// Suma = 770 exactos.
				const colStyles = {
					0:  { cellWidth: 60 },   // Fecha
					1:  { cellWidth: 115 },  // Producto
					2:  { cellWidth: 35, halign:'right' }, // Cant.
					3:  { cellWidth: 60, halign:'right' }, // Precio
					4:  { cellWidth: 70, halign:'right' }, // Ventas
					5:  { cellWidth: 55, halign:'right' }, // Gastos
					6:  { cellWidth: 60 },   // M√©todo
					7:  { cellWidth: 55 },   // Estado
					8:  { cellWidth: 90 },   // Cliente
					9:  { cellWidth: 110 },  // Descripci√≥n
					10: { cellWidth: 60, halign:'right' }  // Pendiente
				};

				// T√≠tulo de la tabla de detalle
				if (y > pageHeight - 120) { doc.addPage(); header(); y = 70; }
				doc.setFont('helvetica','bold'); doc.setFontSize(11);
				doc.text('Detalle de registros del per√≠odo', margin, y);
				y += 6;

				doc.autoTable({
					startY: y + 8,
					head: [[
					'Fecha','Producto','Cant.','Precio','Ventas','Gastos',
					'M√©todo','Estado','Cliente','Descripci√≥n','Pendiente'
					]],
					body: filasDetalle,
					theme: 'grid',
					headStyles: { fillColor: [52,58,64], textColor: 255 }, // gris oscuro
					styles: {
					fontSize: 8.5,
					cellPadding: 4,
					overflow: 'linebreak'
					},
					columnStyles: colStyles,
					margin: { left: margin, right: margin },
					didDrawPage: (data) => { if (data.pageNumber>1) header(); }
				});

				y = doc.lastAutoTable?.finalY + 18;
				}
			}

			// Footer en todas las p√°ginas
			const totalPages = doc.internal.getNumberOfPages();
			for (let i=1;i<=totalPages;i++){ doc.setPage(i); footer(); }

			const sufijo = (negocioSel === 'Todos') ? 'Todos' : negocioSel;
			doc.save(`informe_periodo_${desde}_a_${hasta}_${sufijo}.pdf`);
		}

		// ====== Helpers ======
		function esFechaEnRango(fechaISO, desdeISO, hastaISO) {
			if (!fechaISO) return false;
			if (desdeISO && fechaISO < desdeISO) return false;
			if (hastaISO && fechaISO > hastaISO) return false;
			return true;
		}
		function primerDiaMesActualISO() {
			const d = new Date(); const y = d.getFullYear(); const m = d.getMonth()+1;
			return `${y}-${String(m).padStart(2,'0')}-01`;
		}

		// ====== C√°lculo del P&L (base caja) ======
		/*
		Devuelve:
		{
			global: { ventasEf, ventasNq, abonosEf, abonosNq, ventasTotales, gastos, costos, utilidad, capitalInformativo },
			negocios: {
			NegocioX: {
				ventasEf, ventasNq, abonosEf, abonosNq, ventasTotales, gastos, costos, utilidad,
				topProductos:[], gastosCat:[]
			}, ...
			}
		}
		*/
		async function construirPL(desdeISO, hastaISO, negocioSel='Todos', incluirCostos=false) {
			const datos = await fetchPorRango(desdeISO, hastaISO, negocioSel); // ‚Üê usar par√°metros
			const negocios = (negocioSel === 'Todos') ? Object.keys(datos) : [negocioSel];

			const result = {
				global: {
					ventasEf:0, ventasNq:0, abonosEf:0, abonosNq:0,
					ventasTotales:0, gastos:0, costos:0, utilidad:0,
					capitalInformativo: 0 // suma de capital inicial de los negocios filtrados (solo informativo)
				},
				negocios: {}
			};

			for (const neg of negocios) {
				const regs = (datos[neg] || []).filter(r => esFechaEnRango(r.fecha, desdeISO, hastaISO));

				// Capital inicial (solo para nota, no entra al P&L)
				const capEf = Number(saldoInicial[neg]?.efectivo || 0);
				const capNq = Number(saldoInicial[neg]?.nequi || 0);
				const capitalInformativo = capEf + capNq;
				result.global.capitalInformativo += capitalInformativo;

				// Ventas pagadas (con m√©todo) ‚Äî base caja
				let ventasEf = 0, ventasNq = 0;
				regs.forEach(r => {
				if (r.tipo === 'movimiento' &&
					Number(r.ventas||0) > 0 &&
					(r.estadoPago === 'Pagado' || r.estadoPago == null) &&
					r.excluirDeAnalisis !== true) {
					if (r.metodo === 'Efectivo') ventasEf += Number(r.ventas||0);
					if (r.metodo === 'Nequi')    ventasNq += Number(r.ventas||0);
				}
				});

				// Abonos del per√≠odo (siempre entran a caja)
				let abonosEf = 0, abonosNq = 0;
				regs.forEach(r => {
				if (r.tipo === 'movimiento' && r.esAbono === true && Number(r.ventas||0) > 0) {
					if (r.metodo === 'Efectivo') abonosEf += Number(r.ventas||0);
					if (r.metodo === 'Nequi')    abonosNq += Number(r.ventas||0);
				}
				});

				const ventasTotales = ventasEf + ventasNq + abonosEf + abonosNq;

				// Gastos del per√≠odo (cualquier m√©todo)
				const gastos = regs.reduce((sum, r) =>
				(r.tipo === 'movimiento') ? sum + Number(r.gastos||0) : sum
				, 0);

				// Costos del per√≠odo ‚Äî por ahora 0 (hook futuro)
				const costos = incluirCostos ? 0 : 0;

				const utilidad = ventasTotales - gastos - costos;

				// Top productos (ventas por producto en el per√≠odo, no cuenta abonos)
				const mapaProd = new Map();
				regs.forEach(r => {
				if (r.tipo === 'movimiento' && r.producto && r.cantidad && Number(r.ventas||0) > 0 && r.esAbono !== true) {
					const prev = mapaProd.get(r.producto) || { cantidad:0, total:0 };
					prev.cantidad += Number(r.cantidad)||0;
					prev.total    += Number(r.ventas)||0;
					mapaProd.set(r.producto, prev);
				}
				});
				const topProductos = [...mapaProd.entries()]
				.map(([producto,info]) => ({ producto, cantidad: info.cantidad, total: info.total }))
				.sort((a,b)=> b.total - a.total).slice(0,10);

				// Gastos por categor√≠a (descripci√≥n)
				const mapaCat = new Map();
				regs.forEach(r => {
				const g = Number(r.gastos||0);
				if (r.tipo === 'movimiento' && g > 0) {
					const cat = ((r.descripcion || 'Sin descripci√≥n').trim() || 'Sin descripci√≥n');
					mapaCat.set(cat, (mapaCat.get(cat)||0) + g);
				}
				});
				const gastosCat = [...mapaCat.entries()]
				.map(([categoria, total]) => ({ categoria, total }))
				.sort((a,b)=> b.total - a.total).slice(0,10);

				result.negocios[neg] = {
				ventasEf, ventasNq, abonosEf, abonosNq, ventasTotales, gastos, costos, utilidad,
				topProductos, gastosCat, capitalInformativo
				};

				// Global
				result.global.ventasEf += ventasEf;
				result.global.ventasNq += ventasNq;
				result.global.abonosEf += abonosEf;
				result.global.abonosNq += abonosNq;
				result.global.ventasTotales += ventasTotales;
				result.global.gastos += gastos;
				result.global.costos += costos;
				result.global.utilidad += utilidad;
			}

			return result;
		}

		// ====== Previsualizaci√≥n HTML ======
		async function previsualizarPL() {
			const desde = document.getElementById('plDesde').value;
			const hasta = document.getElementById('plHasta').value;
			const negocioSel = document.getElementById('plNegocio')?.value || 'Todos';
			const incluirCostos = !!document.getElementById('plIncluirCostos')?.checked;

			if (!desde || !hasta || hasta < desde) { mostrarError('Selecciona un rango de fechas v√°lido.'); return; }

			const pl = await construirPL(desde, hasta, negocioSel, incluirCostos);
			const cont = document.getElementById('plPreview');
			const tituloNeg = (negocioSel === 'Todos') ? 'Todos los negocios' : (nombresNegocios[negocioSel] || negocioSel);

			let html = `
				<div class="business-section">
				<h4>Estado de Resultados ‚Äî ${tituloNeg}</h4>
				<p style="color:#666;margin-top:4px;">Per√≠odo: ${desde} a ${hasta}</p>

				<div class="summary-card" style="margin-top:10px;">
					<strong>Nota (informativa):</strong><br>
					Capital inicial del informe (suma de negocios filtrados): <strong>${COP(pl.global.capitalInformativo)}</strong><br>
					<span style="color:#777;">Este valor no forma parte de la utilidad del per√≠odo.</span>
				</div>

				<div class="summary-grid">
					<div class="summary-box">
					<h4>Ventas (caja)</h4>
					<div class="value" style="color:#007bff;">${COP(pl.global.ventasTotales)}</div>
					<div style="margin-top:6px;font-size:12px;color:#555;">
						Efectivo: ${COP(pl.global.ventasEf + pl.global.abonosEf)}<br>
						Nequi: ${COP(pl.global.ventasNq + pl.global.abonosNq)}
					</div>
					</div>
					<div class="summary-box">
					<h4>Gastos</h4>
					<div class="value" style="color:#dc3545;">-${COP(pl.global.gastos)}</div>
					</div>
					<div class="summary-box" style="border-color:#28a745;background:#f4fff6;">
					<h4>Utilidad</h4>
					<div class="value" style="color:#28a745;">${COP(pl.global.utilidad)}</div>
					</div>
				</div>

				<table>
					<thead>
					<tr>
						<th>Negocio</th>
						<th style="text-align:right;">Ventas (caja)</th>
						<th style="text-align:right;">Gastos</th>
						<th style="text-align:right;">Costos</th>
						<th style="text-align:right;">Utilidad</th>
					</tr>
					</thead>
					<tbody>
			`;

			for (const [neg, info] of Object.entries(pl.negocios)) {
				html += `
				<tr>
					<td>${nombresNegocios[neg] || neg}</td>
					<td style="text-align:right;">${COP(info.ventasTotales)}</td>
					<td style="text-align:right;">-${COP(info.gastos)}</td>
					<td style="text-align:right;">-${COP(info.costos)}</td>
					<td style="text-align:right;font-weight:600;color:${info.utilidad >= 0 ? '#28a745' : '#dc3545'};">${COP(info.utilidad)}</td>
				</tr>
				`;
			}

			html += `
					</tbody>
				</table>
			`;

			// Por negocio, anexos
			for (const [neg, info] of Object.entries(pl.negocios)) {
				html += `
				<div class="summary-card" style="margin-top:12px;">
					<h3 style="margin-bottom:6px;">Detalle ‚Äî ${nombresNegocios[neg] || neg}</h3>
					<div style="color:#555;font-size:13px;margin-bottom:6px;">
					Capital inicial (informativo): ${COP(info.capitalInformativo)}
					</div>
					<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
					<div>
						<strong>Top productos</strong>
						<table>
						<thead><tr><th>Producto</th><th style="text-align:center;">Cant.</th><th style="text-align:right;">Ventas</th></tr></thead>
						<tbody>
							${
							(info.topProductos.length ? info.topProductos : [{producto:'(sin datos)',cantidad:0,total:0}])
							.map(p => `<tr><td>${p.producto}</td><td style="text-align:center;">${p.cantidad}</td><td style="text-align:right;">${COP(p.total)}</td></tr>`)
							.join('')
							}
						</tbody>
						</table>
					</div>
					<div>
						<strong>Gastos por categor√≠a</strong>
						<table>
						<thead><tr><th>Categor√≠a</th><th style="text-align:right;">Total</th></tr></thead>
						<tbody>
							${
							(info.gastosCat.length ? info.gastosCat : [{categoria:'(sin datos)',total:0}])
							.map(g => `<tr><td>${g.categoria}</td><td style="text-align:right;">-${COP(g.total)}</td></tr>`)
							.join('')
							}
						</tbody>
						</table>
					</div>
					</div>
				</div>
				`;
			}

			html += `</div>`;
			cont.innerHTML = html;
		}

		async function exportarPLPDF() {
			const desde = document.getElementById('plDesde').value;
			const hasta = document.getElementById('plHasta').value;
			const negocioSel = document.getElementById('plNegocio')?.value || 'Todos';
			const incluirCostos = !!document.getElementById('plIncluirCostos')?.checked;

			if (!desde || !hasta || hasta < desde) { mostrarError('Selecciona un rango v√°lido.'); return; }

			const pl = await construirPL(desde, hasta, negocioSel, incluirCostos);
			const tituloNeg = (negocioSel === 'Todos') ? 'Todos los negocios' : (nombresNegocios[negocioSel] || negocioSel);

			const { jsPDF } = window.jspdf;
			const doc = new jsPDF({ unit:'pt', format:'a4' });
			const margin = 36;
			const pw = doc.internal.pageSize.getWidth();
			const ph = doc.internal.pageSize.getHeight();

			function header() {
				doc.setFillColor(102,126,234);
				doc.rect(0,0,pw,54,'F');
				doc.setFont('helvetica','bold'); doc.setTextColor('#fff'); doc.setFontSize(14);
				doc.text('Estado de Resultados (P&L)', margin, 28);
				doc.setFont('helvetica','normal'); doc.setFontSize(11);
				doc.text(`Per√≠odo: ${desde} a ${hasta} ¬∑ ${tituloNeg}`, margin, 46);
			}
			function footer() {
				const str = `Generado ${new Date().toLocaleString('es-CO')} ¬∑ P√°g. ${doc.internal.getNumberOfPages()}`;
				doc.setFontSize(9); doc.setTextColor('#777');
				doc.text(str, pw - margin, ph - 14, { align:'right' });
			}

			header();

			// Nota informativa (capital inicial)
			doc.setFont('helvetica','bold'); doc.setFontSize(11); doc.setTextColor('#333');
			doc.text('Nota (informativa):', margin, 74);
			doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor('#000');
			doc.text(`Capital inicial consolidado de los negocios filtrados: ${COP(pl.global.capitalInformativo)} ‚Äî Este valor no forma parte de la utilidad del per√≠odo.`, margin, 90);

			// KPIs globales
			const resumenRows = [
				['Ventas (caja)', COP(pl.global.ventasTotales)],
				['Gastos del per√≠odo', `-${COP(pl.global.gastos)}`],
				['Costos del per√≠odo', `-${COP(pl.global.costos)}`],
				['UTILIDAD NETA', COP(pl.global.utilidad)]
			];
			doc.autoTable({
				startY: 106,
				head: [['Concepto','Valor']],
				body: resumenRows,
				theme: 'grid',
				headStyles: { fillColor: [102,126,234] },
				styles: { fontSize: 10, cellPadding: 6 },
				columnStyles: { 1:{ halign:'right' } },
				margin: { left: margin, right: margin },
				didDrawPage: (data)=>{ if (data.pageNumber>1) header(); }
			});

			let y = doc.lastAutoTable?.finalY || 130;

			// Tabla por negocio
			const porNegRows = Object.entries(pl.negocios).map(([neg, info]) => [
				(nombresNegocios[neg] || neg),
				COP(info.ventasTotales),
				`-${COP(info.gastos)}`,
				`-${COP(info.costos)}`,
				COP(info.utilidad)
			]);
			doc.autoTable({
				startY: y + 14,
				head: [['Negocio','Ventas (caja)','Gastos','Costos','Utilidad']],
				body: porNegRows,
				theme: 'striped',
				headStyles: { fillColor: [102,126,234] },
				styles: { fontSize: 9.5, cellPadding: 5 },
				columnStyles: { 1:{halign:'right'}, 2:{halign:'right'}, 3:{halign:'right'}, 4:{halign:'right'} },
				margin: { left: margin, right: margin },
				didDrawPage: (data)=>{ if (data.pageNumber>1) header(); }
			});

			y = doc.lastAutoTable?.finalY || (y + 14);

			// Por negocio: Top productos y Gastos por categor√≠a (compacto)
			for (const [neg, info] of Object.entries(pl.negocios)) {
				if (y > ph - 160) { doc.addPage(); header(); y = 70; }
				doc.setFont('helvetica','bold'); doc.setFontSize(12); doc.setTextColor('#333');
				doc.text(`${nombresNegocios[neg] || neg}`, margin, y + 14);
				y += 12;

				// Top productos
				const bodyTop = (info.topProductos.length ? info.topProductos : [{producto:'(sin datos)',cantidad:0,total:0}])
				.map(p => [p.producto, String(p.cantidad), COP(p.total)]);
				doc.autoTable({
				startY: y + 10,
				head: [['Top productos', 'Cant.', 'Ventas']],
				body: bodyTop,
				theme: 'grid',
				headStyles: { fillColor: [102,126,234] },
				styles: { fontSize: 9, cellPadding: 5 },
				columnStyles: { 1:{halign:'center',cellWidth:60}, 2:{halign:'right',cellWidth:80} },
				margin: { left: margin, right: margin },
				didDrawPage: (data)=>{ if (data.pageNumber>1) header(); }
				});

				let afterTop = doc.lastAutoTable?.finalY || (y + 10);

				// Gastos por categor√≠a
				const bodyGastos = (info.gastosCat.length ? info.gastosCat : [{categoria:'(sin datos)',total:0}])
				.map(g => [g.categoria, `-${COP(g.total)}`]);

				doc.autoTable({
				startY: afterTop + 10,
				head: [['Gastos por categor√≠a', 'Total']],
				body: bodyGastos,
				theme: 'grid',
				headStyles: { fillColor: [220,53,69] },
				styles: { fontSize: 9, cellPadding: 5 },
				columnStyles: { 1:{ halign:'right', cellWidth: 100 } },
				margin: { left: margin, right: margin },
				didDrawPage: (data)=>{ if (data.pageNumber>1) header(); }
				});

				y = doc.lastAutoTable?.finalY || (afterTop + 10);
			}

			const totalPages = doc.internal.getNumberOfPages();
			for (let i=1;i<=totalPages;i++){ doc.setPage(i); footer(); }

			const sufijo = (negocioSel === 'Todos') ? 'Todos' : negocioSel;
			doc.save(`estado_resultados_${desde}_a_${hasta}_${sufijo}.pdf`);
		}

		/* ===== Acorde√≥n de Informes: abrir/cerrar todo + recordar estado ===== */
		function toggleInformes(open) {
			document.querySelectorAll('#informes details').forEach(d => d.open = !!open);
			saveInformesState();
		}

		function saveInformesState() {
			const state = {};
			document.querySelectorAll('#informes details').forEach(d => state[d.id] = d.open ? 1 : 0);
			localStorage.setItem('informesState', JSON.stringify(state));
		}

		function restoreInformesState() {
			const raw = localStorage.getItem('informesState');
			if (!raw) return;
			try {
				const state = JSON.parse(raw);
				Object.entries(state).forEach(([id, val]) => {
				const el = document.getElementById(id);
				if (el) el.open = !!val;
				});
			} catch {}
		}

		// Alt + clic en cada summary = abrir SOLO ese informe
		function initInformesAccordionHotkeys() {
			document.querySelectorAll('#informes details > summary').forEach(sm => {
				sm.addEventListener('click', (ev) => {
				// guardamos state despu√©s de que cambie el "open"
				setTimeout(saveInformesState, 0);
				if (ev.altKey) {
					const me = sm.parentElement?.id;
					if (!me) return;
					document.querySelectorAll('#informes details').forEach(d => d.open = (d.id === me));
					ev.preventDefault();
					saveInformesState();
				}
				});
			});
		}

		function refreshAfterSave(fechaAfectada){
			// Invalida cache del d√≠a, del per√≠odo que podr√≠a incluir hoy y de CxC
			invalidateCacheByPrefix(`dia:${fechaAfectada}:`);
			invalidateCacheByPrefix(`rng:`);      // si quieres ser fino, invalida s√≥lo rangos que contengan la fecha
			invalidateCacheByPrefix(`cxc:`);      // deudas pueden cambiar

			// NO hagas lecturas aqu√≠; deja que cada pesta√±a, cuando el usuario la vea,
			// consulte de nuevo (cach√© vac√≠a -> nueva query).
		}
    </script>
	<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.1/dist/jspdf.plugin.autotable.min.js"></script>
	<script type="module">
	  import { initializeApp } 
	  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";

	  import { 
		getAuth, 
		onAuthStateChanged, 
		signOut,
		signInWithEmailAndPassword,
		reauthenticateWithCredential,
		EmailAuthProvider
	  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

	  import { 
		getFirestore, 
		collection, 
		addDoc, 
		getDocs,
		getDoc,
		query, 
		where,
		doc,
		updateDoc,
		deleteDoc,
		serverTimestamp,
		getCountFromServer
	  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

	  const firebaseConfig = {
		apiKey: "AIzaSyA_C9CYbLYpkJhaME5j9OgzlVjN83iwY78",
		authDomain: "cuentaselancla.firebaseapp.com",
		projectId: "cuentaselancla",
		storageBucket: "cuentaselancla.firebasestorage.app",
		messagingSenderId: "538778905068",
		appId: "1:538778905068:web:4e48f2ef1510d68d6138c9"
	  };

	  // üî• INICIALIZAR UNA SOLA VEZ
	  const app = initializeApp(firebaseConfig);
	  const auth = getAuth(app);
	  const db = getFirestore(app);

	  // üî• HACER VARIABLES GLOBALES
	  window.db = db;
	  window.collection = collection;
	  window.addDoc = addDoc;
	  window.getDocs = getDocs;
	  window.getDoc  = getDoc;
	  window.query = query;
	  window.where = where;
	  window.doc = doc;
	  window.updateDoc = updateDoc;
	  window.deleteDoc = deleteDoc;
	  window.serverTimestamp = serverTimestamp;
	  window.cxcSeleccionado = null;
	  window.getCountFromServer = getCountFromServer;
	  window.filtroNegocioCobroCliente = null;

	  // Hacer accesible la sesi√≥n y m√©todos de auth a scripts no-m√≥dulo
	  window.auth = auth;
	  window.signInWithEmailAndPassword = signInWithEmailAndPassword;
	  window.reauthenticateWithCredential = reauthenticateWithCredential;
	  window.EmailAuthProvider = EmailAuthProvider;

	  // üîê VALIDAR SESI√ìN
 	  onAuthStateChanged(auth, (user) => {
		  if (user) {
			console.log("Usuario autenticado:", user.email);
			startInactivityTimer();
		  } else {
			console.log("No hay sesi√≥n activa");
			setTimeout(() => {
			  window.location.href = "login.html";
			}, 500);
		  }
		});

	  // üö™ CERRAR SESI√ìN
	  window.logout = function() {
		signOut(auth).then(() => {
		  window.location.href = "login.html";
		});
	  };
	  
		// ============== AUTO-LOGOUT POR INACTIVIDAD (5 MIN) ==============
		const INACTIVITY_LIMIT_MS = 5 * 60 * 1000; // 5 minutos
		let inactivityTimer = null;

		function resetInactivityTimer() {
			if (inactivityTimer) clearTimeout(inactivityTimer);
			inactivityTimer = setTimeout(async () => {
			try {
				await signOut(auth);
			} catch (e) {
				console.warn('Error haciendo signOut por inactividad', e);
			} finally {
				window.location.href = 'login.html';
			}
			}, INACTIVITY_LIMIT_MS);
		}

		function startInactivityTimer() {
			resetInactivityTimer();

			const resetEvents = ['mousemove','keydown','click','touchstart','scroll','visibilitychange'];
			resetEvents.forEach(evt => {
			document.addEventListener(evt, () => {
				// Solo reinicia si la pesta√±a est√° activa o el usuario volvi√≥ a verla
				if (evt !== 'visibilitychange' || document.visibilityState === 'visible') {
				resetInactivityTimer();
				}
			}, { passive: true });
			});
		}
	</script>
</body>
</html>
