<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Contabilidad - Restaurantes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
            flex-wrap: wrap;
        }
        
        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: #f5f5f5;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            min-width: 150px;
        }
        
        .tab-button:hover {
            background: #efefef;
        }
        
        .tab-button.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        
        .content {
            display: none;
            padding: 30px;
        }
        
        .content.active {
            display: block;
        }
        
        .business-selector {
            margin-bottom: 30px;
        }
        
        .business-selector label {
            font-weight: 600;
            color: #333;
            margin-right: 10px;
            font-size: 1.1em;
        }
        
        .business-selector select {
            padding: 10px 15px;
            font-size: 1em;
            border: 2px solid #667eea;
            border-radius: 5px;
            cursor: pointer;
            background: white;
            color: #333;
        }
        
        .form-group {
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .form-group.full {
            grid-template-columns: 1fr;
        }
        
        .input-field {
            display: flex;
            flex-direction: column;
        }
        
        .input-field label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        
        .input-field input,
        .input-field select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }
        
        .input-field input:focus,
        .input-field select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 25px;
            justify-content: center;
        }
        
        button {
            padding: 12px 30px;
            font-size: 1em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
            border: 2px solid #ddd;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .payment-method {
            display: flex;
            gap: 20px;
            margin: 15px 0;
        }
        
        .radio-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .radio-group input[type="radio"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }
        
        .radio-group label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        table th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        table td {
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
        }
        
        table tr:hover {
            background: #f5f5f5;
        }
        
        .summary-card {
            background: #f9f9f9;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin: 15px 0;
            border-radius: 5px;
        }
        
        .summary-card h3 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .summary-box {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        
        .summary-box h4 {
            color: #666;
            margin-bottom: 10px;
            font-size: 0.9em;
            text-transform: uppercase;
        }
        
        .summary-box .value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            border: 1px solid #c3e6cb;
            display: none;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            border: 1px solid #f5c6cb;
            display: none;
        }
        
        .business-section {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #667eea;
        }
        
        .business-section h3 {
            color: #333;
            margin-bottom: 15px;
        }
        
        @media (max-width: 768px) {
            .form-group {
                grid-template-columns: 1fr;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .tab-button {
                font-size: 0.85em;
                min-width: 100px;
                padding: 10px 15px;
            }
        }
		/* ===== MODAL ===== */
		.modal-backdrop{
		position: fixed; inset: 0;
		background: rgba(0,0,0,0.45);
		display: flex; align-items: center; justify-content: center;
		padding: 16px; z-index: 9999;
		}
		.modal-card{
		width: 100%; max-width: 520px;
		background: #fff; border-radius: 10px;
		box-shadow: 0 20px 60px rgba(0,0,0,0.35);
		overflow: hidden; border: 1px solid #e5e5e5;
		}
		.modal-header{
		display: flex; align-items: center; justify-content: space-between;
		padding: 16px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
		color: #fff;
		}
		.modal-body{ padding: 18px 20px; }
		.modal-footer{
		padding: 14px 20px; display: flex; justify-content: flex-end; gap: 10px; background: #fafafa;
		border-top: 1px solid #eee;
		}
		.modal-close{
		background: transparent; border: none; color: #fff; font-size: 18px; cursor: pointer;
		}
		.modal-radio{ display: grid; gap: 10px; margin-top: 10px; }
		.radio-item{ display: flex; gap: 10px; align-items: center; cursor: pointer; }
		
		/*inputs deshabilitados*/
		input:disabled {
		  background-color: #f5f5f5;
		  color: #999;
		  cursor: not-allowed;
		}
		/* Efecto "shake" para errores de ingreso */
		@keyframes shake {
			10%, 90% { transform: translateX(-1px); }
			20%, 80% { transform: translateX(2px); }
			30%, 50%, 70% { transform: translateX(-4px); }
			40%, 60% { transform: translateX(4px); }
			}
			.input-shake {
			animation: shake 0.3s ease-in-out;
			border-color: #dc3545 !important; /* rojo de error */
		}
    </style>
</head>
<body>
    <div class="container">
        <div class="header" style="position:relative;">
			
			<button onclick="logout()" class="btn-danger" style="
				position:absolute;
				top:20px;
				right:20px;">
				Cerrar sesi√≥n
			</button>

			<h1>üìä Sistema de Contabilidad</h1>
			<p>Gesti√≥n de Negocios - Base, Ventas y Gastos</p>

		</div>
        
        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('entrada', event)">Entrada de Datos</button>
			<button class="tab-button" onclick="switchTab('resumen', event)">Resumen Diario</button>
			<button class="tab-button" onclick="switchTab('acumulado', event)">Cuentas Acumuladas</button>
			<button class="tab-button" onclick="switchTab('metodos', event)">An√°lisis Pagos</button>
			<button class="tab-button" onclick="switchTab('configuracion', event)">Configuraci√≥n</button>
        </div>
        
        <!-- PESTA√ëA 1: ENTRADA DE DATOS -->
        <div id="entrada" class="content active">
            <div class="success-message" id="successMsg">‚úì Datos guardados correctamente</div>
            <div class="error-message" id="errorMsg"></div>
            
            <div class="business-selector">
                <label for="business">Selecciona Negocio:</label>
                <select id="business">
                    <option value="Negocio1">Negocio Fritos</option>
                    <option value="Negocio2">Negocio Almuerzos</option>
                    <option value="Negocio3">Negocio Licorer√≠a</option>
                    <option value="Negocio4">Negocio Comidas R√°pidas</option>
                </select>
            </div>
            
            <h3 style="color: #333; margin-bottom: 10px;">Registrar Movimiento del D√≠a</h3>
            <p style="color:#666; margin-bottom:20px; font-size:0.9em;">
			  Registra <strong>ventas por producto</strong> y/o <strong>gastos</strong> para el negocio y fecha.
			</p>
            
            <div class="form-group full">
                <div class="input-field">
                    <label for="fecha">Fecha:</label>
                    <input type="date" id="fecha" value="">
                </div>
            </div>
            
            <div class="form-group">
			  <div class="input-field">
				<div class="form-group">
				  <div class="input-field">
					<label>Producto:</label>
					<select id="productoSelect"></select>
				  </div>

				  <div class="input-field">
					<label>Cantidad:</label>
					<input type="number" id="cantidad" min="1" value="1">
				  </div>
				</div>

				<!-- Se muestra solo cuando sea Mojarra en Negocio2 -->
				<div class="input-field" style="display:none;" id="precioPersonalizadoWrap">
				  <label>Precio personalizado (solo Mojarra &gt; $25.000):</label>
				  <input type="number" id="precioPersonalizado" min="25001" step="1" placeholder="Ej: 26000">
				  <small style="color:#666;">Si el precio es mayor a $25.000, escribe aqu√≠ el valor exacto.</small>
				</div>

				<!-- Se muestra solo cuando sea Corriente en Negocio2 -->
				<div class="input-field" style="display:none;" id="tipoCorrienteWrap">
					<label>Tipo de corriente:</label>
					<input type="text" id="tipoCorriente" placeholder="Ej: pollo, res, mixta">
					<small style="color:#666;">Obligatorio para Corriente (Negocio Almuerzos).</small>
				</div>

				<div class="summary-card">
				  <strong>Total Venta:</strong>
				  <span id="totalVentaPreview">$0</span>
				</div>
				
				<!-- Bot√≥n para apilar la l√≠nea al carrito -->
				<div class="button-group" style="margin-top:10px;">
				  <button class="btn-success" type="button" onclick="agregarAlCarrito()">‚ûï Agregar al pedido</button>
				</div>

				<!-- Tabla del carrito (pedido actual, no guardado a√∫n) -->
				<div class="business-section" id="carritoSection" style="display:none;">
				  <h4>Pedido actual (no guardado)</h4>
				  <table id="carritoTabla">
					<thead>
					  <tr>
						<th>Producto</th>
						<th>Cant.</th>
						<th>Precio Unit.</th>
						<th>Total</th>
						<th></th>
					  </tr>
					</thead>
					<tbody></tbody>
				  </table>
				  <div style="margin-top:10px; text-align:right;">
					<strong>Total pedido:</strong> <span id="carritoTotal">$0</span>
				  </div>
				</div>
			  </div>
			</div>
            
            <div class="form-group">
                <div class="input-field">
                    <label for="gastos">Gastos ($):</label>
                    <input type="number" id="gastos" placeholder="0" step="0.01" min="0">
                </div>
                <div class="input-field">
                    <label for="descripcion">Descripci√≥n de Gasto:</label>
                    <input type="text" id="descripcion" placeholder="Ej: Compra de ingredientes">
                </div>
            </div>
            
            <!-- <div class="form-group full">
                <div class="input-field">
                    <label>M√©todo de Pago (Ventas):</label>
                    <div class="payment-method">
                        <div class="radio-group">
                            <input type="radio" id="efectivo" name="metodo" value="Efectivo" checked>
                            <label for="efectivo">üíµ Efectivo</label>
                        </div>
                        <div class="radio-group">
                            <input type="radio" id="nequi" name="metodo" value="Nequi">
                            <label for="nequi">üì± Nequi</label>
                        </div>
                    </div>
                </div>
            </div> -->
            
            <div class="button-group">
                <button class="btn-primary" onclick="abrirModalPago()">Guardar Registro</button>
                <button class="btn-secondary" onclick="limpiarFormulario()">Limpiar</button>
            </div>
        </div>
        
        <!-- PESTA√ëA 2: RESUMEN DIARIO -->
        <div id="resumen" class="content">
            <h3 style="color: #333; margin-bottom: 20px;">Resumen Diario</h3>
            
            <div class="input-field" style="margin-bottom: 20px; max-width: 300px;">
                <label for="fechaFiltro">Filtrar por Fecha:</label>
                <input type="date" id="fechaFiltro" onchange="actualizarResumen()">
            </div>
            
			<div class="input-field" style="margin-bottom: 10px; max-width: 300px;">
			<label class="radio-group" style="gap:8px;">
				<input type="checkbox" id="soloDeudas" onchange="actualizarResumen()">
				<span>Mostrar solo deudas (ventas en "Debe")</span>
			</label>
			</div>

			<!-- Contenedor de la secci√≥n de Cuentas por Cobrar -->
			<div id="cxcContent"></div>
            <div id="resumenContent"></div>
        </div>
        
        <!-- PESTA√ëA 3: CUENTAS ACUMULADAS -->
        <div id="acumulado" class="content">
            <h3 style="color: #333; margin-bottom: 20px;">Cuentas Acumuladas por Negocio</h3>
            
            <div class="summary-grid" id="acumuladoContent"></div>
        </div>
        
        <!-- PESTA√ëA 4: AN√ÅLISIS PAGOS -->
        <div id="metodos" class="content">
            <h3 style="color: #333; margin-bottom: 20px;">An√°lisis de M√©todos de Pago</h3>
            
            <div class="form-group">
                <div class="input-field">
                    <label for="negocioFiltro">Negocio:</label>
                    <select id="negocioFiltro" onchange="actualizarAnalisisPagos()">
                        <option value="Todos">Todos los Negocios</option>
                        <option value="Negocio1">Negocio Fritos</option>
                        <option value="Negocio2">Negocio Almuerzos</option>
                        <option value="Negocio3">Negocio Licorer√≠a</option>
                        <option value="Negocio4">Negocio Comidas R√°pidas</option>
                    </select>
                </div>
                <div class="input-field">
                    <label for="filtroFechaPagos">Filtrar por Fecha:</label>
                    <select id="filtroFechaPagos" onchange="actualizarAnalisisPagos()">
                        <option value="actual">Estado Actual (Acumulado)</option>
                        <option value="fecha">Por Fecha Espec√≠fica</option>
                    </select>
                </div>
				<!-- Toggle incluir capital inicial -->
				<div class="input-field">
					<label for="toggleCapitalInicial" style="user-select:none;">Opciones:</label>
					<label class="radio-group" style="gap:10px;">
						<input type="checkbox" id="toggleCapitalInicial" onchange="actualizarAnalisisPagos()">
						<span>Incluir capital inicial</span>
					</label>
				</div>
            </div>
            
            <div id="fechaPagosContainer" style="display: none; margin-bottom: 20px;">
                <div class="input-field" style="max-width: 300px;">
                    <label for="fechaSeleccionadaPagos">Selecciona Fecha:</label>
                    <input type="date" id="fechaSeleccionadaPagos" onchange="actualizarAnalisisPagos()">
                </div>
            </div>
            
            <div id="analisisPagosContent"></div>
        </div>
        
        <!-- PESTA√ëA 5: CONFIGURACI√ìN -->
        <div id="configuracion" class="content">
            <h3 style="color: #333; margin-bottom: 20px;">Configuraci√≥n del Sistema</h3>
            
            <div class="business-section">
                <h4>Gesti√≥n de Datos</h4>
                <div class="button-group">
                    <button class="btn-secondary" onclick="exportarDatos()">üì• Exportar Datos</button>
                    <button class="btn-secondary" onclick="descargarExcel()">üìä Descargar Excel</button>
                    <button class="btn-danger" onclick="limpiarTodos()">üóëÔ∏è Limpiar Datos Locales</button>
                </div>
            </div>
            
            <div class="business-section">
                <h4>Informaci√≥n del Sistema</h4>
                <p><strong>Versi√≥n:</strong> 1.7</p>
                <p><strong>Negocios Registrados:</strong> 4</p>
                <p><strong>Datos Almacenados:</strong> <span id="totalRegistros">0</span> registros</p>
            </div>

            <!-- === Cat√°logo de productos (Config) === -->
            <div class="business-section">
              <h4>Cat√°logo de productos por negocio</h4>
              <p style="color:#666;margin:8px 0 14px;">
                Agrega productos personalizados (se suman al cat√°logo base del negocio). Se guardan en tu equipo.
              </p>

              <div class="form-group">
                <div class="input-field">
                  <label for="cfgNegocio">Negocio:</label>
                  <select id="cfgNegocio" onchange="renderCatalogoUI()">
                    <option value="Negocio1">Negocio Fritos</option>
                    <option value="Negocio2">Negocio Almuerzos</option>
                    <option value="Negocio3">Negocio Licorer√≠a</option>
                    <option value="Negocio4">Negocio Comidas R√°pidas</option>
                  </select>
                </div>

                <div class="input-field">
                  <label for="cfgNombreProd">Nombre del producto:</label>
                  <input id="cfgNombreProd" type="text" placeholder="Ej: Perro hawaiano">
                </div>
                <div class="input-field">
                  <label for="cfgPrecioProd">Precio (COP):</label>
                  <input id="cfgPrecioProd" type="number" min="1" step="1" placeholder="Ej: 12000">
                </div>
              </div>

              <div class="button-group" style="justify-content:flex-start;">
                <button class="btn-success" type="button" onclick="cfgAgregarProducto()">‚ûï Agregar producto</button>
              </div>

              <div id="cfgTablaWrap" style="margin-top:14px;">
                <!-- Aqu√≠ se renderiza la tabla del cat√°logo del negocio seleccionado -->
              </div>
            </div>			
        </div>
    </div>
	<!-- MODAL Confirmaci√≥n de pago -->
	<div id="modalPagoBackdrop" class="modal-backdrop" style="display:none;">
		<div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalPagoTitulo">
			<div class="modal-header">
			<h3 id="modalPagoTitulo">Confirmar estado de pago</h3>
			<button class="modal-close" onclick="cerrarModalPago()" aria-label="Cerrar">‚úñ</button>
			</div>

			<div class="modal-body">
			  <p style="color:#555;margin-bottom:12px;">
				Indica c√≥mo registrar√°s este movimiento.
			  </p>

			  <div class="modal-radio">
				<label class="radio-item">
				  <input type="radio" name="estadoPago" value="pagado" checked onchange="updateModalPagoUI()">
				  <span>El cliente <strong>pag√≥ todo</strong></span>
				</label>
				<label class="radio-item">
				  <input type="radio" name="estadoPago" value="debe" onchange="updateModalPagoUI()">
				  <span>El cliente <strong>qued√≥ debiendo</strong></span>
				</label>
				<label class="radio-item">
				  <input type="radio" name="estadoPago" value="soloGasto" onchange="updateModalPagoUI()">
				  <span><strong>Solo gasto</strong> (sin ventas)</span>
				</label>
			  </div>

			  <!-- Nombre cliente (solo si 'Debe' y hay ventas en carrito) -->
			  <div id="nombreClienteWrap" style="display:none; margin-top:12px;">
				<label for="nombreClienteDeudor" style="font-weight:600;color:#333;margin-bottom:6px;">
				  Nombre del cliente (obligatorio si debe):
				</label>
				<input type="text" id="nombreClienteDeudor" placeholder="Ej: Juan P√©rez"
					   style="width:100%;padding:10px;border:2px solid #ddd;border-radius:6px;">
				<small style="color:#666;">Este nombre se guardar√° con cada l√≠nea de venta como cuenta por cobrar.</small>
			  </div>

			  <!-- M√©todo de pago de la VENTA (solo si 'pagado' y hay carrito) -->
			  <div id="metodoVentaWrap" style="display:none; margin-top:12px;">
				<label style="font-weight:600;color:#333;margin-bottom:6px;display:block;">M√©todo de pago de la venta:</label>
				<div class="payment-method">
				  <div class="radio-group">
					<input type="radio" id="pagoVentaEfectivo" name="metodoVenta" value="Efectivo" checked>
					<label for="pagoVentaEfectivo">üíµ Efectivo</label>
				  </div>
				  <div class="radio-group">
					<input type="radio" id="pagoVentaNequi" name="metodoVenta" value="Nequi">
					<label for="pagoVentaNequi">üì± Nequi</label>
				  </div>
				</div>
			  </div>

			  <!-- M√©todo de pago del GASTO (si hay gasto > 0) -->
			  <div id="metodoGastoWrap" style="display:none; margin-top:12px;">
				<label style="font-weight:600;color:#333;margin-bottom:6px;display:block;">M√©todo de pago del gasto:</label>
				<div class="payment-method">
				  <div class="radio-group">
					<input type="radio" id="pagoGastoEfectivo" name="metodoGasto" value="Efectivo" checked>
					<label for="pagoGastoEfectivo">üíµ Efectivo</label>
				  </div>
				  <div class="radio-group">
					<input type="radio" id="pagoGastoNequi" name="metodoGasto" value="Nequi">
					<label for="pagoGastoNequi">üì± Nequi</label>
				  </div>
				</div>
				<small style="color:#666;">Este m√©todo solo aplica al registro de gasto.</small>
			  </div>

			  <div id="modalPagoError" class="error-message" style="display:none;margin-top:12px;">.</div>
			</div>
			<div class="modal-footer">
			  <button class="btn-secondary" onclick="cerrarModalPago()">Cancelar</button>
			  <button class="btn-primary" onclick="confirmarGuardarDesdeModal()">Confirmar y guardar</button>
			</div>
		</div>
	</div>
	<div id="modalCobrarBackdrop" class="modal-backdrop" style="display:none;">
	  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalCobrarTitulo">
		
			<div class="modal-header">
			  <h3 id="modalCobrarTitulo">Registrar Pago</h3>
			  <button class="modal-close" onclick="cerrarModalCobrar()" aria-label="Cerrar">&times;</button>
			</div>

			<div class="modal-body">
			  <p class="modal-instruction">Selecciona el m√©todo de pago para esta venta:</p>

			  <div class="payment-options">
					<label class="payment-radio">
					  <input type="radio" id="cobroEfectivo" name="metodoCobro" value="Efectivo" checked>
					  <div class="radio-content">
						<span class="icon">üíµ</span>
						<span class="text">Efectivo</span>
					  </div>
					</label>

					<label class="payment-radio">
					  <input type="radio" name="metodoCobro" value="Nequi">
					  <div class="radio-content">
						<span class="icon">üì±</span>
						<span class="text">Nequi</span>
					  </div>
					</label>
			  </div>

			  <div id="modalCobrarError" class="error-message" style="display:none;"></div>
			</div>

			<div class="modal-footer">
			  <button class="btn-secondary" onclick="cerrarModalCobrar()">Cancelar</button>
			  <button id="btnConfirmarCobro" class="btn-primary" onclick="confirmarCobro()">Confirmar Cobro</button>
			</div>
	  </div>
	</div>

    <!-- MODAL: Cobro por Cliente (CxC) -->
    <div id="modalCobroClienteBackdrop" class="modal-backdrop" style="display:none;">
      <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalCobroClienteTitulo">
        <div class="modal-header">
          <h3 id="modalCobroClienteTitulo">Cobrar cuenta</h3>
          <button class="modal-close" onclick="cerrarModalCobroCliente()" aria-label="Cerrar">‚úñ</button>
        </div>

        <div class="modal-body">
          <p><strong>Cliente:</strong> <span id="cxcClienteNombre"></span></p>
          <p><strong>Total por cobrar:</strong> <span id="cxcClienteDeuda">$0</span></p>
          <hr>

          <div class="modal-radio">
            <label class="radio-item">
              <input type="radio" name="tipoCobroCliente" value="total" checked onclick="toggleMontoParcial(false)">
              <span>Pago total</span>
            </label>
            <label class="radio-item">
              <input type="radio" name="tipoCobroCliente" value="parcial" onclick="toggleMontoParcial(true)">
              <span>Pago parcial</span>
            </label>
          </div>

          <div id="montoParcialWrap" class="input-field" style="display:none; margin-top:10px;">
            <label for="montoParcial">Monto a cobrar (COP):</label>
            <input type="number" id="montoParcial" min="1" step="1" placeholder="Ej: 20000">
            <small style="color:#666;">No puede exceder el total por cobrar.</small>
          </div>

          <div class="payment-options" style="margin-top:12px;">
            <label class="payment-radio">
              <input type="radio" name="metodoCobroCliente" value="Efectivo" checked>
              <div class="radio-content">
                <span class="icon">üíµ</span><span class="text">Efectivo</span>
              </div>
            </label>

            <label class="payment-radio">
              <input type="radio" name="metodoCobroCliente" value="Nequi">
              <div class="radio-content">
                <span class="icon">üì±</span><span class="text">Nequi</span>
              </div>
            </label>
          </div>

          <div id="modalCobroClienteError" class="error-message" style="display:none;"></div>
        </div>

        <div class="modal-footer">
          <button class="btn-secondary" onclick="cerrarModalCobroCliente()">Cancelar</button>
          <button class="btn-primary" onclick="confirmarCobroCliente()">Confirmar cobro</button>
        </div>
      </div>
    </div>
	
	<!-- MODAL Verificaci√≥n de credenciales para eliminar producto personalizado -->
	<div id="modalCredencialesBackdrop" class="modal-backdrop" style="display:none;">
		<div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalCredencialesTitulo">
			<div class="modal-header">
				<h3 id="modalCredencialesTitulo">Confirmar con contrase√±a</h3>
				<button class="modal-close" onclick="cerrarModalCredenciales()" aria-label="Cerrar">‚úñ</button>
			</div>
			<div class="modal-body">
				<p style="color:#555;margin-bottom:12px;">
					Por seguridad, ingresa tu contrase√±a para eliminar este producto.
				</p>

				<!-- Si quieres pedir tambi√©n correo, descomenta:
				<div class="input-field" style="margin-bottom:10px;">
					<label for="credEmail">Correo:</label>
					<input type="email" id="credEmail" placeholder="tu@correo.com">
				</div>
				-->

				<div class="input-field">
					<label for="credPassword">Contrase√±a:</label>
					<input type="password" id="credPassword" placeholder="********">
				</div>

				<div id="credError" class="error-message" style="display:none;"></div>
			</div>
			<div class="modal-footer">
				<button class="btn-secondary" onclick="cerrarModalCredenciales()">Cancelar</button>
				<button class="btn-primary" onclick="confirmarCredenciales()">Confirmar</button>
			</div>
		</div>
	</div>
    <script>
	
		// ==== MAPA DE NOMBRES ====
		const nombresNegocios = {
			Negocio1: "Negocio Fritos",
			Negocio2: "Negocio Almuerzos",
			Negocio3: "Negocio Licorer√≠a",
			Negocio4: "Negocio Comidas R√°pidas"
		};
		
		// üîµ SALDO INICIAL FIJO POR NEGOCIO
		const saldoInicial = {
			Negocio1: { efectivo: 310000, nequi: 0 },
			Negocio2: { efectivo: 250000, nequi: 0 },
			Negocio3: { efectivo: 0, nequi: 746000 },
			Negocio4: { efectivo: 0, nequi: 150000 }
		};
		
		// üîµ PRODUCTOS POR NEGOCIO
		const productos = {

		  Negocio1: [ // Fritos
			{ nombre: "Arepa de huevo", precio: 3000 },
			{ nombre: "Patacones", precio: 3000 },
			{ nombre: "Deditos", precio: 1500 },
			{ nombre: "Papa carne", precio: 2000 },
			{ nombre: "Papa pollo", precio: 2000 },
			{ nombre: "Empanada carne", precio: 2000 },
			{ nombre: "Empanada pollo", precio: 2000 },
			{ nombre: "Cariba√±olas", precio: 2000 }
		  ],

		  Negocio2: [ // Almuerzos
			{ nombre: "Corriente", precio: 15000 },
			{ nombre: "Mojarra", precio: 25000 },
			{ nombre: "Sopa 8k", precio: 8000 },
			{ nombre: "Sopa 10k", precio: 10000 },
			{ nombre: "Sopa 13k", precio: 13000 }
		  ],

		  Negocio3: [ // Licorer√≠a
			{ nombre: "Coste√±ita x38", precio: 85000 },
			{ nombre: "Coste√±ita peque√±a", precio: 3000 },
			{ nombre: "Coste√±a", precio: 4000 },
			{ nombre: "√Åguila negra peque√±a", precio: 4000 },
			{ nombre: "√Åguila negra grande", precio: 7000 },
			{ nombre: "Gaseosa personal", precio: 2000 }
		  ],

		  Negocio4: [] // Comidas r√°pidas (por ahora manual)
		};
		
		// === Formateador COP (sin decimales) ===
		const COP = (n) => new Intl.NumberFormat('es-CO', {
		  style: 'currency',
		  currency: 'COP',
		  minimumFractionDigits: 0,
		  maximumFractionDigits: 0
		}).format(Number(n) || 0);

        /* =========================
          Cat√°logos personalizados
          ========================= */

        // Clave de almacenamiento local
        const CATALOGOS_KEY = 'catalogos';

        // Carga el objeto completo { Negocio1: [...], Negocio2: [...], ... }
        function loadCatalogos() {
          try { return JSON.parse(localStorage.getItem(CATALOGOS_KEY) || '{}'); }
          catch { return {}; }
        }

        // Guarda el objeto completo
        function saveCatalogos(obj) {
          localStorage.setItem(CATALOGOS_KEY, JSON.stringify(obj));
        }

        // Obtiene el array del negocio (si no existe, []), solo personalizados
        function getCatalogoPersonalizado(negocioKey) {
          const all = loadCatalogos();
          return Array.isArray(all[negocioKey]) ? all[negocioKey] : [];
        }

        // Reemplaza la lista combinada que se usa para vender: BASE + PERSONALIZADOS
        function getCatalogoCombinado(negocioKey) {
          const base = Array.isArray(productos[negocioKey]) ? productos[negocioKey] : [];
          const custom = getCatalogoPersonalizado(negocioKey);
          // Concatenamos ambos cat√°logos (si quieres deduplicar por nombre, te lo dejo luego)
          return [...base, ...custom];
        }

        // Agrega producto al negocio desde Configuraci√≥n
        function cfgAgregarProducto() {
          const negocioKey = document.getElementById('cfgNegocio').value;
          const nombre = (document.getElementById('cfgNombreProd').value || '').trim();
          const precio = parseInt(document.getElementById('cfgPrecioProd').value, 10) || 0;

          if (!nombre) { mostrarError('Escribe el nombre del producto.'); return; }
          if (precio <= 0) { mostrarError('Escribe un precio v√°lido mayor a 0.'); return; }

          const all = loadCatalogos();
          const arr = Array.isArray(all[negocioKey]) ? all[negocioKey] : [];
          arr.push({ nombre, precio });
          all[negocioKey] = arr;
          saveCatalogos(all);

          // Limpiar inputs
          document.getElementById('cfgNombreProd').value = '';
          document.getElementById('cfgPrecioProd').value = '';

          // Si estoy en ese negocio en "Entrada de Datos", refrescar selector
          try { if (document.getElementById('business').value === negocioKey) cargarProductos(); } catch (e) {}
          renderCatalogoUI();
          mostrarExito();
        }

		function abrirModalCredenciales() {
			const err = document.getElementById('credError');
			if (err) { err.style.display = 'none'; err.textContent = ''; }
			// Si pides correo, puedes precargar el del usuario actual:
			// const user = window.auth?.currentUser;
			// if (user) document.getElementById('credEmail').value = user.email || '';
			document.getElementById('credPassword').value = '';
			document.getElementById('modalCredencialesBackdrop').style.display = 'flex';
		}

		function cerrarModalCredenciales() {
			document.getElementById('modalCredencialesBackdrop').style.display = 'none';
		}

		let __credBusy = false;

		function setCredBusy(state) {
			__credBusy = !!state;
			const btn = document.querySelector('#modalCredencialesBackdrop .btn-primary');
			if (btn) btn.disabled = !!state;
		}

		async function confirmarCredenciales() {
			if (__credBusy) return;
			setCredBusy(true);

			const err = document.getElementById('credError');
			const passEl = document.getElementById('credPassword');

			// Helper para mostrar error y (opcionalmente) limpiar password
			const showError = (msg, { clearPwd = false, focusPwd = false, shake = false } = {}) => {
				if (err) {
					err.textContent = msg;
					err.style.display = 'block';
				}
				if (clearPwd && passEl) passEl.value = '';
				if (focusPwd && passEl) passEl.focus();
				if (shake && passEl) {
					passEl.classList.add('input-shake');
					setTimeout(() => passEl.classList.remove('input-shake'), 300);
				}
			};

			try {
				// Validaciones de entorno/sesi√≥n
				if (!window.auth) {
					showError('No se pudo acceder a la sesi√≥n actual.');
					return;
				}

				const user = window.auth.currentUser;
				if (!user) {
					showError('No hay sesi√≥n activa. Inicia sesi√≥n nuevamente.');
					setTimeout(() => { window.location.href = 'login.html'; }, 1200);
					return;
				}

				const email = user.email;
				const password = (passEl?.value || '');

				if (!password) {
					showError('Ingresa tu contrase√±a.');
					if (passEl) passEl.focus();
					return;
				}

				// Reautenticaci√≥n
				const cred = window.EmailAuthProvider.credential(email, password);
				await window.reauthenticateWithCredential(user, cred);

				// OK ‚Üí eliminar
				await __eliminarProductoPersonalizadoConfirmado();

				cerrarModalCredenciales();
				mostrarExito();

			} catch (e) {
				console.error(e);
				// Error de credenciales: feedback + cooldown del bot√≥n
				showError('Credenciales inv√°lidas. Intenta nuevamente.', { clearPwd: true, focusPwd: true, shake: true });

				const btn = document.querySelector('#modalCredencialesBackdrop .btn-primary');
				if (btn) {
					btn.disabled = true;
					setTimeout(() => { btn.disabled = false; }, 1000);
				}

			} finally {
				// IMPORTANTE: liberar busy salvo que el bot√≥n est√© en cooldown por error.
				// Si quieres que __credBusy se libere incluso en cooldown, deja solo setCredBusy(false).
				setCredBusy(false);
			}
		}

		// (Opcional) Limpia mensaje de error cuando el usuario empieza a tipear.
		document.getElementById('credPassword')?.addEventListener('input', () => {
		const err = document.getElementById('credError');
		if (err && err.style.display !== 'none') {
			err.style.display = 'none';
			err.textContent = '';
		}
		});

		// (Opcional) Confirmar con Enter en el input de password:
		document.getElementById('credPassword')?.addEventListener('keydown', (ev) => {
		if (ev.key === 'Enter') confirmarCredenciales();
		});

		async function __eliminarProductoPersonalizadoConfirmado() {
			if (__pendingDeleteIdx == null || !__pendingDeleteNegocioKey) return;

			const all = loadCatalogos();
			const arr = Array.isArray(all[__pendingDeleteNegocioKey]) ? all[__pendingDeleteNegocioKey] : [];
			const idx = __pendingDeleteIdx;

			if (idx >= 0 && idx < arr.length) {
				arr.splice(idx, 1);
				all[__pendingDeleteNegocioKey] = arr;
				saveCatalogos(all);
			}

			// Guardamos para usarlo luego de refrescar UI
			const negocioKeyUsado = __pendingDeleteNegocioKey;

			// Limpiar estado
			__pendingDeleteIdx = null;
			__pendingDeleteNegocioKey = null;

			// Refrescar UI (configuraci√≥n y, si aplica, selector en Entrada)
			renderCatalogoUI();
			try {
				if (document.getElementById('business').value === negocioKeyUsado) {
				cargarProductos();
				}
			} catch (e) {}
		}

        // Estado temporal a nivel de archivo para saber qu√© borrar tras verificar
		let __pendingDeleteIdx = null;
		let __pendingDeleteNegocioKey = null;

		function cfgEliminarProducto(idx) {
			const negocioKey = document.getElementById('cfgNegocio').value;

			// Guardar intenci√≥n de borrado
			__pendingDeleteIdx = idx;
			__pendingDeleteNegocioKey = negocioKey;

			// Abrir modal para pedir contrase√±a
			abrirModalCredenciales();
		}

        // Renderiza la tabla de productos personalizados del negocio seleccionado
        function renderCatalogoUI() {
          const wrap = document.getElementById('cfgTablaWrap');
          if (!wrap) return;

          const negocioKey = document.getElementById('cfgNegocio')?.value || 'Negocio1';
          const personalizados = getCatalogoPersonalizado(negocioKey);

          if (!personalizados.length) {
            wrap.innerHTML = '<p style="color:#999;">Este negocio no tiene productos personalizados.</p>';
            return;
          }

          let rows = '';
          personalizados.forEach((p, idx) => {
            rows += `
              <tr>
                <td>${p.nombre}</td>
                <td style="text-align:right;">${COP(p.precio)}</td>
                <td style="text-align:center;">
                  <button class="btn-danger" type="button" onclick="cfgEliminarProducto(${idx})">Eliminar</button>
                </td>
              </tr>
            `;
          });

          wrap.innerHTML = `
            <table>
              <thead>
                <tr>
                  <th>Producto (personalizado)</th>
                  <th style="width:180px;">Precio</th>
                  <th style="width:140px;">Acciones</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          `;
        }		

		// ====== CARGAR PRODUCTOS AUTOM√ÅTICAMENTE ======
        function cargarProductos() {
          const negocio = document.getElementById("business").value;
          const select = document.getElementById("productoSelect");
          const precioWrap = document.getElementById("precioPersonalizadoWrap");
          const precioInput = document.getElementById("precioPersonalizado");

          select.innerHTML = "";

          // Catalogo combinado (base + personalizados)
          const catalogo = getCatalogoCombinado(negocio);

          // Negocio sin cat√°logo -> Venta Manual
          if (!catalogo || catalogo.length === 0) {
            const opt = document.createElement("option");
            opt.value = "manual";
            opt.textContent = "Venta Manual";
            select.appendChild(opt);
            document.getElementById("totalVentaPreview").textContent = "$0";
            precioWrap.style.display = "none";
            precioInput.value = "";
            return;
          }

          // Llenar cat√°logo
          catalogo.forEach((p, index) => {
            const option = document.createElement("option");
            option.value = index; // √≠ndice dentro del combinado
            option.textContent = `${p.nombre} - $${p.precio}`;
            select.appendChild(option);
          });

          // Mostrar/ocultar extras seg√∫n producto
          const idx = parseInt(select.value, 10);
          const prod = catalogo[idx];

          // Mojarra (solo Negocio2)
          if (negocio === "Negocio2" && prod && prod.nombre.toLowerCase().includes("mojarra")) {
            precioWrap.style.display = "block";
          } else {
            precioWrap.style.display = "none";
            precioInput.value = "";
          }

          // Tipo de corriente (solo Negocio2)
          const tipoCorrienteWrap = document.getElementById("tipoCorrienteWrap");
          const tipoCorrienteInput = document.getElementById("tipoCorriente");
          if (negocio === "Negocio2" && prod && prod.nombre.toLowerCase().includes("corriente")) {
            tipoCorrienteWrap.style.display = "block";
          } else {
            tipoCorrienteWrap.style.display = "none";
            if (tipoCorrienteInput) tipoCorrienteInput.value = "";
          }

          calcularTotalVenta();
        }

		// ====== CALCULAR TOTAL (incluye precio personalizado para Mojarra y Tipo de corriente) ======
        function calcularTotalVenta() {
          const negocio = document.getElementById("business").value;
          const select = document.getElementById("productoSelect");
          const index = select.value;
          const cantidad = parseInt(document.getElementById("cantidad").value, 10) || 0;

          const precioWrap = document.getElementById("precioPersonalizadoWrap");
          const precioInput = document.getElementById("precioPersonalizado");

          const catalogo = getCatalogoCombinado(negocio);

          if (index === 'manual' || !catalogo || !catalogo[index]) {
            document.getElementById("totalVentaPreview").textContent = "$0";
            return;
          }

          const prod = catalogo[index];
          let precioUnitario = prod.precio || 0;

          // Mojarra personalizada (> 25.000) solo Negocio2
          if (negocio === "Negocio2" && prod && prod.nombre.toLowerCase().includes("mojarra")) {
            precioWrap.style.display = "block";
            const personalizado = parseInt(precioInput.value, 10);
            if (!isNaN(personalizado) && personalizado > 25000) {
              precioUnitario = personalizado;
            }
          } else {
            precioWrap.style.display = "none";
            if (precioInput) precioInput.value = "";
          }

          // Tipo de corriente (solo Negocio2)
          const tipoCorrienteWrap = document.getElementById("tipoCorrienteWrap");
          const tipoCorrienteInput = document.getElementById("tipoCorriente");
          if (negocio === "Negocio2" && prod && prod.nombre.toLowerCase().includes("corriente")) {
            tipoCorrienteWrap.style.display = "block";
          } else {
            tipoCorrienteWrap.style.display = "none";
            if (tipoCorrienteInput) tipoCorrienteInput.value = "";
          }

          const total = precioUnitario * (cantidad || 1);
          document.getElementById("totalVentaPreview").textContent = COP(total);
        }

        // Inicializar localStorage
        function inicializarSistema() {
            if (!localStorage.getItem('contabilidad')) {
                const datosInicial = {
                    Negocio1: [],
                    Negocio2: [],
                    Negocio3: [],
                    Negocio4: []
                };
                localStorage.setItem('contabilidad', JSON.stringify(datosInicial));
            }
            setFechaActual();
            actualizarTotalRegistros();
			cargarProductos();
			updateGastoInputsState();
        }
		async function obtenerTodosLosRegistros() {
			const snapshot = await getDocs(collection(db, "registros"));

			const datos = {
				Negocio1: [],
				Negocio2: [],
				Negocio3: [],
				Negocio4: []
			};

			snapshot.forEach(d => {
				const data = d.data();

				// Resolver key del negocio a partir del nombre almacenado
				let negocioKey = Object.keys(nombresNegocios).find(key =>
				nombresNegocios[key] === data.negocio || key === data.negocio
				);

				// Normalizar strings por si vinieran con diferencias de casing o espacios
				if (!negocioKey && typeof data.negocio === 'string') {
				const nom = data.negocio.trim().toLowerCase();
				negocioKey = Object.keys(nombresNegocios).find(key =>
					(nombresNegocios[key] || '').toLowerCase() === nom || key.toLowerCase() === nom
				);
				}

				if (negocioKey) {
				// ‚üµ IMPORTANTE: guardar tambi√©n el id del documento
				datos[negocioKey].push({ id: d.id, ...data });
				}
			});

			return datos;
		}
		
		// === Helper: fecha local en formato YYYY-MM-DD (sin UTC) ===
		function hoyLocalISO() {
		  const d = new Date();
		  const y = d.getFullYear();
		  const m = String(d.getMonth() + 1).padStart(2, '0');
		  const day = String(d.getDate()).padStart(2, '0');
		  return `${y}-${m}-${day}`;
		}

        // Establecer fecha actual
        function setFechaActual() {
		  const hoy = hoyLocalISO();
		  document.getElementById('fecha').value = hoy;
		  document.getElementById('fechaFiltro').value = hoy;
		}

          // Guardar datos: ventas (por carrito) + gasto opcional.
		  // - estadoPago: 'pagado' | 'debe' | 'soloGasto'
		  // - nombreCliente: string | null
		  // - metodoVenta: 'Efectivo' | 'Nequi' | null (solo si 'pagado' y hay carrito)
		  // - metodoGasto: 'Efectivo' | 'Nequi' | null (si hay gasto)
		  // - soloGasto: true para ignorar carrito y registrar SOLO el gasto
		  async function guardarDatos({ estadoPago = 'pagado', nombreCliente = null, metodoVenta = null, metodoGasto = null, soloGasto = false } = {}) {
			const negocioKey = document.getElementById('business').value;
			const negocio = nombresNegocios[negocioKey];
			const fecha = document.getElementById('fecha').value;
			const gastos = parseFloat(document.getElementById('gastos').value) || 0;
			let descripcion = document.getElementById('descripcion').value || '';
			const hayCarrito = carrito.length > 0;
			const hayGasto = gastos > 0;

			if (!fecha) {
			  mostrarError('Debes seleccionar la fecha');
			  return;
			}

			if (!hayCarrito && !hayGasto) {
			  mostrarError('Agrega al menos una l√≠nea al pedido o registra un gasto.');
			  return;
			}

			// Normalizar estado
			const estadoFmt = (estadoPago === 'debe') ? 'Debe'
							 : (estadoPago === 'pagado') ? 'Pagado'
							 : 'soloGasto';

			// Validaciones m√≠nimas
			if (estadoFmt === 'Pagado' && hayCarrito && !metodoVenta) {
			  mostrarError('Selecciona el m√©todo de pago de la venta.');
			  return;
			}
			if (hayGasto && !metodoGasto) {
			  mostrarError('Selecciona el m√©todo de pago del gasto.');
			  return;
			}
			if (estadoFmt === 'Debe' && hayCarrito && !(nombreCliente && nombreCliente.trim())) {
			  mostrarError('Debes ingresar el nombre del cliente que qued√≥ debiendo.');
			  return;
			}
			if (estadoFmt === 'soloGasto' && !hayGasto) {
			  mostrarError('Seleccionaste "Solo gasto" pero no hay valor de gasto.');
			  return;
			}

			try {
			  // 1) Si NO es soloGasto, guardamos las VENTAS del carrito
			  if (!soloGasto && hayCarrito) {
				for (const item of carrito) {
				  await addDoc(collection(db, "registros"), {
					tipo: "movimiento",
					negocio,
					fecha,
					producto: item.producto,
					tipoCorriente: null,
					cantidad: item.cantidad,
					precioUnitario: item.precioUnitario,
					ventas: item.ventas,
					gastos: 0,
					// m√©todo:
					// - Pagado: usar metodoVenta
					// - Debe  : null (se asigna al cobrar)
					metodo: (estadoFmt === 'Pagado') ? metodoVenta : null,
					estadoPago: (estadoFmt === 'soloGasto') ? null : estadoFmt, // soloGasto no aplica
					cliente: (estadoFmt === 'Debe') ? (nombreCliente || null) : null,
					descripcion: `${item.producto} x ${item.cantidad}`,
					createdAt: new Date()
				  });
				}
			  }

			  // 2) Si hay GASTO, guardarlo (no aplica estadoPago ni cliente)
			  if (hayGasto) {
				await addDoc(collection(db, "registros"), {
				  tipo: "movimiento",
				  negocio,
				  fecha,
				  producto: null,
				  cantidad: null,
				  precioUnitario: null,
				  ventas: 0,
				  gastos,
				  metodo: metodoGasto,          // ‚Üê m√©todo del gasto (obligatorio si hay gasto)
				  estadoPago: null,
				  cliente: null,
				  descripcion: descripcion || 'Gasto del d√≠a',
				  createdAt: new Date()
				});
			  }

			  // Limpieza y feedback
			  carrito = [];
			  renderCarrito();
			  document.getElementById('gastos').value = '';
			  document.getElementById('descripcion').value = '';
			  mostrarExito();

			  // Refrescar tableros relevantes
			  try { await actualizarResumen(); } catch(e) {}
			  try { await actualizarAnalisisPagos(); } catch(e) {}
			  try { await actualizarAcumulado(); } catch(e) {}
			  try { await actualizarCuentasPorCobrar(); } catch(e) {}

			} catch (error) {
			  console.error(error);
			  mostrarError("Error guardando en la nube");
			}
		  }
		
		// ====== CARRITO (pedido en pantalla) ======
		let carrito = []; // {producto, cantidad, precioUnitario, ventas}

		// Render del carrito
		function renderCarrito() {
			const tbody = document.querySelector('#carritoTabla tbody');
			const section = document.getElementById('carritoSection');
			const totalEl = document.getElementById('carritoTotal');

			if (!tbody || !section || !totalEl) return;

			tbody.innerHTML = '';
			let totalPedido = 0;

			carrito.forEach((item, idx) => {
			  const tr = document.createElement('tr');
			  const totalLinea = item.ventas || 0;
			  totalPedido += totalLinea;

			  tr.innerHTML = `
				<td>${item.producto}</td>
				<td>${item.cantidad}</td>
				<td>${COP(item.precioUnitario)}</td>
				<td>${COP(totalLinea)}</td>
				<td><button class="btn-danger" type="button" onclick="quitarLinea(${idx})">‚úñ</button></td>
			  `;
			  tbody.appendChild(tr);
			});

			totalEl.textContent = COP(totalPedido);
			section.style.display = carrito.length > 0 ? 'block' : 'none';
			
			// üëá NUEVO: actualizar el estado de los inputs de gasto
			  updateGastoInputsState();
		}

		// Quitar l√≠nea del carrito
		function quitarLinea(idx) {
		  carrito.splice(idx, 1);
		  renderCarrito();
		}

		// Agregar l√≠nea al carrito
        function agregarAlCarrito() {
          const negocio = document.getElementById('business').value;
          const index = document.getElementById("productoSelect").value;
          const cantidad = parseInt(document.getElementById("cantidad").value, 10) || 0;

          const catalogo = getCatalogoCombinado(negocio);

          if (!catalogo || index === 'manual' || !catalogo[index]) {
            mostrarError('Selecciona un producto del cat√°logo para agregar al pedido.');
            return;
          }
          if (cantidad <= 0) {
            mostrarError('La cantidad debe ser mayor a 0');
            return;
          }

          const prod = catalogo[index];
          let precioUnitario = prod.precio || 0;

          // Mojarra con precio personalizado
          if (negocio === "Negocio2" && prod.nombre.toLowerCase().includes("mojarra")) {
            const personalizado = parseInt(document.getElementById("precioPersonalizado").value, 10);
            if (!isNaN(personalizado) && personalizado > 25000) {
              precioUnitario = personalizado;
            }
          }

          // Corriente: exigir tipo
          let nombreProductoParaLinea = prod.nombre;
          if (negocio === "Negocio2" && prod.nombre.toLowerCase().includes("corriente")) {
            const tipo = (document.getElementById("tipoCorriente").value || "").trim();
            if (!tipo) {
              mostrarError('Debes indicar el tipo de corriente (ej: pollo, res, mixta).');
              return;
            }
            nombreProductoParaLinea = `Corriente (${tipo})`;
          }

          const ventas = precioUnitario * cantidad;

          carrito.push({
            producto: nombreProductoParaLinea,
            cantidad,
            precioUnitario,
            ventas
          });

          document.getElementById('cantidad').value = '1';
          const p = document.getElementById('precioPersonalizado');
          if (p) p.value = '';

          calcularTotalVenta();
          renderCarrito();
        }

		// Vaciar carrito si cambia fecha/negocio (para no mezclar cortes)
		function resetCarritoSiCambiaCorte() {
		  carrito = [];
		  renderCarrito();
		  const tipoCorriente = document.getElementById('tipoCorriente');
		  if (tipoCorriente) tipoCorriente.value = '';
		  const wrap = document.getElementById('tipoCorrienteWrap');
		  if (wrap) wrap.style.display = 'none';
		  updateGastoInputsState();
		}

		// Hookear cambios de fecha y negocio
		document.getElementById('business').addEventListener('change', resetCarritoSiCambiaCorte);
		document.getElementById('fecha').addEventListener('change', resetCarritoSiCambiaCorte);

        // Agrupa l√≠neas del d√≠a por producto para mostrar conteo y total
		function agruparPlatosPorProducto(registrosDelDia) {
		  const mapa = new Map(); // clave: producto, valor: {cantidadTotal, totalVentas}
		  registrosDelDia.forEach(r => {
			if (r.tipo === 'movimiento' && r.producto && r.cantidad && r.ventas) {
			  const key = r.producto;
			  const prev = mapa.get(key) || { cantidadTotal: 0, totalVentas: 0 };
			  prev.cantidadTotal += Number(r.cantidad) || 0;
			  prev.totalVentas += Number(r.ventas) || 0;
			  mapa.set(key, prev);
			}
		  });
		  // A HTML
		  if (mapa.size === 0) return '';
		  let rows = '';
		  mapa.forEach((val, prod) => {
			rows += `
			  <tr>
				<td>${prod}</td>
				<td style="text-align:center;">${val.cantidadTotal}</td>
				<td style="text-align:right;">${COP(val.totalVentas)}</td>
			  </tr>
			`;
		  });
		  return `
			<div style="margin-top:10px;">
			  <h4>Platos vendidos</h4>
			  <table>
				<thead>
				  <tr>
					<th>Producto</th>
					<th>Cant.</th>
					<th>Total (COP)</th>
				  </tr>
				</thead>
				<tbody>
				  ${rows}
				</tbody>
			  </table>
			</div>
		  `;
		}
		
		// === Reemplazar COMPLETO ===
		async function actualizarResumen() {
		  const fecha = document.getElementById('fechaFiltro').value;
		  const soloDeudas = !!document.getElementById('soloDeudas')?.checked;
		  const excluirDeudasResumen = true;
		  const datos = await obtenerTodosLosRegistros();
		  const container = document.getElementById('resumenContent');
		  let html = '';

		  for (const [negocio, registros] of Object.entries(datos)) {
			// Registros del d√≠a (por negocio)
			const delDia = registros.filter(r => r.fecha === fecha);

			// === BLOQUE NUEVO: c√°lculo de saldos del d√≠a (con o sin deudas) ===
			const registrosParaSaldos = excluirDeudasResumen
			  ? delDia.filter(r => r.tipo === "movimiento" && (r.estadoPago === 'Pagado' || r.estadoPago == null))
			  : delDia;

			let ventasEfectivo = 0;
			let ventasNequi = 0;
			let totalGastos = 0;

			// Ventas: usar registrosParaSaldos
			registrosParaSaldos.forEach(r => {
			  if (r.tipo === "movimiento") {
				const v = Number(r.ventas || 0);
				if (r.metodo === "Efectivo") ventasEfectivo += v;
				if (r.metodo === "Nequi") ventasNequi += v;
			  }
			});

			// Gastos: SIEMPRE sumar del d√≠a completo
			delDia.forEach(r => {
			  if (r.tipo === "movimiento") {
				totalGastos += Number(r.gastos || 0);
			  }
			});

			const totalVentas = ventasEfectivo + ventasNequi;
			const balance = totalVentas - totalGastos;
			const saldoEfectivo = ventasEfectivo - totalGastos;
			const saldoNequi = ventasNequi;

			// === Tabla del d√≠a: respeta el filtro "Solo Deudas" ===
			const registrosParaTabla = soloDeudas
			  ? delDia.filter(r =>
				  r.tipo === 'movimiento' &&
				  Number(r.ventas) > 0 &&
				  r.estadoPago === 'Debe'
				)
			  : delDia;

			html += `
			  <div class="business-section">
				<h4>${nombresNegocios[negocio]}</h4>
				<div class="summary-grid">
				  <div class="summary-box">
					<h4>Ventas</h4>
					<div class="value" style="color:#007bff;">${COP(totalVentas)}</div>
				  </div>
				  <div class="summary-box">
					<h4>Gastos</h4>
					<div class="value" style="color:#dc3545;">-${COP(totalGastos)}</div>
				  </div>
				  <div class="summary-box" style="border-color:#667eea;background:#f0f4ff;">
					<h4>Balance del D√≠a</h4>
					<div class="value" style="color:#667eea;">${COP(balance)}</div>
				  </div>
				</div>
				<hr style="margin:15px 0;">
				<div style="display:flex;justify-content:space-between;">
				  <div>üíµ <strong>Saldo en Efectivo:</strong><br>
					<span style="color:#28a745;font-weight:bold;">${COP(saldoEfectivo)}</span>
				  </div>
				  <div>üì± <strong>Saldo en Nequi:</strong><br>
					<span style="color:#007bff;font-weight:bold;">${COP(saldoNequi)}</span>
				  </div>
				</div>
				${registrosParaTabla.length > 0 ? `<table>${generarTablaRegistros(registrosParaTabla)}</table>` : '<p style="color:#999;margin-top:15px;">No hay registros para esta fecha</p>'}
				${agruparPlatosPorProducto(registrosParaTabla)}
			  </div>
			`;
		  }

		  container.innerHTML = html || '<p>No hay datos</p>';
		}
		
		// === Reemplazar COMPLETO ===
		async function actualizarCuentasPorCobrar() {
		  const container = document.getElementById('cxcContent');
		  if (!container) return;

		  const datos = await obtenerTodosLosRegistros();

		  // Agrupar por cliente (todas las fechas, todos los negocios)
		  const mapaClientes = new Map(); // cliente -> { totalPendiente, cantidadVentas }

		  let totalGeneral = 0;
		  let totalVentasPendientes = 0;

		  for (const registros of Object.values(datos)) {
			registros.forEach(r => {
			  if (r.tipo === 'movimiento' && r.estadoPago === 'Debe') {
				const pendiente = Number((r.montoPendiente != null ? r.montoPendiente : r.ventas) || 0);
				if (pendiente > 0) {
				  const cliente = (r.cliente && String(r.cliente).trim()) ? r.cliente.trim() : 'Sin nombre';
				  const prev = mapaClientes.get(cliente) || { totalPendiente: 0, cantidadVentas: 0 };
				  prev.totalPendiente += pendiente;
				  prev.cantidadVentas += 1;
				  mapaClientes.set(cliente, prev);

				  totalGeneral += pendiente;
				  totalVentasPendientes += 1;
				}
			  }
			});
		  }

		  // Orden por mayor deuda
		  const filas = [...mapaClientes.entries()]
			.sort((a, b) => b[1].totalPendiente - a[1].totalPendiente)
			.map(([cliente, info]) => {
			  const clienteSafe = cliente.replace(/'/g, "\\'");
			  return `
				<tr>
				  <td>${cliente}</td>
				  <td style="text-align:center;">${info.cantidadVentas}</td>
				  <td style="text-align:right;">${COP(info.totalPendiente)}</td>
				  <td style="text-align:center;">
					<button class="btn-success" type="button"
					  onclick="abrirModalCobroCliente('${clienteSafe}', ${info.totalPendiente})">
					  Cobrar
					</button>
				  </td>
				</tr>
			  `;
			}).join('');

		  const clientesUnicos = mapaClientes.size;

		  const html = `
			<div class="business-section" style="border-left-color:#dc3545;">
			  <h3>üí≥ Cuentas por Cobrar (Acumulado)</h3>
			  <div class="summary-grid">
				<div class="summary-box">
				  <h4>Total por Cobrar</h4>
				  <div class="value" style="color:#dc3545;">${COP(totalGeneral)}</div>
				</div>
				<div class="summary-box">
				  <h4>Clientes con deuda</h4>
				  <div class="value">${clientesUnicos}</div>
				</div>
				<div class="summary-box">
				  <h4>Ventas pendientes</h4>
				  <div class="value">${totalVentasPendientes}</div>
				</div>
			  </div>

			  ${
				clientesUnicos > 0
				? `
				  <table>
					<thead>
					  <tr>
						<th>Cliente</th>
						<th style="width:140px;"># Ventas</th>
						<th style="width:200px;">Total Pendiente (COP)</th>
						<th style="width:140px;">Acciones</th>
					  </tr>
					</thead>
					<tbody>
					  ${filas}
					</tbody>
				  </table>
				`
				: '<p style="color:#28a745;margin-top:10px;">No hay deudas pendientes. ‚úÖ</p>'
			  }
			</div>
		  `;

		  container.innerHTML = html;
		}
		
		//modal por cliente
		let clienteACobrar = null;
		let deudaClienteActual = 0;

		function abrirModalCobroCliente(cliente, deuda) {
		  clienteACobrar = cliente;
		  deudaClienteActual = Number(deuda) || 0;

		  document.getElementById('cxcClienteNombre').textContent = clienteACobrar;
		  document.getElementById('cxcClienteDeuda').textContent = COP(deudaClienteActual);

		  document.querySelector('input[name="tipoCobroCliente"][value="total"]').checked = true;
		  toggleMontoParcial(false);
		  const monto = document.getElementById('montoParcial');
		  if (monto) monto.value = '';

		  document.querySelector('input[name="metodoCobroCliente"][value="Efectivo"]').checked = true;

		  const err = document.getElementById('modalCobroClienteError');
		  err.style.display = 'none'; err.textContent = '';

		  document.getElementById('modalCobroClienteBackdrop').style.display = 'flex';
		}

		function cerrarModalCobroCliente() {
		  document.getElementById('modalCobroClienteBackdrop').style.display = 'none';
		  clienteACobrar = null;
		  deudaClienteActual = 0;
		}

		function toggleMontoParcial(show) {
		  const wrap = document.getElementById('montoParcialWrap');
		  if (wrap) wrap.style.display = show ? 'block' : 'none';
		}
		
		function updateModalPagoUI() {
			const estado = document.querySelector('input[name="estadoPago"]:checked')?.value || 'pagado';
			const hayCarrito = (carrito && carrito.length > 0);
			const gastos = parseFloat(document.getElementById('gastos').value) || 0;
			const hayGasto = gastos > 0;

			// Nombre cliente solo si 'Debe' y hay ventas
			const nombreWrap = document.getElementById('nombreClienteWrap');
			if (nombreWrap) nombreWrap.style.display = (estado === 'debe' && hayCarrito) ? 'block' : 'none';

			// M√©todo de pago de la venta solo si 'pagado' y hay ventas
			const ventaWrap = document.getElementById('metodoVentaWrap');
			if (ventaWrap) ventaWrap.style.display = (estado === 'pagado' && hayCarrito) ? 'block' : 'none';

			// M√©todo del gasto si hay gasto (independiente del estado)
			const gastoWrap = document.getElementById('metodoGastoWrap');
			if (gastoWrap) gastoWrap.style.display = hayGasto ? 'block' : 'none';
		}
		
		// === Cobro por cliente: total/parcial con m√©todo ===
		async function confirmarCobroCliente() {
		  const err = document.getElementById('modalCobroClienteError');

		  try {
			if (!clienteACobrar) {
			  err.textContent = '‚úó No hay cliente seleccionado.'; err.style.display = 'block';
			  return;
			}

			const tipo = document.querySelector('input[name="tipoCobroCliente"]:checked')?.value || 'total';
			const metodo = document.querySelector('input[name="metodoCobroCliente"]:checked')?.value || 'Efectivo';

			let montoParcial = 0;
			if (tipo === 'parcial') {
			  montoParcial = parseInt(document.getElementById('montoParcial').value, 10) || 0;
			  if (montoParcial <= 0) {
				err.textContent = '‚úó Ingresa un monto v√°lido para el pago parcial.'; err.style.display = 'block';
				return;
			  }
			  if (montoParcial > deudaClienteActual) {
				err.textContent = '‚úó El monto parcial no puede exceder la deuda total del cliente.'; err.style.display = 'block';
				return;
			  }
			}

			// Cargar todas las ventas "Debe" del cliente (de todos los negocios)
			const datos = await obtenerTodosLosRegistros();
			const deudas = [];
			for (const regs of Object.values(datos)) {
			  regs.forEach(r => {
				const cliente = (r.cliente && String(r.cliente).trim()) ? r.cliente.trim() : 'Sin nombre';
				if (
				  r.tipo === 'movimiento' &&
				  r.estadoPago === 'Debe' &&
				  cliente === clienteACobrar
				) {
				  const pendiente = Number((r.montoPendiente != null ? r.montoPendiente : r.ventas) || 0);
				  if (pendiente > 0) {
					deudas.push({ ...r, pendiente });
				  }
				}
			  });
			}

			if (deudas.length === 0) {
			  err.textContent = '‚úó No hay deudas pendientes para este cliente.'; err.style.display = 'block';
			  return;
			}

			// Orden FIFO: por createdAt (si existe) o por fecha
			deudas.sort((a, b) => {
			  const ta = (a.createdAt && a.createdAt.toMillis) ? a.createdAt.toMillis() : new Date(a.fecha).getTime();
			  const tb = (b.createdAt && b.createdAt.toMillis) ? b.createdAt.toMillis() : new Date(b.fecha).getTime();
			  return ta - tb;
			});

			if (tipo === 'total') {
			  // Pago total: marcar todas las ventas como Pagado (no creamos abonos)
			  await Promise.all(
				deudas.map(r =>
				  updateDoc(doc(db, "registros", r.id), {
					estadoPago: 'Pagado',
					metodo: metodo,
					montoPendiente: 0
				  })
				)
			  );
			} else {
			  // Pago parcial: repartir el monto por orden FIFO creando "abonos" como movimientos Pagados
			  let restante = montoParcial;
			  for (const r of deudas) {
				if (restante <= 0) break;

				const aplicar = Math.min(restante, r.pendiente);
				const nuevoPendiente = r.pendiente - aplicar;

				// 1) Crear un movimiento de "abono" (entra a caja hoy por el m√©todo elegido)
				await addDoc(collection(db, "registros"), {
				  tipo: "movimiento",
				  negocio: r.negocio,               // mismo negocio del √≠tem original
				  fecha: hoyLocalISO(), // hoy (hora local)
				  producto: null,                   // es un abono, no un √≠tem vendido
				  cantidad: null,
				  precioUnitario: null,
				  ventas: aplicar,
				  gastos: 0,
				  metodo: metodo,
				  estadoPago: 'Pagado',
				  cliente: clienteACobrar,
				  esAbono: true,                    // flag para identificar abonos
				  descripcion: `Cobro parcial de deuda (venta del ${r.fecha})`,
				  createdAt: new Date()
				});

				// 2) Marcar el original con montoPendiente y bandera para no duplicar en an√°lisis
				const updatePayload = {
				  montoPendiente: nuevoPendiente,
				  excluirDeAnalisis: true
				};
				if (nuevoPendiente <= 0) {
				  updatePayload.estadoPago = 'Pagado';
				} else {
				  updatePayload.estadoPago = 'Debe';
				}
				await updateDoc(doc(db, "registros", r.id), updatePayload);

				restante -= aplicar;
			  }
			}

			cerrarModalCobroCliente();
			mostrarExito();

			// Refrescar tableros
			try { await actualizarCuentasPorCobrar(); } catch (e) {}
			try { await actualizarResumen(); } catch (e) {}
			try { await actualizarAnalisisPagos(); } catch (e) {}
			try { await actualizarAcumulado(); } catch (e) {}

		  } catch (e) {
			console.error(e);
			err.textContent = '‚úó Error registrando el cobro del cliente.';
			err.style.display = 'block';
		  }
		}
		
        // Actualizar cuentas acumuladas
        async function actualizarAcumulado() {

			const datos = await obtenerTodosLosRegistros();
			const container = document.getElementById('acumuladoContent');
			let html = '';

			for (const [negocio, registros] of Object.entries(datos)) {

			  // Saldos iniciales
			  let saldoEfectivo = Number(saldoInicial[negocio]?.efectivo || 0);
			  let saldoNequi   = Number(saldoInicial[negocio]?.nequi || 0);

			  // 1) Ventas de productos (NO contar abonos)
			  //    - r.ventas > 0
			  //    - debe tener 'producto' (los abonos no lo tienen)
			  //    - excluir si viene marcado como abono (flag) o por descripci√≥n
			  const totalVentasProductos = registros.reduce((sum, r) => {
				const esMovimiento = r.tipo === 'movimiento';
				const esVenta      = Number(r.ventas || 0) > 0;
				const tieneProducto = !!r.producto;
				const esAbonoFlag  = r.esAbono === true;
				const esAbonoPorDescripcion = typeof r.descripcion === 'string' &&
				  r.descripcion.toLowerCase().includes('cobro parcial');

				if (esMovimiento && esVenta && tieneProducto && !esAbonoFlag && !esAbonoPorDescripcion) {
				  return sum + Number(r.ventas || 0);
				}
				return sum;
			  }, 0);

			  // 2) Gastos totales (da igual si el doc es abono u otro, abonos traen gastos=0)
			  const totalGastos = registros.reduce((sum, r) => {
				if (r.tipo === 'movimiento') {
				  return sum + Number(r.gastos || 0);
				}
				return sum;
			  }, 0);

			  // 3) Flujos reales por m√©todo ‚Üí (ventas pagadas + abonos) - gastos
			  //    - Esto mantiene abonos como ENTRADAS de efectivo/nequi, que es correcto
			  registros.forEach(r => {
				if (r.tipo !== 'movimiento') return;
				const v = Number(r.ventas || 0);
				const g = Number(r.gastos || 0);

				if (r.metodo === "Efectivo") {
				  saldoEfectivo += v - g;
				} else if (r.metodo === "Nequi") {
				  saldoNequi += v - g;
				}
			  });

			  const saldoTotal = saldoEfectivo + saldoNequi;

			  html += `
				<div class="summary-box">
				  <h4>${nombresNegocios[negocio]}</h4>
				  <p><strong>Capital Inicial:</strong> ${COP((saldoInicial[negocio]?.efectivo || 0) + (saldoInicial[negocio]?.nequi || 0))}</p>
				  <p><strong>Ventas Totales:</strong> ${COP(totalVentasProductos)}</p>
				  <p><strong>Gastos Totales:</strong> -${COP(totalGastos)}</p>
				  <hr>
				  <p><strong>Saldo Total Real:</strong> ${COP(saldoTotal)}</p>
				  <hr>
				  <p>üíµ Saldo Efectivo: ${COP(saldoEfectivo)}</p>
				  <p>üì± Saldo Nequi: ${COP(saldoNequi)}</p>
				</div>
			  `;
			}

			container.innerHTML = html;
		}

		// === Reemplazar COMPLETO ===
		async function actualizarAnalisisPagos() {
			const negocioFiltro = document.getElementById('negocioFiltro').value;
			const filtroFecha = document.getElementById('filtroFechaPagos').value;
			const incluirInicial = !!document.getElementById('toggleCapitalInicial')?.checked;

			const datos = await obtenerTodosLosRegistros();
			const container = document.getElementById('analisisPagosContent');
			const fechaPagosContainer = document.getElementById('fechaPagosContainer');

			// Mostrar/ocultar selector de fecha
			if (filtroFecha === 'fecha') {
			fechaPagosContainer.style.display = 'block';
			if (!document.getElementById('fechaSeleccionadaPagos').value) {
				document.getElementById('fechaSeleccionadaPagos').value = hoyLocalISO();
			}
			} else {
			fechaPagosContainer.style.display = 'none';
			}

			const fechaSeleccionada = document.getElementById('fechaSeleccionadaPagos').value;

			const negocios = (negocioFiltro === 'Todos') ? Object.keys(datos) : [negocioFiltro];

			// Totales globales (saldos reales)
			let totalGlobalEfectivo = 0;
			let totalGlobalNequi = 0;

			let html = '';

			for (const negocio of negocios) {
			let registros = datos[negocio] || [];

			// Filtro por fecha (opcional)
			if (filtroFecha === 'fecha') {
				registros = registros.filter(r => r.fecha === fechaSeleccionada);
			}

			// Ventas pagadas por m√©todo (excluye originales marcados para no duplicar)
			const ventasPagadasEfectivo = registros
			  .filter(r =>
				r.tipo === 'movimiento' &&
				Number(r.ventas) > 0 &&
				r.metodo === 'Efectivo' &&
				(r.estadoPago === 'Pagado' || r.estadoPago == null) &&
				r.excluirDeAnalisis !== true
			  )
			  .reduce((sum, r) => sum + (Number(r.ventas) || 0), 0);

			const ventasPagadasNequi = registros
			  .filter(r =>
				r.tipo === 'movimiento' &&
				Number(r.ventas) > 0 &&
				r.metodo === 'Nequi' &&
				(r.estadoPago === 'Pagado' || r.estadoPago == null) &&
				r.excluirDeAnalisis !== true
			  )
			  .reduce((sum, r) => sum + (Number(r.ventas) || 0), 0);

			// Gastos por m√©todo
			const gastosEfectivo = registros
				.filter(r => r.tipo === 'movimiento' && Number(r.gastos) > 0 && r.metodo === 'Efectivo')
				.reduce((sum, r) => sum + (Number(r.gastos) || 0), 0);

			const gastosNequi = registros
				.filter(r => r.tipo === 'movimiento' && Number(r.gastos) > 0 && r.metodo === 'Nequi')
				.reduce((sum, r) => sum + (Number(r.gastos) || 0), 0);

			// Capital inicial por m√©todo (opcional, toggle)
			const inicialEfectivo = incluirInicial ? (saldoInicial[negocio]?.efectivo || 0) : 0;
			const inicialNequi = incluirInicial ? (saldoInicial[negocio]?.nequi || 0) : 0;

			// Saldos reales por m√©todo
			const saldoEfectivo = inicialEfectivo + ventasPagadasEfectivo - gastosEfectivo;
			const saldoNequi = inicialNequi + ventasPagadasNequi - gastosNequi;
			const totalSaldo = saldoEfectivo + saldoNequi;

			totalGlobalEfectivo += saldoEfectivo;
			totalGlobalNequi += saldoNequi;

			const pctEfectivo = totalSaldo > 0 ? ((saldoEfectivo / totalSaldo) * 100).toFixed(1) : 0;
			const pctNequi = totalSaldo > 0 ? ((saldoNequi / totalSaldo) * 100).toFixed(1) : 0;

			html += `
				<div class="business-section">
				<h4>${nombresNegocios[negocio]}</h4>
				<div class="summary-grid">
					<div class="summary-box">
					<h4>üíµ Saldo en Efectivo</h4>
					<div class="value">${COP(saldoEfectivo)}</div>
					<p style="color:#666;margin-top:10px;">${pctEfectivo}%</p>
					</div>
					<div class="summary-box">
					<h4>üì± Saldo en Nequi</h4>
					<div class="value">${COP(saldoNequi)}</div>
					<p style="color:#666;margin-top:10px;">${pctNequi}%</p>
					</div>
					<div class="summary-box">
					<h4>üí∞ Total Saldos</h4>
					<div class="value">${COP(totalSaldo)}</div>
					</div>
				</div>

				<div class="summary-card" style="margin-top:10px;">
					<h3>Detalle</h3>
					<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;">
					<div>
						<strong>Inicial Efectivo:</strong> ${COP(inicialEfectivo)}<br>
						<strong>Ventas (Pagadas) Efectivo:</strong> ${COP(ventasPagadasEfectivo)}<br>
						<strong>Gastos en Efectivo:</strong> -${COP(gastosEfectivo)}
					</div>
					<div>
						<strong>Inicial Nequi:</strong> ${COP(inicialNequi)}<br>
						<strong>Ventas (Pagadas) Nequi:</strong> ${COP(ventasPagadasNequi)}<br>
						<strong>Gastos en Nequi:</strong> -${COP(gastosNequi)}
					</div>
					</div>
				</div>
				</div>
			`;
			}

			const totalGlobal = totalGlobalEfectivo + totalGlobalNequi;
			const pctGlobalEfectivo = totalGlobal > 0 ? ((totalGlobalEfectivo / totalGlobal) * 100).toFixed(1) : 0;
			const pctGlobalNequi = totalGlobal > 0 ? ((totalGlobalNequi / totalGlobal) * 100).toFixed(1) : 0;

			const baseTitulo = (filtroFecha === 'fecha')
			? `SALDOS DEL D√çA (${document.getElementById('fechaSeleccionadaPagos').value})`
			: 'SALDOS TOTALES (Acumulado)';

			const resumenTitulo = incluirInicial ? `${baseTitulo} ‚Äî (incluye capital inicial)` : baseTitulo;

			let htmlFinal = `
			<div class="business-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
				<h4 style="color: white; text-align: center; margin-bottom: 20px; font-size: 1.1em;">${resumenTitulo}</h4>
				<div class="summary-grid">
				<div class="summary-box" style="background: rgba(255,255,255,0.95); border: none;">
					<h4 style="color: #28a745;">üíµ Saldo Efectivo</h4>
					<div class="value" style="color: #28a745;">${COP(totalGlobalEfectivo)}</div>
					<p style="color: #666; margin-top: 10px; font-weight: bold;">${pctGlobalEfectivo}%</p>
				</div>
				<div class="summary-box" style="background: rgba(255,255,255,0.95); border: none;">
					<h4 style="color: #007bff;">üì± Saldo Nequi</h4>
					<div class="value" style="color: #007bff;">${COP(totalGlobalNequi)}</div>
					<p style="color: #666; margin-top: 10px; font-weight: bold;">${pctGlobalNequi}%</p>
				</div>
				<div class="summary-box" style="background: rgba(255,255,255,0.95); border: none;">
					<h4 style="color: #667eea;">üí∞ Total General</h4>
					<div class="value" style="color: #667eea;">${COP(totalGlobal)}</div>
				</div>
				</div>
			</div>
			`;

			htmlFinal += html;
			container.innerHTML = htmlFinal || '<p>No hay datos de pagos</p>';
		}
		
		// === Reemplazar COMPLETO ===
		function generarTablaRegistros(registros) {
		  let html = '<tr>' +
			'<th>Fecha</th><th>Producto</th><th>Cant.</th><th>Precio</th>' +
			'<th>Ventas</th><th>Gastos</th><th>M√©todo</th><th>Estado</th>' +
			'<th>Cliente</th><th>Descripci√≥n</th><th>Pendiente</th><th>Acciones</th>' +
		  '</tr>';

		  registros.forEach(r => {
			const ventasNum = Number(r.ventas || 0);
			const gastosNum = Number(r.gastos || 0);
			const precioFmt = (r.precioUnitario != null) ? COP(r.precioUnitario) : '-';
			const ventasFmt = (r.tipo === "movimiento") ? COP(ventasNum) : "-";
			const estadoFmt = r.estadoPago || '-';
			const clienteFmt = r.cliente || '-';
			const gastosFmt = (r.tipo === "movimiento") ? '-' + COP(gastosNum) : "-";
			const metodoFmt = (r.tipo === "movimiento")
			  ? (r.metodo === 'Efectivo' ? 'üíµ Efectivo' : (r.metodo === 'Nequi' ? 'üì± Nequi' : (r.metodo || '-')))
			  : "-";

			// NUEVO: calcular ‚ÄúPendiente‚Äù por l√≠nea (si est√° en Debe)
			const pendienteFmt = (r.estadoPago === 'Debe')
			  ? COP((r.montoPendiente != null ? r.montoPendiente : r.ventas) || 0)
			  : '-';

			// Mostrar bot√≥n Cobrar si est√° "Debe" y es una venta
			const puedeCobrar = r.tipo === 'movimiento' && ventasNum > 0 && estadoFmt === 'Debe' && !!r.id;
			const acciones = puedeCobrar
			  ? `<button class="btn-success" type="button" onclick="abrirModalCobrar('${r.id}')">Cobrar</button>`
			  : '-';

			html += `
			  <tr>
				<td>${r.fecha}</td>
				<td>${r.producto || '-'}</td>
				<td>${r.cantidad ?? '-'}</td>
				<td>${precioFmt}</td>
				<td style="color:#007bff;">${ventasFmt}</td>
				<td style="color:#dc3545;">${gastosFmt}</td>
				<td>${metodoFmt}</td>
				<td>${estadoFmt}</td>
				<td>${clienteFmt}</td>
				<td>${r.descripcion || '-'}</td>
				<td style="color:#d39e00;font-weight:600;">${pendienteFmt}</td>
				<td>${acciones}</td>
			  </tr>
			`;
		  });

		  return html;
		}

        // Limpiar formulario
        function limpiarFormulario() {
		  document.getElementById('gastos').value = '';
		  document.getElementById('descripcion').value = '';
		  document.getElementById('cantidad').value = '1';
		  document.getElementById('totalVentaPreview').textContent = '$0';
		  const precioInput = document.getElementById("precioPersonalizado");
		  if (precioInput) precioInput.value = '';
		  setFechaActual();
		  cargarProductos(); // recarga selector de productos
		  const tipoCorriente = document.getElementById('tipoCorriente');
		  if (tipoCorriente) tipoCorriente.value = '';
		  document.getElementById('tipoCorrienteWrap').style.display = 'none';
		  updateGastoInputsState();
		}

        // Mostrar mensajes
        function mostrarExito() {
            const msg = document.getElementById('successMsg');
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 3000);
        }

        function mostrarError(texto) {
            const msg = document.getElementById('errorMsg');
            msg.textContent = '‚úó ' + texto;
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 3000);
        }
		
		// Habilita/deshabilita inputs de gasto seg√∫n el estado del carrito
		function updateGastoInputsState() {
		  const gastosEl = document.getElementById('gastos');
		  const descEl   = document.getElementById('descripcion');

		  if (!gastosEl || !descEl) return;

		  const disabled = (carrito && carrito.length > 0);

		  // Si hay productos en carrito, limpiar y deshabilitar
		  if (disabled) {
			gastosEl.value = '';
			descEl.value = '';
		  }

		  gastosEl.disabled = disabled;
		  descEl.disabled = disabled;

		  // Si el modal "Guardar Registro" est√° abierto, refrescar su UI
		  // para que no muestre "M√©todo de gasto" si est√° deshabilitado
		  try { updateModalPagoUI(); } catch (e) {}
		}
				
		// ==== MODAL DE CONFIRMACI√ìN DE PAGO ====
		function abrirModalPago() {
			const gastos = parseFloat(document.getElementById('gastos').value) || 0;
			const hayCarrito = carrito.length > 0;
			const hayGasto = gastos > 0;

			if (!hayCarrito && !hayGasto) {
			  mostrarError('Agrega al menos una l√≠nea al pedido o registra un gasto.');
			  return;
			}

			// Estado por defecto:
			// - Si hay ventas, por defecto 'pagado'
			// - Si NO hay ventas y s√≠ gasto, por defecto 'soloGasto'
			const defaultEstado = hayCarrito ? 'pagado' : 'soloGasto';
			const radio = document.querySelector(`input[name="estadoPago"][value="${defaultEstado}"]`);
			if (radio) radio.checked = true;

			// Reset campos
			const err = document.getElementById('modalPagoError');
			if (err) err.style.display = 'none';
			const nombre = document.getElementById('nombreClienteDeudor');
			if (nombre) nombre.value = '';

			// Mostrar modal + ajustar visibilidad de secciones
			document.getElementById('modalPagoBackdrop').style.display = 'flex';
			updateModalPagoUI();
		}

		function cerrarModalPago() {
		  document.getElementById('modalPagoBackdrop').style.display = 'none';
		}

		function toggleNombreCliente(mostrar) {
		  const wrap = document.getElementById('nombreClienteWrap');
		  wrap.style.display = mostrar ? 'block' : 'none';
		}

		function confirmarGuardarDesdeModal() {
			const estado = document.querySelector('input[name="estadoPago"]:checked')?.value || 'pagado';
			const nombre = (document.getElementById('nombreClienteDeudor')?.value || '').trim();
			const err = document.getElementById('modalPagoError');

			const gastos = parseFloat(document.getElementById('gastos').value) || 0;
			const hayCarrito = carrito.length > 0;
			const hayGasto = gastos > 0;

			// Leer m√©todos (si visibles/corresponden)
			let metodoVenta = null;
			let metodoGasto = null;

			const ventaWrapVisible = document.getElementById('metodoVentaWrap')?.style.display !== 'none';
			if (ventaWrapVisible) {
			  metodoVenta = document.querySelector('input[name="metodoVenta"]:checked')?.value || null;
			}

			const gastoWrapVisible = document.getElementById('metodoGastoWrap')?.style.display !== 'none';
			if (gastoWrapVisible) {
			  metodoGasto = document.querySelector('input[name="metodoGasto"]:checked')?.value || null;
			}

			// Validaciones r√°pidas en el modal
			if (estado === 'debe' && hayCarrito && !nombre) {
			  err.textContent = '‚úó Debes ingresar el nombre del cliente que qued√≥ debiendo.';
			  err.style.display = 'block';
			  return;
			}
			if (estado === 'pagado' && hayCarrito && !metodoVenta) {
			  err.textContent = '‚úó Selecciona el m√©todo de pago de la venta.';
			  err.style.display = 'block';
			  return;
			}
			if (hayGasto && !metodoGasto) {
			  err.textContent = '‚úó Selecciona el m√©todo de pago del gasto.';
			  err.style.display = 'block';
			  return;
			}

			// üü° Confirmaci√≥n si seleccion√≥ 'Solo gasto' pero hay productos en el carrito
			if (estado === 'soloGasto' && hayCarrito) {
			  const seguro = confirm('Seleccionaste "Solo gasto", pero hay productos en el carrito. Se ignorar√°n estas ventas y solo se registrar√° el gasto. ¬øDeseas continuar?');
			  if (!seguro) return;
			}

			err.style.display = 'none';
			cerrarModalPago();

			// Guardar con los par√°metros finales
			guardarDatos({
			  estadoPago: estado,
			  nombreCliente: nombre || null,
			  metodoVenta,
			  metodoGasto,
			  soloGasto: (estado === 'soloGasto')
			});
		}
		
        // Exportar datos
        async function exportarDatos() {
			const datos = await obtenerTodosLosRegistros();
			
			// Crear nuevo objeto con nombres reales
			const datosFormateados = {};

			for (const [negocio, registros] of Object.entries(datos)) {
				const nombreReal = nombresNegocios[negocio] || negocio;
				datosFormateados[nombreReal] = registros;
			}

			const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(datosFormateados, null, 2));
			
			const link = document.createElement('a');
			link.href = dataStr;
			link.download = 'contabilidad_' + hoyLocalISO() + '.json';
			link.click();
		}


        // Descargar Excel (actualizado correctamente)
		async function descargarExcel() {
		  const datos = await obtenerTodosLosRegistros();
		  let csv = 'Negocio,Fecha,Producto,Tipo Corriente,Cantidad,Precio Unitario,Ventas,Gastos,M√©todo,Estado Pago,Cliente,Descripci√≥n\n';
		  for (const [negocio, registros] of Object.entries(datos)) {
			registros.forEach(r => {
			  if (r.tipo === "movimiento") {
				const descripcion = (r.descripcion || '').replace(/"/g, '""');
				function csvEsc(s) {
					s = (s ?? '').toString();
					return `"${s.replace(/"/g, '""')}"`;
					}

					// y √∫salo en todas las columnas string:
					csv += [
					csvEsc(nombresNegocios[negocio]),
					csvEsc(r.fecha),
					csvEsc(r.producto || ''),
					csvEsc(r.tipoCorriente || ''),
					r.cantidad ?? '',
					r.precioUnitario ?? '',
					r.ventas || 0,
					r.gastos || 0,
					csvEsc(r.metodo || ''),
					csvEsc(r.estadoPago || ''),
					csvEsc(r.cliente || ''),
					csvEsc(descripcion)
				].join(',') + '\n';


			  }
			});
		  }
		  const link = document.createElement('a');
		  link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
		  link.download = 'contabilidad_' + hoyLocalISO() + '.csv';
		  link.click();
		}

        // Limpiar todo
        function limpiarTodos() {
            if (confirm('¬øEst√°s seguro de que deseas limpiar TODOS los datos? Esta acci√≥n no se puede deshacer.')) {
                localStorage.removeItem('contabilidad');
                inicializarSistema();
                actualizarTotalRegistros();
                mostrarExito();
            }
        }

        // Actualizar total de registros
        async function actualizarTotalRegistros() {
            const datos = await obtenerTodosLosRegistros();
            let total = 0;
            for (const registros of Object.values(datos)) {
                total += registros.length;
            }
            document.getElementById('totalRegistros').textContent = total;
        }
        
		// Productos y c√°lculo
		document.getElementById("business").addEventListener("change", cargarProductos);
		document.getElementById("productoSelect").addEventListener("change", calcularTotalVenta);
		document.getElementById("cantidad").addEventListener("input", calcularTotalVenta);
		document.getElementById("precioPersonalizado").addEventListener("input", calcularTotalVenta);

		// Espera a que el <script type="module"> exponga las globals de Firebase
		async function waitForFirebaseReady() {
			while (!(window.db && window.getDocs && window.collection && window.updateDoc)) {
			// Espera 20ms y vuelve a chequear
			await new Promise(r => setTimeout(r, 20));
			}
		}

		// Inicializa SOLO cuando Firebase globals est√©n listas
		window.addEventListener('DOMContentLoaded', async () => {
			try {
			await waitForFirebaseReady();
			} catch (e) {
			console.error('Firebase no se inicializ√≥ a tiempo:', e);
			} finally {
			// Tu inicializaci√≥n normal
			inicializarSistema();
			}
		});
		
		async function switchTab(tabName, ev) {
		  const contents = document.querySelectorAll('.content');
		  const buttons = document.querySelectorAll('.tab-button');
		  
		  // Desactivar todo
		  contents.forEach(c => c.classList.remove('active'));
		  buttons.forEach(b => b.classList.remove('active'));
		  
		  // Activar contenido
		  document.getElementById(tabName).classList.add('active');
		  // Activar el bot√≥n que dispar√≥ el evento (si existe)
		  if (ev && ev.target) ev.target.classList.add('active');

		  // Cargar datos al entrar a cada pesta√±a
		  if (tabName === 'resumen') {
			await actualizarResumen();
			await actualizarCuentasPorCobrar();
		  }
		  if (tabName === 'acumulado') await actualizarAcumulado();
		  if (tabName === 'metodos') await actualizarAnalisisPagos();
		  if (tabName === 'configuracion') renderCatalogoUI();
		}
		
		// ===== Cobrar ventas en "Debe" =====
		let ventaACobrarId = null;

		function abrirModalCobrar(id) {
			ventaACobrarId = id;
			document.getElementById('modalCobrarError').style.display = 'none';
			// Default: Efectivo
			const ef = document.getElementById('cobroEfectivo');
			if (ef) ef.checked = true;
			document.getElementById('modalCobrarBackdrop').style.display = 'flex';
		}

		function cerrarModalCobrar() {
			document.getElementById('modalCobrarBackdrop').style.display = 'none';
			ventaACobrarId = null;
		}

		async function confirmarCobro() {
			const err = document.getElementById('modalCobrarError');
			try {
			if (!ventaACobrarId) {
				err.textContent = '‚úó No se encontr√≥ la venta a cobrar.';
				err.style.display = 'block';
				return;
			}
			const metodoSel = document.querySelector('input[name="metodoCobro"]:checked')?.value || 'Efectivo';

			await updateDoc(doc(db, "registros", ventaACobrarId), {
				estadoPago: 'Pagado',
				metodo: metodoSel,
				montoPendiente: 0
			});

			cerrarModalCobrar();
			mostrarExito();

			// Refrescar tableros (por si est√°s en cualquiera)
			try { await actualizarResumen(); } catch(e) {}
			try { await actualizarAnalisisPagos(); } catch(e) {}
			try { await actualizarAcumulado(); } catch(e) {}
			try { await actualizarCuentasPorCobrar(); } catch(e) {}

			} catch (e) {
			console.error(e);
			err.textContent = '‚úó Error registrando el cobro.';
			err.style.display = 'block';
			}
		}
    </script>
	<script type="module">
	  import { initializeApp } 
	  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";

	  import { 
		getAuth, 
		onAuthStateChanged, 
		signOut,
		signInWithEmailAndPassword,
		reauthenticateWithCredential,
		EmailAuthProvider
	  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

	  import { 
		getFirestore, 
		collection, 
		addDoc, 
		getDocs, 
		query, 
		where,
		doc,
		updateDoc 
	  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

	  const firebaseConfig = {
		apiKey: "AIzaSyA_C9CYbLYpkJhaME5j9OgzlVjN83iwY78",
		authDomain: "cuentaselancla.firebaseapp.com",
		projectId: "cuentaselancla",
		storageBucket: "cuentaselancla.firebasestorage.app",
		messagingSenderId: "538778905068",
		appId: "1:538778905068:web:4e48f2ef1510d68d6138c9"
	  };

	  // üî• INICIALIZAR UNA SOLA VEZ
	  const app = initializeApp(firebaseConfig);
	  const auth = getAuth(app);
	  const db = getFirestore(app);

	  // üî• HACER VARIABLES GLOBALES
	  window.db = db;
	  window.collection = collection;
	  window.addDoc = addDoc;
	  window.getDocs = getDocs;
	  window.query = query;
	  window.where = where;
	  window.doc = doc;
	  window.updateDoc = updateDoc;

	  // Hacer accesible la sesi√≥n y m√©todos de auth a scripts no-m√≥dulo
	  window.auth = auth;
	  window.signInWithEmailAndPassword = signInWithEmailAndPassword;
	  window.reauthenticateWithCredential = reauthenticateWithCredential;
	  window.EmailAuthProvider = EmailAuthProvider;

	  // üîê VALIDAR SESI√ìN
 	  onAuthStateChanged(auth, (user) => {
		  if (user) {
			console.log("Usuario autenticado:", user.email);
			startInactivityTimer();
		  } else {
			console.log("No hay sesi√≥n activa");
			setTimeout(() => {
			  window.location.href = "login.html";
			}, 500);
		  }
		});

	  // üö™ CERRAR SESI√ìN
	  window.logout = function() {
		signOut(auth).then(() => {
		  window.location.href = "login.html";
		});
	  };
	  
		// ============== AUTO-LOGOUT POR INACTIVIDAD (5 MIN) ==============
		const INACTIVITY_LIMIT_MS = 5 * 60 * 1000; // 5 minutos
		let inactivityTimer = null;

		function resetInactivityTimer() {
			if (inactivityTimer) clearTimeout(inactivityTimer);
			inactivityTimer = setTimeout(async () => {
			try {
				await signOut(auth);
			} catch (e) {
				console.warn('Error haciendo signOut por inactividad', e);
			} finally {
				window.location.href = 'login.html';
			}
			}, INACTIVITY_LIMIT_MS);
		}

		function startInactivityTimer() {
			resetInactivityTimer();

			const resetEvents = ['mousemove','keydown','click','touchstart','scroll','visibilitychange'];
			resetEvents.forEach(evt => {
			document.addEventListener(evt, () => {
				// Solo reinicia si la pesta√±a est√° activa o el usuario volvi√≥ a verla
				if (evt !== 'visibilitychange' || document.visibilityState === 'visible') {
				resetInactivityTimer();
				}
			}, { passive: true });
			});
		}
	</script>
</body>
</html>
